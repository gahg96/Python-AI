# 银行数据提取快速指南

## 🚀 快速开始

### 1. 准备配置文件

编辑 `config/extract_config.yaml`，配置数据源：

```yaml
# 从Parquet文件提取（示例）
customer_source:
  type: parquet
  file_path: data/historical/customers.parquet

# 从数据库提取（实际使用）
customer_source:
  type: database
  connection_string: postgresql://user:password@host:port/database
  query: |
    SELECT customer_id, age, gender, ... 
    FROM crm.customer_profile
    WHERE registration_date >= '2015-01-01'
```

### 2. 运行提取脚本

```bash
# 使用默认配置
python3 scripts/extract_banking_data.py

# 指定配置文件
python3 scripts/extract_banking_data.py --config config/extract_config.yaml

# 指定输出目录
python3 scripts/extract_banking_data.py --output data/my_extracted/
```

### 3. 查看结果

```bash
# 查看提取的特征数据
python3 scripts/view_parquet.py data/extracted/customer_features.parquet
```

---

## 📊 数据源类型

### 1. 从数据库提取

```yaml
customer_source:
  type: database
  connection_string: postgresql://user:password@host:port/database
  query: |
    SELECT * FROM customers
    WHERE registration_date >= '2015-01-01'
```

**支持的数据库**：
- PostgreSQL
- MySQL
- Oracle
- SQL Server
- 其他 SQLAlchemy 支持的数据库

### 2. 从CSV文件提取

```yaml
customer_source:
  type: csv
  file_path: data/customers.csv
```

### 3. 从Parquet文件提取

```yaml
customer_source:
  type: parquet
  file_path: data/historical/customers.parquet
```

---

## 🔧 特征工程

脚本会自动计算以下特征：

### 基础特征
- 客户年龄分组
- 客户关系时长（月数）

### 财务特征
- 负债率 (debt_ratio)
- 债务收入比 (debt_to_income)

### 交易特征（如果提供交易数据）
- 平均交易金额
- 交易标准差
- 总收入/总支出
- 储蓄率
- 收入波动率

### 贷款特征（如果提供贷款数据）
- 历史贷款次数
- 总贷款金额
- 平均/最大贷款金额
- 违约次数
- 最大逾期天数
- 距上次贷款时间

---

## 📝 实际使用示例

### 示例1：从现有Parquet文件提取

```bash
# 1. 编辑配置文件，指向现有数据
vim config/extract_config.yaml

# 2. 运行提取
python3 scripts/extract_banking_data.py

# 3. 查看结果
python3 scripts/view_parquet.py data/extracted/customer_features.parquet --head 10
```

### 示例2：从数据库提取

```yaml
# config/extract_config.yaml
customer_source:
  type: database
  connection_string: postgresql://bank_user:password@db.example.com:5432/bank_db
  query: |
    SELECT 
      customer_id,
      age,
      gender,
      education_level,
      industry,
      city_tier,
      registration_date,
      customer_type,
      monthly_income,
      total_assets,
      total_liabilities
    FROM crm.customer_profile
    WHERE registration_date >= '2015-01-01'
      AND status = 'active'
```

```bash
# 运行提取
python3 scripts/extract_banking_data.py --config config/extract_config.yaml
```

### 示例3：多数据源合并

```yaml
# 客户数据
customer_source:
  type: database
  connection_string: postgresql://...
  query: SELECT * FROM customers

# 交易数据
transaction_source:
  type: database
  connection_string: postgresql://...
  query: SELECT * FROM transactions WHERE date >= '2024-01-01'

# 贷款数据
loan_source:
  type: database
  connection_string: postgresql://...
  query: SELECT * FROM loans
```

---

## 🔒 数据安全

### 数据脱敏

在配置文件中设置：

```yaml
anonymize: true
```

脚本会自动：
- 对 `customer_id` 进行哈希处理
- 删除 `id_card`, `phone`, `email` 等敏感字段

### 自定义脱敏字段

修改脚本中的 `anonymize_data` 方法，添加需要脱敏的字段。

---

## 📚 详细文档

- **完整指南**: `docs/银行数据提取与特征工程指南.md`
- **特征说明**: 查看脚本中的 `calculate_*_features` 方法
- **配置示例**: `config/extract_config.yaml`

---

## ⚠️ 注意事项

1. **数据库连接**
   - 确保有数据库访问权限
   - 安装相应的数据库驱动：`pip install sqlalchemy psycopg2` (PostgreSQL)

2. **数据量**
   - 大表建议使用增量提取
   - 可以添加 `LIMIT` 子句进行测试

3. **数据质量**
   - 检查缺失值比例
   - 验证数据范围是否合理
   - 检查异常值

4. **性能优化**
   - 使用索引字段进行过滤
   - 只选择需要的列
   - 分批处理大数据

---

## 🐛 常见问题

### Q: 数据库连接失败
**A**: 检查连接字符串格式，确保数据库服务运行中

### Q: 特征计算失败
**A**: 检查数据列名是否匹配，查看错误日志

### Q: 内存不足
**A**: 使用分批处理，或增加服务器内存

### Q: 数据脱敏后无法关联
**A**: 使用一致的哈希算法，确保同一客户ID哈希结果相同

