# 模型预测与评估指南

## 📋 目录
1. [客户信用评分预测](#客户信用评分预测)
2. [模型评估方法](#模型评估方法)
3. [评判标准与依据](#评判标准与依据)
4. [使用示例](#使用示例)
5. [常见问题](#常见问题)

---

## 🎯 客户信用评分预测

### 1. 预测流程

```
客户申请数据
    ↓
特征提取与预处理
    ↓
模型预测
    ↓
信用评分 (0-1000分)
    ↓
风险等级判定
    ↓
审批建议
```

### 2. 信用评分说明

**评分范围**: 0-1000分

| 评分范围 | 风险等级 | 审批建议 | 说明 |
|---------|---------|---------|------|
| 800-1000 | 低风险 | 建议通过 | 信用状况良好，违约概率低 |
| 650-799 | 中低风险 | 建议通过 | 信用状况较好，可正常审批 |
| 500-649 | 中风险 | 条件通过 | 需额外审核，可考虑提高利率或降低额度 |
| 350-499 | 中高风险 | 谨慎审批 | 风险较高，需严格审核 |
| 0-349 | 高风险 | 建议拒绝 | 违约概率高，不建议放贷 |

### 3. 预测结果组成

```json
{
  "credit_score": 720,
  "default_probability": 0.08,
  "risk_level": "中低风险",
  "approval_suggestion": "建议通过",
  "prediction": 0,
  "probability_distribution": {
    "normal": 0.92,
    "defaulted": 0.08
  },
  "explanation": {
    "key_factors": [...],
    "risk_factors": [...],
    "positive_factors": [...]
  }
}
```

---

## 📊 模型评估方法

### 1. 评估指标

#### 核心指标

**AUC Score (ROC曲线下面积)**
- **范围**: 0-1
- **含义**: 模型区分正负样本的能力
- **评判标准**:
  - AUC > 0.9: 优秀
  - AUC > 0.8: 良好
  - AUC > 0.7: 可接受
  - AUC < 0.7: 需要改进

**准确率 (Accuracy)**
- **公式**: (TP + TN) / (TP + TN + FP + FN)
- **含义**: 所有预测中正确的比例
- **注意**: 在类别不平衡时可能不准确

**精确率 (Precision)**
- **公式**: TP / (TP + FP)
- **含义**: 预测为违约的客户中，真正违约的比例
- **重要性**: 避免误拒（将好客户误判为坏客户）

**召回率 (Recall)**
- **公式**: TP / (TP + FN)
- **含义**: 真正违约的客户中，被正确识别的比例
- **重要性**: 避免漏检（将坏客户误判为好客户）

**F1分数 (F1-Score)**
- **公式**: 2 × (Precision × Recall) / (Precision + Recall)
- **含义**: 精确率和召回率的调和平均
- **用途**: 平衡精确率和召回率

#### 业务指标

**KS值 (Kolmogorov-Smirnov)**
- **含义**: 模型区分能力的指标
- **评判标准**:
  - KS > 0.4: 优秀
  - KS > 0.3: 良好
  - KS > 0.2: 可接受

**提升度 (Lift)**
- **含义**: 模型预测的违约率相对于总体违约率的倍数
- **用途**: 评估模型在特定分位数的表现

### 2. 混淆矩阵

```
              预测
           正常  违约
实际 正常  TN   FP  (误拒)
     违约  FN   TP  (正确识别)
```

**关键指标**:
- **TP (True Positive)**: 正确识别的违约客户
- **TN (True Negative)**: 正确识别的正常客户
- **FP (False Positive)**: 误判为违约的正常客户（误拒）
- **FN (False Negative)**: 误判为正常的违约客户（漏检）

### 3. 评估曲线

**ROC曲线**
- **横轴**: 假正率 (FPR)
- **纵轴**: 真正率 (TPR)
- **用途**: 评估模型在不同阈值下的表现
- **AUC值**: ROC曲线下面积

**PR曲线 (Precision-Recall)**
- **横轴**: 召回率 (Recall)
- **纵轴**: 精确率 (Precision)
- **用途**: 在类别不平衡时更有效

---

## ⚖️ 评判标准与依据

### 1. 模型准确性评判标准

#### 行业标准

| 指标 | 优秀 | 良好 | 可接受 | 需改进 |
|-----|------|------|--------|--------|
| AUC | > 0.9 | 0.8-0.9 | 0.7-0.8 | < 0.7 |
| 精确率 | > 0.85 | 0.75-0.85 | 0.65-0.75 | < 0.65 |
| 召回率 | > 0.80 | 0.70-0.80 | 0.60-0.70 | < 0.60 |
| F1分数 | > 0.82 | 0.72-0.82 | 0.62-0.72 | < 0.62 |
| KS值 | > 0.4 | 0.3-0.4 | 0.2-0.3 | < 0.2 |

#### 业务标准

**风险控制要求**:
- **误拒率 (FP率)**: < 5% (避免过多好客户被拒绝)
- **漏检率 (FN率)**: < 10% (避免过多坏客户被通过)
- **整体准确率**: > 85%

**成本效益分析**:
- **误拒成本**: 失去一个好客户的收益
- **漏检成本**: 一个坏客户造成的损失
- **最优阈值**: 平衡两种成本的阈值

### 2. 评估依据

#### 数据质量依据

1. **训练数据质量**
   - 数据量: 建议 > 10,000 条
   - 数据分布: 正负样本比例合理（建议 1:10 到 1:20）
   - 数据时效性: 使用最近3-5年的数据
   - 数据完整性: 缺失值 < 5%

2. **特征质量**
   - 特征相关性: 与目标变量相关性 > 0.1
   - 特征稳定性: 特征分布在不同时间段保持一致
   - 特征可解释性: 特征有业务含义

#### 模型性能依据

1. **交叉验证**
   - 使用K折交叉验证（K=5或10）
   - 各折的AUC差异 < 0.05
   - 确保模型泛化能力

2. **时间验证**
   - 使用时间序列分割（训练集用旧数据，测试集用新数据）
   - 验证模型在时间上的稳定性

3. **样本外验证**
   - 使用完全独立的测试集
   - 测试集与训练集无重叠
   - 测试集大小建议为总数据的20%

#### 业务验证依据

1. **业务规则一致性**
   - 模型预测结果符合业务逻辑
   - 高风险客户的特征符合经验判断
   - 低风险客户的特征符合经验判断

2. **专家评审**
   - 业务专家审核模型结果
   - 对比模型预测与人工判断
   - 识别模型异常情况

3. **A/B测试**
   - 在真实业务场景中测试
   - 对比模型决策与人工决策的效果
   - 监控模型在实际应用中的表现

### 3. 持续监控指标

**模型稳定性监控**:
- **PSI (Population Stability Index)**: 评估特征分布变化
  - PSI < 0.1: 稳定
  - PSI 0.1-0.25: 轻微变化
  - PSI > 0.25: 显著变化，需重新训练

**模型性能监控**:
- **准确率趋势**: 监控准确率是否下降
- **AUC趋势**: 监控AUC是否下降
- **预测分布**: 监控预测概率分布是否异常

**业务效果监控**:
- **实际违约率**: 对比预测违约率与实际违约率
- **审批通过率**: 监控审批通过率变化
- **坏账率**: 监控实际坏账率

---

## 💻 使用示例

### 示例1：预测单个客户

```bash
# 1. 准备客户数据 (customer_data.json)
{
  "age": 35,
  "gender": "M",
  "education": "bachelor",
  "industry": "it",
  "city_tier": "tier_1",
  "customer_type": "salaried",
  "monthly_income": 15000,
  "total_assets": 500000,
  "total_liabilities": 200000,
  "total_deposit_balance": 100000,
  "total_loans": 2,
  "default_count": 0,
  "max_overdue_days": 0,
  "months_as_customer": 36
}

# 2. 进行预测
python3 scripts/predict_customer.py \
    --model models/model_20241209_143022.pkl \
    --customer customer_data.json \
    --explain \
    --output prediction_result.json
```

**输出示例**:
```
📊 预测结果
============================================================
信用评分: 720 分
违约概率: 8.00%
风险等级: 中低风险
审批建议: 建议通过

风险因素 (0个):

正面因素 (2个):
  - 储蓄率较高: 17.00% (影响: 中)
  - 客户关系稳定: 36个月 (影响: 中)
```

### 示例2：评估模型

```bash
# 使用测试集评估模型
python3 scripts/evaluate_model.py \
    --model models/model_20241209_143022.pkl \
    --test data/test_features.parquet \
    --output evaluation_report.json \
    --plot \
    --plot-dir evaluation_plots
```

**输出示例**:
```
📊 模型评估报告
============================================================

核心指标:
  AUC Score:     0.8541
  准确率:        0.9520
  精确率:        0.8500
  召回率:        0.7200
  F1分数:        0.7800

测试集信息:
  总样本数:      1,000,000
  正样本数:      50,000
  负样本数:      950,000
  正样本率:      5.00%

混淆矩阵:
              预测
           正常  违约
实际 正常  931000  19000
     违约   14000  36000
```

### 示例3：批量预测

```python
import pandas as pd
import pickle
import json

# 加载模型
with open('models/model_20241209_143022.pkl', 'rb') as f:
    model = pickle.load(f)

# 加载客户数据
customers = pd.read_parquet('data/new_applications.parquet')

# 批量预测
predictions = []
for idx, customer in customers.iterrows():
    # 准备特征
    features = prepare_features(customer)
    
    # 预测
    prob = model.predict_proba([features])[0][1]
    score = int((1 - prob) * 1000)
    
    predictions.append({
        'customer_id': customer['customer_id'],
        'credit_score': score,
        'default_probability': prob,
        'approval_suggestion': '通过' if score >= 650 else '拒绝'
    })

# 保存结果
pd.DataFrame(predictions).to_parquet('predictions.parquet', index=False)
```

---

## ❓ 常见问题

### Q1: 如何判断模型是否准确？

**A**: 从多个维度评估：
1. **统计指标**: AUC > 0.8, 精确率 > 0.75, 召回率 > 0.70
2. **业务指标**: 实际违约率与预测违约率接近
3. **稳定性**: PSI < 0.1, 不同时间段表现稳定
4. **可解释性**: 预测结果符合业务逻辑

### Q2: 模型预测的信用评分是否可靠？

**A**: 可靠性取决于：
1. **模型性能**: AUC越高，可靠性越高
2. **数据质量**: 训练数据质量越好，可靠性越高
3. **特征完整性**: 客户特征越完整，预测越准确
4. **模型更新**: 定期重新训练，保持模型时效性

### Q3: 如何提高模型准确性？

**A**: 
1. **增加数据量**: 使用更多历史数据训练
2. **特征工程**: 挖掘更多有效特征
3. **模型调优**: 调整超参数，尝试不同算法
4. **集成学习**: 使用多个模型集成
5. **持续监控**: 定期评估和更新模型

### Q4: 预测结果与人工判断不一致怎么办？

**A**: 
1. **分析差异原因**: 检查模型使用的特征是否完整
2. **专家评审**: 请业务专家审核差异案例
3. **模型解释**: 查看模型决策的关键因素
4. **A/B测试**: 对比模型决策与人工决策的效果
5. **模型调整**: 根据反馈调整模型或阈值

### Q5: 如何设置审批阈值？

**A**: 
1. **业务目标**: 根据风险承受能力设定
2. **成本效益**: 平衡误拒成本和漏检成本
3. **历史数据**: 参考历史审批通过率和违约率
4. **监管要求**: 符合监管对坏账率的要求
5. **动态调整**: 根据实际效果持续优化

---

## 📚 相关文档

- **特征文件格式**: `docs/特征文件格式与训练指南.md`
- **模型训练**: `docs/特征文件与训练快速指南.md`
- **数据提取**: `docs/银行数据提取与特征工程指南.md`

---

## 🔍 总结

### 预测流程
1. 准备客户数据
2. 提取特征
3. 模型预测
4. 生成信用评分
5. 给出审批建议

### 评估方法
1. 统计指标 (AUC, 精确率, 召回率)
2. 业务指标 (实际违约率, 审批通过率)
3. 稳定性监控 (PSI, 时间验证)
4. 业务验证 (专家评审, A/B测试)

### 评判标准
- **AUC > 0.8**: 模型性能良好
- **精确率 > 0.75**: 误拒率低
- **召回率 > 0.70**: 漏检率低
- **PSI < 0.1**: 模型稳定
- **业务逻辑一致**: 预测结果合理

