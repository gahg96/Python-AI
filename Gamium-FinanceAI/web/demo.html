<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç«¯åˆ°ç«¯è´·æ¬¾å®¡æ‰¹Demo - äº¤äº’ç•Œé¢</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .step-container {
            margin-bottom: 30px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
        }

        .step-header {
            background: #f5f5f5;
            padding: 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s;
        }

        .step-header:hover {
            background: #eeeeee;
        }

        .step-header.active {
            background: #667eea;
            color: white;
        }

        .step-title {
            font-size: 1.3em;
            font-weight: bold;
        }

        .step-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .status-pending {
            background: #ffc107;
            color: #000;
        }

        .status-running {
            background: #17a2b8;
            color: white;
        }

        .status-success {
            background: #28a745;
            color: white;
        }

        .status-error {
            background: #dc3545;
            color: white;
        }

        .step-content {
            padding: 20px;
            display: none;
        }

        .step-content.active {
            display: block;
        }

        .step-actions {
            margin-top: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
            font-weight: bold;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .log-container {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .log-line {
            margin-bottom: 5px;
            white-space: pre-wrap;
        }

        .log-success {
            color: #4ec9b0;
        }

        .log-error {
            color: #f48771;
        }

        .log-warning {
            color: #dcdcaa;
        }

        .result-display {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 6px;
            margin-top: 20px;
        }
        
        .result-display table {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .result-display th {
            font-weight: bold;
            font-size: 0.9em;
        }
        
        .result-display td {
            font-size: 0.85em;
        }
        
        .result-display tbody tr:hover {
            background: #e3f2fd !important;
            cursor: pointer;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid #e0e0e0;
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-label {
            font-weight: bold;
            color: #666;
        }

        .result-value {
            color: #333;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .alert {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ ç«¯åˆ°ç«¯è´·æ¬¾å®¡æ‰¹Demo</h1>
            <p>åŸºäºå†å²æ•°æ®çš„å®Œæ•´è´·æ¬¾å®¡æ‰¹æµç¨‹æ¨¡æ‹Ÿç³»ç»Ÿ</p>
        </div>

        <div class="content">
            <!-- æ€»ä½“è¿›åº¦ -->
            <div class="progress-bar">
                <div class="progress-fill" id="overall-progress">0%</div>
            </div>

            <!-- æ­¥éª¤1ï¼šå†å²æ•°æ®å‡†å¤‡ -->
            <div class="step-container">
                <div class="step-header" onclick="toggleStep(1)">
                    <div>
                        <span class="step-title">æ­¥éª¤1ï¼šå†å²æ•°æ®å‡†å¤‡</span>
                        <span class="step-status status-pending" id="step1-status">å¾…æ‰§è¡Œ</span>
                    </div>
                    <span>â–¼</span>
                </div>
                <div class="step-content" id="step1-content">
                    <div class="form-group">
                        <label>å†å²è´·æ¬¾æ•°é‡ï¼š</label>
                        <input type="number" id="num-historical-loans" value="10000" min="1000" max="100000">
                    </div>
                    <div class="form-group">
                        <label>å¯¹ç§è´·æ¬¾æ¯”ä¾‹ï¼š</label>
                        <input type="number" id="personal-ratio" value="0.7" min="0" max="1" step="0.1">
                    </div>
                    <div class="step-actions">
                        <button class="btn btn-primary" onclick="runStep1()">ç”Ÿæˆå†å²æ•°æ®</button>
                    </div>
                    <div class="log-container" id="step1-log"></div>
                    <div class="result-display" id="step1-results" style="display:none;"></div>
                </div>
            </div>

            <!-- æ­¥éª¤2ï¼šæ•°æ®è´¨é‡æ£€æŸ¥ -->
            <div class="step-container">
                <div class="step-header" onclick="toggleStep(2)">
                    <div>
                        <span class="step-title">æ­¥éª¤2ï¼šæ•°æ®è´¨é‡æ£€æŸ¥</span>
                        <span class="step-status status-pending" id="step2-status">å¾…æ‰§è¡Œ</span>
                    </div>
                    <span>â–¼</span>
                </div>
                <div class="step-content" id="step2-content">
                    <div class="step-actions">
                        <button class="btn btn-primary" onclick="runStep2()">æ‰§è¡Œè´¨é‡æ£€æŸ¥</button>
                    </div>
                    <div class="log-container" id="step2-log"></div>
                    <div class="result-display" id="step2-results" style="display:none;"></div>
                </div>
            </div>

            <!-- æ­¥éª¤3ï¼šç‰¹å¾å·¥ç¨‹ -->
            <div class="step-container">
                <div class="step-header" onclick="toggleStep(3)">
                    <div>
                        <span class="step-title">æ­¥éª¤3ï¼šç‰¹å¾å·¥ç¨‹</span>
                        <span class="step-status status-pending" id="step3-status">å¾…æ‰§è¡Œ</span>
                    </div>
                    <span>â–¼</span>
                </div>
                <div class="step-content" id="step3-content">
                    <div class="step-actions">
                        <button class="btn btn-primary" onclick="runStep3()">æ‰§è¡Œç‰¹å¾å·¥ç¨‹</button>
                    </div>
                    <div class="log-container" id="step3-log"></div>
                    <div class="result-display" id="step3-results" style="display:none;"></div>
                </div>
            </div>

            <!-- æ­¥éª¤4ï¼šè§„åˆ™æå– -->
            <div class="step-container">
                <div class="step-header" onclick="toggleStep(4)">
                    <div>
                        <span class="step-title">æ­¥éª¤4ï¼šè§„åˆ™æå–å’Œé‡åŒ–</span>
                        <span class="step-status status-pending" id="step4-status">å¾…æ‰§è¡Œ</span>
                    </div>
                    <span>â–¼</span>
                </div>
                <div class="step-content" id="step4-content">
                    <div class="step-actions">
                        <button class="btn btn-primary" onclick="runStep4()">æå–è§„åˆ™</button>
                    </div>
                    <div class="log-container" id="step4-log"></div>
                    <div class="result-display" id="step4-results" style="display:none;"></div>
                </div>
            </div>

            <!-- æ­¥éª¤5ï¼šæ¨¡å‹è®­ç»ƒ -->
            <div class="step-container">
                <div class="step-header" onclick="toggleStep(5)">
                    <div>
                        <span class="step-title">æ­¥éª¤5ï¼šæ¨¡å‹è®­ç»ƒ</span>
                        <span class="step-status status-pending" id="step5-status">å¾…æ‰§è¡Œ</span>
                    </div>
                    <span>â–¼</span>
                </div>
                <div class="step-content" id="step5-content">
                    <div class="step-actions">
                        <button class="btn btn-primary" onclick="runStep5()">è®­ç»ƒæ¨¡å‹</button>
                    </div>
                    <div class="log-container" id="step5-log"></div>
                    <div class="result-display" id="step5-results" style="display:none;"></div>
                </div>
            </div>

            <!-- æ­¥éª¤6ï¼šæ¨¡æ‹Ÿå®¡æ‰¹ -->
            <div class="step-container">
                <div class="step-header" onclick="toggleStep(6)">
                    <div>
                        <span class="step-title">æ­¥éª¤6ï¼šæ¨¡æ‹Ÿå®¡æ‰¹</span>
                        <span class="step-status status-pending" id="step6-status">å¾…æ‰§è¡Œ</span>
                    </div>
                    <span>â–¼</span>
                </div>
                <div class="step-content" id="step6-content">
                    <div class="form-group">
                        <label>æ¨¡æ‹Ÿå®¢æˆ·æ•°é‡ï¼š</label>
                        <input type="number" id="num-simulated-customers" value="100" min="10" max="1000">
                    </div>
                    <div class="step-actions">
                        <button class="btn btn-primary" onclick="runStep6()">å¼€å§‹æ¨¡æ‹Ÿ</button>
                    </div>
                    <div class="log-container" id="step6-log"></div>
                    <div class="result-display" id="step6-results" style="display:none;"></div>
                </div>
            </div>

            <!-- æ­¥éª¤7ï¼šç»“æœéªŒè¯ -->
            <div class="step-container">
                <div class="step-header" onclick="toggleStep(7)">
                    <div>
                        <span class="step-title">æ­¥éª¤7ï¼šç»“æœéªŒè¯</span>
                        <span class="step-status status-pending" id="step7-status">å¾…æ‰§è¡Œ</span>
                    </div>
                    <span>â–¼</span>
                </div>
                <div class="step-content" id="step7-content">
                    <div class="step-actions">
                        <button class="btn btn-primary" onclick="runStep7()">æ‰§è¡ŒéªŒè¯</button>
                    </div>
                    <div class="log-container" id="step7-log"></div>
                    <div class="result-display" id="step7-results" style="display:none;"></div>
                </div>
            </div>

            <!-- ä¸€é”®è¿è¡Œæ‰€æœ‰æ­¥éª¤ -->
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-success" style="font-size: 1.2em; padding: 15px 40px;" onclick="runAllSteps()">
                    ğŸš€ ä¸€é”®è¿è¡Œå®Œæ•´æµç¨‹
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentStep = 0;
        const totalSteps = 7;

        function toggleStep(stepNum) {
            const content = document.getElementById(`step${stepNum}-content`);
            const header = content.previousElementSibling;
            
            if (content.classList.contains('active')) {
                content.classList.remove('active');
                header.querySelector('span:last-child').textContent = 'â–¼';
            } else {
                // å…³é—­å…¶ä»–æ­¥éª¤
                document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.step-header span:last-child').forEach(el => el.textContent = 'â–¼');
                
                content.classList.add('active');
                header.querySelector('span:last-child').textContent = 'â–²';
            }
        }

        function updateProgress(step, status) {
            const statusEl = document.getElementById(`step${step}-status`);
            if (!statusEl) {
                console.warn(`Status element for step ${step} not found`);
                return;
            }
            statusEl.className = `step-status status-${status}`;
            
            const statusText = {
                'pending': 'å¾…æ‰§è¡Œ',
                'running': 'æ‰§è¡Œä¸­...',
                'success': 'âœ… å®Œæˆ',
                'error': 'âŒ å¤±è´¥'
            };
            statusEl.textContent = statusText[status];
            
            // æ›´æ–°æ€»ä½“è¿›åº¦
            let completed = 0;
            for (let i = 1; i <= totalSteps; i++) {
                const el = document.getElementById(`step${i}-status`);
                if (el && el.classList.contains('status-success')) completed++;
            }
            const progress = (completed / totalSteps) * 100;
            const progressEl = document.getElementById('overall-progress');
            if (progressEl) {
                progressEl.style.width = progress + '%';
                progressEl.textContent = Math.round(progress) + '%';
            }
        }

        function addLog(step, message, type = 'info') {
            const logEl = document.getElementById(`step${step}-log`);
            const logLine = document.createElement('div');
            logLine.className = `log-line log-${type}`;
            logLine.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logEl.appendChild(logLine);
            logEl.scrollTop = logEl.scrollHeight;
        }

        function showResults(step, data) {
            const resultsEl = document.getElementById(`step${step}-results`);
            if (!resultsEl) {
                console.warn(`Results element for step ${step} not found`);
                return;
            }
            resultsEl.style.display = 'block';
            
            let html = '<h3>æ‰§è¡Œç»“æœï¼š</h3>';
            if (typeof data === 'object' && data !== null) {
                for (const [key, value] of Object.entries(data)) {
                    html += `<div class="result-item">
                        <span class="result-label">${key}:</span>
                        <span class="result-value">${value}</span>
                    </div>`;
                }
            } else {
                html += `<div class="result-item">${data || 'æ— æ•°æ®'}</div>`;
            }
            resultsEl.innerHTML = html;
        }

        async function runStep1() {
            updateProgress(1, 'running');
            addLog(1, 'å¼€å§‹ç”Ÿæˆå†å²æ•°æ®...', 'info');
            
            const numLoans = document.getElementById('num-historical-loans').value;
            const personalRatio = document.getElementById('personal-ratio').value;
            
            try {
                const response = await fetch('/api/demo/generate-historical', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        num_loans: parseInt(numLoans),
                        personal_ratio: parseFloat(personalRatio)
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    addLog(1, 'âœ… å†å²æ•°æ®ç”ŸæˆæˆåŠŸï¼', 'success');
                    if (data.stats) {
                        showResults(1, data.stats);
                    }
                    updateProgress(1, 'success');
                } else {
                    addLog(1, `âŒ é”™è¯¯: ${data.error || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                    updateProgress(1, 'error');
                }
            } catch (error) {
                addLog(1, `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
                updateProgress(1, 'error');
            }
        }

        async function runStep2() {
            updateProgress(2, 'running');
            addLog(2, 'å¼€å§‹æ•°æ®è´¨é‡æ£€æŸ¥...', 'info');
            
            try {
                const response = await fetch('/api/demo/check-quality', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    addLog(2, 'âœ… è´¨é‡æ£€æŸ¥å®Œæˆï¼', 'success');
                    showResults(2, {
                        'ç»¼åˆå¾—åˆ†': data.overall_score?.toFixed(4) || 'N/A',
                        'å®Œæ•´æ€§': data.completeness_score?.toFixed(4) || 'N/A',
                        'ä¸€è‡´æ€§': data.consistency_score?.toFixed(4) || 'N/A',
                        'æ—¶é—´ä¸€è‡´æ€§': data.temporal_score?.toFixed(4) || 'N/A',
                        'ä¸šåŠ¡è§„åˆ™': data.rule_score?.toFixed(4) || 'N/A'
                    });
                    updateProgress(2, 'success');
                } else {
                    addLog(2, `âŒ é”™è¯¯: ${data.error}`, 'error');
                    updateProgress(2, 'error');
                }
            } catch (error) {
                addLog(2, `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
                updateProgress(2, 'error');
            }
        }

        async function runStep3() {
            updateProgress(3, 'running');
            addLog(3, 'å¼€å§‹ç‰¹å¾å·¥ç¨‹...', 'info');
            
            try {
                const response = await fetch('/api/demo/engineer-features', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    addLog(3, 'âœ… ç‰¹å¾å·¥ç¨‹å®Œæˆï¼', 'success');
                    
                    // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
                    const stats = {
                        'åŸå§‹ç‰¹å¾æ•°': data.original_features || 'N/A',
                        'æ–°å¢ç‰¹å¾æ•°': data.new_features || 'N/A',
                        'æ€»ç‰¹å¾æ•°': data.total_features || 'N/A'
                    };
                    
                    // æ˜¾ç¤ºè¯¦ç»†ç‰¹å¾åˆ—è¡¨
                    if (data.new_feature_list && data.new_feature_list.length > 0) {
                        stats['æ–°å¢ç‰¹å¾åˆ—è¡¨'] = data.new_feature_list.length + ' ä¸ªç‰¹å¾';
                    }
                    
                    showResults(3, stats);
                    
                    // æ˜¾ç¤ºè¯¦ç»†ç‰¹å¾ä¿¡æ¯
                    if (data.new_feature_list) {
                        showFeatureDetails(3, data.new_feature_list, data.original_feature_list);
                    }
                    
                    updateProgress(3, 'success');
                } else {
                    addLog(3, `âŒ é”™è¯¯: ${data.error}`, 'error');
                    updateProgress(3, 'error');
                }
            } catch (error) {
                addLog(3, `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
                updateProgress(3, 'error');
            }
        }

        async function runStep4() {
            updateProgress(4, 'running');
            addLog(4, 'å¼€å§‹è§„åˆ™æå–...', 'info');
            
            try {
                const response = await fetch('/api/demo/extract-rules', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    addLog(4, 'âœ… è§„åˆ™æå–å®Œæˆï¼', 'success');
                    showResults(4, {
                        'æå–è§„åˆ™æ•°': data.num_rules || 'N/A',
                        'é‡åŒ–è§„åˆ™æ•°': data.num_quantified || 'N/A'
                    });
                    
                    // æ˜¾ç¤ºè¯¦ç»†è§„åˆ™ä¿¡æ¯
                    if (data.rules_detail && data.rules_detail.length > 0) {
                        showRulesDetails(4, data.rules_detail);
                    }
                    
                    updateProgress(4, 'success');
                } else {
                    addLog(4, `âŒ é”™è¯¯: ${data.error}`, 'error');
                    updateProgress(4, 'error');
                }
            } catch (error) {
                addLog(4, `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
                updateProgress(4, 'error');
            }
        }

        async function runStep5() {
            updateProgress(5, 'running');
            addLog(5, 'å¼€å§‹æ¨¡å‹è®­ç»ƒ...', 'info');
            
            try {
                const response = await fetch('/api/demo/train-models', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    addLog(5, 'âœ… æ¨¡å‹è®­ç»ƒå®Œæˆï¼', 'success');
                    showResults(5, {
                        'è¿çº¦é¢„æµ‹å‡†ç¡®ç‡': data.default_accuracy?.toFixed(4) || 'N/A',
                        'åˆ©æ¶¦é¢„æµ‹RÂ²': data.profit_r2?.toFixed(4) || 'N/A',
                        'è®­ç»ƒæ¨¡å‹æ•°': data.num_models || 'N/A'
                    });
                    updateProgress(5, 'success');
                } else {
                    addLog(5, `âŒ é”™è¯¯: ${data.error}`, 'error');
                    updateProgress(5, 'error');
                }
            } catch (error) {
                addLog(5, `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
                updateProgress(5, 'error');
            }
        }

        async function runStep6() {
            updateProgress(6, 'running');
            addLog(6, 'å¼€å§‹æ¨¡æ‹Ÿå®¡æ‰¹...', 'info');
            
            const numCustomers = document.getElementById('num-simulated-customers').value;
            
            try {
                const response = await fetch('/api/demo/simulate-approval', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        num_customers: parseInt(numCustomers)
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    addLog(6, 'âœ… æ¨¡æ‹Ÿå®¡æ‰¹å®Œæˆï¼', 'success');
                    
                    // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
                    const stats = data.stats || {};
                    showResults(6, {
                        'æ¨¡æ‹Ÿå®¢æˆ·æ•°': stats.num_customers || 'N/A',
                        'å®¡æ‰¹é€šè¿‡': stats.approved_count || 'N/A',
                        'å®¡æ‰¹æ‹’ç»': stats.rejected_count || 'N/A',
                        'å®é™…è¿çº¦': stats.defaulted_count || 'N/A',
                        'è¿çº¦ç‡': stats.default_rate ? (stats.default_rate * 100).toFixed(2) + '%' : 'N/A',
                        'å¹³å‡åˆ©æ¶¦': 'Â¥' + (stats.avg_profit?.toFixed(2) || '0'),
                        'æ€»åˆ©æ¶¦': 'Â¥' + (stats.total_profit?.toFixed(2) || '0'),
                        'å¹³å‡è¿çº¦æ¦‚ç‡': stats.avg_default_prob ? (stats.avg_default_prob * 100).toFixed(2) + '%' : 'N/A'
                    });
                    
                    // æ˜¾ç¤ºè¯¦ç»†äº¤æ˜“æ•°æ®
                    if (data.transactions && data.transactions.length > 0) {
                        showTransactionDetails(6, data.transactions, data.total_transactions);
                    }
                    
                    updateProgress(6, 'success');
                } else {
                    addLog(6, `âŒ é”™è¯¯: ${data.error}`, 'error');
                    updateProgress(6, 'error');
                }
            } catch (error) {
                addLog(6, `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
                updateProgress(6, 'error');
            }
        }

        async function runStep7() {
            updateProgress(7, 'running');
            addLog(7, 'å¼€å§‹ç»“æœéªŒè¯...', 'info');
            
            try {
                const response = await fetch('/api/demo/validate-results', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    addLog(7, 'âœ… ç»“æœéªŒè¯å®Œæˆï¼', 'success');
                    showResults(7, {
                        'è¿çº¦ç‡éªŒè¯': data.default_rate_valid ? 'âœ… é€šè¿‡' : 'âŒ æœªé€šè¿‡',
                        'åˆ©æ¶¦åˆ†å¸ƒéªŒè¯': data.profit_valid ? 'âœ… é€šè¿‡' : 'âŒ æœªé€šè¿‡',
                        'å›æ”¶ç‡éªŒè¯': data.recovery_valid ? 'âœ… é€šè¿‡' : 'âŒ æœªé€šè¿‡'
                    });
                    updateProgress(7, 'success');
                } else {
                    addLog(7, `âŒ é”™è¯¯: ${data.error}`, 'error');
                    updateProgress(7, 'error');
                }
            } catch (error) {
                addLog(7, `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
                updateProgress(7, 'error');
            }
        }

        async function runAllSteps() {
            if (!confirm('ç¡®å®šè¦è¿è¡Œå®Œæ•´æµç¨‹å—ï¼Ÿè¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´ã€‚')) {
                return;
            }
            
            // é‡ç½®æ‰€æœ‰æ­¥éª¤
            for (let i = 1; i <= totalSteps; i++) {
                updateProgress(i, 'pending');
                document.getElementById(`step${i}-log`).innerHTML = '';
                document.getElementById(`step${i}-results`).style.display = 'none';
            }
            
            // ä¾æ¬¡æ‰§è¡Œ
            await runStep1();
            await new Promise(r => setTimeout(r, 500));
            await runStep2();
            await new Promise(r => setTimeout(r, 500));
            await runStep3();
            await new Promise(r => setTimeout(r, 500));
            await runStep4();
            await new Promise(r => setTimeout(r, 500));
            await runStep5();
            await new Promise(r => setTimeout(r, 500));
            await runStep6();
            await new Promise(r => setTimeout(r, 500));
            await runStep7();
            
            alert('âœ… å®Œæ•´æµç¨‹æ‰§è¡Œå®Œæˆï¼');
        }
        
        function showFeatureDetails(step, newFeatures, originalFeatures) {
            const resultsEl = document.getElementById(`step${step}-results`);
            if (!resultsEl) return;
            
            let html = resultsEl.innerHTML;
            html += '<h3 style="margin-top: 20px;">æ–°å¢ç‰¹å¾è¯¦æƒ…ï¼š</h3>';
            html += '<div style="max-height: 300px; overflow-y: auto; background: #f8f9fa; padding: 15px; border-radius: 6px; margin-top: 10px;">';
            
            // æŒ‰ç±»åˆ«åˆ†ç»„æ˜¾ç¤º
            const categories = {
                'è¡ç”Ÿç‰¹å¾': [],
                'æ—¶é—´ç‰¹å¾': [],
                'äº¤äº’ç‰¹å¾': [],
                'å…¶ä»–': []
            };
            
            newFeatures.forEach(feat => {
                if (feat.includes('ratio') || feat.includes('score') || feat.includes('category')) {
                    categories['è¡ç”Ÿç‰¹å¾'].push(feat);
                } else if (feat.includes('year') || feat.includes('month') || feat.includes('quarter') || feat.includes('day')) {
                    categories['æ—¶é—´ç‰¹å¾'].push(feat);
                } else if (feat.includes('interaction') || feat.includes('_x_')) {
                    categories['äº¤äº’ç‰¹å¾'].push(feat);
                } else {
                    categories['å…¶ä»–'].push(feat);
                }
            });
            
            for (const [category, features] of Object.entries(categories)) {
                if (features.length > 0) {
                    html += `<div style="margin-bottom: 15px;"><strong>${category} (${features.length}ä¸ª):</strong>`;
                    html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 5px; margin-top: 5px;">';
                    features.forEach(feat => {
                        html += `<span style="background: white; padding: 4px 8px; border-radius: 4px; font-size: 0.9em; border: 1px solid #ddd;">${feat}</span>`;
                    });
                    html += '</div></div>';
                }
            }
            
            html += '</div>';
            resultsEl.innerHTML = html;
        }
        
        function showRulesDetails(step, rulesDetail) {
            const resultsEl = document.getElementById(`step${step}-results`);
            if (!resultsEl) return;
            
            let html = resultsEl.innerHTML;
            html += '<h3 style="margin-top: 20px;">æå–çš„è§„åˆ™è¯¦æƒ…ï¼š</h3>';
            html += '<div style="max-height: 400px; overflow-y: auto; margin-top: 10px;">';
            
            rulesDetail.forEach((rule, index) => {
                html += `<div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 10px; border-left: 4px solid #667eea;">`;
                html += `<div style="font-weight: bold; color: #667eea; margin-bottom: 8px;">è§„åˆ™ ${rule.id}: ${rule.name || 'æœªå‘½åè§„åˆ™'}</div>`;
                html += `<div style="margin-bottom: 5px;"><strong>ç±»å‹:</strong> ${rule.type || 'N/A'}</div>`;
                html += `<div style="margin-bottom: 5px;"><strong>å®¢æˆ·ç±»å‹:</strong> ${rule.customer_type || 'both'}</div>`;
                html += `<div style="margin-bottom: 5px;"><strong>æè¿°:</strong> ${rule.description || 'æ— æè¿°'}</div>`;
                html += `<div style="margin-bottom: 5px;"><strong>ç½®ä¿¡åº¦:</strong> ${(rule.confidence * 100).toFixed(2)}% | <strong>æ”¯æŒåº¦:</strong> ${(rule.support * 100).toFixed(2)}%</div>`;
                
                if (rule.conditions && rule.conditions.length > 0) {
                    html += `<div style="margin-top: 8px;"><strong>æ¡ä»¶:</strong>`;
                    html += '<ul style="margin: 5px 0; padding-left: 20px;">';
                    rule.conditions.forEach(cond => {
                        html += `<li>${cond.field || 'N/A'} ${cond.operator || 'N/A'} ${cond.value || 'N/A'}</li>`;
                    });
                    html += '</ul></div>';
                }
                
                html += `</div>`;
            });
            
            html += '</div>';
            resultsEl.innerHTML = html;
        }
        
        function showTransactionDetails(step, transactions, totalCount) {
            const resultsEl = document.getElementById(`step${step}-results`);
            if (!resultsEl) return;
            
            let html = resultsEl.innerHTML;
            html += `<h3 style="margin-top: 20px;">è¯¦ç»†äº¤æ˜“æ•°æ® (æ˜¾ç¤º ${transactions.length} / ${totalCount} æ¡):</h3>`;
            html += '<div style="max-height: 500px; overflow-y: auto; margin-top: 10px;">';
            html += '<table style="width: 100%; border-collapse: collapse; background: white; border-radius: 6px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">';
            
            // è¡¨å¤´
            html += '<thead style="background: #667eea; color: white; position: sticky; top: 0; z-index: 10;">';
            html += '<tr>';
            html += '<th style="padding: 10px; text-align: left; border: 1px solid #ddd; font-size: 0.9em;">ID</th>';
            html += '<th style="padding: 10px; text-align: left; border: 1px solid #ddd; font-size: 0.9em;">å®¢æˆ·ID</th>';
            html += '<th style="padding: 10px; text-align: left; border: 1px solid #ddd; font-size: 0.9em;">å®¢æˆ·ç±»å‹</th>';
            html += '<th style="padding: 10px; text-align: right; border: 1px solid #ddd; font-size: 0.9em;">è´·æ¬¾é‡‘é¢</th>';
            html += '<th style="padding: 10px; text-align: center; border: 1px solid #ddd; font-size: 0.9em;">å†³ç­–</th>';
            html += '<th style="padding: 10px; text-align: right; border: 1px solid #ddd; font-size: 0.9em;">è¿çº¦æ¦‚ç‡</th>';
            html += '<th style="padding: 10px; text-align: right; border: 1px solid #ddd; font-size: 0.9em;">é¢„æœŸåˆ©æ¶¦</th>';
            html += '<th style="padding: 10px; text-align: center; border: 1px solid #ddd; font-size: 0.9em;">æ˜¯å¦è¿çº¦</th>';
            html += '<th style="padding: 10px; text-align: right; border: 1px solid #ddd; font-size: 0.9em;">å®é™…åˆ©æ¶¦</th>';
            html += '<th style="padding: 10px; text-align: right; border: 1px solid #ddd; font-size: 0.9em;">å›æ”¶ç‡</th>';
            html += '</tr>';
            html += '</thead>';
            
            // è¡¨ä½“
            html += '<tbody>';
            transactions.forEach((tx, index) => {
                const rowClass = index % 2 === 0 ? 'background: #f8f9fa;' : 'background: white;';
                const decisionColor = tx.decision === 'approve' ? '#28a745' : tx.decision === 'reject' ? '#dc3545' : '#ffc107';
                const defaultColor = tx.actual_defaulted ? '#dc3545' : '#28a745';
                const profitColor = tx.actual_profit >= 0 ? '#28a745' : '#dc3545';
                
                html += `<tr style="${rowClass}">`;
                html += `<td style="padding: 8px; border: 1px solid #ddd; font-size: 0.85em;">${tx.id}</td>`;
                html += `<td style="padding: 8px; border: 1px solid #ddd; font-family: monospace; font-size: 0.85em;">${tx.customer_id || 'N/A'}</td>`;
                html += `<td style="padding: 8px; border: 1px solid #ddd; font-size: 0.85em;">${tx.customer_type === 'personal' ? 'å¯¹ç§' : tx.customer_type === 'corporate' ? 'å¯¹å…¬' : tx.customer_type || 'N/A'}</td>`;
                html += `<td style="padding: 8px; border: 1px solid #ddd; text-align: right; font-size: 0.85em;">Â¥${tx.loan_amount.toLocaleString('zh-CN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>`;
                html += `<td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-size: 0.85em;"><span style="color: ${decisionColor}; font-weight: bold;">${tx.decision === 'approve' ? 'é€šè¿‡' : tx.decision === 'reject' ? 'æ‹’ç»' : 'å®¡æ ¸'}</span></td>`;
                html += `<td style="padding: 8px; border: 1px solid #ddd; text-align: right; font-size: 0.85em;">${(tx.default_probability * 100).toFixed(2)}%</td>`;
                html += `<td style="padding: 8px; border: 1px solid #ddd; text-align: right; font-size: 0.85em;">Â¥${tx.expected_profit.toLocaleString('zh-CN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>`;
                html += `<td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-size: 0.85em;"><span style="color: ${defaultColor}; font-weight: bold;">${tx.actual_defaulted ? 'æ˜¯' : 'å¦'}</span></td>`;
                html += `<td style="padding: 8px; border: 1px solid #ddd; text-align: right; color: ${profitColor}; font-weight: bold; font-size: 0.85em;">Â¥${tx.actual_profit.toLocaleString('zh-CN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>`;
                html += `<td style="padding: 8px; border: 1px solid #ddd; text-align: right; font-size: 0.85em;">${(tx.recovery_rate * 100).toFixed(2)}%</td>`;
                html += '</tr>';
            });
            html += '</tbody>';
            html += '</table>';
            html += '</div>';
            
            // æ·»åŠ æç¤º
            html += '<div style="margin-top: 10px; padding: 10px; background: #e7f3ff; border-radius: 6px; font-size: 0.9em; color: #0066cc;">';
            html += 'ğŸ’¡ æç¤ºï¼šè¡¨æ ¼æ”¯æŒæ»šåŠ¨æŸ¥çœ‹ï¼Œå¯ä»¥æŸ¥çœ‹æ¯æ¡äº¤æ˜“çš„è¯¦ç»†ä¿¡æ¯';
            html += '</div>';
            
            resultsEl.innerHTML = html;
        }
    </script>
</body>
</html>

