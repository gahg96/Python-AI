<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gamium Finance AI - é‡‘èå†³ç­–æ™ºèƒ½å¹³å°</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* ä¸»é¢˜å˜é‡å®šä¹‰ */
        :root {
            /* æ·±è‰²ä¸»é¢˜ï¼ˆé»˜è®¤ï¼‰ */
            --bg-primary: #0a0e17;
            --bg-secondary: #131a2b;
            --bg-card: #1a2332;
            --bg-hover: #243044;
            --accent-primary: #00d4aa;
            --accent-secondary: #7c3aed;
            --accent-warning: #f59e0b;
            --accent-danger: #ef4444;
            --accent-blue: #3b82f6;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border-color: #2d3a4f;
            --gradient-primary: linear-gradient(135deg, #00d4aa 0%, #7c3aed 100%);
            --gradient-card: linear-gradient(180deg, rgba(26, 35, 50, 0.9) 0%, rgba(19, 26, 43, 0.95) 100%);
            --shadow-glow: 0 0 40px rgba(0, 212, 170, 0.15);
        }
        
        /* ä¸­æ€§ä¸»é¢˜ */
        [data-theme="neutral"] {
            --bg-primary: #1e293b;
            --bg-secondary: #334155;
            --bg-card: #475569;
            --bg-hover: #64748b;
            --accent-primary: #06b6d4;
            --accent-secondary: #8b5cf6;
            --accent-warning: #f59e0b;
            --accent-danger: #ef4444;
            --accent-blue: #3b82f6;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            --border-color: #64748b;
            --gradient-primary: linear-gradient(135deg, #06b6d4 0%, #8b5cf6 100%);
            --gradient-card: linear-gradient(180deg, rgba(71, 85, 105, 0.95) 0%, rgba(51, 65, 85, 0.98) 100%);
            --shadow-glow: 0 0 40px rgba(6, 182, 212, 0.2);
        }
        
        /* æ˜äº®ä¸»é¢˜ */
        [data-theme="bright"] {
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-card: #f1f5f9;
            --bg-hover: #e2e8f0;
            --accent-primary: #0ea5e9;
            --accent-secondary: #6366f1;
            --accent-warning: #f59e0b;
            --accent-danger: #ef4444;
            --accent-blue: #3b82f6;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-muted: #64748b;
            --border-color: #cbd5e1;
            --gradient-primary: linear-gradient(135deg, #0ea5e9 0%, #6366f1 100%);
            --gradient-card: linear-gradient(180deg, rgba(241, 245, 249, 0.95) 0%, rgba(248, 250, 252, 0.98) 100%);
            --shadow-glow: 0 0 40px rgba(14, 165, 233, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans SC', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* èƒŒæ™¯æ•ˆæœ */
        .bg-pattern {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(0, 212, 170, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(124, 58, 237, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(59, 130, 246, 0.05) 0%, transparent 40%);
            pointer-events: none;
            z-index: 0;
        }

        /* å¯¼èˆªæ  */
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 64px;
            background: rgba(10, 14, 23, 0.85);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 24px;
            z-index: 1000;
            overflow: visible;
            flex-wrap: nowrap;
        }
        
        [data-theme="neutral"] .navbar {
            background: rgba(30, 41, 59, 0.85);
        }
        
        [data-theme="bright"] .navbar {
            background: rgba(255, 255, 255, 0.85);
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-icon {
            font-size: 28px;
        }

        .nav-tabs {
            display: flex;
            gap: 8px;
            margin-left: 48px;
            flex-shrink: 1;
            min-width: 0;
        }

        .nav-tab {
            padding: 10px 20px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .nav-tab:hover {
            color: var(--text-primary);
            background: var(--bg-hover);
        }

        .nav-tab.active {
            color: var(--accent-primary);
            background: rgba(0, 212, 170, 0.1);
        }
        
        /* ä¸»é¢˜åˆ‡æ¢æŒ‰é’® */
        .theme-switcher {
            margin-left: auto !important;
            display: flex !important;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--bg-card) !important;
            border: 2px solid var(--accent-primary) !important;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            z-index: 1001;
            white-space: nowrap;
            visibility: visible !important;
            opacity: 1 !important;
            min-width: 100px;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(0, 212, 170, 0.3) !important;
        }
        
        .theme-switcher::before {
            content: 'ğŸ¨';
            margin-right: 4px;
        }
        
        .theme-switcher:hover {
            background: var(--bg-hover);
            border-color: var(--accent-primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 212, 170, 0.2);
        }
        
        .theme-switcher-icon {
            font-size: 20px;
            transition: transform 0.3s ease;
        }
        
        .theme-switcher:hover .theme-switcher-icon {
            transform: rotate(180deg);
        }
        
        .theme-switcher-label {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .theme-menu {
            position: absolute;
            top: 72px;
            right: 24px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 8px;
            min-width: 160px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            display: none;
            z-index: 1001;
            animation: slideDown 0.3s ease;
        }
        
        .theme-menu.show {
            display: block;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .theme-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-primary);
        }
        
        .theme-option:hover {
            background: var(--bg-hover);
        }
        
        .theme-option.active {
            background: rgba(0, 212, 170, 0.1);
            color: var(--accent-primary);
        }
        
        .theme-option-icon {
            font-size: 18px;
            width: 24px;
            text-align: center;
        }
        
        .theme-option-name {
            flex: 1;
            font-size: 14px;
            font-weight: 500;
        }
        
        .theme-option-check {
            font-size: 16px;
            color: var(--accent-primary);
        }

        /* ä¸»å†…å®¹åŒº */
        .main-content {
            position: relative;
            margin-top: 64px;
            padding: 24px;
            z-index: 1;
        }

        .page {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* AIåŠ¨ç”»æ•ˆæœ */
        @keyframes aiPulse {
            0%, 100% { 
                opacity: 1; 
                transform: scale(1);
                box-shadow: 0 0 20px rgba(0, 212, 170, 0.3);
            }
            50% { 
                opacity: 0.8; 
                transform: scale(1.05);
                box-shadow: 0 0 40px rgba(0, 212, 170, 0.6);
            }
        }
        
        @keyframes aiGlow {
            0%, 100% { 
                box-shadow: 0 0 10px rgba(0, 212, 170, 0.3),
                           0 0 20px rgba(124, 58, 237, 0.2);
            }
            50% { 
                box-shadow: 0 0 20px rgba(0, 212, 170, 0.6),
                           0 0 40px rgba(124, 58, 237, 0.4);
            }
        }
        
        @keyframes aiThinking {
            0% { transform: rotate(0deg) scale(1); }
            25% { transform: rotate(90deg) scale(1.1); }
            50% { transform: rotate(180deg) scale(1); }
            75% { transform: rotate(270deg) scale(1.1); }
            100% { transform: rotate(360deg) scale(1); }
        }
        
        @keyframes aiScan {
            0% { 
                background-position: -100% 0;
                opacity: 0.3;
            }
            50% {
                opacity: 0.6;
            }
            100% { 
                background-position: 200% 0;
                opacity: 0.3;
            }
        }
        
        /* AIæ ‡è¯† */
        .ai-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            background: linear-gradient(135deg, rgba(0, 212, 170, 0.2), rgba(124, 58, 237, 0.2));
            border: 1px solid rgba(0, 212, 170, 0.3);
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            color: var(--accent-primary);
            animation: aiPulse 2s ease-in-out infinite;
        }
        
        .ai-badge::before {
            content: 'ğŸ¤–';
            font-size: 14px;
            animation: aiThinking 3s linear infinite;
        }
        
        /* AIæ€è€ƒè¿‡ç¨‹ */
        .ai-thinking {
            position: relative;
            padding: 16px;
            background: rgba(0, 212, 170, 0.05);
            border-left: 3px solid var(--accent-primary);
            border-radius: 8px;
            margin: 12px 0;
        }
        
        .ai-thinking::before {
            content: 'ğŸ¤– AIæ­£åœ¨åˆ†æ...';
            display: block;
            font-size: 12px;
            color: var(--accent-primary);
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .ai-thinking::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(0, 212, 170, 0.1) 50%, 
                transparent 100%);
            background-size: 200% 100%;
            animation: aiScan 2s linear infinite;
            pointer-events: none;
        }
        
        /* AIç½®ä¿¡åº¦æŒ‡ç¤ºå™¨ */
        .ai-confidence {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: rgba(0, 212, 170, 0.1);
            border-radius: 20px;
            font-size: 12px;
        }
        
        .ai-confidence-bar {
            width: 60px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
            position: relative;
        }
        
        .ai-confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 2px;
            transition: width 0.5s ease;
            animation: aiGlow 2s ease-in-out infinite;
        }
        
        /* AIå»ºè®®å¡ç‰‡ */
        .ai-suggestion {
            padding: 16px;
            background: linear-gradient(135deg, rgba(0, 212, 170, 0.1), rgba(124, 58, 237, 0.1));
            border: 1px solid rgba(0, 212, 170, 0.3);
            border-radius: 12px;
            margin: 12px 0;
            position: relative;
            overflow: hidden;
        }
        
        .ai-suggestion::before {
            content: 'ğŸ’¡ AIå»ºè®®';
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: var(--accent-primary);
            margin-bottom: 8px;
        }
        
        .ai-suggestion::after {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(0, 212, 170, 0.1) 0%, transparent 70%);
            animation: aiPulse 3s ease-in-out infinite;
        }
        
        /* AIåˆ†ææ­¥éª¤ */
        .ai-steps {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin: 16px 0;
        }
        
        .ai-step {
            display: flex;
            align-items: start;
            gap: 12px;
            padding: 12px;
            background: rgba(0, 212, 170, 0.05);
            border-left: 3px solid var(--accent-primary);
            border-radius: 8px;
            opacity: 0;
            animation: fadeIn 0.5s ease forwards;
        }
        
        .ai-step-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--accent-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            flex-shrink: 0;
            animation: aiPulse 2s ease-in-out infinite;
        }
        
        .ai-step-content {
            flex: 1;
        }
        
        .ai-step-title {
            font-weight: 600;
            font-size: 13px;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        
        .ai-step-desc {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* å¡ç‰‡ */
        .card {
            background: var(--gradient-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-glow);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-icon {
            font-size: 24px;
        }

        /* ç½‘æ ¼å¸ƒå±€ */
        .grid {
            display: grid;
            gap: 20px;
        }

        .grid-2 {
            grid-template-columns: repeat(2, 1fr);
        }

        .grid-3 {
            grid-template-columns: repeat(3, 1fr);
        }

        .grid-4 {
            grid-template-columns: repeat(4, 1fr);
        }
        
        /* å¿«é€Ÿå¼€å§‹å¡ç‰‡æ ·å¼ */
        .quick-start-card {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .quick-start-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-primary);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }
        
        .quick-start-card:hover {
            transform: translateY(-4px);
            border-color: var(--accent-primary);
            box-shadow: 0 8px 24px rgba(0, 212, 170, 0.2);
        }
        
        .quick-start-card:hover::before {
            transform: scaleX(1);
        }
        
        .quick-start-icon {
            transition: transform 0.3s ease;
        }
        
        .quick-start-card:hover .quick-start-icon {
            transform: scale(1.1) rotate(5deg);
        }
        
        .quick-start-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        
        .quick-start-desc {
            font-size: 13px;
            color: var(--text-muted);
            line-height: 1.5;
        }

        @media (max-width: 1200px) {
            .grid-4 { grid-template-columns: repeat(2, 1fr); }
            .grid-3 { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 768px) {
            .grid-4, .grid-3, .grid-2 { grid-template-columns: 1fr; }
            .nav-tabs { display: none; }
        }

        /* ç»Ÿè®¡å¡ç‰‡ */
        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            border-color: var(--accent-primary);
            box-shadow: 0 0 20px rgba(0, 212, 170, 0.1);
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }

        .stat-value.positive { color: var(--accent-primary); }
        .stat-value.negative { color: var(--accent-danger); }
        .stat-value.warning { color: var(--accent-warning); }

        .stat-change {
            font-size: 12px;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* æŒ‰é’® */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 20px rgba(0, 212, 170, 0.3);
        }

        .btn-secondary {
            background: var(--bg-hover);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--bg-card);
            border-color: var(--accent-primary);
        }
        
        /* å¼¹çª—æ ·å¼ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            width: 90%;
            max-width: 900px;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-secondary);
        }
        
        .modal-header h3 {
            margin: 0;
            color: var(--accent-primary);
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        
        .modal-close:hover {
            color: var(--accent-danger);
        }
        
        .modal-body {
            padding: 24px;
            overflow-y: auto;
            max-height: calc(85vh - 80px);
        }
        
        /* ä¸‹é’»æ ‡ç­¾æŒ‰é’®æ ·å¼ */
        .drilldown-tab-btn {
            padding: 8px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }
        
        .drilldown-tab-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
        
        .drilldown-tab-btn.active {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }
        
        .detail-section {
            margin-bottom: 24px;
        }
        
        .detail-section-title {
            font-size: 14px;
            color: var(--accent-primary);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
        }
        
        @media (max-width: 1400px) {
            .detail-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        @media (max-width: 1000px) {
            .detail-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 600px) {
            .detail-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .detail-item {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 12px;
        }
        
        .detail-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .detail-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-top: 4px;
        }
        
        .detail-value.positive { color: var(--accent-success); }
        .detail-value.warning { color: var(--accent-warning); }
        .detail-value.negative { color: var(--accent-danger); }
        
        .risk-meter {
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }
        
        .risk-meter-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        
        .analysis-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
        }
        
        .analysis-title {
            font-size: 13px;
            color: var(--accent-primary);
            margin-bottom: 12px;
        }
        
        .factor-bar {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .factor-name {
            width: 100px;
            font-size: 12px;
            color: var(--text-muted);
        }
        
        .factor-bar-bg {
            flex: 1;
            height: 8px;
            background: var(--bg-card);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .factor-bar-fill {
            height: 100%;
            border-radius: 4px;
        }
        
        .factor-value {
            width: 50px;
            text-align: right;
            font-size: 12px;
            font-weight: 600;
        }
        
        /* æ­¥éª¤è¯¦æƒ…æ ·å¼ */
        .step-link {
            font-size: 12px;
            color: var(--accent-primary);
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        
        .timeline-item:hover .step-link {
            opacity: 1;
        }
        
        .step-detail {
            display: none;
            margin-top: 12px;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
            font-size: 13px;
        }
        
        .step-detail.show {
            display: block;
        }
        
        .action-item {
            display: flex;
            align-items: flex-start;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .action-item:last-child {
            border-bottom: none;
        }
        
        .action-icon {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 12px;
            background: rgba(59, 130, 246, 0.2);
            color: var(--accent-primary);
        }
        
        .action-content {
            flex: 1;
        }
        
        .action-name {
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .action-desc {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 2px;
        }
        
        .action-time {
            font-size: 11px;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }
        
        /* å®¡è®¡æ—¥å¿—æ ·å¼ */
        .audit-entry {
            display: flex;
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            font-size: 13px;
        }
        
        .audit-entry:hover {
            background: var(--bg-secondary);
        }
        
        .audit-time {
            width: 100px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            color: var(--text-muted);
        }
        
        .audit-action {
            width: 150px;
            font-weight: 500;
            color: var(--accent-primary);
        }
        
        .audit-detail {
            flex: 1;
            color: var(--text-secondary);
        }
        
        .data-sample-table {
            width: 100%;
            font-size: 12px;
            border-collapse: collapse;
            margin-top: 8px;
        }
        
        .data-sample-table th,
        .data-sample-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        .data-sample-table th {
            color: var(--accent-primary);
            font-weight: 500;
        }
        
        .feature-chip {
            display: inline-block;
            padding: 2px 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            margin: 2px;
            font-size: 11px;
            color: var(--text-secondary);
        }
        
        .rule-card {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
        }
        
        .rule-name {
            font-weight: 500;
            color: var(--accent-primary);
            margin-bottom: 8px;
        }
        
        .rule-params {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .rule-param {
            font-size: 12px;
            padding: 4px 8px;
            background: var(--bg-card);
            border-radius: 4px;
        }
        
        .rule-param span {
            color: var(--text-muted);
        }
        
        /* æ•°æ®æµè§ˆå™¨æ ·å¼ */
        .data-source-item {
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .data-source-item:hover {
            background: var(--bg-secondary);
            border-color: var(--accent-primary);
        }
        
        .data-source-item.active {
            background: rgba(59, 130, 246, 0.1);
            border-color: var(--accent-primary);
        }
        
        .data-file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            margin: 4px 0;
            background: var(--bg-secondary);
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }
        
        .data-file-item:hover {
            background: rgba(59, 130, 246, 0.15);
        }
        
        .data-file-item.active {
            background: rgba(59, 130, 246, 0.2);
            color: var(--accent-primary);
        }
        
        .schema-table {
            width: 100%;
            font-size: 12px;
            border-collapse: collapse;
        }
        
        .schema-table th,
        .schema-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        .schema-table th {
            background: var(--bg-secondary);
            color: var(--accent-primary);
            font-weight: 500;
        }
        
        .dtype-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .dtype-int { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
        .dtype-float { background: rgba(16, 185, 129, 0.2); color: #34d399; }
        .dtype-object { background: rgba(245, 158, 11, 0.2); color: #fbbf24; }
        .dtype-bool { background: rgba(139, 92, 246, 0.2); color: #a78bfa; }
        .dtype-datetime { background: rgba(236, 72, 153, 0.2); color: #f472b6; }
        
        .data-grid {
            width: 100%;
            overflow-x: auto;
        }
        
        .data-grid table {
            width: 100%;
            min-width: 800px;
            font-size: 12px;
            border-collapse: collapse;
        }
        
        .data-grid th,
        .data-grid td {
            padding: 10px 8px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .data-grid th {
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-weight: 500;
            position: sticky;
            top: 0;
        }
        
        .data-grid tr:hover {
            background: rgba(59, 130, 246, 0.05);
        }
        
        .data-grid tr {
            cursor: pointer;
        }
        
        .record-field {
            display: flex;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .record-field:last-child {
            border-bottom: none;
        }
        
        .field-name {
            width: 180px;
            font-weight: 500;
            color: var(--accent-primary);
            flex-shrink: 0;
        }
        
        .field-value {
            flex: 1;
            word-break: break-all;
        }
        
        .field-meta {
            width: 100px;
            text-align: right;
            font-size: 11px;
            color: var(--text-muted);
        }
        
        .stat-bar {
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 4px;
        }
        
        .stat-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 4px;
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.2);
            color: var(--accent-danger);
            border: 1px solid var(--accent-danger);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* è¡¨å• */
        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(0, 212, 170, 0.1);
        }

        .form-range {
            width: 100%;
            margin-top: 8px;
        }

        /* è¡¨æ ¼ */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        tr:hover {
            background: var(--bg-hover);
        }

        /* è¿›åº¦æ¡ */
        .progress-bar {
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--gradient-primary);
            transition: width 0.5s ease;
        }

        /* æ ‡ç­¾ */
        .badge {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-success {
            background: rgba(0, 212, 170, 0.15);
            color: var(--accent-primary);
        }

        .badge-warning {
            background: rgba(245, 158, 11, 0.15);
            color: var(--accent-warning);
        }

        .badge-danger {
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-danger);
        }

        /* å›¾è¡¨å®¹å™¨ */
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 16px;
        }

        /* å®¢æˆ·ç”»åƒå¡ç‰‡ */
        .customer-profile {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .profile-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .profile-label {
            color: var(--text-muted);
            font-size: 13px;
        }

        .profile-value {
            font-weight: 500;
            font-family: 'JetBrains Mono', monospace;
        }

        /* é£é™©ä»ªè¡¨ç›˜ */
        .risk-meter {
            position: relative;
            width: 200px;
            height: 100px;
            margin: 20px auto;
        }

        /* æ¨¡æ‹Ÿæ§åˆ¶é¢æ¿ */
        .control-panel {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .control-group {
            flex: 1;
            min-width: 150px;
        }

        /* æ—¥å¿—é¢æ¿ */
        .log-panel {
            background: var(--bg-secondary);
            border-radius: 10px;
            padding: 16px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
        }

        .log-entry {
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-secondary);
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        /* æ—¶é—´çº¿ */
        .timeline {
            position: relative;
            padding-left: 30px;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 10px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--border-color);
        }

        .timeline-item {
            position: relative;
            padding: 16px 0;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -24px;
            top: 20px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--accent-primary);
        }

        .timeline-item.pending::before {
            background: var(--text-muted);
        }

        .timeline-item.active::before {
            box-shadow: 0 0 0 4px rgba(0, 212, 170, 0.3);
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ç»æµå‘¨æœŸæŒ‡ç¤ºå™¨ */
        .cycle-indicator {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }

        .cycle-phase {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            font-size: 13px;
            font-weight: 500;
            opacity: 0.5;
            transition: all 0.3s ease;
        }

        .cycle-phase.active {
            opacity: 1;
            transform: scale(1.05);
        }

        .cycle-boom { background: rgba(0, 212, 170, 0.2); color: var(--accent-primary); }
        .cycle-recession { background: rgba(245, 158, 11, 0.2); color: var(--accent-warning); }
        .cycle-depression { background: rgba(239, 68, 68, 0.2); color: var(--accent-danger); }
        .cycle-recovery { background: rgba(59, 130, 246, 0.2); color: var(--accent-blue); }

        /* æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }
    </style>
</head>
<body>
    <div class="bg-pattern"></div>

    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="logo">
            <span class="logo-icon">ğŸ®</span>
            <span>Gamium Finance AI</span>
        </div>
        <a href="/" class="nav-tab" style="text-decoration: none; margin-right: 10px; background: linear-gradient(135deg, rgba(0, 245, 255, 0.2), rgba(168, 85, 247, 0.2)); border: 1px solid rgba(0, 245, 255, 0.5);">
            ğŸ“º å¤§å±ç›‘æ§
        </a>
        <a href="/story" class="nav-tab" style="text-decoration: none; margin-right: 10px; background: linear-gradient(135deg, rgba(255, 184, 0, 0.2), rgba(255, 107, 53, 0.2)); border: 1px solid rgba(255, 184, 0, 0.5);">
            ğŸ“– é¡¹ç›®ä»‹ç»
        </a>
        <a href="/banking-architecture" class="nav-tab" style="text-decoration: none; margin-right: 20px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.2)); border: 1px solid rgba(102, 126, 234, 0.5);">
            ğŸ¦ ç³»ç»Ÿæ¶æ„
        </a>
        <div class="nav-tabs">
            <button class="nav-tab active" data-page="dashboard">ğŸ“Š ä»ªè¡¨ç›˜</button>
            <button class="nav-tab" data-page="customer">ğŸ‘¤ å®¢æˆ·é¢„æµ‹</button>
            <button class="nav-tab" data-page="analysis">ğŸ“ˆ å‘¨æœŸåˆ†æ</button>
            <button class="nav-tab" data-page="simulation">ğŸ¦ é“¶è¡Œæ¨¡æ‹Ÿ</button>
            <button class="nav-tab" data-page="comparison">âš”ï¸ ç­–ç•¥å¯¹æ¯”</button>
            <button class="nav-tab" data-page="distillation">ğŸ”¬ æ•°æ®è’¸é¦</button>
            <button class="nav-tab" data-page="databrowser">ğŸ“‚ æ•°æ®æµè§ˆ</button>
            <button class="nav-tab" data-page="stresstest">âš ï¸ é£æ§å‹æµ‹</button>
            <button class="nav-tab" data-page="modeleval">ğŸ¤– æ¨¡å‹è¯„æµ‹</button>
            <button class="nav-tab" data-page="aihub">ğŸ¯ AI Hub</button>
        </div>
        
        <!-- ä¸»é¢˜åˆ‡æ¢å™¨ -->
        <div class="theme-switcher" onclick="toggleThemeMenu()">
            <span class="theme-switcher-icon">ğŸ¨</span>
            <span class="theme-switcher-label" id="current-theme-label">æ·±è‰²</span>
        </div>
        
        <!-- ä¸»é¢˜èœå• -->
        <div class="theme-menu" id="theme-menu">
            <div class="theme-option active" onclick="switchTheme('dark')" data-theme="dark">
                <span class="theme-option-icon">ğŸŒ™</span>
                <span class="theme-option-name">æ·±è‰²ä¸»é¢˜</span>
                <span class="theme-option-check">âœ“</span>
            </div>
            <div class="theme-option" onclick="switchTheme('neutral')" data-theme="neutral">
                <span class="theme-option-icon">ğŸŒ“</span>
                <span class="theme-option-name">ä¸­æ€§ä¸»é¢˜</span>
                <span class="theme-option-check" style="display: none;">âœ“</span>
            </div>
            <div class="theme-option" onclick="switchTheme('bright')" data-theme="bright">
                <span class="theme-option-icon">â˜€ï¸</span>
                <span class="theme-option-name">æ˜äº®ä¸»é¢˜</span>
                <span class="theme-option-check" style="display: none;">âœ“</span>
            </div>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹ -->
    <main class="main-content">
        <!-- ä»ªè¡¨ç›˜é¡µé¢ -->
        <div id="page-dashboard" class="page active">
            <h1 style="margin-bottom: 24px; font-size: 28px;">æ¬¢è¿ä½¿ç”¨ Gamium Finance AI</h1>
            
            <div class="grid grid-4">
                <div class="stat-card">
                    <div class="stat-label">æ¨¡å‹çŠ¶æ€</div>
                    <div class="stat-value positive">å·²å°±ç»ª</div>
                    <div class="stat-change">âœ… ä¸–ç•Œæ¨¡å‹å·²åŠ è½½</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">æ”¯æŒå®¢æˆ·ç±»å‹</div>
                    <div class="stat-value">18</div>
                    <div class="stat-change" style="font-size: 12px; line-height: 1.6;">
                        <strong style="color: var(--accent-primary);">ä¸ªäººå®¢æˆ·ï¼š</strong>å·¥è–ª/å°å¾®/è‡ªç”±èŒä¸š/å†œæˆ·/ä¸“ä¸šäººå£«/åˆ›ä¸šè€…/æŠ•èµ„è€…/é€€ä¼‘/å­¦ç”Ÿ<br>
                        <strong style="color: var(--accent-primary);">ä¼ä¸šå®¢æˆ·ï¼š</strong>å¾®å‹/å°å‹/ä¸­å‹/å¤§å‹/åˆåˆ›/ç§‘æŠ€åˆåˆ›/åˆ¶é€ /è´¸æ˜“/æœåŠ¡
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ç»æµå‘¨æœŸé˜¶æ®µ</div>
                    <div class="stat-value">4</div>
                    <div class="stat-change">ç¹è£/è¡°é€€/è§æ¡/å¤è‹</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ç­–ç•¥æ•°é‡</div>
                    <div class="stat-value">5</div>
                    <div class="stat-change">å« AlphaZero</div>
                </div>
            </div>

            <div style="margin-top: 24px;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title"><span class="card-icon">ğŸ¯</span> å¿«é€Ÿå¼€å§‹</div>
                        <div style="font-size: 12px; color: var(--text-muted);">ç‚¹å‡»ä¸‹æ–¹å¡ç‰‡å¿«é€Ÿè®¿é—®å„é¡¹åŠŸèƒ½</div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; padding: 20px;">
                        <div class="quick-start-card" onclick="switchPage('customer')" style="cursor: pointer;">
                            <div class="quick-start-icon" style="font-size: 48px; margin-bottom: 12px;">ğŸ‘¤</div>
                            <div class="quick-start-title">å®¢æˆ·é¢„æµ‹</div>
                            <div class="quick-start-desc">ç”Ÿæˆå®¢æˆ·å¹¶é¢„æµ‹è¿çº¦é£é™©</div>
                        </div>
                        <div class="quick-start-card" onclick="switchPage('analysis')" style="cursor: pointer;">
                            <div class="quick-start-icon" style="font-size: 48px; margin-bottom: 12px;">ğŸ“ˆ</div>
                            <div class="quick-start-title">å‘¨æœŸåˆ†æ</div>
                            <div class="quick-start-desc">åˆ†æç»æµå‘¨æœŸå¯¹è¿çº¦ç‡çš„å½±å“</div>
                        </div>
                        <div class="quick-start-card" onclick="switchPage('simulation')" style="cursor: pointer;">
                            <div class="quick-start-icon" style="font-size: 48px; margin-bottom: 12px;">ğŸ¦</div>
                            <div class="quick-start-title">é“¶è¡Œæ¨¡æ‹Ÿ</div>
                            <div class="quick-start-desc">æ¨¡æ‹Ÿé“¶è¡Œ10å¹´ç»è¥</div>
                        </div>
                        <div class="quick-start-card" onclick="switchPage('comparison')" style="cursor: pointer;">
                            <div class="quick-start-icon" style="font-size: 48px; margin-bottom: 12px;">âš”ï¸</div>
                            <div class="quick-start-title">ç­–ç•¥å¯¹æ¯”</div>
                            <div class="quick-start-desc">å¯¹æ¯”ä¸åŒç­–ç•¥è¡¨ç°</div>
                        </div>
                        <div class="quick-start-card" onclick="switchPage('distillation')" style="cursor: pointer;">
                            <div class="quick-start-icon" style="font-size: 48px; margin-bottom: 12px;">ğŸ”¬</div>
                            <div class="quick-start-title">æ•°æ®è’¸é¦</div>
                            <div class="quick-start-desc">ä»å†å²æ•°æ®ä¸­å­¦ä¹ å•†ä¸šç‰©ç†å®šå¾‹</div>
                        </div>
                        <div class="quick-start-card" onclick="switchPage('databrowser')" style="cursor: pointer;">
                            <div class="quick-start-icon" style="font-size: 48px; margin-bottom: 12px;">ğŸ“‚</div>
                            <div class="quick-start-title">æ•°æ®æµè§ˆ</div>
                            <div class="quick-start-desc">æµè§ˆå’Œç®¡ç†å†å²æ•°æ®</div>
                        </div>
                        <div class="quick-start-card" onclick="switchPage('stresstest')" style="cursor: pointer;">
                            <div class="quick-start-icon" style="font-size: 48px; margin-bottom: 12px;">ğŸ’«</div>
                            <div class="quick-start-title">é£æ§å‹æµ‹</div>
                            <div class="quick-start-desc">å‹åŠ›æµ‹è¯•ä¸é£é™©æ§åˆ¶è¯„ä¼°</div>
                        </div>
                        <div class="quick-start-card" onclick="openBankComparison()" style="cursor: pointer;">
                            <div class="quick-start-icon" style="font-size: 48px; margin-bottom: 12px;">ğŸ¦</div>
                            <div class="quick-start-title">å¤šé“¶è¡Œå¯¹æ¯”</div>
                            <div class="quick-start-desc">å¿«é€Ÿå¯¹æ¯”ä¸åŒé“¶è¡Œçš„å®¡æ‰¹ä¸æ”¶ç›Šè¡¨ç°</div>
                        </div>
                        <div class="quick-start-card" onclick="switchPage('modeleval')" style="cursor: pointer;">
                            <div class="quick-start-icon" style="font-size: 48px; margin-bottom: 12px;">ğŸ¤–</div>
                            <div class="quick-start-title">æ¨¡å‹è¯„æµ‹</div>
                            <div class="quick-start-desc">å¤šæ¨¡å‹å¯¹æŠ—è¯„æµ‹ä¸ABæµ‹è¯•</div>
                        </div>
                        <div class="quick-start-card" onclick="switchPage('aihub')" style="cursor: pointer;">
                            <div class="quick-start-icon" style="font-size: 48px; margin-bottom: 12px;">ğŸ¯</div>
                            <div class="quick-start-title">AI Hub</div>
                            <div class="quick-start-desc">æ¨¡å‹ç®¡ç†ã€æ•æ„Ÿè¯ã€æƒé™æ§åˆ¶</div>
                        </div>
                        <div class="quick-start-card" onclick="window.open('docs/ç³»ç»ŸåŠŸèƒ½è¯´æ˜.html', '_blank')" style="cursor: pointer; border: 2px dashed var(--accent-primary); background: linear-gradient(135deg, rgba(0, 212, 170, 0.1), rgba(102, 126, 234, 0.1));">
                            <div class="quick-start-icon" style="font-size: 48px; margin-bottom: 12px;">ğŸ“–</div>
                            <div class="quick-start-title">ä½¿ç”¨è¯´æ˜</div>
                            <div class="quick-start-desc">æŸ¥çœ‹å®Œæ•´ç³»ç»ŸåŠŸèƒ½è¯´æ˜æ–‡æ¡£</div>
                        </div>
                        <div class="quick-start-card" onclick="openArenaModal()" style="cursor: pointer;">
                            <div class="quick-start-icon" style="font-size: 48px; margin-bottom: 12px;">ğŸ§ </div>
                            <div class="quick-start-title">AI æ¼”æ­¦åœº</div>
                            <div class="quick-start-desc">å¤šæ¨¡å‹/ç­–ç•¥PKï¼Œå¯¹æ¯”å®¡æ‰¹ä¸é£é™©æ”¶ç›Š</div>
                        </div>
                        <div class="quick-start-card" onclick="window.location.href='/demo'" style="cursor: pointer;">
                            <div class="quick-start-icon" style="font-size: 48px; margin-bottom: 12px;">ğŸ¤–</div>
                            <div class="quick-start-title">Alpha Zeroæ¨¡æ‹Ÿè´·æ¬¾å®¡æ‰¹</div>
                            <div class="quick-start-desc">ç«¯åˆ°ç«¯è´·æ¬¾å®¡æ‰¹æ¼”ç¤ºï¼šä»å†å²æ•°æ®åˆ°è§„åˆ™æå–å†åˆ°æ¨¡æ‹Ÿå®¡æ‰¹</div>
                        </div>
                    </div>
                </div>
            </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title"><span class="card-icon">ğŸ“š</span> æ ¸å¿ƒèƒ½åŠ›</div>
                    </div>
                    <div class="timeline">
                        <div class="timeline-item">
                            <strong>æ•°æ®è’¸é¦</strong>
                            <p style="color: var(--text-muted); font-size: 13px; margin-top: 4px;">
                                ä»å†å²æ•°æ®ä¸­å­¦ä¹ "å•†ä¸šç‰©ç†å®šå¾‹"
                            </p>
                        </div>
                        <div class="timeline-item">
                            <strong>å®¢æˆ·é¢„æµ‹</strong>
                            <p style="color: var(--text-muted); font-size: 13px; margin-top: 4px;">
                                é¢„æµ‹è¿çº¦æ¦‚ç‡ã€LTVã€æµå¤±é£é™©ã€é£é™©è¯„åˆ†
                            </p>
                        </div>
                        <div class="timeline-item">
                            <strong>ç»æµå‘¨æœŸæ¨¡æ‹Ÿ</strong>
                            <p style="color: var(--text-muted); font-size: 13px; margin-top: 4px;">
                                ç¹è£â†’è¡°é€€â†’è§æ¡â†’å¤è‹å®Œæ•´å‘¨æœŸ
                            </p>
                        </div>
                        <div class="timeline-item">
                            <strong>AlphaZero å†³ç­–</strong>
                            <p style="color: var(--text-muted); font-size: 13px; margin-top: 4px;">
                                è‡ªæˆ‘åšå¼ˆå­¦ä¹ æœ€ä¼˜ç»è¥ç­–ç•¥
                            </p>
                        </div>
                        <div class="timeline-item">
                            <strong>é£æ§å‹åŠ›æµ‹è¯•</strong>
                            <p style="color: var(--text-muted); font-size: 13px; margin-top: 4px;">
                                é»‘å¤©é¹…äº‹ä»¶æ¨¡æ‹Ÿä¸éŸ§æ€§è¯„ä¼°
                            </p>
                        </div>
                        <div class="timeline-item">
                            <strong>å¤šæ¨¡å‹å¯¹æŠ—è¯„æµ‹</strong>
                            <p style="color: var(--text-muted); font-size: 13px; margin-top: 4px;">
                                12ç»´åº¦é‡åŒ–è¯„ä¼°ï¼Œæ”¯æŒ18+ä¸»æµæ¨¡å‹
                            </p>
                        </div>
                        <div class="timeline-item">
                            <strong>AI Hub ç®¡ç†</strong>
                            <p style="color: var(--text-muted); font-size: 13px; margin-top: 4px;">
                                APIå¯†é’¥ã€é™é¢ã€ç†”æ–­ã€æ•æ„Ÿè¯ã€æƒé™æ§åˆ¶
                            </p>
                        </div>
                        <div class="timeline-item">
                            <strong>ä¼ä¸šå®¢æˆ·æ”¯æŒ</strong>
                            <p style="color: var(--text-muted); font-size: 13px; margin-top: 4px;">
                                æ”¯æŒä¸ªäºº/ä¼ä¸šåŒæ¨¡å¼ï¼Œå¤šè¡Œä¸šè¯„ä¼°
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å®¢æˆ·é¢„æµ‹é¡µé¢ -->
        <div id="page-customer" class="page">
            <h1 style="margin-bottom: 24px;">ğŸ‘¤ å®¢æˆ·é¢„æµ‹</h1>
            
            <div class="grid grid-2">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title"><span class="card-icon">âš™ï¸</span> é…ç½®å‚æ•°</div>
                    </div>
                    
                    <h4 style="margin: 0 0 16px; color: var(--accent-primary); font-size: 14px;">ğŸ‘¤ å®¢æˆ·å±æ€§</h4>
                    <div class="grid grid-3">
                        <div class="form-group">
                            <label class="form-label">å®¢æˆ·ç±»å‹</label>
                            <select id="customer-type" class="form-select" onchange="toggleCustomerTypeFields()">
                                <option value="">éšæœº</option>
                                <optgroup label="ğŸ‘¤ ä¸ªäººå®¢æˆ·">
                                    <option value="salaried">å·¥è–ªé˜¶å±‚</option>
                                    <option value="small_business">å°å¾®ä¼ä¸šä¸»</option>
                                    <option value="freelancer">è‡ªç”±èŒä¸š</option>
                                    <option value="farmer">å†œæˆ·</option>
                                    <option value="professional">ä¸“ä¸šäººå£«</option>
                                    <option value="entrepreneur">åˆ›ä¸šè€…</option>
                                    <option value="investor">æŠ•èµ„è€…</option>
                                    <option value="retiree">é€€ä¼‘äººå‘˜</option>
                                    <option value="student">å­¦ç”Ÿ</option>
                                </optgroup>
                                <optgroup label="ğŸ¢ ä¼ä¸šå®¢æˆ·">
                                    <option value="micro_enterprise">å¾®å‹ä¼ä¸š (å¹´è¥æ”¶ < 1000ä¸‡)</option>
                                    <option value="small_enterprise">å°å‹ä¼ä¸š (å¹´è¥æ”¶ 1000-5000ä¸‡)</option>
                                    <option value="medium_enterprise">ä¸­å‹ä¼ä¸š (å¹´è¥æ”¶ 5000ä¸‡-2äº¿)</option>
                                    <option value="large_enterprise">å¤§å‹ä¼ä¸š (å¹´è¥æ”¶ > 2äº¿)</option>
                                    <option value="startup">åˆåˆ›ä¼ä¸š</option>
                                    <option value="tech_startup">ç§‘æŠ€åˆåˆ›</option>
                                    <option value="manufacturing">åˆ¶é€ ä¼ä¸š</option>
                                    <option value="trade_company">è´¸æ˜“å…¬å¸</option>
                                    <option value="service_company">æœåŠ¡ä¼ä¸š</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">é£é™©ç”»åƒ</label>
                            <select id="risk-profile" class="form-select">
                                <option value="low">ä½é£é™©</option>
                                <option value="medium" selected>ä¸­ç­‰é£é™©</option>
                                <option value="high">é«˜é£é™©</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">æ‰€å±è¡Œä¸š</label>
                            <select id="customer-industry" class="form-select">
                                <option value="">éšæœº</option>
                                <option value="manufacturing">åˆ¶é€ ä¸š</option>
                                <option value="service">æœåŠ¡ä¸š</option>
                                <option value="retail">é›¶å”®ä¸š</option>
                                <option value="catering">é¤é¥®ä¸š</option>
                                <option value="it">IT/äº’è”ç½‘</option>
                                <option value="construction">å»ºç­‘ä¸š</option>
                                <option value="agriculture">å†œä¸š</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="grid grid-3" style="margin-top: 12px;">
                        <div class="form-group">
                            <label class="form-label">åŸå¸‚ç­‰çº§</label>
                            <select id="customer-city" class="form-select">
                                <option value="">éšæœº</option>
                                <option value="tier_1">ä¸€çº¿åŸå¸‚</option>
                                <option value="tier_2">äºŒçº¿åŸå¸‚</option>
                                <option value="tier_3">ä¸‰çº¿åŸå¸‚</option>
                                <option value="tier_4">å››çº¿åŠä»¥ä¸‹</option>
                            </select>
                        </div>
                        <div class="form-group" id="age-field">
                            <label class="form-label">å¹´é¾„èŒƒå›´</label>
                            <select id="customer-age" class="form-select">
                                <option value="">éšæœº</option>
                                <option value="young">é’å¹´ (22-35)</option>
                                <option value="middle">ä¸­å¹´ (35-50)</option>
                                <option value="senior">ä¸­è€å¹´ (50+)</option>
                            </select>
                        </div>
                        <div class="form-group" id="years-field" style="display: none;">
                            <label class="form-label">æˆç«‹å¹´é™</label>
                            <select id="customer-years" class="form-select">
                                <option value="">éšæœº</option>
                                <option value="new">æ–°ä¼ä¸š (0-3å¹´)</option>
                                <option value="established">æˆç†Ÿä¼ä¸š (3-10å¹´)</option>
                                <option value="old">è€ä¼ä¸š (10å¹´ä»¥ä¸Š)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">å®¢æˆ·å…³ç³»</label>
                            <select id="customer-relation" class="form-select">
                                <option value="new">æ–°å®¢æˆ·</option>
                                <option value="normal" selected>æ™®é€šå®¢æˆ·</option>
                                <option value="vip">VIPå®¢æˆ·</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- ä¸ªäººå®¢æˆ·ä¸“ç”¨å­—æ®µ -->
                    <div id="personal-fields" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                        <h4 style="margin-bottom: 16px; color: var(--accent-primary); font-size: 14px;">ğŸ‘¤ ä¸ªäººå®¢æˆ·ä¿¡æ¯ï¼ˆå¯é€‰ï¼Œç•™ç©ºå°†è‡ªåŠ¨ç”Ÿæˆï¼‰</h4>
                        <div class="grid grid-3">
                            <div class="form-group">
                                <label class="form-label">æœˆæ”¶å…¥ (å…ƒ)</label>
                                <input type="number" id="personal-monthly-income" class="form-input" placeholder="ç•™ç©ºè‡ªåŠ¨ç”Ÿæˆ">
                            </div>
                            <div class="form-group">
                                <label class="form-label">æ”¶å…¥æ³¢åŠ¨æ€§ (%)</label>
                                <input type="number" id="personal-income-volatility" class="form-input" step="0.1" min="0" max="100" placeholder="ç•™ç©ºè‡ªåŠ¨ç”Ÿæˆ">
                            </div>
                            <div class="form-group">
                                <label class="form-label">æ€»èµ„äº§ (å…ƒ)</label>
                                <input type="number" id="personal-total-assets" class="form-input" placeholder="ç•™ç©ºè‡ªåŠ¨ç”Ÿæˆ">
                            </div>
                            <div class="form-group">
                                <label class="form-label">æ€»è´Ÿå€º (å…ƒ)</label>
                                <input type="number" id="personal-total-liabilities" class="form-input" placeholder="ç•™ç©ºè‡ªåŠ¨ç”Ÿæˆ">
                            </div>
                            <div class="form-group">
                                <label class="form-label">å­˜æ¬¾ä½™é¢ (å…ƒ)</label>
                                <input type="number" id="personal-deposit-balance" class="form-input" placeholder="ç•™ç©ºè‡ªåŠ¨ç”Ÿæˆ">
                            </div>
                            <div class="form-group">
                                <label class="form-label">å­˜æ¬¾ç¨³å®šæ€§ (%)</label>
                                <input type="number" id="personal-deposit-stability" class="form-input" step="0.1" min="0" max="100" placeholder="ç•™ç©ºè‡ªåŠ¨ç”Ÿæˆ">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ä»ä¸šå¹´é™ (å¹´)</label>
                                <input type="number" id="personal-years-in-business" class="form-input" step="0.1" placeholder="ç•™ç©ºè‡ªåŠ¨ç”Ÿæˆ">
                            </div>
                            <div class="form-group">
                                <label class="form-label">å†å²è´·æ¬¾æ¬¡æ•°</label>
                                <input type="number" id="personal-previous-loans" class="form-input" min="0" placeholder="ç•™ç©ºè‡ªåŠ¨ç”Ÿæˆ">
                            </div>
                            <div class="form-group">
                                <label class="form-label">å†å²æœ€å¤§é€¾æœŸ (å¤©)</label>
                                <input type="number" id="personal-max-dpd" class="form-input" min="0" placeholder="ç•™ç©ºè‡ªåŠ¨ç”Ÿæˆ">
                            </div>
                        </div>
                    </div>
                    
                    <h4 style="margin: 20px 0 16px; color: var(--accent-primary); font-size: 14px;">ğŸ’° è´·æ¬¾æ¡ä»¶</h4>
                    <div class="grid grid-3">
                        <div class="form-group">
                            <label class="form-label">è´·æ¬¾é‡‘é¢ (å…ƒ)</label>
                            <input type="number" id="loan-amount" class="form-input" value="100000">
                        </div>
                        <div class="form-group">
                            <label class="form-label">å¹´åˆ©ç‡</label>
                            <input type="number" id="loan-rate" class="form-input" value="0.08" step="0.01">
                        </div>
                        <div class="form-group">
                            <label class="form-label">æœŸé™ (æœˆ)</label>
                            <input type="number" id="loan-term" class="form-input" value="24">
                        </div>
                    </div>
                    <div class="grid grid-2" style="margin-top: 12px;">
                        <div class="form-group">
                            <label class="form-label">è´·æ¬¾ç”¨é€”</label>
                            <select id="loan-purpose" class="form-select">
                                <option value="consumption">æ¶ˆè´¹</option>
                                <option value="business" selected>ç»è¥å‘¨è½¬</option>
                                <option value="house">è´­æˆ¿</option>
                                <option value="car">è´­è½¦</option>
                                <option value="education">æ•™è‚²</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">æ‹…ä¿æ–¹å¼</label>
                            <select id="loan-guarantee" class="form-select">
                                <option value="credit" selected>ä¿¡ç”¨</option>
                                <option value="mortgage">æŠµæŠ¼</option>
                                <option value="guarantee">æ‹…ä¿</option>
                            </select>
                        </div>
                    </div>
                    
                    <h4 style="margin: 20px 0 16px; color: var(--accent-primary); font-size: 14px;">ğŸŒ å®è§‚ç¯å¢ƒ</h4>
                    <div class="grid grid-2">
                        <div class="form-group">
                            <label class="form-label">ç»æµå‘¨æœŸ</label>
                            <select id="market-scenario" class="form-select">
                                <option value="boom">ç¹è£æœŸ (GDP +6%)</option>
                                <option value="normal" selected>æ­£å¸¸æœŸ (GDP +3%)</option>
                                <option value="recession">è¡°é€€æœŸ (GDP +1%)</option>
                                <option value="depression">è§æ¡æœŸ (GDP -2%)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">è´§å¸æ”¿ç­–</label>
                            <select id="market-policy" class="form-select">
                                <option value="loose">å®½æ¾ (ä½åˆ©ç‡)</option>
                                <option value="normal" selected>ä¸­æ€§</option>
                                <option value="tight">ç´§ç¼© (é«˜åˆ©ç‡)</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- ä¼ä¸šå®¢æˆ·ä¸“ç”¨å­—æ®µï¼ˆé»˜è®¤éšè—ï¼‰ -->
                    <div id="enterprise-fields" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                        <h4 style="margin-bottom: 16px; color: var(--accent-primary); font-size: 14px;">ğŸ¢ ä¼ä¸šå®¢æˆ·ä¿¡æ¯ï¼ˆå¯é€‰ï¼Œç•™ç©ºå°†è‡ªåŠ¨ç”Ÿæˆï¼‰</h4>
                        <div class="grid grid-3">
                            <div class="form-group">
                                <label class="form-label">å¹´è¥ä¸šæ”¶å…¥ (å…ƒ)</label>
                                <input type="number" id="enterprise-revenue" class="form-input" placeholder="ç•™ç©ºè‡ªåŠ¨ç”Ÿæˆ">
                            </div>
                            <div class="form-group">
                                <label class="form-label">å‡€åˆ©æ¶¦ (å…ƒ)</label>
                                <input type="number" id="enterprise-net-profit" class="form-input" placeholder="ç•™ç©ºè‡ªåŠ¨ç”Ÿæˆ">
                            </div>
                            <div class="form-group">
                                <label class="form-label">å‡€åˆ©æ¶¦ç‡ (%)</label>
                                <input type="number" id="enterprise-profit-margin" class="form-input" step="0.1" placeholder="ç•™ç©ºè‡ªåŠ¨ç”Ÿæˆ">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ç»è¥ç°é‡‘æµ (å…ƒ)</label>
                                <input type="number" id="enterprise-cash-flow" class="form-input" placeholder="ç•™ç©ºè‡ªåŠ¨ç”Ÿæˆ">
                            </div>
                            <div class="form-group">
                                <label class="form-label">æµåŠ¨æ¯”ç‡</label>
                                <input type="number" id="enterprise-current-ratio" class="form-input" step="0.1" placeholder="ç•™ç©ºè‡ªåŠ¨ç”Ÿæˆ">
                            </div>
                            <div class="form-group">
                                <label class="form-label">é€ŸåŠ¨æ¯”ç‡</label>
                                <input type="number" id="enterprise-quick-ratio" class="form-input" step="0.1" placeholder="ç•™ç©ºè‡ªåŠ¨ç”Ÿæˆ">
                            </div>
                            <div class="form-group">
                                <label class="form-label">èµ„äº§è´Ÿå€ºç‡ (%)</label>
                                <input type="number" id="enterprise-debt-ratio" class="form-input" step="0.1" placeholder="ç•™ç©ºè‡ªåŠ¨ç”Ÿæˆ">
                            </div>
                            <div class="form-group">
                                <label class="form-label">è¥æ”¶å¢é•¿ç‡ (%)</label>
                                <input type="number" id="enterprise-revenue-growth" class="form-input" step="0.1" placeholder="ç•™ç©ºè‡ªåŠ¨ç”Ÿæˆ">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ç ”å‘è´¹ç”¨ç‡ (%)</label>
                                <input type="number" id="enterprise-rnd-ratio" class="form-input" step="0.1" placeholder="ç•™ç©ºè‡ªåŠ¨ç”Ÿæˆ">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ä¸“åˆ©æ€»æ•°</label>
                                <input type="number" id="enterprise-patents" class="form-input" placeholder="ç•™ç©ºè‡ªåŠ¨ç”Ÿæˆ">
                            </div>
                            <div class="form-group">
                                <label class="form-label">æ³•å¾‹çº çº·æ•°é‡</label>
                                <input type="number" id="enterprise-legal-disputes" class="form-input" min="0" placeholder="ç•™ç©ºè‡ªåŠ¨ç”Ÿæˆ">
                            </div>
                            <div class="form-group">
                                <label class="form-label">æˆç«‹å¹´é™ (å¹´)</label>
                                <input type="number" id="enterprise-years" class="form-input" step="0.1" placeholder="ç•™ç©ºè‡ªåŠ¨ç”Ÿæˆ">
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="generateAndPredict()" style="width: 100%; margin-top: 20px;">
                        ğŸ² ç”Ÿæˆå®¢æˆ·å¹¶é¢„æµ‹
                    </button>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title"><span class="card-icon">ğŸ“‹</span> é¢„æµ‹ç»“æœ</div>
                        <button class="btn btn-secondary" id="btn-customer-detail" onclick="showCustomerDetail()" style="display: none;">
                            ğŸ“„ æŸ¥çœ‹å®Œæ•´ç”»åƒ
                        </button>
                    </div>
                    <div id="prediction-result">
                        <div class="loading">
                            <p style="color: var(--text-muted);">ç‚¹å‡»"ç”Ÿæˆå®¢æˆ·å¹¶é¢„æµ‹"å¼€å§‹</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- å®¢æˆ·è¯¦æƒ…å¼¹çª— -->
        <div id="customer-detail-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>ğŸ“‹ å®¢æˆ·å®Œæ•´ç”»åƒ</h3>
                    <button class="modal-close" onclick="closeCustomerDetail()">Ã—</button>
                </div>
                <div class="modal-body" id="customer-detail-content">
                </div>
            </div>
        </div>
        
        <!-- å†å²è´·æ¬¾è¯¦æƒ…å¼¹çª— -->
        <div id="loan-history-modal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 1000px; max-height: 90vh;">
                <div class="modal-header">
                    <h3>ğŸ“Š å†å²è´·æ¬¾è¯¦æƒ…</h3>
                    <button class="modal-close" onclick="closeLoanHistory()">Ã—</button>
                </div>
                <div class="modal-body" id="loan-history-content" style="max-height: calc(90vh - 100px); overflow-y: auto;">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>åŠ è½½ä¸­...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- è¿çº¦æ¦‚ç‡è¯¦ç»†è®¡ç®—æ¨¡æ€æ¡† -->
        <div id="default-probability-modal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 1000px; max-height: 90vh;">
                <div class="modal-header">
                    <h3>ğŸ” è¿çº¦æ¦‚ç‡è¯¦ç»†è®¡ç®—è¿‡ç¨‹</h3>
                    <button class="modal-close" onclick="closeDefaultProbabilityDetail()">Ã—</button>
                </div>
                <div class="modal-body" id="default-probability-content" style="max-height: calc(90vh - 100px); overflow-y: auto;">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>è®¡ç®—ä¸­...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æµå¤±æ¦‚ç‡è¯¦ç»†è®¡ç®—æ¨¡æ€æ¡† -->
        <div id="churn-probability-modal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 1000px; max-height: 90vh;">
                <div class="modal-header">
                    <h3>ğŸ” æµå¤±æ¦‚ç‡è¯¦ç»†è®¡ç®—è¿‡ç¨‹</h3>
                    <button class="modal-close" onclick="closeChurnProbabilityDetail()">Ã—</button>
                </div>
                <div class="modal-body" id="churn-probability-content" style="max-height: calc(90vh - 100px); overflow-y: auto;">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>è®¡ç®—ä¸­...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- é£é™©è¯„åˆ†è¯¦ç»†è®¡ç®—æ¨¡æ€æ¡† -->
        <div id="risk-score-modal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 1000px; max-height: 90vh;">
                <div class="modal-header">
                    <h3>ğŸ“Š é£é™©è¯„åˆ†è¯¦ç»†è®¡ç®—è§„åˆ™</h3>
                    <button class="modal-close" onclick="closeRiskScoreDetail()">Ã—</button>
                </div>
                <div class="modal-body" id="risk-score-content" style="max-height: calc(90vh - 100px); overflow-y: auto;">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>è®¡ç®—ä¸­...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- LTVè¯´æ˜æ¨¡æ€æ¡† -->
        <div id="ltv-explanation-modal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 800px;">
                <div class="modal-header">
                    <h3>ğŸ’° LTV (ç”Ÿå‘½å‘¨æœŸä»·å€¼) è¯´æ˜</h3>
                    <button class="modal-close" onclick="closeLTVExplanation()">Ã—</button>
                </div>
                <div class="modal-body" style="max-height: 80vh; overflow-y: auto;">
                    <div style="padding: 20px;">
                        <h4 style="color: var(--accent-primary); margin-bottom: 15px;">ä»€ä¹ˆæ˜¯LTVï¼Ÿ</h4>
                        <p style="margin-bottom: 15px; line-height: 1.8; color: var(--text-primary);">
                            <strong style="color: var(--text-primary);">LTV (Lifetime Value)</strong> = <strong style="color: var(--text-primary);">å®¢æˆ·ç”Ÿå‘½å‘¨æœŸä»·å€¼</strong><br>
                            <span style="color: var(--text-primary);">LTVè¡¨ç¤ºé“¶è¡Œä»æŸä¸ªå®¢æˆ·èº«ä¸Šé¢„æœŸèƒ½è·å¾—çš„<strong>å‡€æ”¶ç›Š</strong>ï¼Œå³åœ¨æ•´ä¸ªå®¢æˆ·å…³ç³»å‘¨æœŸå†…ï¼Œé“¶è¡Œä»è¿™ä¸ªå®¢æˆ·èº«ä¸Šèµšåˆ°çš„é’±å‡å»å¯èƒ½æŸå¤±çš„é’±ã€‚</span>
                        </p>
                        
                        <div style="background: rgba(102, 126, 234, 0.1); padding: 15px; border-radius: 8px; margin: 15px 0; border: 1px solid rgba(102, 126, 234, 0.2);">
                            <h5 style="margin-bottom: 10px; color: var(--text-primary);">ğŸ“Š è®¡ç®—å…¬å¼ï¼š</h5>
                            <div style="font-family: 'Courier New', monospace; background: rgba(0, 0, 0, 0.3); color: #4facfe; padding: 15px; border-radius: 5px; margin: 10px 0; font-size: 14px; font-weight: bold;">
                                LTV = åˆ©æ¯æ”¶å…¥ - é¢„æœŸæŸå¤± - è¿è¥æˆæœ¬
                            </div>
                            <ul style="margin-left: 20px; margin-top: 10px; line-height: 1.8; color: var(--text-primary);">
                                <li><strong style="color: var(--text-primary);">åˆ©æ¯æ”¶å…¥</strong>ï¼šé“¶è¡Œä»å®¢æˆ·æ”¶å–çš„è´·æ¬¾åˆ©æ¯</li>
                                <li><strong style="color: var(--text-primary);">é¢„æœŸæŸå¤±</strong>ï¼šå®¢æˆ·è¿çº¦åå¯èƒ½æ— æ³•æ”¶å›çš„æœ¬é‡‘ï¼ˆ= è´·æ¬¾æœ¬é‡‘ Ã— è¿çº¦æ¦‚ç‡ Ã— 60%ï¼‰</li>
                                <li><strong style="color: var(--text-primary);">è¿è¥æˆæœ¬</strong>ï¼šå®¡æ‰¹ã€ç®¡ç†ã€å‚¬æ”¶ç­‰æˆæœ¬ï¼ˆé€šå¸¸ä¸ºè´·æ¬¾æœ¬é‡‘çš„2%ï¼‰</li>
                            </ul>
                        </div>
                        
                        <h4 style="color: var(--accent-primary); margin: 25px 0 15px;">å¦‚ä½•è§£è¯»LTVï¼Ÿ</h4>
                        <div class="grid grid-2" style="gap: 15px; margin: 15px 0;">
                            <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(5, 150, 105, 0.15)); padding: 15px; border-radius: 8px; border-left: 4px solid #10b981;">
                                <div style="font-weight: bold; color: #10b981; margin-bottom: 8px; font-size: 15px;">LTV > 0ï¼ˆæ­£å€¼ï¼‰</div>
                                <div style="font-size: 13px; color: var(--text-primary); line-height: 1.6;">
                                    è¿™ä¸ªå®¢æˆ·èƒ½ä¸ºé“¶è¡Œå¸¦æ¥åˆ©æ¶¦ï¼Œå€¼å¾—æ”¾è´·ã€‚æ•°å€¼è¶Šå¤§ï¼Œåˆ©æ¶¦è¶Šå¤šã€‚
                                </div>
                            </div>
                            <div style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(220, 38, 38, 0.15)); padding: 15px; border-radius: 8px; border-left: 4px solid #ef4444;">
                                <div style="font-weight: bold; color: #ef4444; margin-bottom: 8px; font-size: 15px;">LTV < 0ï¼ˆè´Ÿå€¼ï¼‰</div>
                                <div style="font-size: 13px; color: var(--text-primary); line-height: 1.6;">
                                    è¿™ä¸ªå®¢æˆ·å¯èƒ½è®©é“¶è¡ŒäºæŸï¼Œéœ€è¦è°¨æ…è€ƒè™‘ã€‚å¯èƒ½éœ€è¦æé«˜åˆ©ç‡æˆ–æ‹’ç»æ”¾è´·ã€‚
                                </div>
                            </div>
                        </div>
                        
                        <h4 style="color: var(--accent-primary); margin: 25px 0 15px;">å®é™…ç¤ºä¾‹</h4>
                        <div style="background: rgba(245, 158, 11, 0.15); padding: 15px; border-radius: 8px; border-left: 4px solid #f59e0b; margin: 15px 0;">
                            <strong style="color: var(--text-primary);">ç¤ºä¾‹ï¼šè´·æ¬¾100,000å…ƒï¼Œå¹´åˆ©ç‡6%ï¼ŒæœŸé™12ä¸ªæœˆï¼Œè¿çº¦æ¦‚ç‡10%</strong>
                            <div style="margin-top: 10px; font-size: 13px; line-height: 1.8; color: var(--text-primary);">
                                1. åˆ©æ¯æ”¶å…¥ = <strong style="color: #10b981;">3,320å…ƒ</strong><br>
                                2. é¢„æœŸæŸå¤± = 100,000 Ã— 10% Ã— 60% = <strong style="color: #ef4444;">6,000å…ƒ</strong><br>
                                3. è¿è¥æˆæœ¬ = 100,000 Ã— 2% = <strong style="color: #f59e0b;">2,000å…ƒ</strong><br>
                                <strong style="color: var(--text-primary);">LTV = 3,320 Ã— 90% - 6,000 - 2,000 = <span style="color: #ef4444;">-5,012å…ƒ</span></strong><br>
                                <span style="color: #ef4444; font-weight: bold;">ç»“æœï¼šè´Ÿå€¼ï¼Œè¡¨ç¤ºå¯èƒ½äºæŸ</span>
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border-color);">
                            <a href="/model-terms" target="_blank" style="color: var(--accent-primary); text-decoration: none; font-size: 13px;">
                                ğŸ“– æŸ¥çœ‹æ›´è¯¦ç»†çš„LTVè¯´æ˜æ–‡æ¡£ â†’
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å‘¨æœŸåˆ†æé¡µé¢ -->
        <div id="page-analysis" class="page">
            <h1 style="margin-bottom: 24px;">ğŸ“ˆ ç»æµå‘¨æœŸå½±å“åˆ†æ</h1>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><span class="card-icon">âš™ï¸</span> åˆ†æé…ç½®</div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-secondary" id="btn-cycle-trace" onclick="showCycleTrace()" style="display: none;">
                            ğŸ“‹ åˆ†ææ—¥å¿—
                        </button>
                        <button class="btn btn-primary" onclick="runCycleAnalysis()">
                            ğŸ” è¿è¡Œåˆ†æ
                        </button>
                    </div>
                </div>
                <div class="form-group" style="max-width: 300px;">
                    <label class="form-label">æ ·æœ¬å®¢æˆ·æ•°é‡</label>
                    <input type="number" id="analysis-count" class="form-input" value="100" min="50" max="200">
                </div>
                <div id="cycle-run-id" style="font-size: 12px; color: var(--text-muted); margin-top: 8px;"></div>
            </div>
            
            <div id="analysis-result" style="display: none;">
                <!-- æ‘˜è¦ç»Ÿè®¡ -->
                <div class="grid grid-4" id="cycle-stats"></div>
                
                <!-- é¢„è­¦ä¿¡å· -->
                <div class="card" style="margin-top: 20px; display: none;" id="warnings-card">
                    <div class="card-header">
                        <div class="card-title">âš ï¸ é£é™©é¢„è­¦ä¿¡å·</div>
                    </div>
                    <div id="warnings-content"></div>
                </div>
                
                <!-- ä¸»è¦å›¾è¡¨ -->
                <div class="grid grid-2" style="margin-top: 20px;">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">ğŸ“Š å„å‘¨æœŸè¿çº¦ç‡å¯¹æ¯”</div>
                        </div>
                        <div class="chart-container">
                            <canvas id="cycle-chart"></canvas>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">ğŸ‘¥ è§æ¡æœŸå„å®¢æˆ·ç±»å‹é£é™©</div>
                        </div>
                        <div class="chart-container">
                            <canvas id="type-chart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- ç»æµæŒ‡æ ‡è¯¦ç»†å±•ç¤º -->
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <div class="card-title">ğŸ“ˆ å®è§‚ç»æµæŒ‡æ ‡è¯¦æƒ…</div>
                    </div>
                    <div class="grid grid-2" id="economic-indicators-grid"></div>
                </div>
                
                <!-- è¡Œä¸šé£é™©åˆ†æ -->
                <div class="card" style="margin-top: 20px; display: none;" id="industry-analysis-card">
                    <div class="card-header">
                        <div class="card-title">ğŸ­ è¡Œä¸šé£é™©åˆ†æ</div>
                    </div>
                    <div class="chart-container" style="height: 400px;">
                        <canvas id="industry-chart"></canvas>
                    </div>
                </div>
                
                <!-- é£é™©åˆ†å¸ƒ -->
                <div class="card" style="margin-top: 20px; display: none;" id="risk-distribution-card">
                    <div class="card-header">
                        <div class="card-title">ğŸ“Š é£é™©åˆ†å¸ƒåˆ†æ</div>
                    </div>
                    <div class="grid grid-2">
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="risk-distribution-chart"></canvas>
                        </div>
                        <div id="risk-distribution-stats"></div>
                    </div>
                </div>
                
                <!-- æŒ‡æ ‡ç›¸å…³æ€§åˆ†æ -->
                <div class="card" style="margin-top: 20px; display: none;" id="correlation-card">
                    <div class="card-header">
                        <div class="card-title">ğŸ”— æŒ‡æ ‡ç›¸å…³æ€§åˆ†æ</div>
                    </div>
                    <div id="correlation-content"></div>
                </div>
            </div>
        </div>

        <!-- é“¶è¡Œæ¨¡æ‹Ÿé¡µé¢ -->
        <div id="page-simulation" class="page">
            <h1 style="margin-bottom: 24px;">ğŸ¦ é“¶è¡Œç»è¥æ¨¡æ‹Ÿ</h1>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><span class="card-icon">ğŸ®</span> æ¨¡æ‹Ÿæ§åˆ¶</div>
                    <button class="btn btn-secondary" id="btn-sim-trace" onclick="showSimulationTrace()" style="display: none;">
                        ğŸ“‹ æ¨¡æ‹Ÿæ—¥å¿—
                    </button>
                </div>
                <div class="grid grid-2">
                    <div class="form-group">
                        <label class="form-label">é€‰æ‹©ç­–ç•¥</label>
                        <select id="sim-strategy" class="form-select">
                            <option value="rule_based">è§„åˆ™ç­–ç•¥ (æ¨¡æ‹Ÿä¼ ç»Ÿé“¶è¡Œ)</option>
                            <option value="conservative">ä¿å®ˆç­–ç•¥</option>
                            <option value="aggressive">æ¿€è¿›ç­–ç•¥</option>
                            <option value="random">éšæœºç­–ç•¥</option>
                        </select>
                    </div>
                    <div style="display: flex; align-items: flex-end; gap: 8px;">
                        <button class="btn btn-primary" onclick="runSimulation()" style="flex: 1;">
                            â–¶ï¸ è¿è¡Œ10å¹´æ¨¡æ‹Ÿ
                        </button>
                    </div>
                </div>
                <div id="sim-run-id" style="font-size: 12px; color: var(--text-muted); margin-top: 8px;"></div>
            </div>
            
            <div id="sim-result" style="display: none;">
                <div class="grid grid-4" id="sim-stats"></div>
                
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <div class="card-title">ğŸ“ˆ ç»è¥æ›²çº¿</div>
                    </div>
                    <div class="cycle-indicator" id="current-phase">
                        <div class="cycle-phase cycle-boom">ç¹è£</div>
                        <div class="cycle-phase cycle-recession">è¡°é€€</div>
                        <div class="cycle-phase cycle-depression">è§æ¡</div>
                        <div class="cycle-phase cycle-recovery">å¤è‹</div>
                    </div>
                    <div class="chart-container" style="height: 400px;">
                        <canvas id="sim-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç­–ç•¥å¯¹æ¯”é¡µé¢ -->
        <div id="page-comparison" class="page">
            <h1 style="margin-bottom: 24px;">âš”ï¸ ç­–ç•¥å¯¹æ¯”</h1>
            
            <!-- ç­–ç•¥è¯´æ˜å¡ç‰‡ -->
            <div class="card" style="margin-bottom: 24px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1)); border: 1px solid rgba(102, 126, 234, 0.3);">
                <div class="card-header">
                    <div class="card-title"><span class="card-icon">ğŸ“š</span> ç­–ç•¥è¯´æ˜</div>
                    <button class="btn btn-secondary" onclick="showStrategyExplanation()" style="font-size: 12px; padding: 6px 12px;">
                        ğŸ’¡ æŸ¥çœ‹è¯¦ç»†è¯´æ˜
                    </button>
                </div>
                <div style="padding: 0 24px 24px;">
                    <p style="color: var(--text-secondary); line-height: 1.8; margin-bottom: 16px;">
                        <strong>ç­–ç•¥</strong>å°±æ˜¯é“¶è¡Œæ¯ä¸ªæœˆå¦‚ä½•åšç»è¥å†³ç­–çš„è§„åˆ™å’Œæ–¹æ³•ã€‚ç³»ç»Ÿæä¾›5ç§ç­–ç•¥è¿›è¡Œå¯¹æ¯”ï¼š
                    </p>
                    <div class="grid grid-5" style="gap: 12px;">
                        <div style="padding: 12px; background: rgba(255, 255, 255, 0.05); border-radius: 8px; border: 1px solid rgba(102, 126, 234, 0.2);">
                            <div style="font-weight: 600; color: var(--accent-primary); margin-bottom: 4px; font-size: 13px;">éšæœºç­–ç•¥</div>
                            <div style="font-size: 11px; color: var(--text-muted);">å®Œå…¨éšæœºå†³ç­–ï¼Œç”¨äºåŸºå‡†å¯¹æ¯”</div>
                        </div>
                        <div style="padding: 12px; background: rgba(255, 255, 255, 0.05); border-radius: 8px; border: 1px solid rgba(102, 126, 234, 0.2);">
                            <div style="font-weight: 600; color: var(--accent-primary); margin-bottom: 4px; font-size: 13px;">è§„åˆ™ç­–ç•¥</div>
                            <div style="font-size: 11px; color: var(--text-muted);">åŸºäºå›ºå®šè§„åˆ™ï¼Œæ¨¡æ‹Ÿä¼ ç»Ÿé“¶è¡Œ</div>
                        </div>
                        <div style="padding: 12px; background: rgba(255, 255, 255, 0.05); border-radius: 8px; border: 1px solid rgba(102, 126, 234, 0.2);">
                            <div style="font-weight: 600; color: var(--accent-primary); margin-bottom: 4px; font-size: 13px;">ä¿å®ˆç­–ç•¥</div>
                            <div style="font-size: 11px; color: var(--text-muted);">ä½é£é™©ä½æ”¶ç›Šï¼Œä¸“æ³¨ä¼˜è´¨å®¢æˆ·</div>
                        </div>
                        <div style="padding: 12px; background: rgba(255, 255, 255, 0.05); border-radius: 8px; border: 1px solid rgba(102, 126, 234, 0.2);">
                            <div style="font-weight: 600; color: var(--accent-primary); margin-bottom: 4px; font-size: 13px;">æ¿€è¿›ç­–ç•¥</div>
                            <div style="font-size: 11px; color: var(--text-muted);">é«˜é£é™©é«˜æ”¶ç›Šï¼Œå¤§é‡æ¬¡çº§å®¢æˆ·</div>
                        </div>
                        <div style="padding: 12px; background: rgba(16, 185, 129, 0.1); border-radius: 8px; border: 1px solid rgba(16, 185, 129, 0.3);">
                            <div style="font-weight: 600; color: #10b981; margin-bottom: 4px; font-size: 13px;">AlphaZero</div>
                            <div style="font-size: 11px; color: var(--text-muted);">AIè‡ªæˆ‘å­¦ä¹ ï¼Œæœ€ä¼˜ç­–ç•¥</div>
                        </div>
                    </div>
                    <div style="margin-top: 16px; padding: 12px; background: rgba(79, 172, 254, 0.1); border-radius: 8px; border-left: 3px solid #4facfe;">
                        <div style="font-size: 12px; color: var(--text-secondary); line-height: 1.6;">
                            <strong>ğŸ’¡ æç¤ºï¼š</strong>æ¯ä¸ªç­–ç•¥ä¼šæ¨¡æ‹Ÿ10å¹´é“¶è¡Œç»è¥ï¼Œç³»ç»Ÿä¼šè®°å½•æ¯æœˆçš„å†³ç­–ï¼ˆåˆ©ç‡è°ƒæ•´ã€å®¡æ‰¹ç‡ã€å®¢æˆ·åˆ†é…ï¼‰å’Œç»“æœï¼ˆåˆ©æ¶¦ã€NPLã€ç ´äº§é£é™©ï¼‰ï¼Œæœ€ç»ˆå¯¹æ¯”å„ç­–ç•¥çš„é•¿æœŸè¡¨ç°ã€‚
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><span class="card-icon">âš™ï¸</span> å¯¹æ¯”é…ç½®</div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-secondary" id="btn-comparison-trace" onclick="showComparisonTrace()" style="display: none;">
                            ğŸ“‹ å¯¹æ¯”æ—¥å¿—
                        </button>
                        <button class="btn btn-primary" onclick="runComparison()">
                            ğŸ å¼€å§‹å¯¹æ¯”
                        </button>
                    </div>
                </div>
                <div class="form-group" style="max-width: 300px;">
                    <label class="form-label">æ¯ç­–ç•¥è¯„ä¼°å›åˆæ•°</label>
                    <input type="number" id="comparison-episodes" class="form-input" value="3" min="1" max="5">
                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">æ¯ä¸ªç­–ç•¥è¿è¡Œå¤šæ¬¡å–å¹³å‡å€¼ï¼Œæé«˜ç»“æœå¯é æ€§</div>
                </div>
                <div id="comparison-run-id" style="font-size: 12px; color: var(--text-muted); margin-top: 8px;"></div>
            </div>
            
            <div id="comparison-result" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">ğŸ† ç­–ç•¥æ’å</div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-secondary" onclick="showComparisonMetricsExplanation()" style="font-size: 12px; padding: 6px 12px;">
                                ğŸ“ æŒ‡æ ‡è¯´æ˜
                            </button>
                            <button class="btn btn-secondary" onclick="showAIExplanation('comparison')" style="font-size: 12px; padding: 6px 12px;">
                                ğŸ¤– AIè§£é‡Š
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table id="comparison-table">
                            <thead>
                                <tr>
                                    <th>æ’å</th>
                                    <th>ç­–ç•¥ <button onclick="showStrategyDetailModal()" style="margin-left: 4px; padding: 2px 6px; background: rgba(102, 126, 234, 0.1); border: 1px solid rgba(102, 126, 234, 0.3); border-radius: 4px; color: #667eea; font-size: 10px; cursor: pointer;">è¯´æ˜</button></th>
                                    <th>å¹³å‡å¥–åŠ± <button onclick="showMetricCalculation('avg_reward')" style="margin-left: 4px; padding: 2px 6px; background: rgba(102, 126, 234, 0.1); border: 1px solid rgba(102, 126, 234, 0.3); border-radius: 4px; color: #667eea; font-size: 10px; cursor: pointer;">è®¡ç®—</button></th>
                                    <th>ç´¯è®¡åˆ©æ¶¦ <button onclick="showMetricCalculation('profit')" style="margin-left: 4px; padding: 2px 6px; background: rgba(102, 126, 234, 0.1); border: 1px solid rgba(102, 126, 234, 0.3); border-radius: 4px; color: #667eea; font-size: 10px; cursor: pointer;">è®¡ç®—</button></th>
                                    <th>å¹³å‡NPL <button onclick="showMetricCalculation('npl')" style="margin-left: 4px; padding: 2px 6px; background: rgba(102, 126, 234, 0.1); border: 1px solid rgba(102, 126, 234, 0.3); border-radius: 4px; color: #667eea; font-size: 10px; cursor: pointer;">è®¡ç®—</button></th>
                                    <th>ç ´äº§ç‡ <button onclick="showMetricCalculation('bankruptcy')" style="margin-left: 4px; padding: 2px 6px; background: rgba(102, 126, 234, 0.1); border: 1px solid rgba(102, 126, 234, 0.3); border-radius: 4px; color: #667eea; font-size: 10px; cursor: pointer;">è®¡ç®—</button></th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <div class="card-title">ğŸ“Š å¯è§†åŒ–å¯¹æ¯”</div>
                        <button class="btn btn-secondary" onclick="showChartExplanation()" style="font-size: 12px; padding: 6px 12px;">
                            ğŸ“– å›¾è¡¨è¯´æ˜
                        </button>
                    </div>
                    <div class="chart-container">
                        <canvas id="comparison-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ•°æ®è’¸é¦é¡µé¢ -->
        <div id="page-distillation" class="page">
            <h1 style="margin-bottom: 24px;">ğŸ”¬ æ•°æ®è’¸é¦</h1>
            
            <div class="grid grid-2">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title"><span class="card-icon">âš™ï¸</span> è’¸é¦é…ç½®</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">æ•°æ®æ¥æº</label>
                        <select id="distill-source" class="form-input" onchange="updateDistillOptions()">
                            <option value="synthetic">ğŸ”§ åˆæˆæ•°æ® (æ¼”ç¤ºç”¨)</option>
                            <option value="test_data">ğŸ“Š æµ‹è¯•æ•°æ®é›† (10Kå®¢æˆ·)</option>
                            <option value="historical">ğŸ­ å®Œæ•´å†å²æ•°æ® (5Må®¢æˆ·)</option>
                        </select>
                    </div>
                    
                    <div id="synthetic-options">
                        <div class="form-group">
                            <label class="form-label">åˆæˆæ•°æ®é‡</label>
                            <input type="number" id="distill-size" class="form-input" value="1000" min="500" max="3000">
                        </div>
                    </div>
                    
                    <div id="real-data-options" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">é‡‡æ ·å¤§å° (ç•™ç©ºä½¿ç”¨å…¨éƒ¨)</label>
                            <input type="number" id="distill-sample" class="form-input" value="" placeholder="å¦‚: 50000">
                        </div>
                        <div id="data-source-info" class="stat-card" style="padding: 12px; margin-bottom: 12px;">
                            <div style="font-size: 12px; color: var(--text-muted);">æ­£åœ¨æ£€æŸ¥æ•°æ®æº...</div>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="runDistillation()" id="btn-distill" style="width: 100%; margin-top: 16px;">
                        ğŸ”¥ å¼€å§‹è’¸é¦
                    </button>
                    
                    <div id="distill-progress" style="margin-top: 24px; display: none;">
                        <div class="form-label">è¿›åº¦</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="distill-progress-bar" style="width: 0%"></div>
                        </div>
                        <div id="distill-percent" style="text-align: center; margin-top: 8px; font-family: 'JetBrains Mono';">0%</div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title"><span class="card-icon">ğŸ“</span> è’¸é¦æ—¥å¿—</div>
                        <button class="btn btn-secondary" id="btn-audit-log" onclick="showAuditLog()" style="display: none;">
                            ğŸ“‹ å®¡è®¡æ—¥å¿—
                        </button>
                    </div>
                    <div class="log-panel" id="distill-logs">
                        <div class="log-entry" style="color: var(--text-muted);">ç­‰å¾…å¼€å§‹...</div>
                    </div>
                </div>
            </div>
            
            <!-- æ­¥éª¤è¯¦æƒ…å¡ç‰‡ -->
            <div class="card" style="margin-top: 20px;" id="distill-result">
                <div class="card-header">
                    <div class="card-title"><span class="card-icon">ğŸ“Š</span> è’¸é¦è¿‡ç¨‹è¿½è¸ª</div>
                    <span id="distill-run-id" style="font-size: 12px; color: var(--text-muted);"></span>
                </div>
                <div class="timeline" id="distill-steps">
                    <div class="timeline-item pending" data-step="1" onclick="showStepDetail(1)">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>ğŸ“¦ ç¬¬ä¸€æ­¥: æ•°æ®å‡†å¤‡</strong>
                                <p style="color: var(--text-muted); font-size: 13px;">æ”¶é›†å¹¶æ¸…æ´—å†å²è´·æ¬¾è®°å½•</p>
                            </div>
                            <span class="step-link">æŸ¥çœ‹è¯¦æƒ… â†’</span>
                        </div>
                        <div class="step-detail" id="step-detail-1"></div>
                    </div>
                    <div class="timeline-item pending" data-step="2" onclick="showStepDetail(2)">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>âš™ï¸ ç¬¬äºŒæ­¥: ç‰¹å¾å·¥ç¨‹</strong>
                                <p style="color: var(--text-muted); font-size: 13px;">æå–é™æ€/è¡Œä¸º/ä¿¡è´·/ç¯å¢ƒç‰¹å¾</p>
                            </div>
                            <span class="step-link">æŸ¥çœ‹è¯¦æƒ… â†’</span>
                        </div>
                        <div class="step-detail" id="step-detail-2"></div>
                    </div>
                    <div class="timeline-item pending" data-step="3" onclick="showStepDetail(3)">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>ğŸ§  ç¬¬ä¸‰æ­¥: è§„å¾‹å»ºæ¨¡</strong>
                                <p style="color: var(--text-muted); font-size: 13px;">è®­ç»ƒæ¨¡å‹å­¦ä¹ éšè—è§„å¾‹</p>
                            </div>
                            <span class="step-link">æŸ¥çœ‹è¯¦æƒ… â†’</span>
                        </div>
                        <div class="step-detail" id="step-detail-3"></div>
                    </div>
                    <div class="timeline-item pending" data-step="4" onclick="showStepDetail(4)">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>ğŸ“¦ ç¬¬å››æ­¥: å‡½æ•°å°è£…</strong>
                                <p style="color: var(--text-muted); font-size: 13px;">å°è£…ä¸º predict_customer_future() API</p>
                            </div>
                            <span class="step-link">æŸ¥çœ‹è¯¦æƒ… â†’</span>
                        </div>
                        <div class="step-detail" id="step-detail-4"></div>
                    </div>
                    <div class="timeline-item pending" data-step="5" onclick="showStepDetail(5)">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <p style="color: var(--text-muted); font-size: 13px;">ä½¿ç”¨ä¿ç•™æ•°æ®å›æµ‹éªŒè¯</p>
                            </div>
                            <span class="step-link">æŸ¥çœ‹è¯¦æƒ… â†’</span>
                        </div>
                        <div class="step-detail" id="step-detail-5"></div>
                    </div>
                </div>
            </div>
            
            <!-- éªŒè¯ç»“æœå¡ç‰‡ -->
            <div class="card" style="margin-top: 20px; display: none;" id="validation-card">
                <div class="card-header">
                    <div class="card-title"><span class="card-icon">ğŸ“ˆ</span> éªŒè¯ç»“æœè¯¦æƒ…</div>
                </div>
                <div id="validation-content"></div>
            </div>
        </div>
        
        <!-- æ•°æ®æµè§ˆå™¨é¡µé¢ -->
        <div id="page-databrowser" class="page">
            <h1 style="margin-bottom: 24px;">ğŸ“‚ æ•°æ®æµè§ˆå™¨</h1>
            
            <div class="grid grid-2">
                <!-- æ•°æ®æºé€‰æ‹© -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title"><span class="card-icon">ğŸ“</span> æ•°æ®æº</div>
                        <button class="btn btn-secondary" onclick="refreshDataSources()">ğŸ”„ åˆ·æ–°</button>
                    </div>
                    <div id="data-sources-list">
                        <div style="text-align: center; color: var(--text-muted); padding: 20px;">åŠ è½½ä¸­...</div>
                    </div>
                </div>
                
                <!-- è¡¨ç»“æ„ -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title"><span class="card-icon">ğŸ“‹</span> è¡¨ç»“æ„</div>
                        <button class="btn btn-secondary" onclick="showTableStats()" id="btn-stats" style="display: none;">ğŸ“Š ç»Ÿè®¡ä¿¡æ¯</button>
                    </div>
                    <div id="table-schema">
                        <div style="text-align: center; color: var(--text-muted); padding: 20px;">é€‰æ‹©æ•°æ®è¡¨æŸ¥çœ‹ç»“æ„</div>
                    </div>
                </div>
            </div>
            
            <!-- æ•°æ®è¡¨æ ¼ -->
            <div class="card" style="margin-top: 20px;">
                <div class="card-header">
                    <div class="card-title"><span class="card-icon">ğŸ“Š</span> æ•°æ®è®°å½•</div>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <input type="text" id="data-search" class="form-input" placeholder="æœç´¢..." 
                               style="width: 200px;" onkeypress="if(event.key==='Enter')searchData()">
                        <button class="btn btn-secondary" onclick="searchData()">ğŸ” æœç´¢</button>
                    </div>
                </div>
                <div id="data-table-container">
                    <div style="text-align: center; color: var(--text-muted); padding: 40px;">é€‰æ‹©æ•°æ®è¡¨æŸ¥çœ‹è®°å½•</div>
                </div>
                <div id="data-pagination" style="display: none; padding: 16px; border-top: 1px solid var(--border-color);">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div id="pagination-info" style="color: var(--text-muted); font-size: 13px;"></div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-secondary" onclick="prevPage()" id="btn-prev">â† ä¸Šä¸€é¡µ</button>
                            <button class="btn btn-secondary" onclick="nextPage()" id="btn-next">ä¸‹ä¸€é¡µ â†’</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- å¤šæ¨¡å‹å¯¹æŠ—è¯„æµ‹é¡µé¢ -->
        <div id="page-modeleval" class="page">
            <h1 style="margin-bottom: 24px;">ğŸ¤– AIæ¨¡å‹å¯¹æŠ—è¯„æµ‹</h1>
            
            <div class="card" style="margin-bottom: 24px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1)); border: 1px solid rgba(59, 130, 246, 0.3);">
                <div style="padding: 20px;">
                    <p style="font-size: 14px; line-height: 1.8; color: var(--text-secondary);">
                        é“¶è¡Œåœ¨æ™ºèƒ½é—®æ•°ã€å®¢æˆ·å’¨è¯¢ã€è´·æ¬¾å®¡æ‰¹ã€è¥é”€æ²Ÿé€šç­‰åœºæ™¯ä¸­ï¼Œéœ€è¦ç»Ÿä¸€è¯„æµ‹ä¸åŒå¤§æ¨¡å‹å’Œæ™ºèƒ½ä½“çš„è¡¨ç°ã€‚
                        Gamium æä¾›å›åˆåˆ¶è‡ªåŠ¨å¯¹è¯å’Œä»»åŠ¡æ‰§è¡Œèƒ½åŠ›ï¼Œé‡åŒ–è¯„ä¼°å…³é”®æŒ‡æ ‡ï¼Œæ”¯æŒABæµ‹è¯•ã€‚
                    </p>
                </div>
            </div>
            
            <div class="grid grid-2">
                <!-- å·¦ä¾§ï¼šé…ç½®é¢æ¿ -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title"><span class="card-icon">âš™ï¸</span> è¯„æµ‹é…ç½®</div>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h4 style="margin: 0; color: var(--accent-primary); font-size: 14px; font-weight: 600;">ğŸ¤– é€‰æ‹©æ¨¡å‹</h4>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="selectAllModels()" class="action-btn select-all-btn" style="padding: 8px 16px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(139, 92, 246, 0.15)); border: 2px solid rgba(59, 130, 246, 0.4); border-radius: 8px; color: #3b82f6; font-size: 12px; cursor: pointer; font-weight: 600; transition: all 0.2s; display: flex; align-items: center; gap: 6px;">
                                <span>âœ“</span>å…¨é€‰
                            </button>
                            <button onclick="deselectAllModels()" class="action-btn deselect-all-btn" style="padding: 8px 16px; background: rgba(107, 114, 128, 0.1); border: 2px solid rgba(107, 114, 128, 0.3); border-radius: 8px; color: #6b7280; font-size: 12px; cursor: pointer; font-weight: 600; transition: all 0.2s; display: flex; align-items: center; gap: 6px;">
                                <span>âœ•</span>å–æ¶ˆ
                            </button>
                        </div>
                    </div>
                    
                    <!-- æœç´¢å’Œç­›é€‰ -->
                    <div style="margin-bottom: 16px; position: relative;">
                        <input type="text" id="model-search" placeholder="ğŸ” æœç´¢æ¨¡å‹åç§°ã€ç±»å‹..." 
                               style="width: 100%; padding: 10px 12px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 13px; transition: all 0.2s;"
                               oninput="filterModels()"
                               onfocus="this.style.borderColor='var(--accent-primary)'; this.style.boxShadow='0 0 0 3px rgba(0, 212, 170, 0.1)'"
                               onblur="this.style.borderColor='var(--border-color)'; this.style.boxShadow='none'">
                    </div>
                    
                    <!-- æ¨¡å‹åˆ†ç±» -->
                    <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; padding: 8px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(139, 92, 246, 0.05)); border-radius: 12px; border: 1px solid rgba(59, 130, 246, 0.1);">
                        <button class="model-category-btn active" onclick="filterByCategory('all')" data-category="all">
                            <span style="margin-right: 6px;">ğŸ”</span>å…¨éƒ¨
                        </button>
                        <button class="model-category-btn" onclick="filterByCategory('openai')" data-category="openai">
                            <span style="margin-right: 6px;">ğŸ§ </span>OpenAI
                        </button>
                        <button class="model-category-btn" onclick="filterByCategory('anthropic')" data-category="anthropic">
                            <span style="margin-right: 6px;">ğŸ¯</span>Anthropic
                        </button>
                        <button class="model-category-btn" onclick="filterByCategory('local')" data-category="local">
                            <span style="margin-right: 6px;">ğŸ’»</span>æœ¬åœ°æ¨¡å‹
                        </button>
                        <button class="model-category-btn" onclick="filterByCategory('rag')" data-category="rag">
                            <span style="margin-right: 6px;">ğŸ“š</span>RAGåº”ç”¨
                        </button>
                    </div>
                    
                    <div id="model-selection" style="margin-bottom: 24px; max-height: 450px; overflow-y: auto; padding-right: 4px;">
                        <!-- åŠ¨æ€åŠ è½½æ¨¡å‹åˆ—è¡¨ -->
                    </div>
                    
                    <h4 style="margin: 0 0 16px; color: var(--accent-primary); font-size: 14px;">
                        ğŸ“‹ é€‰æ‹©æµ‹è¯•ç”¨ä¾‹
                        <button onclick="showMetricsExplanation()" style="margin-left: 8px; padding: 4px 8px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 4px; color: #3b82f6; font-size: 11px; cursor: pointer;">ğŸ“– è¯„åˆ†ä¾æ®</button>
                    </h4>
                    <div id="test-case-selection" style="margin-bottom: 24px;">
                        <!-- åŠ¨æ€åŠ è½½æµ‹è¯•ç”¨ä¾‹ -->
                    </div>
                    
                    <button class="btn btn-primary" onclick="runEvaluation()" style="width: 100%; margin-top: 20px;">
                        ğŸš€ å¼€å§‹è¯„æµ‹
                    </button>
                </div>
                
                <!-- å³ä¾§ï¼šç»“æœå±•ç¤º -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title"><span class="card-icon">ğŸ“Š</span> è¯„æµ‹ç»“æœ</div>
                    </div>
                    <div id="evaluation-results">
                        <div style="text-align: center; color: var(--text-muted); padding: 60px 20px;">
                            <div style="font-size: 80px; margin-bottom: 20px; opacity: 0.4; filter: drop-shadow(0 0 10px rgba(59, 130, 246, 0.3));">ğŸ¤–</div>
                            <p style="font-size: 14px; line-height: 1.6; color: var(--text-muted);">é…ç½®è¯„æµ‹å‚æ•°åï¼Œç‚¹å‡»"å¼€å§‹è¯„æµ‹"æŸ¥çœ‹ç»“æœ</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- è¯¦ç»†å¯¹æ¯”ç»“æœ -->
            <div id="evaluation-details" style="display: none; margin-top: 24px;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title"><span class="card-icon">ğŸ“ˆ</span> è¯¦ç»†å¯¹æ¯”åˆ†æ</div>
                    </div>
                    <div id="detailed-comparison"></div>
                </div>
            </div>
        </div>
        
        <!-- AI Hub ç®¡ç†ç•Œé¢ -->
        <div id="page-aihub" class="page">
            <h1 style="margin-bottom: 24px;">ğŸ¯ AI Hub ç®¡ç†ä¸­å¿ƒ</h1>
            
            <div class="card" style="margin-bottom: 24px; background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(59, 130, 246, 0.1)); border: 1px solid rgba(139, 92, 246, 0.3);">
                <div style="padding: 20px;">
                    <p style="font-size: 14px; line-height: 1.8; color: var(--text-secondary);">
                        AI Hub æä¾›ç»Ÿä¸€çš„æ¨¡å‹ç®¡ç†å¹³å°ï¼Œæ”¯æŒAPIå¯†é’¥ç®¡ç†ã€ä½¿ç”¨é™é¢ã€ç†”æ–­ä¿æŠ¤ã€æ•æ„Ÿè¯è¿‡æ»¤ã€æƒé™æ§åˆ¶ç­‰åŠŸèƒ½ã€‚
                        ç¡®ä¿AIæœåŠ¡çš„å®‰å…¨ã€ç¨³å®šå’Œåˆè§„è¿è¡Œã€‚
                    </p>
                </div>
            </div>
            
            <!-- åŠŸèƒ½æ ‡ç­¾é¡µ -->
            <div style="display: flex; gap: 12px; margin-bottom: 24px; border-bottom: 2px solid var(--border-color);">
                <button class="hub-tab-btn active" onclick="switchHubTab('models')" data-tab="models">ğŸ¤– æ¨¡å‹ç®¡ç†</button>
                <button class="hub-tab-btn" onclick="switchHubTab('sensitive')" data-tab="sensitive">ğŸš« æ•æ„Ÿè¯ç®¡ç†</button>
                <button class="hub-tab-btn" onclick="switchHubTab('permissions')" data-tab="permissions">ğŸ” æƒé™æ§åˆ¶</button>
                <button class="hub-tab-btn" onclick="switchHubTab('statistics')" data-tab="statistics">ğŸ“Š ä½¿ç”¨ç»Ÿè®¡</button>
            </div>
            
            <!-- æ¨¡å‹ç®¡ç†æ ‡ç­¾é¡µ -->
            <div id="hub-tab-models" class="hub-tab-content">
                <div class="grid grid-2">
                    <!-- å·¦ä¾§ï¼šæ¨¡å‹åˆ—è¡¨ -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title"><span class="card-icon">ğŸ“‹</span> æ¨¡å‹åˆ—è¡¨</div>
                            <button onclick="showAddModelModal()" style="padding: 6px 12px; background: var(--accent-primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 500;">+ æ·»åŠ æ¨¡å‹</button>
                        </div>
                        <div id="hub-model-list" style="max-height: 600px; overflow-y: auto;">
                            <!-- åŠ¨æ€åŠ è½½æ¨¡å‹åˆ—è¡¨ -->
                        </div>
                    </div>
                    
                    <!-- å³ä¾§ï¼šæ¨¡å‹è¯¦æƒ… -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title"><span class="card-icon">âš™ï¸</span> æ¨¡å‹é…ç½®</div>
                        </div>
                        <div id="hub-model-detail">
                            <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
                                <div style="font-size: 64px; margin-bottom: 16px; opacity: 0.4;">âš™ï¸</div>
                                <p>è¯·ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªæ¨¡å‹è¿›è¡Œé…ç½®</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- æ•æ„Ÿè¯ç®¡ç†æ ‡ç­¾é¡µ -->
            <div id="hub-tab-sensitive" class="hub-tab-content" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title"><span class="card-icon">ğŸš«</span> æ•æ„Ÿè¯ç®¡ç†</div>
                        <button onclick="showAddSensitiveWordModal()" style="padding: 6px 12px; background: var(--accent-primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 500;">+ æ·»åŠ æ•æ„Ÿè¯</button>
                    </div>
                    <div id="hub-sensitive-words" style="padding: 20px;">
                        <!-- åŠ¨æ€åŠ è½½æ•æ„Ÿè¯åˆ—è¡¨ -->
                    </div>
                </div>
            </div>
            
            <!-- æƒé™æ§åˆ¶æ ‡ç­¾é¡µ -->
            <div id="hub-tab-permissions" class="hub-tab-content" style="display: none;">
                <div class="grid grid-2">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title"><span class="card-icon">ğŸ‘¥</span> ç”¨æˆ·æƒé™</div>
                        </div>
                        <div id="hub-user-permissions" style="padding: 20px;">
                            <!-- åŠ¨æ€åŠ è½½ç”¨æˆ·æƒé™åˆ—è¡¨ -->
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title"><span class="card-icon">ğŸ”‘</span> è§’è‰²ç®¡ç†</div>
                        </div>
                        <div id="hub-roles" style="padding: 20px;">
                            <!-- åŠ¨æ€åŠ è½½è§’è‰²åˆ—è¡¨ -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ä½¿ç”¨ç»Ÿè®¡æ ‡ç­¾é¡µ -->
            <div id="hub-tab-statistics" class="hub-tab-content" style="display: none;">
                <div class="grid grid-3">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title"><span class="card-icon">ğŸ“ˆ</span> è°ƒç”¨ç»Ÿè®¡</div>
                        </div>
                        <div id="hub-call-stats" style="padding: 20px;">
                            <!-- åŠ¨æ€åŠ è½½è°ƒç”¨ç»Ÿè®¡ -->
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title"><span class="card-icon">ğŸ’°</span> æˆæœ¬ç»Ÿè®¡</div>
                        </div>
                        <div id="hub-cost-stats" style="padding: 20px;">
                            <!-- åŠ¨æ€åŠ è½½æˆæœ¬ç»Ÿè®¡ -->
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title"><span class="card-icon">âš ï¸</span> å¼‚å¸¸ç›‘æ§</div>
                        </div>
                        <div id="hub-error-stats" style="padding: 20px;">
                            <!-- åŠ¨æ€åŠ è½½å¼‚å¸¸ç»Ÿè®¡ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- é£æ§å‹åŠ›æµ‹è¯•é¡µé¢ -->
        <div id="page-stresstest" class="page">
            <h1 style="margin-bottom: 24px;">âš ï¸ é£æ§å‹åŠ›æµ‹è¯•</h1>
            
            <div class="card" style="margin-bottom: 24px; background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(239, 68, 68, 0.1)); border: 1px solid rgba(245, 158, 11, 0.3);">
                <div style="padding: 20px;">
                    <p style="color: var(--text-primary); line-height: 1.8; margin: 0;">
                        åœ¨è™šæ‹Ÿç¯å¢ƒä¸­æ³¨å…¥å„ç±»"é»‘å¤©é¹…"äº‹ä»¶ï¼Œæµ‹è¯•ç°æœ‰ç­–ç•¥çš„éŸ§æ€§å’Œæ¢å¤èƒ½åŠ›ã€‚
                        å¸®åŠ©é£æ§å›¢é˜Ÿæå‰å‘ç°æ½œåœ¨é£é™©ï¼Œåˆ¶å®šåº”å¯¹é¢„æ¡ˆã€‚
                    </p>
                </div>
            </div>
            
            <div class="grid grid-3">
                <!-- å·¦ä¾§ï¼šé…ç½®é¢æ¿ -->
                <div class="card" style="grid-column: span 1;">
                    <div class="card-header">
                        <div class="card-title"><span class="card-icon">âš™ï¸</span> å‹åŠ›æµ‹è¯•é…ç½®</div>
                    </div>
                    
                    <h4 style="margin: 20px 0 16px; color: var(--accent-primary); font-size: 14px;">ğŸ¦¢ é»‘å¤©é¹…äº‹ä»¶æ³¨å…¥</h4>
                    <div class="form-group">
                        <label class="form-label">äº‹ä»¶ç±»å‹</label>
                        <select id="stress-event-type" class="form-select">
                            <option value="financial_crisis">é‡‘èå±æœº</option>
                            <option value="pandemic">ç–«æƒ…å†²å‡»</option>
                            <option value="industry_collapse">è¡Œä¸šæš´é›·</option>
                            <option value="interest_rate_shock">åˆ©ç‡å†²å‡»</option>
                            <option value="unemployment_surge">å¤±ä¸šç‡é£™å‡</option>
                            <option value="custom">è‡ªå®šä¹‰äº‹ä»¶</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">äº‹ä»¶å¼ºåº¦</label>
                        <select id="stress-severity" class="form-select">
                            <option value="mild">è½»åº¦ (1.2xé£é™©)</option>
                            <option value="moderate" selected>ä¸­åº¦ (1.5xé£é™©)</option>
                            <option value="severe">é‡åº¦ (2.0xé£é™©)</option>
                            <option value="extreme">æç«¯ (3.0xé£é™©)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">æŒç»­æ—¶é—´ (æœˆ)</label>
                        <input type="number" id="stress-duration" class="form-input" value="6" min="1" max="24">
                    </div>
                    
                    <h4 style="margin: 20px 0 16px; color: var(--accent-primary); font-size: 14px;">ğŸ‘¥ æµ‹è¯•å®¢æˆ·é…ç½®</h4>
                    <div class="form-group">
                        <label class="form-label">å®¢æˆ·ç±»å‹</label>
                        <select id="stress-customer-type" class="form-select">
                            <option value="">å…¨éƒ¨ç±»å‹</option>
                            <option value="salaried">å·¥è–ªé˜¶å±‚</option>
                            <option value="small_business">å°å¾®ä¼ä¸šä¸»</option>
                            <option value="freelancer">è‡ªç”±èŒä¸šè€…</option>
                            <option value="farmer">å†œæˆ·</option>
                            <option value="professional">ä¸“ä¸šäººå£«</option>
                            <option value="entrepreneur">åˆ›ä¸šè€…</option>
                            <option value="investor">æŠ•èµ„è€…</option>
                            <option value="retiree">é€€ä¼‘äººå‘˜</option>
                            <option value="student">å­¦ç”Ÿ</option>
                            <option value="startup">åˆåˆ›ä¼ä¸š</option>
                            <option value="tech_startup">ç§‘æŠ€åˆåˆ›</option>
                            <option value="manufacturing">åˆ¶é€ ä¼ä¸š</option>
                            <option value="trade_company">è´¸æ˜“å…¬å¸</option>
                            <option value="service_company">æœåŠ¡ä¼ä¸š</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">è¡Œä¸šç­›é€‰</label>
                        <select id="stress-industry" class="form-select">
                            <option value="">å…¨éƒ¨è¡Œä¸š</option>
                            <option value="manufacturing">åˆ¶é€ ä¸š</option>
                            <option value="service">æœåŠ¡ä¸š</option>
                            <option value="retail">é›¶å”®ä¸š</option>
                            <option value="catering">é¤é¥®ä¸š</option>
                            <option value="it">IT/äº’è”ç½‘</option>
                            <option value="construction">å»ºç­‘ä¸š</option>
                            <option value="agriculture">å†œä¸š</option>
                            <option value="finance">é‡‘èä¸š</option>
                            <option value="real_estate">æˆ¿åœ°äº§ä¸š</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">åŸå¸‚ç­‰çº§</label>
                        <select id="stress-city-tier" class="form-select">
                            <option value="">å…¨éƒ¨åŸå¸‚</option>
                            <option value="tier_1">ä¸€çº¿åŸå¸‚</option>
                            <option value="tier_2">äºŒçº¿åŸå¸‚</option>
                            <option value="tier_3">ä¸‰çº¿åŸå¸‚</option>
                            <option value="tier_4">å››çº¿åŠä»¥ä¸‹</option>
                        </select>
                    </div>
                    
                    <h4 style="margin: 20px 0 16px; color: var(--accent-primary); font-size: 14px;">ğŸ’° è´·æ¬¾æ¡ä»¶</h4>
                    <div class="form-group">
                        <label class="form-label">è´·æ¬¾é‡‘é¢ (å…ƒ)</label>
                        <input type="number" id="stress-loan-amount" class="form-input" value="100000" min="10000" max="10000000" step="10000">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">å¹´åˆ©ç‡ (%)</label>
                        <input type="number" id="stress-interest-rate" class="form-input" value="8" min="3" max="20" step="0.1">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">è´·æ¬¾æœŸé™ (æœˆ)</label>
                        <input type="number" id="stress-loan-term" class="form-input" value="24" min="6" max="60" step="6">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">æµ‹è¯•å®¢æˆ·æ•°é‡</label>
                        <input type="number" id="stress-customer-count" class="form-input" value="100" min="50" max="500" step="50">
                        <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">å»ºè®®100-200ä¸ªå®¢æˆ·ä»¥è·å¾—å‡†ç¡®ç»“æœ</div>
                    </div>
                    
                    <h4 style="margin: 20px 0 16px; color: var(--accent-primary); font-size: 14px;">ğŸ”¬ æ•æ„Ÿæ€§åˆ†æ</h4>
                    <div class="form-group">
                        <label class="form-label">åˆ†æç»´åº¦</label>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="sensitivity-gdp" checked>
                                <span>GDPå¢é•¿ç‡</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="sensitivity-unemployment" checked>
                                <span>å¤±ä¸šç‡</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="sensitivity-interest" checked>
                                <span>åˆ©ç‡æ°´å¹³</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="sensitivity-inflation">
                                <span>é€šèƒ€ç‡</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">å˜åŒ–èŒƒå›´ (%)</label>
                        <input type="number" id="sensitivity-range" class="form-input" value="30" min="10" max="100" step="5">
                    </div>
                    
                    <h4 style="margin: 20px 0 16px; color: var(--accent-primary); font-size: 14px;">ğŸ›¡ï¸ éŸ§æ€§è¯„ä¼°</h4>
                    <div class="form-group">
                        <label class="form-label">è¯„ä¼°æŒ‡æ ‡</label>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="resilience-default" checked>
                                <span>è¿çº¦ç‡å˜åŒ–</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="resilience-profit" checked>
                                <span>åˆ©æ¶¦å›æ’¤</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="resilience-recovery" checked>
                                <span>æ¢å¤é€Ÿåº¦</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="resilience-capital">
                                <span>èµ„æœ¬å……è¶³ç‡</span>
                            </label>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="runStressTest()" style="width: 100%; margin-top: 20px;">
                        ğŸš€ å¼€å§‹å‹åŠ›æµ‹è¯•
                    </button>
                </div>
                
                <!-- ä¸­é—´ï¼šç»“æœå±•ç¤º -->
                <div class="card" style="grid-column: span 2;">
                    <div class="card-header">
                        <div class="card-title"><span class="card-icon">ğŸ“Š</span> æµ‹è¯•ç»“æœ</div>
                    </div>
                    <div id="stress-test-results">
                        <div style="text-align: center; color: var(--text-muted); padding: 60px 20px;">
                            <div style="font-size: 80px; margin-bottom: 20px; opacity: 0.4; filter: drop-shadow(0 0 10px rgba(59, 130, 246, 0.3));">ğŸ’«</div>
                            <p style="font-size: 14px; line-height: 1.6; color: var(--text-muted);">é…ç½®å‹åŠ›æµ‹è¯•å‚æ•°åï¼Œç‚¹å‡»"å¼€å§‹å‹åŠ›æµ‹è¯•"æŸ¥çœ‹ç»“æœ</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- è¯¦ç»†åˆ†æç»“æœ -->
            <div class="grid grid-4" id="stress-details" style="display: none; margin-top: 24px;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title"><span class="card-icon">ğŸ¦¢</span> é»‘å¤©é¹…å½±å“</div>
                        <button class="btn btn-secondary" onclick="showImpactDetail()" style="font-size: 12px; padding: 4px 8px;">ğŸ“Š ä¸‹é’»</button>
                    </div>
                    <div id="black-swan-impact"></div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title"><span class="card-icon">ğŸ”¬</span> æ•æ„Ÿæ€§åˆ†æ</div>
                        <button class="btn btn-secondary" onclick="showSensitivityDetail()" style="font-size: 12px; padding: 4px 8px;">ğŸ“Š ä¸‹é’»</button>
                    </div>
                    <div id="sensitivity-analysis"></div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title"><span class="card-icon">ğŸ›¡ï¸</span> éŸ§æ€§è¯„ä¼°</div>
                        <button class="btn btn-secondary" onclick="showResilienceDetail()" style="font-size: 12px; padding: 4px 8px;">ğŸ“Š ä¸‹é’»</button>
                    </div>
                    <div id="resilience-assessment"></div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title"><span class="card-icon">ğŸ“‹</span> åº”å¯¹é¢„æ¡ˆ</div>
                    </div>
                    <div id="contingency-plan"></div>
                </div>
            </div>
            
            <!-- è®¡ç®—è¿‡ç¨‹ä¸‹é’»å¼¹çª— -->
            <div id="stress-detail-modal" class="modal" style="display: none;">
                <div class="modal-content" style="max-width: 1000px;">
                    <div class="modal-header">
                        <h3 id="stress-detail-title">ğŸ“Š è¯¦ç»†è®¡ç®—è¿‡ç¨‹</h3>
                        <button class="modal-close" onclick="closeStressDetail()">Ã—</button>
                    </div>
                    <div class="modal-body" id="stress-detail-content" style="max-height: 70vh; overflow-y: auto;">
                    </div>
                </div>
            </div>
            
            <!-- æŒ‡æ ‡è®¡ç®—è¯´æ˜å¼¹çª— -->
            <div id="metric-calculation-modal" class="modal" style="display: none;">
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h3 id="metric-calculation-title">ğŸ“Š è®¡ç®—è¯´æ˜</h3>
                        <button class="modal-close" onclick="closeMetricCalculation()">Ã—</button>
                    </div>
                    <div class="modal-body" id="metric-calculation-content" style="max-height: 70vh; overflow-y: auto;">
                    </div>
                </div>
            </div>
        </div>
        
        <!-- è®°å½•è¯¦æƒ…å¼¹çª— -->
        <div id="record-detail-modal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 800px;">
                <div class="modal-header">
                    <h3 id="record-modal-title">ğŸ“‹ è®°å½•è¯¦æƒ…</h3>
                    <button class="modal-close" onclick="closeRecordModal()">Ã—</button>
                </div>
                <div class="modal-body" id="record-modal-content" style="max-height: 70vh; overflow-y: auto;">
                </div>
            </div>
        </div>
        
        <!-- ç»Ÿè®¡ä¿¡æ¯å¼¹çª— -->
        <div id="stats-modal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 900px;">
                <div class="modal-header">
                    <h3 id="stats-modal-title">ğŸ“Š æ•°æ®ç»Ÿè®¡</h3>
                    <button class="modal-close" onclick="closeStatsModal()">Ã—</button>
                </div>
                <div class="modal-body" id="stats-modal-content" style="max-height: 70vh; overflow-y: auto;">
                </div>
            </div>
        </div>
        
        <!-- å®¡è®¡æ—¥å¿—å¼¹çª— -->
        <div id="audit-log-modal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 1000px;">
                <div class="modal-header">
                    <h3>ğŸ“‹ è’¸é¦å®¡è®¡æ—¥å¿—</h3>
                    <button class="modal-close" onclick="closeAuditLog()">Ã—</button>
                </div>
                <div class="modal-body">
                    <div id="audit-config" style="margin-bottom: 20px;"></div>
                    <div id="audit-log-content"></div>
                </div>
            </div>
        </div>
        
        <!-- æ­¥éª¤è¯¦æƒ…å¼¹çª— -->
        <div id="step-detail-modal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 800px;">
                <div class="modal-header">
                    <h3 id="step-modal-title">æ­¥éª¤è¯¦æƒ…</h3>
                    <button class="modal-close" onclick="closeStepModal()">Ã—</button>
                </div>
                <div class="modal-body" id="step-modal-content">
                </div>
            </div>
        </div>
        
        <!-- é€šç”¨è¿½è¸ªæ—¥å¿—å¼¹çª— -->
        <div id="trace-modal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 1100px;">
                <div class="modal-header">
                    <h3 id="trace-modal-title">ğŸ“‹ è¿‡ç¨‹è¿½è¸ª</h3>
                    <button class="modal-close" onclick="closeTraceModal()">Ã—</button>
                </div>
                <div class="modal-body" id="trace-modal-content" style="max-height: 70vh; overflow-y: auto;">
                </div>
            </div>
        </div>
        
        <!-- æŒ‡æ ‡è®¡ç®—è¯´æ˜æ¨¡æ€æ¡† -->
        <div id="metric-calculation-modal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 800px; max-height: 90vh;">
                <div class="modal-header">
                    <h3 id="metric-calculation-title">ğŸ“ æŒ‡æ ‡è®¡ç®—è¯´æ˜</h3>
                    <button class="modal-close" onclick="document.getElementById('metric-calculation-modal').style.display='none'">Ã—</button>
                </div>
                <div class="modal-body" style="max-height: calc(90vh - 100px); overflow-y: auto;">
                    <div style="margin-bottom: 20px; padding: 16px; background: rgba(79, 172, 254, 0.1); border-radius: 8px; border-left: 4px solid #4facfe;">
                        <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">è®¡ç®—å…¬å¼</div>
                        <div style="font-family: 'Courier New', monospace; font-size: 14px; color: #4facfe; font-weight: bold;" id="metric-calculation-formula"></div>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: var(--accent-primary); margin-bottom: 12px;">è®¡ç®—æ­¥éª¤</h4>
                        <ol id="metric-calculation-steps" style="margin-left: 20px; line-height: 2; font-size: 13px; color: var(--text-secondary);"></ol>
                    </div>
                    <div style="padding: 16px; background: rgba(16, 185, 129, 0.1); border-radius: 8px; border-left: 4px solid #10b981;">
                        <h4 style="color: #10b981; margin-bottom: 8px;">ğŸ’¡ æŒ‡æ ‡å«ä¹‰</h4>
                        <p style="font-size: 13px; line-height: 1.8; color: var(--text-secondary);" id="metric-calculation-meaning"></p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // API åŸºç¡€åœ°å€
        const API_BASE = '';
        
        // ============================================================
        // ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½
        // ============================================================
        
        // åˆå§‹åŒ–ä¸»é¢˜ï¼ˆä»localStorageè¯»å–æˆ–ä½¿ç”¨é»˜è®¤æ·±è‰²ä¸»é¢˜ï¼‰
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            switchTheme(savedTheme, false);
        }
        
        // åˆ‡æ¢ä¸»é¢˜
        function switchTheme(theme, save = true) {
            // ç§»é™¤æ‰€æœ‰ä¸»é¢˜å±æ€§
            document.documentElement.removeAttribute('data-theme');
            
            // åº”ç”¨æ–°ä¸»é¢˜
            if (theme !== 'dark') {
                document.documentElement.setAttribute('data-theme', theme);
            }
            
            // æ›´æ–°ä¸»é¢˜èœå•
            document.querySelectorAll('.theme-option').forEach(option => {
                option.classList.remove('active');
                const check = option.querySelector('.theme-option-check');
                if (check) check.style.display = 'none';
                
                if (option.dataset.theme === theme) {
                    option.classList.add('active');
                    const check = option.querySelector('.theme-option-check');
                    if (check) check.style.display = 'inline';
                }
            });
            
            // æ›´æ–°ä¸»é¢˜æ ‡ç­¾
            const themeLabels = {
                'dark': 'æ·±è‰²',
                'neutral': 'ä¸­æ€§',
                'bright': 'æ˜äº®'
            };
            const labelEl = document.getElementById('current-theme-label');
            if (labelEl) {
                labelEl.textContent = themeLabels[theme] || 'æ·±è‰²';
            }
            
            // ä¿å­˜åˆ°localStorage
            if (save) {
                localStorage.setItem('theme', theme);
            }
            
            // å…³é—­èœå•
            const menu = document.getElementById('theme-menu');
            if (menu) {
                menu.classList.remove('show');
            }
        }
        
        // åˆ‡æ¢ä¸»é¢˜èœå•æ˜¾ç¤º/éšè—
        function toggleThemeMenu() {
            const menu = document.getElementById('theme-menu');
            if (menu) {
                menu.classList.toggle('show');
            }
        }
        
        // ç‚¹å‡»å¤–éƒ¨å…³é—­èœå•
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('theme-menu');
            const switcher = document.querySelector('.theme-switcher');
            
            if (menu && switcher && !menu.contains(e.target) && !switcher.contains(e.target)) {
                menu.classList.remove('show');
            }
        });
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–ä¸»é¢˜
        initTheme();
        
        // ============================================================
        // é¡µé¢åˆ‡æ¢
        // ============================================================
        
        // é¡µé¢åˆ‡æ¢
        function switchPage(pageName) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            
            document.getElementById(`page-${pageName}`).classList.add('active');
            document.querySelector(`[data-page="${pageName}"]`).classList.add('active');
        }
        
        // å¯¼èˆªæ ‡ç­¾ç‚¹å‡»
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => switchPage(tab.dataset.page));
        });
        
        // ============================================================
        // å®¢æˆ·é¢„æµ‹
        // ============================================================
        
        // æ ¹æ®å®¢æˆ·ç±»å‹åˆ‡æ¢æ˜¾ç¤ºä¸åŒçš„å­—æ®µ
        function toggleCustomerTypeFields() {
            const customerType = document.getElementById('customer-type').value;
            const personalFields = document.getElementById('personal-fields');
            const enterpriseFields = document.getElementById('enterprise-fields');
            const ageField = document.getElementById('age-field');
            const yearsField = document.getElementById('years-field');
            
            // åˆ¤æ–­æ˜¯å¦ä¸ºä¸ªäººå®¢æˆ·
            const isPersonal = ['salaried', 'small_business', 'freelancer', 'farmer', 
                               'professional', 'entrepreneur', 'investor', 'retiree', 'student'].includes(customerType);
            
            // åˆ¤æ–­æ˜¯å¦ä¸ºä¼ä¸šå®¢æˆ·
            const isEnterprise = ['micro_enterprise', 'small_enterprise', 'medium_enterprise', 
                                'large_enterprise', 'startup', 'tech_startup', 'manufacturing', 
                                'trade_company', 'service_company'].includes(customerType);
            
            // æ˜¾ç¤º/éšè—ä¸ªäººå®¢æˆ·å­—æ®µ
            if (personalFields) {
                personalFields.style.display = isPersonal ? 'block' : 'none';
            }
            
            // æ˜¾ç¤º/éšè—ä¼ä¸šå®¢æˆ·å­—æ®µ
            if (enterpriseFields) {
                enterpriseFields.style.display = isEnterprise ? 'block' : 'none';
            }
            
            // æ˜¾ç¤º/éšè—å¹´é¾„å­—æ®µï¼ˆä¸ªäººå®¢æˆ·ï¼‰æˆ–æˆç«‹å¹´é™å­—æ®µï¼ˆä¼ä¸šå®¢æˆ·ï¼‰
            if (ageField) {
                ageField.style.display = isPersonal ? 'block' : 'none';
            }
            if (yearsField) {
                yearsField.style.display = isEnterprise ? 'block' : 'none';
            }
        }
        
        let currentCustomerData = null;
        let currentPredictionData = null;
        
        async function generateAndPredict() {
            const resultDiv = document.getElementById('prediction-result');
            resultDiv.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            document.getElementById('btn-customer-detail').style.display = 'none';
            
            const marketScenarios = {
                boom: { gdp_growth: 0.06, unemployment_rate: 0.04, base_rate: 0.035 },
                normal: { gdp_growth: 0.03, unemployment_rate: 0.05, base_rate: 0.04 },
                recession: { gdp_growth: 0.01, unemployment_rate: 0.07, base_rate: 0.045 },
                depression: { gdp_growth: -0.02, unemployment_rate: 0.10, base_rate: 0.03 }
            };
            
            const policyRates = {
                loose: 0.03,
                normal: 0.04,
                tight: 0.05
            };
            
            const scenario = document.getElementById('market-scenario').value;
            const policy = document.getElementById('market-policy').value;
            const market = marketScenarios[scenario];
            
            // åˆ¤æ–­å®¢æˆ·ç±»å‹
            const customerType = document.getElementById('customer-type').value;
            const isPersonal = ['salaried', 'small_business', 'freelancer', 'farmer', 
                               'professional', 'entrepreneur', 'investor', 'retiree', 'student'].includes(customerType);
            const isEnterprise = ['micro_enterprise', 'small_enterprise', 'medium_enterprise', 
                                'large_enterprise', 'startup', 'tech_startup', 'manufacturing', 
                                'trade_company', 'service_company'].includes(customerType);
            
            // æ”¶é›†å®¢æˆ·æ•°æ®
            const customerData = {
                customer_type: customerType,
                risk_profile: document.getElementById('risk-profile').value,
                industry: document.getElementById('customer-industry').value || null,
                city_tier: document.getElementById('customer-city').value || null,
            };
            
            // æ ¹æ®å®¢æˆ·ç±»å‹æ”¶é›†ä¸åŒçš„å­—æ®µ
            if (isPersonal) {
                // ä¸ªäººå®¢æˆ·å­—æ®µ
                const monthlyIncome = document.getElementById('personal-monthly-income').value;
                const incomeVolatility = document.getElementById('personal-income-volatility').value;
                const totalAssets = document.getElementById('personal-total-assets').value;
                const totalLiabilities = document.getElementById('personal-total-liabilities').value;
                const depositBalance = document.getElementById('personal-deposit-balance').value;
                const depositStability = document.getElementById('personal-deposit-stability').value;
                const yearsInBusiness = document.getElementById('personal-years-in-business').value;
                const previousLoans = document.getElementById('personal-previous-loans').value;
                const maxDpd = document.getElementById('personal-max-dpd').value;
                
                if (monthlyIncome) customerData.monthly_income = parseFloat(monthlyIncome);
                if (incomeVolatility) customerData.income_volatility = parseFloat(incomeVolatility) / 100;
                if (totalAssets) customerData.total_assets = parseFloat(totalAssets);
                if (totalLiabilities) customerData.total_liabilities = parseFloat(totalLiabilities);
                if (depositBalance) customerData.deposit_balance = parseFloat(depositBalance);
                if (depositStability) customerData.deposit_stability = parseFloat(depositStability) / 100;
                if (yearsInBusiness) customerData.years_in_business = parseFloat(yearsInBusiness);
                if (previousLoans) customerData.previous_loans = parseInt(previousLoans);
                if (maxDpd) customerData.max_historical_dpd = parseInt(maxDpd);
                
                // å¹´é¾„èŒƒå›´
                const ageRange = document.getElementById('customer-age').value;
                if (ageRange) customerData.age_range = ageRange;
            } else if (isEnterprise) {
                // ä¼ä¸šå®¢æˆ·å­—æ®µ
                const revenue = document.getElementById('enterprise-revenue').value;
                const netProfit = document.getElementById('enterprise-net-profit').value;
                const profitMargin = document.getElementById('enterprise-profit-margin').value;
                const cashFlow = document.getElementById('enterprise-cash-flow').value;
                const currentRatio = document.getElementById('enterprise-current-ratio').value;
                const quickRatio = document.getElementById('enterprise-quick-ratio').value;
                const debtRatio = document.getElementById('enterprise-debt-ratio').value;
                const revenueGrowth = document.getElementById('enterprise-revenue-growth').value;
                const rndRatio = document.getElementById('enterprise-rnd-ratio').value;
                const patents = document.getElementById('enterprise-patents').value;
                const legalDisputes = document.getElementById('enterprise-legal-disputes').value;
                const years = document.getElementById('enterprise-years').value;
                
                if (revenue) customerData.annual_revenue = parseFloat(revenue);
                if (netProfit) customerData.net_profit = parseFloat(netProfit);
                if (profitMargin) customerData.profit_margin = parseFloat(profitMargin) / 100;
                if (cashFlow) customerData.operating_cash_flow = parseFloat(cashFlow);
                if (currentRatio) customerData.current_ratio = parseFloat(currentRatio);
                if (quickRatio) customerData.quick_ratio = parseFloat(quickRatio);
                if (debtRatio) customerData.debt_ratio = parseFloat(debtRatio) / 100;
                if (revenueGrowth) customerData.revenue_growth_rate = parseFloat(revenueGrowth) / 100;
                if (rndRatio) customerData.rnd_expense_ratio = parseFloat(rndRatio) / 100;
                if (patents) customerData.total_patents = parseInt(patents);
                if (legalDisputes) customerData.legal_disputes = parseInt(legalDisputes);
                if (years) customerData.years_in_business = parseFloat(years);
                
                // æˆç«‹å¹´é™èŒƒå›´
                const yearsRange = document.getElementById('customer-years').value;
                if (yearsRange) customerData.years_range = yearsRange;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/predict`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        customer: customerData,
                        loan: {
                            amount: parseFloat(document.getElementById('loan-amount').value),
                            interest_rate: parseFloat(document.getElementById('loan-rate').value),
                            term_months: parseInt(document.getElementById('loan-term').value)
                        },
                        market: {
                            gdp_growth: market.gdp_growth,
                            unemployment_rate: market.unemployment_rate,
                            base_interest_rate: policyRates[policy],
                            inflation_rate: 0.02,
                            credit_spread: 0.02
                        }
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentCustomerData = data.customer;
                    currentPredictionData = data.prediction;
                    
                    const c = data.customer;
                    const p = data.prediction;
                    const l = data.loan;
                    
                    document.getElementById('btn-customer-detail').style.display = 'block';
                    
                    const riskClass = p.default_probability < 0.05 ? 'positive' : 
                                     p.default_probability < 0.15 ? 'warning' : 'negative';
                    const ltvClass = p.expected_ltv > 0 ? 'positive' : 'negative';
                    const riskPercent = Math.min(100, p.default_probability * 200);
                    const riskColor = riskPercent < 30 ? '#10b981' : riskPercent < 60 ? '#f59e0b' : '#ef4444';
                    
                    // è®¡ç®—å®¡æ‰¹å»ºè®®
                    let decision = 'é€šè¿‡';
                    let decisionClass = 'positive';
                    let decisionReasons = [];
                    
                    if (p.default_probability > 0.25) {
                        decision = 'æ‹’ç»';
                        decisionClass = 'negative';
                        decisionReasons.push('è¿çº¦é£é™©è¿‡é«˜');
                    } else if (p.default_probability > 0.15) {
                        decision = 'äººå·¥å®¡æ ¸';
                        decisionClass = 'warning';
                        decisionReasons.push('é£é™©å¤„äºè¾¹ç•Œ');
                    }
                    
                    if (c.debt_ratio > 0.6) {
                        if (decision === 'é€šè¿‡') { decision = 'äººå·¥å®¡æ ¸'; decisionClass = 'warning'; }
                        decisionReasons.push('è´Ÿå€ºç‡åé«˜');
                    }
                    
                    const monthlyPayment = l.monthly_payment || (l.amount * (l.interest_rate / 12) / (1 - Math.pow(1 + l.interest_rate/12, -l.term_months)));
                    const paymentRatio = monthlyPayment / c.monthly_income;
                    
                    if (paymentRatio > 0.5) {
                        if (decision === 'é€šè¿‡') { decision = 'äººå·¥å®¡æ ¸'; decisionClass = 'warning'; }
                        decisionReasons.push('æœˆä¾›å æ”¶å…¥æ¯”è¿‡é«˜');
                    }
                    
                    if (decisionReasons.length === 0) {
                        decisionReasons.push('å„é¡¹æŒ‡æ ‡æ­£å¸¸');
                    }
                    
                    resultDiv.innerHTML = `
                        <!-- å®¡æ‰¹å»ºè®® -->
                        <div class="stat-card" style="margin-bottom: 20px; border-left: 4px solid var(--accent-${decisionClass === 'positive' ? 'success' : decisionClass === 'warning' ? 'warning' : 'danger'});">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div class="stat-label">AI å®¡æ‰¹å»ºè®®</div>
                                    <div class="stat-value ${decisionClass}" style="font-size: 28px;">${decision}</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 12px; color: var(--text-muted);">å†³ç­–ä¾æ®</div>
                                    <div style="font-size: 13px; color: var(--text-secondary);">${decisionReasons.join('ã€')}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- æ ¸å¿ƒæŒ‡æ ‡ -->
                        <div class="grid grid-4" style="margin-bottom: 20px;">
                            <div class="stat-card">
                                <div class="stat-label">è¿çº¦æ¦‚ç‡</div>
                                <div class="stat-value ${riskClass}">${(p.default_probability * 100).toFixed(2)}%</div>
                                <div class="risk-meter">
                                    <div class="risk-meter-fill" style="width: ${riskPercent}%; background: ${riskColor};"></div>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">é¢„æœŸLTV</div>
                                <div class="stat-value ${ltvClass}">Â¥${p.expected_ltv.toLocaleString()}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">æµå¤±æ¦‚ç‡</div>
                                <div class="stat-value ${p.churn_probability < 0.2 ? 'positive' : 'warning'}">${(p.churn_probability * 100).toFixed(1)}%</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">æ¨¡å‹ç½®ä¿¡åº¦</div>
                                <div class="stat-value">${(p.confidence * 100).toFixed(0)}%</div>
                            </div>
                        </div>
                        
                        <!-- å®¢æˆ·æ¦‚è¦ -->
                        <h4 style="margin: 16px 0 12px; color: var(--text-secondary); font-size: 14px;">${c.is_enterprise ? 'ğŸ¢ ä¼ä¸šæ¦‚è¦' : 'ğŸ‘¤ å®¢æˆ·æ¦‚è¦'}</h4>
                        <div class="customer-profile" style="margin-bottom: 16px;">
                            <div class="profile-item">
                                <span class="profile-label">å®¢æˆ·ID</span>
                                <span class="profile-value">${c.customer_id}</span>
                            </div>
                            <div class="profile-item">
                                <span class="profile-label">ç±»å‹</span>
                                <span class="profile-value">${c.customer_type}</span>
                            </div>
                            <div class="profile-item">
                                <span class="profile-label">è¡Œä¸š</span>
                                <span class="profile-value">${c.industry}</span>
                            </div>
                            ${c.is_enterprise ? `
                            <div class="profile-item">
                                <span class="profile-label">æˆç«‹å¹´é™</span>
                                <span class="profile-value">${c.years_in_business}å¹´</span>
                            </div>
                            <div class="profile-item">
                                <span class="profile-label">å‘˜å·¥æ•°</span>
                                <span class="profile-value">${c.employee_count ? c.employee_count.toLocaleString() : '--'}äºº</span>
                            </div>
                            ` : `
                            <div class="profile-item">
                                <span class="profile-label">å¹´é¾„</span>
                                <span class="profile-value">${c.age}å²</span>
                            </div>
                            `}
                        </div>
                        
                        <!-- è´¢åŠ¡çŠ¶å†µ -->
                        <h4 style="margin: 16px 0 12px; color: var(--text-secondary); font-size: 14px;">ğŸ’° ${c.is_enterprise ? 'ä¼ä¸šè´¢åŠ¡' : 'ä¸ªäººè´¢åŠ¡'}</h4>
                        <div class="customer-profile" style="margin-bottom: 16px;">
                            ${c.is_enterprise ? `
                            <div class="profile-item">
                                <span class="profile-label">å¹´è¥ä¸šæ”¶å…¥</span>
                                <span class="profile-value">Â¥${(c.annual_revenue / 1e6).toFixed(2)}ç™¾ä¸‡</span>
                            </div>
                            <div class="profile-item">
                                <span class="profile-label">å‡€åˆ©æ¶¦</span>
                                <span class="profile-value ${c.net_profit < 0 ? 'negative' : ''}">Â¥${(c.net_profit / 1e6).toFixed(2)}ç™¾ä¸‡</span>
                            </div>
                            <div class="profile-item">
                                <span class="profile-label">å‡€åˆ©æ¶¦ç‡</span>
                                <span class="profile-value ${c.profit_margin < 0.05 ? 'negative' : c.profit_margin < 0.1 ? 'warning' : ''}">${(c.profit_margin * 100).toFixed(2)}%</span>
                            </div>
                            <div class="profile-item">
                                <span class="profile-label">æµåŠ¨æ¯”ç‡</span>
                                <span class="profile-value ${c.current_ratio < 1.2 ? 'negative' : c.current_ratio < 1.5 ? 'warning' : ''}">${c.current_ratio.toFixed(2)}</span>
                            </div>
                            <div class="profile-item">
                                <span class="profile-label">èµ„äº§è´Ÿå€ºç‡</span>
                                <span class="profile-value ${c.debt_ratio > 0.65 ? 'negative' : c.debt_ratio > 0.5 ? 'warning' : ''}">${(c.debt_ratio * 100).toFixed(1)}%</span>
                            </div>
                            <div class="profile-item">
                                <span class="profile-label">ç»è¥ç°é‡‘æµ</span>
                                <span class="profile-value ${c.operating_cash_flow < 0 ? 'negative' : ''}">Â¥${(c.operating_cash_flow / 1e6).toFixed(2)}ç™¾ä¸‡</span>
                            </div>
                            ` : `
                            <div class="profile-item">
                                <span class="profile-label">æœˆæ”¶å…¥</span>
                                <span class="profile-value">Â¥${c.monthly_income ? c.monthly_income.toLocaleString() : '--'}</span>
                            </div>
                            <div class="profile-item">
                                <span class="profile-label">è´Ÿå€ºç‡</span>
                                <span class="profile-value ${c.debt_ratio > 0.6 ? 'negative' : c.debt_ratio > 0.4 ? 'warning' : ''}">${(c.debt_ratio * 100).toFixed(1)}%</span>
                            </div>
                            <div class="profile-item">
                                <span class="profile-label">æœˆä¾›/æ”¶å…¥</span>
                                <span class="profile-value ${paymentRatio > 0.5 ? 'negative' : paymentRatio > 0.3 ? 'warning' : ''}">${(paymentRatio * 100).toFixed(1)}%</span>
                            </div>
                            <div class="profile-item">
                                <span class="profile-label">æœˆä¾›é‡‘é¢</span>
                                <span class="profile-value">Â¥${monthlyPayment.toLocaleString()}</span>
                            </div>
                            `}
                        </div>
                        
                        ${c.is_enterprise ? `
                        <!-- ä¼ä¸šä¸“ç”¨ä¿¡æ¯ -->
                        <h4 style="margin: 16px 0 12px; color: var(--text-secondary); font-size: 14px;">ğŸ”¬ åˆ›æ–°èƒ½åŠ›</h4>
                        <div class="customer-profile" style="margin-bottom: 16px;">
                            <div class="profile-item">
                                <span class="profile-label">ç ”å‘è´¹ç”¨</span>
                                <span class="profile-value">Â¥${(c.rnd_expense / 1e6).toFixed(2)}ç™¾ä¸‡</span>
                            </div>
                            <div class="profile-item">
                                <span class="profile-label">ç ”å‘è´¹ç”¨ç‡</span>
                                <span class="profile-value">${(c.rnd_expense_ratio * 100).toFixed(2)}%</span>
                            </div>
                            <div class="profile-item">
                                <span class="profile-label">ä¸“åˆ©æ€»æ•°</span>
                                <span class="profile-value">${c.total_patents || 0}é¡¹</span>
                            </div>
                            <div class="profile-item">
                                <span class="profile-label">å‘æ˜ä¸“åˆ©</span>
                                <span class="profile-value">${c.invention_patents || 0}é¡¹</span>
                            </div>
                            <div class="profile-item">
                                <span class="profile-label">åˆ›æ–°èƒ½åŠ›è¯„åˆ†</span>
                                <span class="profile-value ${c.innovation_score > 0.6 ? 'positive' : c.innovation_score > 0.3 ? 'warning' : 'negative'}">${(c.innovation_score * 100).toFixed(0)}</span>
                            </div>
                        </div>
                        
                        <h4 style="margin: 16px 0 12px; color: var(--text-secondary); font-size: 14px;">ğŸ“Š å¸‚åœºä¿¡æ¯</h4>
                        <div class="customer-profile" style="margin-bottom: 16px;">
                            <div class="profile-item">
                                <span class="profile-label">æ˜¯å¦ä¸Šå¸‚</span>
                                <span class="profile-value">${c.is_listed ? 'æ˜¯' : 'å¦'}</span>
                            </div>
                            ${c.is_listed ? `
                            <div class="profile-item">
                                <span class="profile-label">å¸‚å€¼</span>
                                <span class="profile-value">Â¥${(c.market_cap / 1e8).toFixed(2)}äº¿</span>
                            </div>
                            <div class="profile-item">
                                <span class="profile-label">è‚¡ä»·</span>
                                <span class="profile-value">Â¥${c.stock_price.toFixed(2)}</span>
                            </div>
                            ` : ''}
                            <div class="profile-item">
                                <span class="profile-label">ä¿¡ç”¨è¯„çº§</span>
                                <span class="profile-value ${c.credit_rating && c.credit_rating.startsWith('AAA') ? 'positive' : c.credit_rating && ['AA', 'A'].some(r => c.credit_rating.startsWith(r)) ? 'warning' : 'negative'}">${c.credit_rating || '--'}</span>
                            </div>
                            ${c.industry_ranking > 0 ? `
                            <div class="profile-item">
                                <span class="profile-label">è¡Œä¸šæ’å</span>
                                <span class="profile-value">ç¬¬${c.industry_ranking}å</span>
                            </div>
                            ` : ''}
                            ${c.market_share > 0 ? `
                            <div class="profile-item">
                                <span class="profile-label">å¸‚åœºä»½é¢</span>
                                <span class="profile-value">${c.market_share.toFixed(2)}%</span>
                            </div>
                            ` : ''}
                        </div>
                        ` : ''}
                        
                        <!-- ä¿¡ç”¨å†å² -->
                        <h4 style="margin: 16px 0 12px; color: var(--text-secondary); font-size: 14px;">ğŸ“Š ä¿¡ç”¨å†å²</h4>
                        <div class="customer-profile">
                            <div class="profile-item">
                                <span class="profile-label">é£é™©è¯„åˆ†</span>
                                <span class="profile-value">${c.risk_score.toFixed(2)}</span>
                            </div>
                            <div class="profile-item">
                                <span class="profile-label">å†å²é€¾æœŸ</span>
                                <span class="profile-value ${c.max_historical_dpd > 30 ? 'negative' : c.max_historical_dpd > 0 ? 'warning' : 'positive'}">${c.max_historical_dpd}å¤©</span>
                            </div>
                            <div class="profile-item">
                                <span class="profile-label">é¢„æœŸé€¾æœŸ</span>
                                <span class="profile-value">${p.expected_dpd.toFixed(0)}å¤©</span>
                            </div>
                            <div class="profile-item">
                                <span class="profile-label">å®¢æˆ·å¹´é™</span>
                                <span class="profile-value">${(c.months_as_customer / 12).toFixed(1)}å¹´</span>
                            </div>
                        </div>
                        
                        <!-- æ¨¡å‹è¯„ä¼°æŒ‡æ ‡è¯´æ˜ -->
                        <div class="card" style="margin-top: 20px; border: 1px solid var(--border-color);">
                            <div class="card-header" onclick="toggleMetricsExplanation()" style="cursor: pointer; padding: 16px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color);">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span style="font-size: 20px;">ğŸ“Š</span>
                                    <h4 style="margin: 0; font-size: 16px;">æ¨¡å‹è¯„ä¼°æŒ‡æ ‡è¯´æ˜</h4>
                                </div>
                                <span id="metrics-toggle-icon" style="font-size: 18px; transition: transform 0.3s;">â–¼</span>
                            </div>
                            <div id="metrics-explanation" style="display: none; padding: 20px;">
                                <div style="margin-bottom: 20px;">
                                    <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 16px;">
                                        ä»¥ä¸‹æŒ‡æ ‡ç”¨äºè¯„ä¼°æ¨¡å‹é¢„æµ‹çš„å‡†ç¡®æ€§å’Œå¯é æ€§ã€‚ç‚¹å‡» <a href="/model-terms" target="_blank" style="color: var(--accent-primary); text-decoration: underline;">æŸ¥çœ‹è¯¦ç»†æœ¯è¯­è§£é‡Š</a>
                                    </p>
                                </div>
                                
                                <div class="grid grid-2" style="gap: 16px; margin-bottom: 16px;">
                                    <!-- AUC -->
                                    <div class="metric-card" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1)); padding: 16px; border-radius: 8px; border-left: 4px solid #667eea;">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                            <div>
                                                <div style="font-weight: bold; color: #667eea; font-size: 14px;">AUC (ROCæ›²çº¿ä¸‹é¢ç§¯)</div>
                                                <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">æ¨¡å‹åŒºåˆ†èƒ½åŠ›</div>
                                            </div>
                                            <span class="badge" style="background: #17a2b8; color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px;">0.85</span>
                                        </div>
                                        <div style="font-size: 12px; color: var(--text-secondary); line-height: 1.6;">
                                            <strong>å«ä¹‰ï¼š</strong>è¡¡é‡æ¨¡å‹åŒºåˆ†"å¥½å®¢æˆ·"å’Œ"åå®¢æˆ·"çš„æ•´ä½“èƒ½åŠ›<br>
                                            <strong>é€šä¿—è§£é‡Šï¼š</strong>ç»™ä½ ä¸€ä¸ªå¥½äººä¸€ä¸ªå°å·ï¼Œæ¨¡å‹æœ‰85%çš„æ¦‚ç‡èƒ½æ­£ç¡®åŒºåˆ†<br>
                                            <strong>è¯„åˆ¤æ ‡å‡†ï¼š</strong>
                                            <span style="color: #28a745;">> 0.9 ä¼˜ç§€</span> | 
                                            <span style="color: #17a2b8;">0.8-0.9 è‰¯å¥½</span> | 
                                            <span style="color: #ffc107;">0.7-0.8 å¯æ¥å—</span>
                                        </div>
                                    </div>
                                    
                                    <!-- ç²¾ç¡®ç‡ -->
                                    <div class="metric-card" style="background: linear-gradient(135deg, rgba(240, 147, 251, 0.1), rgba(245, 87, 108, 0.1)); padding: 16px; border-radius: 8px; border-left: 4px solid #f5576c;">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                            <div>
                                                <div style="font-weight: bold; color: #f5576c; font-size: 14px;">ç²¾ç¡®ç‡ (Precision)</div>
                                                <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">é¿å…è¯¯æ‹’å¥½å®¢æˆ·</div>
                                            </div>
                                            <span class="badge" style="background: #17a2b8; color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px;">0.85</span>
                                        </div>
                                        <div style="font-size: 12px; color: var(--text-secondary); line-height: 1.6;">
                                            <strong>å«ä¹‰ï¼š</strong>é¢„æµ‹ä¸ºè¿çº¦çš„å®¢æˆ·ä¸­ï¼ŒçœŸæ­£è¿çº¦çš„æ¯”ä¾‹<br>
                                            <strong>é€šä¿—è§£é‡Šï¼š</strong>æ¨¡å‹é¢„æµ‹100ä¸ªä¼šè¿çº¦ï¼Œå…¶ä¸­85ä¸ªçœŸçš„è¿çº¦äº†<br>
                                            <strong>ä¸šåŠ¡å½±å“ï¼š</strong>ç²¾ç¡®ç‡é«˜ = è¯¯æ‹’ç‡ä½ï¼ˆé¿å…å¥½å®¢æˆ·è¢«æ‹’ç»ï¼‰<br>
                                            <strong>è¯„åˆ¤æ ‡å‡†ï¼š</strong>
                                            <span style="color: #28a745;">> 0.85 ä¼˜ç§€</span> | 
                                            <span style="color: #17a2b8;">0.75-0.85 è‰¯å¥½</span>
                                        </div>
                                    </div>
                                    
                                    <!-- å¬å›ç‡ -->
                                    <div class="metric-card" style="background: linear-gradient(135deg, rgba(79, 172, 254, 0.1), rgba(0, 242, 254, 0.1)); padding: 16px; border-radius: 8px; border-left: 4px solid #4facfe;">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                            <div>
                                                <div style="font-weight: bold; color: #4facfe; font-size: 14px;">å¬å›ç‡ (Recall)</div>
                                                <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">é¿å…æ¼æ£€åå®¢æˆ·</div>
                                            </div>
                                            <span class="badge" style="background: #ffc107; color: #333; padding: 4px 8px; border-radius: 12px; font-size: 11px;">0.72</span>
                                        </div>
                                        <div style="font-size: 12px; color: var(--text-secondary); line-height: 1.6;">
                                            <strong>å«ä¹‰ï¼š</strong>çœŸæ­£è¿çº¦çš„å®¢æˆ·ä¸­ï¼Œè¢«æ­£ç¡®è¯†åˆ«çš„æ¯”ä¾‹<br>
                                            <strong>é€šä¿—è§£é‡Šï¼š</strong>å®é™…100ä¸ªè¿çº¦ï¼Œæ¨¡å‹è¯†åˆ«å‡ºäº†72ä¸ª<br>
                                            <strong>ä¸šåŠ¡å½±å“ï¼š</strong>å¬å›ç‡é«˜ = æ¼æ£€ç‡ä½ï¼ˆé¿å…åå®¢æˆ·è¢«æ‰¹å‡†ï¼‰<br>
                                            <strong>è¯„åˆ¤æ ‡å‡†ï¼š</strong>
                                            <span style="color: #28a745;">> 0.80 ä¼˜ç§€</span> | 
                                            <span style="color: #17a2b8;">0.70-0.80 è‰¯å¥½</span>
                                        </div>
                                    </div>
                                    
                                    <!-- F1åˆ†æ•° -->
                                    <div class="metric-card" style="background: linear-gradient(135deg, rgba(250, 112, 154, 0.1), rgba(254, 225, 64, 0.1)); padding: 16px; border-radius: 8px; border-left: 4px solid #fa709a;">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                            <div>
                                                <div style="font-weight: bold; color: #fa709a; font-size: 14px;">F1åˆ†æ•° (F1-Score)</div>
                                                <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">ç²¾ç¡®ç‡å’Œå¬å›ç‡å¹³è¡¡</div>
                                            </div>
                                            <span class="badge" style="background: #17a2b8; color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px;">0.78</span>
                                        </div>
                                        <div style="font-size: 12px; color: var(--text-secondary); line-height: 1.6;">
                                            <strong>å«ä¹‰ï¼š</strong>ç²¾ç¡®ç‡å’Œå¬å›ç‡çš„è°ƒå’Œå¹³å‡æ•°<br>
                                            <strong>é€šä¿—è§£é‡Šï¼š</strong>ç»¼åˆè€ƒè™‘"ä¸è¯¯æ‹’å¥½å®¢æˆ·"å’Œ"ä¸æ¼æ£€åå®¢æˆ·"<br>
                                            <strong>ç”¨é€”ï¼š</strong>å½“éœ€è¦å¹³è¡¡ç²¾ç¡®ç‡å’Œå¬å›ç‡æ—¶ä½¿ç”¨<br>
                                            <strong>è¯„åˆ¤æ ‡å‡†ï¼š</strong>
                                            <span style="color: #28a745;">> 0.82 ä¼˜ç§€</span> | 
                                            <span style="color: #17a2b8;">0.72-0.82 è‰¯å¥½</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- æ··æ·†çŸ©é˜µè¯´æ˜ -->
                                <div style="margin-top: 20px; padding: 16px; background: #f8f9fa; border-radius: 8px;">
                                    <h5 style="margin: 0 0 12px; font-size: 14px; color: var(--text-secondary);">ğŸ“‹ æ··æ·†çŸ©é˜µè¯´æ˜</h5>
                                    <div style="display: grid; grid-template-columns: auto 1fr 1fr; gap: 8px; font-size: 12px;">
                                        <div></div>
                                        <div style="font-weight: bold; text-align: center; padding: 8px; background: #667eea; color: white; border-radius: 4px;">é¢„æµ‹æ­£å¸¸</div>
                                        <div style="font-weight: bold; text-align: center; padding: 8px; background: #667eea; color: white; border-radius: 4px;">é¢„æµ‹è¿çº¦</div>
                                        
                                        <div style="font-weight: bold; padding: 8px; display: flex; align-items: center;">å®é™…æ­£å¸¸</div>
                                        <div style="padding: 8px; background: #17a2b8; color: white; text-align: center; border-radius: 4px;">
                                            <strong>TN</strong><br>
                                            <small>çœŸè´Ÿä¾‹<br>(æ­£ç¡®è¯†åˆ«çš„å¥½å®¢æˆ·)</small>
                                        </div>
                                        <div style="padding: 8px; background: #ffc107; color: #333; text-align: center; border-radius: 4px;">
                                            <strong>FP</strong><br>
                                            <small>å‡æ­£ä¾‹<br>(è¯¯æ‹’çš„å¥½å®¢æˆ·)</small>
                                        </div>
                                        
                                        <div style="font-weight: bold; padding: 8px; display: flex; align-items: center;">å®é™…è¿çº¦</div>
                                        <div style="padding: 8px; background: #dc3545; color: white; text-align: center; border-radius: 4px;">
                                            <strong>FN</strong><br>
                                            <small>å‡è´Ÿä¾‹<br>(æ¼æ£€çš„åå®¢æˆ·)</small>
                                        </div>
                                        <div style="padding: 8px; background: #28a745; color: white; text-align: center; border-radius: 4px;">
                                            <strong>TP</strong><br>
                                            <small>çœŸæ­£ä¾‹<br>(æ­£ç¡®è¯†åˆ«çš„åå®¢æˆ·)</small>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- ä¸šåŠ¡æŒ‡æ ‡ -->
                                <div style="margin-top: 20px;">
                                    <h5 style="margin: 0 0 12px; font-size: 14px; color: var(--text-secondary);">ğŸ’¼ ä¸šåŠ¡æŒ‡æ ‡</h5>
                                    <div class="grid grid-3" style="gap: 12px;">
                                        <div style="padding: 12px; background: #f8f9fa; border-radius: 6px;">
                                            <div style="font-size: 11px; color: var(--text-muted);">è¯¯æ‹’ç‡</div>
                                            <div style="font-size: 16px; font-weight: bold; color: #28a745;">&lt; 5%</div>
                                            <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">é¿å…å¥½å®¢æˆ·è¢«æ‹’ç»</div>
                                        </div>
                                        <div style="padding: 12px; background: #f8f9fa; border-radius: 6px;">
                                            <div style="font-size: 11px; color: var(--text-muted);">æ¼æ£€ç‡</div>
                                            <div style="font-size: 16px; font-weight: bold; color: #17a2b8;">&lt; 10%</div>
                                            <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">é¿å…åå®¢æˆ·è¢«æ‰¹å‡†</div>
                                        </div>
                                        <div style="padding: 12px; background: #f8f9fa; border-radius: 6px;">
                                            <div style="font-size: 11px; color: var(--text-muted);">æ•´ä½“å‡†ç¡®ç‡</div>
                                            <div style="font-size: 16px; font-weight: bold; color: #667eea;">&gt; 85%</div>
                                            <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">æ¨¡å‹æ•´ä½“è¡¨ç°</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border-color); text-align: center;">
                                    <a href="/model-terms" target="_blank" style="color: var(--accent-primary); text-decoration: none; font-size: 13px;">
                                        ğŸ“– æŸ¥çœ‹å®Œæ•´æœ¯è¯­è§£é‡Š â†’
                                    </a>
                                </div>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="loading"><p style="color: var(--accent-danger);">é”™è¯¯: ${error.message}</p></div>`;
            }
        }
        
        function showCustomerDetail() {
            if (!currentCustomerData || !currentPredictionData) return;
            
            const c = currentCustomerData;
            const p = currentPredictionData;
            
            const content = `
                <div class="detail-section">
                    <div class="detail-section-title">ğŸ‘¤ åŸºæœ¬ä¿¡æ¯</div>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">å®¢æˆ·ID</div>
                            <div class="detail-value">${c.customer_id}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">å®¢æˆ·ç±»å‹</div>
                            <div class="detail-value">${c.customer_type}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">æ‰€å±è¡Œä¸š</div>
                            <div class="detail-value">${c.industry}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">åŸå¸‚ç­‰çº§</div>
                            <div class="detail-value">${c.city_tier || 'æœªçŸ¥'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">å¹´é¾„</div>
                            <div class="detail-value">${c.age}å²</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">ä»ä¸šå¹´é™</div>
                            <div class="detail-value">${c.years_in_business?.toFixed(1) || 0}å¹´</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">å®¢æˆ·å…³ç³»</div>
                            <div class="detail-value">${(c.months_as_customer / 12).toFixed(1)}å¹´</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">å†å²è´·æ¬¾</div>
                            <div class="detail-value" style="cursor: pointer; color: var(--accent-primary); text-decoration: underline;" 
                                 onclick="showLoanHistory('${c.customer_id}', ${c.previous_loans || 0})">
                                ${c.previous_loans || 0}ç¬” <span style="font-size: 12px;">ğŸ” æŸ¥çœ‹è¯¦æƒ…</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="detail-section">
                    <div class="detail-section-title">ğŸ’° è´¢åŠ¡çŠ¶å†µ</div>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">æœˆæ”¶å…¥</div>
                            <div class="detail-value">Â¥${c.monthly_income?.toLocaleString() || 0}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">æ”¶å…¥æ³¢åŠ¨æ€§</div>
                            <div class="detail-value ${c.income_volatility > 0.3 ? 'warning' : ''}">${((c.income_volatility || 0) * 100).toFixed(1)}%</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">è´Ÿå€ºç‡</div>
                            <div class="detail-value ${c.debt_ratio > 0.6 ? 'negative' : c.debt_ratio > 0.4 ? 'warning' : ''}">${((c.debt_ratio || 0) * 100).toFixed(1)}%</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">å€ºåŠ¡æ”¶å…¥æ¯”</div>
                            <div class="detail-value">${(c.debt_to_income || 0).toFixed(2)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">å­˜æ¬¾ä½™é¢</div>
                            <div class="detail-value">Â¥${(c.deposit_balance || 0).toLocaleString()}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">å­˜æ¬¾ç¨³å®šæ€§</div>
                            <div class="detail-value">${((c.deposit_stability || 0) * 100).toFixed(0)}%</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label" style="display: flex; align-items: center; gap: 6px;">
                                é£é™©è¯„åˆ†
                                <span style="cursor: pointer; color: var(--accent-primary); font-size: 14px;" 
                                      onclick="showRiskScoreDetail()" 
                                      title="ç‚¹å‡»æŸ¥çœ‹è¯¦ç»†è®¡ç®—è§„åˆ™">ğŸ”</span>
                            </div>
                            <div class="detail-value ${c.risk_score > 0.6 ? 'negative' : c.risk_score > 0.3 ? 'warning' : ''}" 
                                 style="cursor: pointer; text-decoration: underline;" 
                                 onclick="showRiskScoreDetail()">
                                ${(c.risk_score || 0).toFixed(3)}
                            </div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">å†å²æœ€å¤§é€¾æœŸ</div>
                            <div class="detail-value ${c.max_historical_dpd > 30 ? 'negative' : c.max_historical_dpd > 0 ? 'warning' : 'positive'}">${c.max_historical_dpd || 0}å¤©</div>
                        </div>
                    </div>
                </div>
                
                <div class="detail-section">
                    <div class="detail-section-title" style="display: flex; align-items: center; gap: 8px;">
                        <span class="ai-badge">AI</span>
                        ğŸ¯ AI é¢„æµ‹ç»“æœ
                        <span class="ai-confidence" style="margin-left: auto;">
                            <span>ç½®ä¿¡åº¦</span>
                            <div class="ai-confidence-bar">
                                <div class="ai-confidence-fill" style="width: ${(p.confidence || 0.7) * 100}%;"></div>
                            </div>
                            <span style="font-weight: 600;">${((p.confidence || 0.7) * 100).toFixed(0)}%</span>
                        </span>
                    </div>
                    
                    <!-- AIæ€è€ƒè¿‡ç¨‹ -->
                    <div class="ai-thinking" style="margin-bottom: 16px;">
                        <div class="ai-steps">
                            <div class="ai-step" style="animation-delay: 0s;">
                                <div class="ai-step-icon">1</div>
                                <div class="ai-step-content">
                                    <div class="ai-step-title">æ•°æ®ç‰¹å¾æå–</div>
                                    <div class="ai-step-desc">åˆ†æå®¢æˆ·${c.customer_type}çš„${Object.keys(c).length}ä¸ªç‰¹å¾ç»´åº¦</div>
                                </div>
                            </div>
                            <div class="ai-step" style="animation-delay: 0.2s;">
                                <div class="ai-step-icon">2</div>
                                <div class="ai-step-content">
                                    <div class="ai-step-title">é£é™©å› å­è®¡ç®—</div>
                                    <div class="ai-step-desc">è¯„ä¼°${c.risk_score > 0.5 ? 'é«˜é£é™©' : c.risk_score > 0.3 ? 'ä¸­é£é™©' : 'ä½é£é™©'}å®¢æˆ·çš„é£é™©å› å­</div>
                                </div>
                            </div>
                            <div class="ai-step" style="animation-delay: 0.4s;">
                                <div class="ai-step-icon">3</div>
                                <div class="ai-step-content">
                                    <div class="ai-step-title">ä¸–ç•Œæ¨¡å‹æ¨ç†</div>
                                    <div class="ai-step-desc">åŸºäºå†å²æ•°æ®è’¸é¦çš„"å•†ä¸šç‰©ç†å®šå¾‹"è¿›è¡Œé¢„æµ‹</div>
                                </div>
                            </div>
                            <div class="ai-step" style="animation-delay: 0.6s;">
                                <div class="ai-step-icon">âœ“</div>
                                <div class="ai-step-content">
                                    <div class="ai-step-title">é¢„æµ‹ç»“æœç”Ÿæˆ</div>
                                    <div class="ai-step-desc">ç»¼åˆ${p.confidence > 0.8 ? 'é«˜' : p.confidence > 0.6 ? 'ä¸­' : 'ä½'}ç½®ä¿¡åº¦ç”Ÿæˆæœ€ç»ˆé¢„æµ‹</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label" style="display: flex; align-items: center; gap: 6px;">
                                è¿çº¦æ¦‚ç‡
                                <span style="cursor: pointer; color: var(--accent-primary); font-size: 14px;" 
                                      onclick="showDefaultProbabilityDetail()" 
                                      title="ç‚¹å‡»æŸ¥çœ‹è¯¦ç»†è®¡ç®—è¿‡ç¨‹">ğŸ”</span>
                            </div>
                            <div class="detail-value ${p.default_probability < 0.05 ? 'positive' : p.default_probability < 0.15 ? 'warning' : 'negative'}" 
                                 style="cursor: pointer; text-decoration: underline;" 
                                 onclick="showDefaultProbabilityDetail()">
                                ${(p.default_probability * 100).toFixed(2)}%
                            </div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label" style="display: flex; align-items: center; gap: 6px;">
                                é¢„æœŸLTV
                                <span style="cursor: pointer; color: var(--accent-primary); font-size: 14px;" 
                                      onclick="showLTVExplanation()" 
                                      title="ç‚¹å‡»æŸ¥çœ‹LTVè¯¦ç»†è¯´æ˜">â“</span>
                            </div>
                            <div class="detail-value ${p.expected_ltv > 0 ? 'positive' : 'negative'}">Â¥${p.expected_ltv.toLocaleString()}</div>
                            <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">
                                ${p.expected_ltv > 0 ? 'âœ… èƒ½ä¸ºé“¶è¡Œå¸¦æ¥åˆ©æ¶¦' : p.expected_ltv < -5000 ? 'âŒ å¯èƒ½é€ æˆè¾ƒå¤§äºæŸ' : 'âš ï¸ åˆ©æ¶¦å¾®è–„æˆ–å¯èƒ½äºæŸ'}
                            </div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label" style="display: flex; align-items: center; gap: 6px;">
                                æµå¤±æ¦‚ç‡
                                <span style="cursor: pointer; color: var(--accent-primary); font-size: 14px;" 
                                      onclick="showChurnProbabilityDetail()" 
                                      title="ç‚¹å‡»æŸ¥çœ‹è¯¦ç»†è®¡ç®—è¿‡ç¨‹">ğŸ”</span>
                            </div>
                            <div class="detail-value ${p.churn_probability < 0.1 ? 'positive' : p.churn_probability < 0.25 ? 'warning' : 'negative'}" 
                                 style="cursor: pointer; text-decoration: underline;" 
                                 onclick="showChurnProbabilityDetail()">
                                ${(p.churn_probability * 100).toFixed(1)}%
                            </div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">é¢„æœŸé€¾æœŸå¤©æ•°</div>
                            <div class="detail-value">${p.expected_dpd.toFixed(0)}å¤©</div>
                        </div>
                    </div>
                </div>
                
                <div class="detail-section">
                    <div class="detail-section-title">ğŸ“Š é£é™©å› å­åˆ†æ</div>
                    <div class="analysis-card">
                        <div class="factor-bar">
                            <span class="factor-name">å®¢æˆ·ç±»å‹</span>
                            <div class="factor-bar-bg">
                                <div class="factor-bar-fill" style="width: ${c.customer_type === 'å·¥è–ªé˜¶å±‚' ? 20 : c.customer_type === 'å†œæˆ·' ? 40 : 60}%; background: ${c.customer_type === 'å·¥è–ªé˜¶å±‚' ? '#10b981' : c.customer_type === 'å†œæˆ·' ? '#f59e0b' : '#ef4444'};"></div>
                            </div>
                            <span class="factor-value" style="color: ${c.customer_type === 'å·¥è–ªé˜¶å±‚' ? '#10b981' : c.customer_type === 'å†œæˆ·' ? '#f59e0b' : '#ef4444'};">${c.customer_type === 'å·¥è–ªé˜¶å±‚' ? 'ä½' : c.customer_type === 'å†œæˆ·' ? 'ä¸­' : 'é«˜'}</span>
                        </div>
                        <div class="factor-bar">
                            <span class="factor-name">è´Ÿå€ºç‡</span>
                            <div class="factor-bar-bg">
                                <div class="factor-bar-fill" style="width: ${c.debt_ratio * 100}%; background: ${c.debt_ratio < 0.4 ? '#10b981' : c.debt_ratio < 0.6 ? '#f59e0b' : '#ef4444'};"></div>
                            </div>
                            <span class="factor-value">${(c.debt_ratio * 100).toFixed(0)}%</span>
                        </div>
                        <div class="factor-bar">
                            <span class="factor-name">æ”¶å…¥æ³¢åŠ¨</span>
                            <div class="factor-bar-bg">
                                <div class="factor-bar-fill" style="width: ${(c.income_volatility || 0) * 200}%; background: ${c.income_volatility < 0.2 ? '#10b981' : c.income_volatility < 0.4 ? '#f59e0b' : '#ef4444'};"></div>
                            </div>
                            <span class="factor-value">${((c.income_volatility || 0) * 100).toFixed(0)}%</span>
                        </div>
                        <div class="factor-bar">
                            <span class="factor-name">å­˜æ¬¾ç¨³å®š</span>
                            <div class="factor-bar-bg">
                                <div class="factor-bar-fill" style="width: ${(c.deposit_stability || 0) * 100}%; background: ${c.deposit_stability > 0.7 ? '#10b981' : c.deposit_stability > 0.5 ? '#f59e0b' : '#ef4444'};"></div>
                            </div>
                            <span class="factor-value">${((c.deposit_stability || 0) * 100).toFixed(0)}%</span>
                        </div>
                        <div class="factor-bar">
                            <span class="factor-name">å†å²é€¾æœŸ</span>
                            <div class="factor-bar-bg">
                                <div class="factor-bar-fill" style="width: ${Math.min(100, (c.max_historical_dpd || 0) / 90 * 100)}%; background: ${c.max_historical_dpd === 0 ? '#10b981' : c.max_historical_dpd < 30 ? '#f59e0b' : '#ef4444'};"></div>
                            </div>
                            <span class="factor-value">${c.max_historical_dpd || 0}å¤©</span>
                        </div>
                    </div>
                </div>
                
                <!-- AIæ™ºèƒ½å»ºè®® -->
                <div class="detail-section">
                    <div class="detail-section-title">
                        <span class="ai-badge">AI</span>
                        ğŸ’¡ AIæ™ºèƒ½å»ºè®®
                    </div>
                    <div class="ai-suggestion">
                        ${generateAISuggestions(c, p)}
                    </div>
                </div>
            `;
            
            document.getElementById('customer-detail-content').innerHTML = content;
            document.getElementById('customer-detail-modal').style.display = 'flex';
        }
        
        function closeCustomerDetail() {
            document.getElementById('customer-detail-modal').style.display = 'none';
        }
        
        // AIæ™ºèƒ½å»ºè®®ç”Ÿæˆå‡½æ•°
        function generateAISuggestions(customer, prediction) {
            const suggestions = [];
            
            // åŸºäºè¿çº¦æ¦‚ç‡çš„å»ºè®®
            if (prediction.default_probability > 0.25) {
                suggestions.push({
                    type: 'warning',
                    icon: 'âš ï¸',
                    title: 'é«˜é£é™©å®¢æˆ·',
                    content: `è¿çº¦æ¦‚ç‡${(prediction.default_probability * 100).toFixed(1)}%è¾ƒé«˜ï¼Œå»ºè®®ï¼šæé«˜åˆ©ç‡è‡³${(parseFloat(document.getElementById('loan-rate')?.value || 0.08) + 0.02).toFixed(2)}%æˆ–æ‹’ç»æ”¾è´·`
                });
            } else if (prediction.default_probability > 0.15) {
                suggestions.push({
                    type: 'warning',
                    icon: 'âš ï¸',
                    title: 'ä¸­é£é™©å®¢æˆ·',
                    content: `è¿çº¦æ¦‚ç‡${(prediction.default_probability * 100).toFixed(1)}%ä¸­ç­‰ï¼Œå»ºè®®ï¼šé€‚å½“æé«˜åˆ©ç‡æˆ–è¦æ±‚æä¾›æ‹…ä¿`
                });
            } else if (prediction.default_probability < 0.05) {
                suggestions.push({
                    type: 'success',
                    icon: 'âœ…',
                    title: 'ä¼˜è´¨å®¢æˆ·',
                    content: `è¿çº¦æ¦‚ç‡ä»…${(prediction.default_probability * 100).toFixed(1)}%ï¼Œå»ºè®®ï¼šå¯æä¾›ä¼˜æƒ åˆ©ç‡æˆ–å¢åŠ æˆä¿¡é¢åº¦`
                });
            }
            
            // åŸºäºLTVçš„å»ºè®®
            if (prediction.expected_ltv > 10000) {
                suggestions.push({
                    type: 'success',
                    icon: 'ğŸ’°',
                    title: 'é«˜ä»·å€¼å®¢æˆ·',
                    content: `é¢„æœŸLTVä¸ºÂ¥${prediction.expected_ltv.toLocaleString()}ï¼Œå»ºè®®ï¼šä¼˜å…ˆå®¡æ‰¹ï¼Œå¯è€ƒè™‘å»ºç«‹é•¿æœŸåˆä½œå…³ç³»`
                });
            } else if (prediction.expected_ltv < -5000) {
                suggestions.push({
                    type: 'danger',
                    icon: 'âŒ',
                    title: 'äºæŸé£é™©',
                    content: `é¢„æœŸLTVä¸ºè´Ÿå€¼Â¥${prediction.expected_ltv.toLocaleString()}ï¼Œå»ºè®®ï¼šæ‹’ç»æ”¾è´·æˆ–å¤§å¹…æé«˜åˆ©ç‡`
                });
            }
            
            // åŸºäºæµå¤±æ¦‚ç‡çš„å»ºè®®
            if (prediction.churn_probability > 0.3) {
                suggestions.push({
                    type: 'warning',
                    icon: 'ğŸ“‰',
                    title: 'é«˜æµå¤±é£é™©',
                    content: `æµå¤±æ¦‚ç‡${(prediction.churn_probability * 100).toFixed(1)}%è¾ƒé«˜ï¼Œå»ºè®®ï¼šæä¾›æ›´å…·ç«äº‰åŠ›çš„åˆ©ç‡æˆ–å¢å€¼æœåŠ¡`
                });
            }
            
            // åŸºäºé£é™©è¯„åˆ†çš„å»ºè®®
            if (customer.risk_score > 0.6) {
                suggestions.push({
                    type: 'danger',
                    icon: 'ğŸ”´',
                    title: 'é«˜é£é™©è¯„åˆ†',
                    content: `é£é™©è¯„åˆ†${customer.risk_score.toFixed(3)}è¾ƒé«˜ï¼Œå»ºè®®ï¼šè¦æ±‚æä¾›æŠµæŠ¼ç‰©æˆ–æ‹…ä¿äºº`
                });
            } else if (customer.risk_score < 0.2) {
                suggestions.push({
                    type: 'success',
                    icon: 'ğŸŸ¢',
                    title: 'ä½é£é™©è¯„åˆ†',
                    content: `é£é™©è¯„åˆ†${customer.risk_score.toFixed(3)}è¾ƒä½ï¼Œå»ºè®®ï¼šå¯æä¾›å¿«é€Ÿå®¡æ‰¹é€šé“`
                });
            }
            
            // åŸºäºè´Ÿå€ºç‡çš„å»ºè®®
            if (customer.debt_ratio > 0.7) {
                suggestions.push({
                    type: 'warning',
                    icon: 'ğŸ“Š',
                    title: 'é«˜è´Ÿå€ºç‡',
                    content: `è´Ÿå€ºç‡${(customer.debt_ratio * 100).toFixed(1)}%è¿‡é«˜ï¼Œå»ºè®®ï¼šé™ä½è´·æ¬¾é¢åº¦æˆ–å»¶é•¿è¿˜æ¬¾æœŸé™`
                });
            }
            
            // å¦‚æœæ²¡æœ‰å»ºè®®ï¼Œæä¾›é»˜è®¤å»ºè®®
            if (suggestions.length === 0) {
                suggestions.push({
                    type: 'info',
                    icon: 'â„¹ï¸',
                    title: 'æ ‡å‡†å®¢æˆ·',
                    content: `å®¢æˆ·é£é™©æ°´å¹³æ­£å¸¸ï¼Œå»ºè®®ï¼šæŒ‰ç…§æ ‡å‡†æµç¨‹å®¡æ‰¹ï¼Œåˆ©ç‡å¯å‚è€ƒå¸‚åœºå¹³å‡æ°´å¹³`
                });
            }
            
            // ç”ŸæˆHTML
            let html = '<div style="display: flex; flex-direction: column; gap: 12px;">';
            suggestions.forEach((suggestion, index) => {
                const colorMap = {
                    'success': '#10b981',
                    'warning': '#f59e0b',
                    'danger': '#ef4444',
                    'info': '#3b82f6'
                };
                const bgMap = {
                    'success': 'rgba(16, 185, 129, 0.1)',
                    'warning': 'rgba(245, 158, 11, 0.1)',
                    'danger': 'rgba(239, 68, 68, 0.1)',
                    'info': 'rgba(59, 130, 246, 0.1)'
                };
                
                html += `
                    <div style="padding: 12px; background: ${bgMap[suggestion.type]}; border-left: 4px solid ${colorMap[suggestion.type]}; border-radius: 8px; animation: fadeIn 0.5s ease ${index * 0.1}s both;">
                        <div style="display: flex; align-items: start; gap: 10px;">
                            <span style="font-size: 20px;">${suggestion.icon}</span>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: ${colorMap[suggestion.type]}; margin-bottom: 4px; font-size: 13px;">
                                    ${suggestion.title}
                                </div>
                                <div style="font-size: 12px; color: var(--text-secondary); line-height: 1.5;">
                                    ${suggestion.content}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            return html;
        }
        
        async function showLoanHistory(customerId, numLoans) {
            const modal = document.getElementById('loan-history-modal');
            const content = document.getElementById('loan-history-content');
            
            modal.style.display = 'flex';
            content.innerHTML = '<div class="loading"><div class="spinner"></div><p>åŠ è½½ä¸­...</p></div>';
            
            try {
                // ä¼ é€’å®¢æˆ·æ•°æ®ï¼Œç¡®ä¿èƒ½ç”Ÿæˆé€¾æœŸè´·æ¬¾
                const response = await fetch(`${API_BASE}/api/customer/loan-history`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        customer_id: customerId,
                        num_loans: numLoans,
                        customer_data: currentCustomerData  // ä¼ é€’å½“å‰å®¢æˆ·æ•°æ®
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const loans = data.loan_history || [];
                    
                    if (loans.length === 0) {
                        content.innerHTML = `
                            <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                                <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“­</div>
                                <p>è¯¥å®¢æˆ·æš‚æ— å†å²è´·æ¬¾è®°å½•</p>
                            </div>
                        `;
                    } else {
                        // ç»Ÿè®¡ä¿¡æ¯
                        const approved = loans.filter(l => l.approval_status === 'approved').length;
                        const completed = loans.filter(l => l.repayment_status === 'completed').length;
                        const overdue = loans.filter(l => l.repayment_status === 'overdue' || l.repayment_status === 'defaulted').length;
                        const totalAmount = loans.reduce((sum, l) => sum + (l.loan_amount || 0), 0);
                        const totalPaid = loans.reduce((sum, l) => sum + (l.total_paid || 0), 0);
                        const totalRemaining = loans.reduce((sum, l) => sum + (l.remaining_amount || 0), 0);
                        
                        let html = `
                            <div style="margin-bottom: 24px;">
                                <div class="grid grid-4" style="gap: 12px;">
                                    <div style="padding: 16px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1)); border-radius: 8px; border-left: 4px solid #667eea;">
                                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">æ€»è´·æ¬¾æ•°</div>
                                        <div style="font-size: 24px; font-weight: bold; color: #667eea;">${loans.length}ç¬”</div>
                                    </div>
                                    <div style="padding: 16px; background: linear-gradient(135deg, rgba(79, 172, 254, 0.1), rgba(0, 242, 254, 0.1)); border-radius: 8px; border-left: 4px solid #4facfe;">
                                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">å·²æ‰¹å‡†</div>
                                        <div style="font-size: 24px; font-weight: bold; color: #4facfe;">${approved}ç¬”</div>
                                    </div>
                                    <div style="padding: 16px; background: linear-gradient(135deg, rgba(250, 112, 154, 0.1), rgba(254, 225, 64, 0.1)); border-radius: 8px; border-left: 4px solid #fa709a;">
                                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">æ€»è´·æ¬¾é¢</div>
                                        <div style="font-size: 20px; font-weight: bold; color: #fa709a;">Â¥${(totalAmount / 10000).toFixed(1)}ä¸‡</div>
                                    </div>
                                    <div style="padding: 16px; background: linear-gradient(135deg, rgba(240, 147, 251, 0.1), rgba(245, 87, 108, 0.1)); border-radius: 8px; border-left: 4px solid #f5576c;">
                                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">é€¾æœŸ/è¿çº¦</div>
                                        <div style="font-size: 24px; font-weight: bold; color: ${overdue > 0 ? '#f5576c' : '#10b981'};">${overdue}ç¬”</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 16px; padding: 16px; background: rgba(102, 126, 234, 0.05); border-radius: 8px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <strong style="color: var(--text-secondary);">è¿˜æ¬¾ç»Ÿè®¡</strong>
                                </div>
                                <div class="grid grid-3" style="gap: 12px; margin-top: 12px;">
                                    <div>
                                        <div style="font-size: 12px; color: var(--text-muted);">å·²è¿˜é‡‘é¢</div>
                                        <div style="font-size: 18px; font-weight: bold; color: #10b981;">Â¥${(totalPaid / 10000).toFixed(2)}ä¸‡</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 12px; color: var(--text-muted);">å‰©ä½™é‡‘é¢</div>
                                        <div style="font-size: 18px; font-weight: bold; color: ${totalRemaining > 0 ? '#f59e0b' : '#10b981'};">Â¥${(totalRemaining / 10000).toFixed(2)}ä¸‡</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 12px; color: var(--text-muted);">å®Œæˆç‡</div>
                                        <div style="font-size: 18px; font-weight: bold; color: #4facfe;">${completed}/${approved} (${approved > 0 ? ((completed / approved) * 100).toFixed(0) : 0}%)</div>
                                    </div>
                                </div>
                            </div>
                            
                            <h4 style="margin: 24px 0 16px; color: var(--text-secondary); font-size: 16px;">ğŸ“‹ è´·æ¬¾æ˜ç»†</h4>
                            <div style="overflow-x: auto;">
                                <table class="data-sample-table" style="width: 100%; font-size: 13px;">
                                    <thead>
                                        <tr>
                                            <th>è´·æ¬¾ID</th>
                                            <th>ç”³è¯·æ—¥æœŸ</th>
                                            <th>å®¡æ‰¹çŠ¶æ€</th>
                                            <th>è´·æ¬¾é‡‘é¢</th>
                                            <th>æœŸé™</th>
                                            <th>åˆ©ç‡</th>
                                            <th>è¿˜æ¬¾çŠ¶æ€</th>
                                            <th>é€¾æœŸå¤©æ•°</th>
                                            <th>å·²è¿˜/å‰©ä½™</th>
                                            <th>ç”¨é€”</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                        `;
                        
                        loans.forEach(loan => {
                            const approvalColor = loan.approval_status === 'approved' ? '#10b981' : 
                                                  loan.approval_status === 'rejected' ? '#ef4444' : '#f59e0b';
                            const repaymentColor = loan.repayment_status === 'completed' ? '#10b981' :
                                                   loan.repayment_status === 'overdue' ? '#f59e0b' :
                                                   loan.repayment_status === 'defaulted' ? '#ef4444' : '#4facfe';
                            
                            html += `
                                <tr>
                                    <td><code style="font-size: 11px;">${loan.loan_id}</code></td>
                                    <td>${loan.apply_date}</td>
                                    <td>
                                        <span style="padding: 4px 8px; border-radius: 4px; background: ${approvalColor}20; color: ${approvalColor}; font-size: 11px;">
                                            ${loan.approval_status === 'approved' ? 'âœ“ å·²æ‰¹å‡†' : 
                                              loan.approval_status === 'rejected' ? 'âœ— å·²æ‹’ç»' : 'â³ å¾…å®¡æ‰¹'}
                                        </span>
                                    </td>
                                    <td><strong>Â¥${(loan.loan_amount / 10000).toFixed(2)}ä¸‡</strong></td>
                                    <td>${loan.term_months}ä¸ªæœˆ</td>
                                    <td>${(loan.interest_rate * 100).toFixed(2)}%</td>
                                    <td>
                                        <span style="padding: 4px 8px; border-radius: 4px; background: ${repaymentColor}20; color: ${repaymentColor}; font-size: 11px;">
                                            ${loan.repayment_status === 'completed' ? 'âœ“ å·²å®Œæˆ' :
                                              loan.repayment_status === 'ongoing' ? 'ğŸ”„ è¿›è¡Œä¸­' :
                                              loan.repayment_status === 'overdue' ? 'âš ï¸ é€¾æœŸ' :
                                              loan.repayment_status === 'defaulted' ? 'âŒ è¿çº¦' : 'N/A'}
                                        </span>
                                    </td>
                                    <td>
                                        ${loan.overdue_days > 0 ? 
                                          `<span style="color: #ef4444; font-weight: bold;">${loan.overdue_days}å¤©</span>` : 
                                          '<span style="color: #10b981;">0å¤©</span>'}
                                    </td>
                                    <td style="font-size: 11px;">
                                        <div>å·²è¿˜: Â¥${(loan.total_paid / 10000).toFixed(2)}ä¸‡</div>
                                        ${loan.remaining_amount > 0 ? 
                                          `<div style="color: #f59e0b;">å‰©ä½™: Â¥${(loan.remaining_amount / 10000).toFixed(2)}ä¸‡</div>` : 
                                          '<div style="color: #10b981;">å·²ç»“æ¸…</div>'}
                                    </td>
                                    <td>${loan.purpose}</td>
                                </tr>
                                ${loan.overdue_info ? `
                                <tr style="background: rgba(239, 68, 68, 0.05);">
                                    <td colspan="10" style="padding: 16px;">
                                        <div style="padding: 12px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border-left: 4px solid #ef4444;">
                                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                                                <span style="font-size: 18px;">âš ï¸</span>
                                                <strong style="color: #ef4444; font-size: 14px;">é€¾æœŸè¯¦ç»†ä¿¡æ¯</strong>
                                                <span style="padding: 2px 8px; background: #ef4444; color: white; border-radius: 12px; font-size: 11px;">
                                                    ${loan.overdue_info.overdue_severity}
                                                </span>
                                            </div>
                                            <div class="grid grid-4" style="gap: 12px; margin-bottom: 12px;">
                                                <div>
                                                    <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">é€¾æœŸå¼€å§‹æ—¥æœŸ</div>
                                                    <div style="font-size: 13px; font-weight: bold; color: var(--text-primary);">${loan.overdue_info.overdue_start_date}</div>
                                                </div>
                                                <div>
                                                    <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">é€¾æœŸæœŸæ•°</div>
                                                    <div style="font-size: 13px; font-weight: bold; color: var(--text-primary);">${loan.overdue_info.months_overdue}æœŸ</div>
                                                </div>
                                                <div>
                                                    <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">é€¾æœŸæœ¬é‡‘</div>
                                                    <div style="font-size: 13px; font-weight: bold; color: #f59e0b;">Â¥${(loan.overdue_info.overdue_principal / 10000).toFixed(2)}ä¸‡</div>
                                                </div>
                                                <div>
                                                    <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">é€¾æœŸåˆ©æ¯</div>
                                                    <div style="font-size: 13px; font-weight: bold; color: #f59e0b;">Â¥${(loan.overdue_info.overdue_interest / 10000).toFixed(2)}ä¸‡</div>
                                                </div>
                                            </div>
                                            <div class="grid grid-3" style="gap: 12px;">
                                                <div>
                                                    <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">ç½šæ¯é‡‘é¢</div>
                                                    <div style="font-size: 13px; font-weight: bold; color: #ef4444;">Â¥${(loan.overdue_info.overdue_penalty / 10000).toFixed(2)}ä¸‡</div>
                                                </div>
                                                <div>
                                                    <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">é€¾æœŸæ€»é‡‘é¢</div>
                                                    <div style="font-size: 16px; font-weight: bold; color: #ef4444;">Â¥${(loan.overdue_info.total_overdue_amount / 10000).toFixed(2)}ä¸‡</div>
                                                </div>
                                                <div>
                                                    <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">é€¾æœŸå¤©æ•°</div>
                                                    <div style="font-size: 16px; font-weight: bold; color: ${loan.overdue_info.overdue_days > 90 ? '#ef4444' : loan.overdue_info.overdue_days > 30 ? '#f59e0b' : '#fbbf24'};">
                                                        ${loan.overdue_info.overdue_days}å¤©
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                ` : ''}
                            `;
                        });
                        
                        html += `
                                    </tbody>
                                </table>
                            </div>
                        `;
                        
                        content.innerHTML = html;
                    }
                } else {
                    content.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: var(--text-danger);">
                            <p>åŠ è½½å¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                content.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-danger);">
                        <p>åŠ è½½å¤±è´¥: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        function closeLoanHistory() {
            document.getElementById('loan-history-modal').style.display = 'none';
        }
        
        async function showDefaultProbabilityDetail() {
            console.log('showDefaultProbabilityDetail called');
            if (!currentCustomerData || !currentPredictionData) {
                alert('è¯·å…ˆç”Ÿæˆå®¢æˆ·å¹¶é¢„æµ‹');
                return;
            }
            
            const modal = document.getElementById('default-probability-modal');
            const content = document.getElementById('default-probability-content');
            
            if (!modal) {
                console.error('Modal not found: default-probability-modal');
                alert('æ¨¡æ€æ¡†æœªæ‰¾åˆ°ï¼Œè¯·åˆ·æ–°é¡µé¢');
                return;
            }
            
            if (!content) {
                console.error('Content not found: default-probability-content');
                alert('å†…å®¹åŒºåŸŸæœªæ‰¾åˆ°ï¼Œè¯·åˆ·æ–°é¡µé¢');
                return;
            }
            
            modal.style.display = 'flex';
            content.innerHTML = '<div class="loading"><div class="spinner"></div><p>è®¡ç®—ä¸­...</p></div>';
            
            try {
                // è·å–å½“å‰è´·æ¬¾å’Œå¸‚åœºæ•°æ®
                const loanAmount = parseFloat(document.getElementById('loan-amount')?.value || 100000);
                const loanRate = parseFloat(document.getElementById('loan-rate')?.value || 0.08);
                const loanTerm = parseInt(document.getElementById('loan-term')?.value || 24);
                
                const scenario = document.getElementById('market-scenario')?.value || 'normal';
                const policy = document.getElementById('market-policy')?.value || 'normal';
                
                const marketScenarios = {
                    boom: { gdp_growth: 0.06, unemployment_rate: 0.04, base_rate: 0.035 },
                    normal: { gdp_growth: 0.03, unemployment_rate: 0.05, base_rate: 0.04 },
                    recession: { gdp_growth: 0.01, unemployment_rate: 0.07, base_rate: 0.045 },
                    depression: { gdp_growth: -0.02, unemployment_rate: 0.10, base_rate: 0.03 }
                };
                const policyRates = {
                    loose: 0.03,
                    normal: 0.04,
                    tight: 0.05
                };
                
                const market = marketScenarios[scenario];
                
                const response = await fetch(`${API_BASE}/api/customer/default-probability-detail`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        customer: currentCustomerData,
                        prediction: currentPredictionData,
                        loan: {
                            amount: loanAmount,
                            interest_rate: loanRate,
                            term_months: loanTerm
                        },
                        market: {
                            gdp_growth: market.gdp_growth,
                            unemployment_rate: market.unemployment_rate,
                            base_interest_rate: policyRates[policy],
                            inflation_rate: 0.02,
                            credit_spread: 0.02
                        }
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const steps = data.calculation_steps || [];
                    const summary = data.summary || {};
                    
                    let html = `
                        <div style="margin-bottom: 24px;">
                            <div style="padding: 20px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1)); border-radius: 12px; border-left: 4px solid #667eea;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                    <div>
                                        <h4 style="margin: 0 0 8px; color: var(--text-secondary); font-size: 16px;">ğŸ“Š è®¡ç®—ç»“æœæ‘˜è¦</h4>
                                        <div style="font-size: 24px; font-weight: bold; color: ${summary.risk_level === 'é«˜é£é™©' ? '#ef4444' : summary.risk_level === 'ä¸­é£é™©' ? '#f59e0b' : '#10b981'};">
                                            ${(data.final_probability * 100).toFixed(2)}%
                                        </div>
                                        <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">
                                            é£é™©ç­‰çº§: <strong style="color: ${summary.risk_level === 'é«˜é£é™©' ? '#ef4444' : summary.risk_level === 'ä¸­é£é™©' ? '#f59e0b' : '#10b981'};">${summary.risk_level}</strong>
                                        </div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 12px; color: var(--text-muted);">é£é™©å€æ•°</div>
                                        <div style="font-size: 20px; font-weight: bold; color: #667eea;">${summary.risk_multiplier.toFixed(2)}Ã—</div>
                                    </div>
                                </div>
                                <div class="grid grid-3" style="gap: 12px; margin-top: 16px;">
                                    <div style="padding: 12px; background: rgba(255, 255, 255, 0.05); border-radius: 8px;">
                                        <div style="font-size: 11px; color: var(--text-muted);">åŸºç¡€è¿çº¦ç‡</div>
                                        <div style="font-size: 18px; font-weight: bold; color: #4facfe;">${(summary.base_risk * 100).toFixed(2)}%</div>
                                    </div>
                                    <div style="padding: 12px; background: rgba(255, 255, 255, 0.05); border-radius: 8px;">
                                        <div style="font-size: 11px; color: var(--text-muted);">è°ƒæ•´åé£é™©</div>
                                        <div style="font-size: 18px; font-weight: bold; color: #fa709a;">${(summary.adjusted_risk * 100).toFixed(2)}%</div>
                                    </div>
                                    <div style="padding: 12px; background: rgba(255, 255, 255, 0.05); border-radius: 8px;">
                                        <div style="font-size: 11px; color: var(--text-muted);">é£é™©å› å­æ•°</div>
                                        <div style="font-size: 18px; font-weight: bold; color: #667eea;">${data.total_factors}ä¸ª</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 16px; padding: 16px; background: rgba(102, 126, 234, 0.05); border-radius: 8px;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                                <span style="font-size: 18px;">ğŸ“</span>
                                <strong style="color: var(--text-secondary);">è®¡ç®—å…¬å¼</strong>
                            </div>
                            <div style="font-family: 'Courier New', monospace; background: rgba(0, 0, 0, 0.3); padding: 12px; border-radius: 6px; font-size: 13px; color: #4facfe;">
                                ${data.formula}
                            </div>
                        </div>
                        
                        <h4 style="margin: 24px 0 16px; color: var(--text-secondary); font-size: 16px;">ğŸ”¢ è®¡ç®—æ­¥éª¤</h4>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                    `;
                    
                    steps.forEach((step, index) => {
                        const isBase = step.step === 1;
                        const factorValue = step.value;
                        const isIncrease = factorValue > 1.0;
                        const isDecrease = factorValue < 1.0;
                        
                        html += `
                            <div style="padding: 16px; background: ${isBase ? 'rgba(102, 126, 234, 0.1)' : 'rgba(255, 255, 255, 0.03)'}; border-radius: 8px; border-left: 4px solid ${isBase ? '#667eea' : isIncrease ? '#f59e0b' : isDecrease ? '#10b981' : '#4facfe'};">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                    <div style="flex: 1;">
                                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                            <span style="font-size: 12px; padding: 2px 8px; background: ${isBase ? '#667eea' : '#4facfe'}; color: white; border-radius: 12px;">æ­¥éª¤ ${step.step}</span>
                                            <strong style="color: var(--text-secondary); font-size: 14px;">${step.name}</strong>
                                        </div>
                                        <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">${step.description}</div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 18px; font-weight: bold; color: ${isIncrease ? '#f59e0b' : isDecrease ? '#10b981' : '#4facfe'};">
                                            ${isBase ? (step.value * 100).toFixed(2) + '%' : step.value.toFixed(4)}
                                        </div>
                                        ${!isBase ? `
                                            <div style="font-size: 11px; color: var(--text-muted); margin-top: 2px;">
                                                ${step.impact}
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                                <div style="margin-top: 12px; padding: 10px; background: rgba(0, 0, 0, 0.2); border-radius: 6px;">
                                    <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">è®¡ç®—è¿‡ç¨‹:</div>
                                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #4facfe;">
                                        ${step.formula}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `
                        </div>
                        
                        <div style="margin-top: 24px; padding: 16px; background: rgba(79, 172, 254, 0.1); border-radius: 8px; border-left: 4px solid #4facfe;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                                <span style="font-size: 18px;">âœ…</span>
                                <strong style="color: var(--text-secondary);">æœ€ç»ˆç»“æœ</strong>
                            </div>
                            <div style="font-size: 20px; font-weight: bold; color: ${data.final_probability > 0.25 ? '#ef4444' : data.final_probability > 0.10 ? '#f59e0b' : '#10b981'};">
                                è¿çº¦æ¦‚ç‡ = ${(data.final_probability * 100).toFixed(2)}%
                            </div>
                            <div style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">
                                ç»è¿‡ ${data.total_factors} ä¸ªé£é™©å› å­çš„è°ƒæ•´ï¼Œä»åŸºç¡€è¿çº¦ç‡ ${(summary.base_risk * 100).toFixed(2)}% 
                                è°ƒæ•´ä¸º ${(data.final_probability * 100).toFixed(2)}%ï¼Œé£é™©å€æ•° ${summary.risk_multiplier.toFixed(2)}Ã—
                            </div>
                        </div>
                    `;
                    
                    content.innerHTML = html;
                } else {
                    content.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: var(--text-danger);">
                            <p>è®¡ç®—å¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('è¿çº¦æ¦‚ç‡è¯¦æƒ…åŠ è½½é”™è¯¯:', error);
                content.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-danger);">
                        <p>è®¡ç®—å¤±è´¥: ${error.message}</p>
                        <p style="font-size: 12px; color: var(--text-muted); margin-top: 10px;">è¯·æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯</p>
                    </div>
                `;
            }
        }
        
        function closeDefaultProbabilityDetail() {
            document.getElementById('default-probability-modal').style.display = 'none';
        }
        
        function showLTVExplanation() {
            document.getElementById('ltv-explanation-modal').style.display = 'flex';
        }
        
        function closeLTVExplanation() {
            document.getElementById('ltv-explanation-modal').style.display = 'none';
        }
        
        async function showChurnProbabilityDetail() {
            console.log('showChurnProbabilityDetail called');
            if (!currentCustomerData || !currentPredictionData) {
                alert('è¯·å…ˆç”Ÿæˆå®¢æˆ·å¹¶é¢„æµ‹');
                return;
            }
            
            const modal = document.getElementById('churn-probability-modal');
            const content = document.getElementById('churn-probability-content');
            
            if (!modal || !content) {
                alert('æ¨¡æ€æ¡†æœªæ‰¾åˆ°ï¼Œè¯·åˆ·æ–°é¡µé¢');
                return;
            }
            
            modal.style.display = 'flex';
            content.innerHTML = '<div class="loading"><div class="spinner"></div><p>è®¡ç®—ä¸­...</p></div>';
            
            try {
                const loanAmount = parseFloat(document.getElementById('loan-amount')?.value || 100000);
                const loanRate = parseFloat(document.getElementById('loan-rate')?.value || 0.08);
                const loanTerm = parseInt(document.getElementById('loan-term')?.value || 24);
                
                const scenario = document.getElementById('market-scenario')?.value || 'normal';
                const policy = document.getElementById('market-policy')?.value || 'normal';
                
                const marketScenarios = {
                    boom: { gdp_growth: 0.06, unemployment_rate: 0.04, base_rate: 0.035 },
                    normal: { gdp_growth: 0.03, unemployment_rate: 0.05, base_rate: 0.04 },
                    recession: { gdp_growth: 0.01, unemployment_rate: 0.07, base_rate: 0.045 },
                    depression: { gdp_growth: -0.02, unemployment_rate: 0.10, base_rate: 0.03 }
                };
                const policyRates = {
                    loose: 0.03,
                    normal: 0.04,
                    tight: 0.05
                };
                
                const market = marketScenarios[scenario];
                
                const response = await fetch(`${API_BASE}/api/customer/churn-probability-detail`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        customer: currentCustomerData,
                        prediction: currentPredictionData,
                        loan: {
                            amount: loanAmount,
                            interest_rate: loanRate,
                            term_months: loanTerm
                        },
                        market: {
                            gdp_growth: market.gdp_growth,
                            unemployment_rate: market.unemployment_rate,
                            base_interest_rate: policyRates[policy],
                            inflation_rate: 0.02,
                            credit_spread: 0.02
                        }
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const steps = data.calculation_steps || [];
                    const summary = data.summary || {};
                    
                    let html = `
                        <div style="margin-bottom: 24px;">
                            <div style="padding: 20px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1)); border-radius: 12px; border-left: 4px solid #667eea;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                    <div>
                                        <h4 style="margin: 0 0 8px; color: var(--text-secondary); font-size: 16px;">ğŸ“Š è®¡ç®—ç»“æœæ‘˜è¦</h4>
                                        <div style="font-size: 24px; font-weight: bold; color: ${summary.risk_level === 'é«˜é£é™©' ? '#ef4444' : summary.risk_level === 'ä¸­é£é™©' ? '#f59e0b' : '#10b981'};">
                                            ${(data.final_probability * 100).toFixed(2)}%
                                        </div>
                                        <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">
                                            é£é™©ç­‰çº§: <strong style="color: ${summary.risk_level === 'é«˜é£é™©' ? '#ef4444' : summary.risk_level === 'ä¸­é£é™©' ? '#f59e0b' : '#10b981'};">${summary.risk_level}</strong>
                                        </div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 12px; color: var(--text-muted);">æµå¤±å€æ•°</div>
                                        <div style="font-size: 20px; font-weight: bold; color: #667eea;">${summary.churn_multiplier.toFixed(2)}Ã—</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 16px; padding: 16px; background: rgba(102, 126, 234, 0.05); border-radius: 8px;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                                <span style="font-size: 18px;">ğŸ“</span>
                                <strong style="color: var(--text-secondary);">è®¡ç®—å…¬å¼</strong>
                            </div>
                            <div style="font-family: 'Courier New', monospace; background: rgba(0, 0, 0, 0.3); padding: 12px; border-radius: 6px; font-size: 13px; color: #4facfe;">
                                ${data.formula}
                            </div>
                        </div>
                        
                        <h4 style="margin: 24px 0 16px; color: var(--text-secondary); font-size: 16px;">ğŸ”¢ è®¡ç®—æ­¥éª¤</h4>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                    `;
                    
                    steps.forEach((step, index) => {
                        const isBase = step.step === 1;
                        const stepValue = step.value;
                        const isIncrease = stepValue > 0;
                        
                        html += `
                            <div style="padding: 16px; background: ${isBase ? 'rgba(102, 126, 234, 0.1)' : 'rgba(255, 255, 255, 0.03)'}; border-radius: 8px; border-left: 4px solid ${isBase ? '#667eea' : isIncrease ? '#f59e0b' : '#10b981'};">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                    <div style="flex: 1;">
                                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                            <span style="font-size: 12px; padding: 2px 8px; background: ${isBase ? '#667eea' : '#4facfe'}; color: white; border-radius: 12px;">æ­¥éª¤ ${step.step}</span>
                                            <strong style="color: var(--text-secondary); font-size: 14px;">${step.name}</strong>
                                        </div>
                                        <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">${step.description}</div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 18px; font-weight: bold; color: ${isIncrease ? '#f59e0b' : '#10b981'};">
                                            ${isBase ? (step.value * 100).toFixed(2) + '%' : '+' + (step.value * 100).toFixed(2) + '%'}
                                        </div>
                                        <div style="font-size: 11px; color: var(--text-muted); margin-top: 2px;">
                                            ${step.impact}
                                        </div>
                                    </div>
                                </div>
                                <div style="margin-top: 12px; padding: 10px; background: rgba(0, 0, 0, 0.2); border-radius: 6px;">
                                    <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">è®¡ç®—è¿‡ç¨‹:</div>
                                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #4facfe;">
                                        ${step.formula}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `
                        </div>
                        
                        <div style="margin-top: 24px; padding: 16px; background: rgba(79, 172, 254, 0.1); border-radius: 8px; border-left: 4px solid #4facfe;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                                <span style="font-size: 18px;">âœ…</span>
                                <strong style="color: var(--text-secondary);">æœ€ç»ˆç»“æœ</strong>
                            </div>
                            <div style="font-size: 20px; font-weight: bold; color: ${data.final_probability > 0.3 ? '#ef4444' : data.final_probability > 0.15 ? '#f59e0b' : '#10b981'};">
                                æµå¤±æ¦‚ç‡ = ${(data.final_probability * 100).toFixed(2)}%
                            </div>
                            <div style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">
                                ä»åŸºç¡€æµå¤±ç‡ ${(summary.base_churn * 100).toFixed(2)}% 
                                è°ƒæ•´ä¸º ${(data.final_probability * 100).toFixed(2)}%ï¼Œæµå¤±å€æ•° ${summary.churn_multiplier.toFixed(2)}Ã—
                            </div>
                        </div>
                    `;
                    
                    content.innerHTML = html;
                } else {
                    content.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: var(--text-danger);">
                            <p>è®¡ç®—å¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('æµå¤±æ¦‚ç‡è¯¦æƒ…åŠ è½½é”™è¯¯:', error);
                content.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-danger);">
                        <p>è®¡ç®—å¤±è´¥: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        function closeChurnProbabilityDetail() {
            document.getElementById('churn-probability-modal').style.display = 'none';
        }
        
        async function showRiskScoreDetail() {
            console.log('showRiskScoreDetail called');
            if (!currentCustomerData) {
                alert('è¯·å…ˆç”Ÿæˆå®¢æˆ·');
                return;
            }
            
            const modal = document.getElementById('risk-score-modal');
            const content = document.getElementById('risk-score-content');
            
            if (!modal || !content) {
                alert('æ¨¡æ€æ¡†æœªæ‰¾åˆ°ï¼Œè¯·åˆ·æ–°é¡µé¢');
                return;
            }
            
            modal.style.display = 'flex';
            content.innerHTML = '<div class="loading"><div class="spinner"></div><p>è®¡ç®—ä¸­...</p></div>';
            
            try {
                const response = await fetch(`${API_BASE}/api/customer/risk-score-detail`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        customer: currentCustomerData
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const steps = data.calculation_steps || [];
                    const summary = data.summary || {};
                    
                    let html = `
                        <div style="margin-bottom: 24px;">
                            <div style="padding: 20px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1)); border-radius: 12px; border-left: 4px solid #667eea;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                    <div>
                                        <h4 style="margin: 0 0 8px; color: var(--text-secondary); font-size: 16px;">ğŸ“Š é£é™©è¯„åˆ†ç»“æœ</h4>
                                        <div style="font-size: 32px; font-weight: bold; color: ${summary.risk_level === 'é«˜é£é™©' ? '#ef4444' : summary.risk_level === 'ä¸­é£é™©' ? '#f59e0b' : '#10b981'};">
                                            ${data.final_score.toFixed(3)}
                                        </div>
                                        <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">
                                            é£é™©ç­‰çº§: <strong style="color: ${summary.risk_level === 'é«˜é£é™©' ? '#ef4444' : summary.risk_level === 'ä¸­é£é™©' ? '#f59e0b' : '#10b981'};">${summary.risk_level}</strong>
                                        </div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 12px; color: var(--text-muted);">è¯„åˆ†èŒƒå›´</div>
                                        <div style="font-size: 16px; font-weight: bold; color: #667eea;">0.0 - 1.0</div>
                                        <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">
                                            å…±${summary.total_factors}ä¸ªå› å­
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 16px; padding: 16px; background: rgba(102, 126, 234, 0.05); border-radius: 8px;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                                <span style="font-size: 18px;">ğŸ“</span>
                                <strong style="color: var(--text-secondary);">è®¡ç®—å…¬å¼</strong>
                            </div>
                            <div style="font-family: 'Courier New', monospace; background: rgba(0, 0, 0, 0.3); padding: 12px; border-radius: 6px; font-size: 13px; color: #4facfe;">
                                ${data.formula}
                            </div>
                            <div style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">
                                æ³¨ï¼šé£é™©è¯„åˆ†è¶Šé«˜ï¼Œè¡¨ç¤ºå®¢æˆ·é£é™©è¶Šå¤§ã€‚è¯„åˆ†èŒƒå›´0-1ï¼Œæœ€ç»ˆç»“æœé™åˆ¶åœ¨0-1ä¹‹é—´ã€‚
                            </div>
                        </div>
                        
                        <h4 style="margin: 24px 0 16px; color: var(--text-secondary); font-size: 16px;">ğŸ”¢ è®¡ç®—æ­¥éª¤</h4>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                    `;
                    
                    let cumulativeScore = 0.0;
                    steps.forEach((step, index) => {
                        cumulativeScore += step.value;
                        const isPositive = step.value > 0;
                        
                        html += `
                            <div style="padding: 16px; background: rgba(255, 255, 255, 0.03); border-radius: 8px; border-left: 4px solid ${isPositive ? '#f59e0b' : '#10b981'};">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                    <div style="flex: 1;">
                                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                            <span style="font-size: 12px; padding: 2px 8px; background: #4facfe; color: white; border-radius: 12px;">æ­¥éª¤ ${step.step}</span>
                                            <strong style="color: var(--text-secondary); font-size: 14px;">${step.name}</strong>
                                            <span style="font-size: 11px; padding: 2px 6px; background: rgba(102, 126, 234, 0.2); color: #667eea; border-radius: 8px;">æƒé‡ ${(step.weight * 100).toFixed(0)}%</span>
                                        </div>
                                        <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">${step.description}</div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 18px; font-weight: bold; color: ${isPositive ? '#f59e0b' : '#10b981'};">
                                            ${isPositive ? '+' : ''}${step.value.toFixed(4)}
                                        </div>
                                        <div style="font-size: 11px; color: var(--text-muted); margin-top: 2px;">
                                            ç´¯è®¡: ${cumulativeScore.toFixed(4)}
                                        </div>
                                    </div>
                                </div>
                                <div style="margin-top: 12px; padding: 10px; background: rgba(0, 0, 0, 0.2); border-radius: 6px;">
                                    <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">è®¡ç®—è¿‡ç¨‹:</div>
                                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #4facfe;">
                                        ${step.formula}
                                    </div>
                                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">${step.impact}</div>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `
                        </div>
                        
                        <div style="margin-top: 24px; padding: 16px; background: rgba(79, 172, 254, 0.1); border-radius: 8px; border-left: 4px solid #4facfe;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                                <span style="font-size: 18px;">âœ…</span>
                                <strong style="color: var(--text-secondary);">æœ€ç»ˆç»“æœ</strong>
                            </div>
                            <div style="font-size: 20px; font-weight: bold; color: ${data.final_score > 0.6 ? '#ef4444' : data.final_score > 0.3 ? '#f59e0b' : '#10b981'};">
                                é£é™©è¯„åˆ† = ${data.final_score.toFixed(3)}
                            </div>
                            <div style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">
                                åŸå§‹è¯„åˆ†: ${data.raw_score.toFixed(4)}ï¼Œé™åˆ¶å: ${data.final_score.toFixed(3)} (èŒƒå›´: 0.0 - 1.0)
                            </div>
                        </div>
                    `;
                    
                    content.innerHTML = html;
                } else {
                    content.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: var(--text-danger);">
                            <p>è®¡ç®—å¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('é£é™©è¯„åˆ†è¯¦æƒ…åŠ è½½é”™è¯¯:', error);
                content.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-danger);">
                        <p>è®¡ç®—å¤±è´¥: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        function closeRiskScoreDetail() {
            document.getElementById('risk-score-modal').style.display = 'none';
        }
        
        function toggleMetricsExplanation() {
            const explanation = document.getElementById('metrics-explanation');
            const icon = document.getElementById('metrics-toggle-icon');
            if (explanation.style.display === 'none') {
                explanation.style.display = 'block';
                icon.style.transform = 'rotate(180deg)';
            } else {
                explanation.style.display = 'none';
                icon.style.transform = 'rotate(0deg)';
            }
        }
        
        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
        document.getElementById('customer-detail-modal')?.addEventListener('click', function(e) {
            if (e.target === this) closeCustomerDetail();
        });
        
        document.getElementById('ltv-explanation-modal')?.addEventListener('click', function(e) {
            if (e.target === this) closeLTVExplanation();
        });
        
        document.getElementById('loan-history-modal')?.addEventListener('click', function(e) {
            if (e.target === this) closeLoanHistory();
        });
        
        document.getElementById('default-probability-modal')?.addEventListener('click', function(e) {
            if (e.target === this) closeDefaultProbabilityDetail();
        });
        
        document.getElementById('churn-probability-modal')?.addEventListener('click', function(e) {
            if (e.target === this) closeChurnProbabilityDetail();
        });
        
        document.getElementById('risk-score-modal')?.addEventListener('click', function(e) {
            if (e.target === this) closeRiskScoreDetail();
        });
        
        // ============================================================
        // ç»æµå‘¨æœŸåˆ†æ
        // ============================================================
        
        let cycleChart = null;
        let typeChart = null;
        let industryChart = null;
        let riskDistributionChart = null;
        
        async function runCycleAnalysis() {
            const count = parseInt(document.getElementById('analysis-count').value);
            document.getElementById('analysis-result').style.display = 'none';
            
            try {
                const response = await fetch(`${API_BASE}/api/analysis/economic-cycle`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ count })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('analysis-result').style.display = 'block';
                    document.getElementById('btn-cycle-trace').style.display = 'block';
                    document.getElementById('cycle-run-id').textContent = `è¿è¡ŒID: ${data.run_id || '--'}`;
                    
                    // æ˜¾ç¤ºç»Ÿè®¡å¡ç‰‡ - æ‰©å±•ç‰ˆ
                    const statsDiv = document.getElementById('cycle-stats');
                    statsDiv.innerHTML = Object.entries(data.scenarios).map(([name, s]) => {
                        const indicators = s.economic_indicators || {};
                        return `
                        <div class="stat-card">
                            <div class="stat-label">${name}</div>
                            <div class="stat-value ${s.avg_default_rate > 0.15 ? 'negative' : s.avg_default_rate > 0.08 ? 'warning' : 'positive'}">
                                ${(s.avg_default_rate * 100).toFixed(2)}%
                            </div>
                            <div class="stat-change">
                                é«˜é£é™©: ${s.high_risk_count}äºº (${(s.high_risk_ratio * 100).toFixed(0)}%)<br>
                                å¥åº·åº¦: ${indicators.economic_health_score ? indicators.economic_health_score.toFixed(1) : '--'}
                            </div>
                        </div>
                    `;
                    }).join('');
                    
                    // æ˜¾ç¤ºé¢„è­¦ä¿¡å·
                    if (data.warnings && data.warnings.length > 0) {
                        document.getElementById('warnings-card').style.display = 'block';
                        const warningsContent = document.getElementById('warnings-content');
                        warningsContent.innerHTML = data.warnings.map(w => `
                            <div class="alert ${w.level === 'critical' ? 'alert-danger' : w.level === 'high' ? 'alert-warning' : 'alert-info'}" style="margin-bottom: 12px;">
                                <strong>${w.scenario}</strong>: ${w.message}
                            </div>
                        `).join('');
                    }
                    
                    // æ˜¾ç¤ºç»æµæŒ‡æ ‡è¯¦æƒ…
                    const indicatorsGrid = document.getElementById('economic-indicators-grid');
                    indicatorsGrid.innerHTML = Object.entries(data.scenarios).map(([name, s]) => {
                        const ind = s.economic_indicators || {};
                        return `
                            <div class="card" style="padding: 16px;">
                                <h4 style="margin-bottom: 12px; color: var(--accent);">${name}</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 13px;">
                                    <div><strong>GDPå¢é•¿ç‡:</strong> ${(ind.gdp_growth * 100).toFixed(2)}%</div>
                                    <div><strong>å¤±ä¸šç‡:</strong> ${(ind.unemployment_rate * 100).toFixed(2)}%</div>
                                    <div><strong>é€šèƒ€ç‡:</strong> ${(ind.inflation_rate * 100).toFixed(2)}%</div>
                                    <div><strong>åŸºå‡†åˆ©ç‡:</strong> ${(ind.base_interest_rate * 100).toFixed(2)}%</div>
                                    <div><strong>æ¶ˆè´¹è€…ä¿¡å¿ƒ:</strong> ${(ind.consumer_confidence * 100).toFixed(0)}</div>
                                    <div><strong>åˆ¶é€ ä¸šPMI:</strong> ${ind.manufacturing_pmi ? ind.manufacturing_pmi.toFixed(1) : '--'}</div>
                                    <div><strong>æˆ¿ä»·æŒ‡æ•°:</strong> ${ind.housing_price_index ? ind.housing_price_index.toFixed(1) : '--'}</div>
                                    <div><strong>è‚¡å¸‚æŒ‡æ•°:</strong> ${ind.stock_index ? ind.stock_index.toFixed(0) : '--'}</div>
                                    <div><strong>M2å¢é•¿ç‡:</strong> ${(ind.m2_growth * 100).toFixed(2)}%</div>
                                    <div><strong>æ±‡ç‡:</strong> ${ind.exchange_rate ? ind.exchange_rate.toFixed(2) : '--'}</div>
                                    <div><strong>è´¸æ˜“ä½™é¢:</strong> ${ind.trade_balance ? ind.trade_balance.toFixed(0) : '--'}äº¿ç¾å…ƒ</div>
                                    <div><strong>é£é™©åå¥½:</strong> ${(ind.risk_appetite * 100).toFixed(0)}</div>
                                    <div><strong>æµåŠ¨æ€§:</strong> ${(ind.liquidity_index * 100).toFixed(0)}</div>
                                    <div><strong>å¸‚åœºæ³¢åŠ¨:</strong> ${(ind.market_volatility * 100).toFixed(2)}%</div>
                                    <div><strong>æ”¿ç­–åˆºæ¿€:</strong> ${(ind.policy_stimulus_level * 100).toFixed(0)}</div>
                                    <div><strong>ç»æµå‹åŠ›:</strong> ${(ind.economic_stress * 100).toFixed(1)}</div>
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    // ç»˜åˆ¶å‘¨æœŸå›¾è¡¨
                    const cycleCtx = document.getElementById('cycle-chart').getContext('2d');
                    if (cycleChart) cycleChart.destroy();
                    
                    cycleChart = new Chart(cycleCtx, {
                        type: 'bar',
                        data: {
                            labels: Object.keys(data.scenarios),
                            datasets: [{
                                label: 'å¹³å‡è¿çº¦ç‡',
                                data: Object.values(data.scenarios).map(s => (s.avg_default_rate * 100).toFixed(2)),
                                backgroundColor: [
                                    'rgba(0, 212, 170, 0.7)',
                                    'rgba(59, 130, 246, 0.7)',
                                    'rgba(245, 158, 11, 0.7)',
                                    'rgba(239, 68, 68, 0.7)'
                                ],
                                borderRadius: 8
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: { color: 'rgba(255,255,255,0.1)' },
                                    ticks: { color: '#94a3b8' }
                                },
                                x: {
                                    grid: { display: false },
                                    ticks: { color: '#94a3b8' }
                                }
                            }
                        }
                    });
                    
                    // ç»˜åˆ¶å®¢æˆ·ç±»å‹å›¾è¡¨
                    const typeCtx = document.getElementById('type-chart').getContext('2d');
                    if (typeChart) typeChart.destroy();
                    
                    const sortedTypes = Object.entries(data.by_customer_type).sort((a, b) => b[1] - a[1]);
                    
                    typeChart = new Chart(typeCtx, {
                        type: 'doughnut',
                        data: {
                            labels: sortedTypes.map(([k]) => k),
                            datasets: [{
                                data: sortedTypes.map(([, v]) => (v * 100).toFixed(2)),
                                backgroundColor: [
                                    'rgba(239, 68, 68, 0.8)',
                                    'rgba(245, 158, 11, 0.8)',
                                    'rgba(59, 130, 246, 0.8)',
                                    'rgba(0, 212, 170, 0.8)'
                                ]
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'right',
                                    labels: { color: '#f1f5f9' }
                                }
                            }
                        }
                    });
                    
                    // è¡Œä¸šé£é™©åˆ†æ
                    const firstScenario = Object.values(data.scenarios)[0];
                    if (firstScenario.by_industry && Object.keys(firstScenario.by_industry).length > 0) {
                        document.getElementById('industry-analysis-card').style.display = 'block';
                        const industryCtx = document.getElementById('industry-chart').getContext('2d');
                        if (industryChart) industryChart.destroy();
                        
                        // æ”¶é›†æ‰€æœ‰åœºæ™¯çš„è¡Œä¸šæ•°æ®
                        const industryData = {};
                        Object.entries(data.scenarios).forEach(([scenarioName, scenario]) => {
                            Object.entries(scenario.by_industry || {}).forEach(([industry, data]) => {
                                if (!industryData[industry]) {
                                    industryData[industry] = [];
                                }
                                industryData[industry].push({
                                    scenario: scenarioName,
                                    default_rate: data.avg_default_rate,
                                    count: data.count
                                });
                            });
                        });
                        
                        const industries = Object.keys(industryData);
                        const scenarios = Object.keys(data.scenarios);
                        
                        industryChart = new Chart(industryCtx, {
                            type: 'bar',
                            data: {
                                labels: industries,
                                datasets: scenarios.map((scenarioName, idx) => ({
                                    label: scenarioName,
                                    data: industries.map(industry => {
                                        const item = industryData[industry].find(d => d.scenario === scenarioName);
                                        return item ? (item.default_rate * 100) : 0;
                                    }),
                                    backgroundColor: [
                                        'rgba(0, 212, 170, 0.7)',
                                        'rgba(59, 130, 246, 0.7)',
                                        'rgba(245, 158, 11, 0.7)',
                                        'rgba(239, 68, 68, 0.7)'
                                    ][idx]
                                }))
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: { labels: { color: '#f1f5f9' } }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        grid: { color: 'rgba(255,255,255,0.1)' },
                                        ticks: { color: '#94a3b8' }
                                    },
                                    x: {
                                        grid: { display: false },
                                        ticks: { color: '#94a3b8' }
                                    }
                                }
                            }
                        });
                    }
                    
                    // é£é™©åˆ†å¸ƒåˆ†æ
                    if (firstScenario.risk_distribution) {
                        document.getElementById('risk-distribution-card').style.display = 'block';
                        const riskDistCtx = document.getElementById('risk-distribution-chart').getContext('2d');
                        if (riskDistributionChart) riskDistributionChart.destroy();
                        
                        riskDistributionChart = new Chart(riskDistCtx, {
                            type: 'bar',
                            data: {
                                labels: Object.keys(data.scenarios),
                                datasets: [
                                    {
                                        label: 'ä½é£é™© (<5%)',
                                        data: Object.values(data.scenarios).map(s => (s.risk_distribution?.low_risk || 0) * 100),
                                        backgroundColor: 'rgba(0, 212, 170, 0.7)'
                                    },
                                    {
                                        label: 'ä¸­é£é™© (5-15%)',
                                        data: Object.values(data.scenarios).map(s => (s.risk_distribution?.medium_risk || 0) * 100),
                                        backgroundColor: 'rgba(245, 158, 11, 0.7)'
                                    },
                                    {
                                        label: 'é«˜é£é™© (15-25%)',
                                        data: Object.values(data.scenarios).map(s => (s.risk_distribution?.high_risk || 0) * 100),
                                        backgroundColor: 'rgba(239, 68, 68, 0.7)'
                                    },
                                    {
                                        label: 'æé«˜é£é™© (>25%)',
                                        data: Object.values(data.scenarios).map(s => (s.risk_distribution?.very_high_risk || 0) * 100),
                                        backgroundColor: 'rgba(139, 92, 246, 0.7)'
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: { labels: { color: '#f1f5f9' } }
                                },
                                scales: {
                                    x: { stacked: true, grid: { display: false }, ticks: { color: '#94a3b8' } },
                                    y: { 
                                        stacked: true, 
                                        beginAtZero: true,
                                        max: 100,
                                        grid: { color: 'rgba(255,255,255,0.1)' },
                                        ticks: { color: '#94a3b8', callback: function(value) { return value + '%'; } }
                                    }
                                }
                            }
                        });
                        
                        // é£é™©åˆ†å¸ƒç»Ÿè®¡
                        const riskStatsDiv = document.getElementById('risk-distribution-stats');
                        riskStatsDiv.innerHTML = Object.entries(data.scenarios).map(([name, s]) => {
                            const dist = s.risk_distribution || {};
                            return `
                                <div style="margin-bottom: 16px;">
                                    <h4 style="color: var(--accent); margin-bottom: 8px;">${name}</h4>
                                    <div style="font-size: 13px; line-height: 1.8;">
                                        <div>ä½é£é™©: <strong>${((dist.low_risk || 0) * 100).toFixed(1)}%</strong></div>
                                        <div>ä¸­é£é™©: <strong>${((dist.medium_risk || 0) * 100).toFixed(1)}%</strong></div>
                                        <div>é«˜é£é™©: <strong>${((dist.high_risk || 0) * 100).toFixed(1)}%</strong></div>
                                        <div>æé«˜é£é™©: <strong>${((dist.very_high_risk || 0) * 100).toFixed(1)}%</strong></div>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    }
                    
                    // æŒ‡æ ‡ç›¸å…³æ€§åˆ†æ
                    if (data.correlations) {
                        document.getElementById('correlation-card').style.display = 'block';
                        const corrContent = document.getElementById('correlation-content');
                        corrContent.innerHTML = `
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
                                ${Object.entries(data.correlations).map(([scenario, corr]) => `
                                    <div class="card" style="padding: 16px;">
                                        <h4 style="margin-bottom: 12px; color: var(--accent);">${scenario}</h4>
                                        <div style="font-size: 13px; line-height: 1.8;">
                                            <div>GDP vs è¿çº¦ç‡: <strong>${corr.gdp_vs_default ? corr.gdp_vs_default.toFixed(2) : '--'}</strong></div>
                                            <div>å¤±ä¸šç‡ vs è¿çº¦ç‡: <strong>${corr.unemployment_vs_default ? corr.unemployment_vs_default.toFixed(2) : '--'}</strong></div>
                                            <div>ä¿¡å¿ƒæŒ‡æ•° vs è¿çº¦ç‡: <strong>${corr.confidence_vs_default ? corr.confidence_vs_default.toFixed(2) : '--'}</strong></div>
                                            <div>PMI vs è¿çº¦ç‡: <strong>${corr.pmi_vs_default ? corr.pmi_vs_default.toFixed(2) : '--'}</strong></div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }
                    
                    // æ˜¾ç¤ºæ‘˜è¦ä¿¡æ¯
                    if (data.summary) {
                        console.log('åˆ†ææ‘˜è¦:', data.summary);
                    }
                }
            } catch (error) {
                alert('åˆ†æå¤±è´¥: ' + error.message);
                console.error(error);
            }
        }
        
        // ============================================================
        // é“¶è¡Œæ¨¡æ‹Ÿ
        // ============================================================
        
        let simChart = null;
        
        async function runSimulation() {
            const strategy = document.getElementById('sim-strategy').value;
            document.getElementById('sim-result').style.display = 'none';
            
            try {
                const response = await fetch(`${API_BASE}/api/simulation/auto-run`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ strategy, seed: 42 })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('sim-result').style.display = 'block';
                    document.getElementById('btn-sim-trace').style.display = 'block';
                    document.getElementById('sim-run-id').textContent = `è¿è¡ŒID: ${data.run_id || '--'}`;
                    
                    const s = data.summary;
                    document.getElementById('sim-stats').innerHTML = `
                        <div class="stat-card">
                            <div class="stat-label">æ€»å¥–åŠ±</div>
                            <div class="stat-value ${s.total_reward > 0 ? 'positive' : 'negative'}">
                                ${s.total_reward.toFixed(1)}
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">æœ€ç»ˆåˆ©æ¶¦</div>
                            <div class="stat-value ${s.final_profit > 0 ? 'positive' : 'negative'}">
                                Â¥${s.final_profit.toFixed(0)}äº¿
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">æœ€ç»ˆèµ„æœ¬</div>
                            <div class="stat-value">Â¥${s.final_capital.toFixed(0)}äº¿</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">æœ€ç»ˆNPL</div>
                            <div class="stat-value ${s.final_npl > 0.1 ? 'negative' : s.final_npl > 0.05 ? 'warning' : 'positive'}">
                                ${(s.final_npl * 100).toFixed(2)}%
                            </div>
                        </div>
                    `;
                    
                    // ç»˜åˆ¶å›¾è¡¨
                    const simCtx = document.getElementById('sim-chart').getContext('2d');
                    if (simChart) simChart.destroy();
                    
                    simChart = new Chart(simCtx, {
                        type: 'line',
                        data: {
                            labels: data.history.map(h => `${Math.floor(h.month/12)+1}å¹´${h.month%12+1}æœˆ`),
                            datasets: [
                                {
                                    label: 'ç´¯è®¡åˆ©æ¶¦ (äº¿)',
                                    data: data.history.map(h => h.cumulative_profit),
                                    borderColor: '#00d4aa',
                                    backgroundColor: 'rgba(0, 212, 170, 0.1)',
                                    fill: true,
                                    tension: 0.4,
                                    yAxisID: 'y'
                                },
                                {
                                    label: 'NPLç‡ (%)',
                                    data: data.history.map(h => h.npl_ratio * 100),
                                    borderColor: '#ef4444',
                                    tension: 0.4,
                                    yAxisID: 'y1'
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                mode: 'index',
                                intersect: false
                            },
                            plugins: {
                                legend: {
                                    labels: { color: '#f1f5f9' }
                                }
                            },
                            scales: {
                                x: {
                                    grid: { color: 'rgba(255,255,255,0.05)' },
                                    ticks: { 
                                        color: '#64748b',
                                        maxTicksLimit: 12
                                    }
                                },
                                y: {
                                    type: 'linear',
                                    position: 'left',
                                    grid: { color: 'rgba(255,255,255,0.05)' },
                                    ticks: { color: '#00d4aa' },
                                    title: {
                                        display: true,
                                        text: 'ç´¯è®¡åˆ©æ¶¦ (äº¿)',
                                        color: '#00d4aa'
                                    }
                                },
                                y1: {
                                    type: 'linear',
                                    position: 'right',
                                    grid: { display: false },
                                    ticks: { color: '#ef4444' },
                                    title: {
                                        display: true,
                                        text: 'NPLç‡ (%)',
                                        color: '#ef4444'
                                    }
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                alert('æ¨¡æ‹Ÿå¤±è´¥: ' + error.message);
            }
        }
        
        // ============================================================
        // ç­–ç•¥å¯¹æ¯”
        // ============================================================
        
        let comparisonChart = null;
        
        async function runComparison() {
            const episodes = parseInt(document.getElementById('comparison-episodes').value);
            document.getElementById('comparison-result').style.display = 'none';
            
            try {
                const response = await fetch(`${API_BASE}/api/comparison/strategies`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ episodes })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('comparison-result').style.display = 'block';
                    document.getElementById('btn-comparison-trace').style.display = 'block';
                    document.getElementById('comparison-run-id').textContent = `è¿è¡ŒID: ${data.run_id || '--'}`;
                    
                    // ä¿å­˜ç»“æœä¾›AIè§£é‡Šä½¿ç”¨
                    window.comparisonResults = data.results;
                    
                    // å¡«å……è¡¨æ ¼
                    const tbody = document.querySelector('#comparison-table tbody');
                    tbody.innerHTML = data.results.map((r, i) => `
                        <tr>
                            <td><span class="badge ${i === 0 ? 'badge-success' : ''}">#${i + 1}</span></td>
                            <td><strong>${r.name}</strong></td>
                            <td class="${r.avg_reward > 0 ? 'positive' : 'negative'}" style="font-family: 'JetBrains Mono'">
                                ${r.avg_reward.toFixed(2)}
                            </td>
                            <td style="font-family: 'JetBrains Mono'">Â¥${r.avg_profit.toFixed(0)}äº¿</td>
                            <td><span class="badge ${r.avg_npl > 0.1 ? 'badge-danger' : r.avg_npl > 0.05 ? 'badge-warning' : 'badge-success'}">
                                ${(r.avg_npl * 100).toFixed(2)}%
                            </span></td>
                            <td><span class="badge ${r.bankruptcy_rate > 0 ? 'badge-danger' : 'badge-success'}">
                                ${(r.bankruptcy_rate * 100).toFixed(0)}%
                            </span></td>
                        </tr>
                    `).join('');
                    
                    // ç»˜åˆ¶å›¾è¡¨
                    const ctx = document.getElementById('comparison-chart').getContext('2d');
                    if (comparisonChart) comparisonChart.destroy();
                    
                    comparisonChart = new Chart(ctx, {
                        type: 'radar',
                        data: {
                            labels: ['å¹³å‡å¥–åŠ±', 'ç´¯è®¡åˆ©æ¶¦', 'NPLæ§åˆ¶', 'ç¨³å®šæ€§'],
                            datasets: data.results.map((r, i) => ({
                                label: r.name,
                                data: [
                                    Math.max(0, (r.avg_reward + 100) / 2),
                                    r.avg_profit / 10,
                                    (1 - r.avg_npl) * 100,
                                    (1 - r.bankruptcy_rate) * 100
                                ],
                                borderColor: ['#00d4aa', '#3b82f6', '#f59e0b', '#ef4444', '#10b981'][i],
                                backgroundColor: ['rgba(0,212,170,0.1)', 'rgba(59,130,246,0.1)', 'rgba(245,158,11,0.1)', 'rgba(239,68,68,0.1)', 'rgba(16,185,129,0.1)'][i]
                            }))
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: { color: '#f1f5f9' }
                                }
                            },
                            scales: {
                                r: {
                                    grid: { color: 'rgba(255,255,255,0.1)' },
                                    angleLines: { color: 'rgba(255,255,255,0.1)' },
                                    pointLabels: { color: '#94a3b8' },
                                    ticks: { display: false }
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                alert('å¯¹æ¯”å¤±è´¥: ' + error.message);
            }
        }
        
        // ç­–ç•¥è¯´æ˜æ¨¡æ€æ¡†
        function showStrategyExplanation() {
            const modal = document.getElementById('strategy-explanation-modal');
            if (!modal) {
                // åˆ›å»ºæ¨¡æ€æ¡†
                const newModal = document.createElement('div');
                newModal.id = 'strategy-explanation-modal';
                newModal.className = 'modal';
                newModal.innerHTML = `
                    <div class="modal-content" style="max-width: 900px; max-height: 90vh;">
                        <div class="modal-header">
                            <h3>ğŸ“š ç­–ç•¥è¯¦ç»†è¯´æ˜</h3>
                            <button class="modal-close" onclick="closeStrategyExplanation()">Ã—</button>
                        </div>
                        <div class="modal-body" style="max-height: calc(90vh - 100px); overflow-y: auto;">
                            <div style="margin-bottom: 24px;">
                                <h4 style="color: var(--accent-primary); margin-bottom: 12px;">ä»€ä¹ˆæ˜¯ç­–ç•¥ï¼Ÿ</h4>
                                <p style="line-height: 1.8; color: var(--text-secondary);">
                                    ç­–ç•¥å°±æ˜¯é“¶è¡Œæ¯ä¸ªæœˆå¦‚ä½•åšç»è¥å†³ç­–çš„è§„åˆ™å’Œæ–¹æ³•ã€‚æ¯ä¸ªæœˆï¼Œé“¶è¡Œéœ€è¦å†³å®šï¼š
                                </p>
                                <ul style="margin-left: 20px; margin-top: 12px; line-height: 2;">
                                    <li><strong>åˆ©ç‡è°ƒæ•´ï¼š</strong>è´·æ¬¾åˆ©ç‡åº”è¯¥æ¯”å¸‚åœºåˆ©ç‡é«˜å¤šå°‘ï¼Ÿè¿˜æ˜¯ä½å¤šå°‘ï¼Ÿ</li>
                                    <li><strong>å®¡æ‰¹é€šè¿‡ç‡ï¼š</strong>100ä¸ªç”³è¯·ä¸­ï¼Œåº”è¯¥æ‰¹å‡†å¤šå°‘ä¸ªï¼Ÿæ˜¯ä¸¥æ ¼è¿˜æ˜¯å®½æ¾ï¼Ÿ</li>
                                    <li><strong>å®¢æˆ·ç¾¤ä½“åˆ†é…ï¼š</strong>ä¼˜è´¨å®¢æˆ·ã€ä¸­ç­‰å®¢æˆ·ã€æ¬¡çº§å®¢æˆ·ï¼Œå„å å¤šå°‘æ¯”ä¾‹ï¼Ÿ</li>
                                </ul>
                            </div>
                            
                            <div style="margin-bottom: 24px;">
                                <h4 style="color: var(--accent-primary); margin-bottom: 12px;">5ç§ç­–ç•¥è¯¦è§£</h4>
                                
                                <div style="margin-bottom: 20px; padding: 16px; background: rgba(255, 255, 255, 0.03); border-radius: 8px; border-left: 4px solid #667eea;">
                                    <h5 style="color: #667eea; margin-bottom: 8px;">1. éšæœºç­–ç•¥ (Random Strategy)</h5>
                                    <p style="font-size: 13px; color: var(--text-secondary); line-height: 1.8;">
                                        å®Œå…¨éšæœºåšå†³ç­–ï¼Œæ²¡æœ‰ä»»ä½•é€»è¾‘ã€‚åˆ©ç‡ã€å®¡æ‰¹ç‡ã€å®¢æˆ·åˆ†é…éƒ½æ˜¯éšæœºçš„ã€‚
                                        <br><strong>ç”¨é€”ï¼š</strong>ä»…ç”¨äºå¯¹æ¯”åŸºå‡†ï¼Œå±•ç¤ºæ²¡æœ‰ç­–ç•¥çš„åæœã€‚
                                    </p>
                                </div>
                                
                                <div style="margin-bottom: 20px; padding: 16px; background: rgba(255, 255, 255, 0.03); border-radius: 8px; border-left: 4px solid #3b82f6;">
                                    <h5 style="color: #3b82f6; margin-bottom: 8px;">2. è§„åˆ™ç­–ç•¥ (Rule-Based Strategy)</h5>
                                    <p style="font-size: 13px; color: var(--text-secondary); line-height: 1.8;">
                                        æ¨¡æ‹Ÿä¼ ç»Ÿé“¶è¡Œçš„å†³ç­–ç³»ç»Ÿï¼ŒåŸºäºå›ºå®šè§„åˆ™ï¼š
                                    </p>
                                    <ul style="margin-left: 20px; margin-top: 8px; font-size: 13px; line-height: 1.8;">
                                        <li>ç»æµç¹è£æœŸï¼šå®¡æ‰¹ç‡75%ï¼Œåˆ©ç‡+1%ï¼Œæ¬¡çº§å®¢æˆ·25%</li>
                                        <li>ç»æµè¡°é€€æœŸï¼šå®¡æ‰¹ç‡55%ï¼Œåˆ©ç‡-0.5%ï¼Œä¼˜è´¨å®¢æˆ·50%</li>
                                        <li>NPL > 5%ï¼šå®¡æ‰¹ç‡é™ä½15%</li>
                                        <li>NPL > 8%ï¼šå®¡æ‰¹ç‡é™ä½25%</li>
                                    </ul>
                                </div>
                                
                                <div style="margin-bottom: 20px; padding: 16px; background: rgba(255, 255, 255, 0.03); border-radius: 8px; border-left: 4px solid #f59e0b;">
                                    <h5 style="color: #f59e0b; margin-bottom: 8px;">3. ä¿å®ˆç­–ç•¥ (Conservative Strategy)</h5>
                                    <p style="font-size: 13px; color: var(--text-secondary); line-height: 1.8;">
                                        å§‹ç»ˆè¿½æ±‚ä½é£é™©ï¼Œä¸“æ³¨ä¼˜è´¨å®¢æˆ·ï¼š
                                    </p>
                                    <ul style="margin-left: 20px; margin-top: 8px; font-size: 13px; line-height: 1.8;">
                                        <li>å®¡æ‰¹ç‡è¾ƒä½ï¼ˆ35%-45%ï¼‰</li>
                                        <li>ä¸»è¦æœåŠ¡ä¼˜è´¨å®¢æˆ·ï¼ˆ65%+ï¼‰</li>
                                        <li>æå°‘æ¬¡çº§å®¢æˆ·ï¼ˆ5%ä»¥ä¸‹ï¼‰</li>
                                        <li>åˆ©ç‡ç•¥é«˜äºå¸‚åœº</li>
                                    </ul>
                                    <p style="margin-top: 8px; font-size: 12px; color: var(--text-muted);">
                                        <strong>ç»“æœï¼š</strong>é£é™©ä½ã€ç ´äº§ç‡ä½ï¼Œä½†æ”¶ç›Šä¹Ÿè¾ƒä½
                                    </p>
                                </div>
                                
                                <div style="margin-bottom: 20px; padding: 16px; background: rgba(255, 255, 255, 0.03); border-radius: 8px; border-left: 4px solid #ef4444;">
                                    <h5 style="color: #ef4444; margin-bottom: 8px;">4. æ¿€è¿›ç­–ç•¥ (Aggressive Strategy)</h5>
                                    <p style="font-size: 13px; color: var(--text-secondary); line-height: 1.8;">
                                        è¿½æ±‚é«˜æ”¶ç›Šï¼Œæ„¿æ„æ‰¿æ‹…é«˜é£é™©ï¼š
                                    </p>
                                    <ul style="margin-left: 20px; margin-top: 8px; font-size: 13px; line-height: 1.8;">
                                        <li>å®¡æ‰¹ç‡å¾ˆé«˜ï¼ˆ65%-90%ï¼‰</li>
                                        <li>å¤§é‡æ¬¡çº§å®¢æˆ·ï¼ˆ25%-45%ï¼‰</li>
                                        <li>åˆ©ç‡è¾ƒé«˜</li>
                                        <li>ç»æµç¹è£æ—¶æ›´æ¿€è¿›</li>
                                    </ul>
                                    <p style="margin-top: 8px; font-size: 12px; color: var(--text-muted);">
                                        <strong>ç»“æœï¼š</strong>å¯èƒ½è·å¾—é«˜æ”¶ç›Šï¼Œä½†é£é™©é«˜ï¼Œå®¹æ˜“ç ´äº§
                                    </p>
                                </div>
                                
                                <div style="margin-bottom: 20px; padding: 16px; background: rgba(16, 185, 129, 0.1); border-radius: 8px; border-left: 4px solid #10b981;">
                                    <h5 style="color: #10b981; margin-bottom: 8px;">5. AlphaZero ç­–ç•¥ (AIç­–ç•¥)</h5>
                                    <p style="font-size: 13px; color: var(--text-secondary); line-height: 1.8;">
                                        é€šè¿‡AIè‡ªæˆ‘å­¦ä¹ ï¼Œæ‰¾åˆ°æœ€ä¼˜ç­–ç•¥ï¼š
                                    </p>
                                    <ul style="margin-left: 20px; margin-top: 8px; font-size: 13px; line-height: 1.8;">
                                        <li>é€šè¿‡è‡ªæˆ‘åšå¼ˆå­¦ä¹ ï¼ˆå°±åƒAlphaGoä¸‹æ£‹ä¸€æ ·ï¼‰</li>
                                        <li>èƒ½å¤Ÿé€‚åº”å¤æ‚çš„ç»æµç¯å¢ƒ</li>
                                        <li>åŠ¨æ€è°ƒæ•´ï¼Œä¸æ˜¯å›ºå®šè§„åˆ™</li>
                                        <li>åœ¨é£é™©å’Œæ”¶ç›Šä¹‹é—´æ‰¾åˆ°æœ€ä½³å¹³è¡¡</li>
                                    </ul>
                                    <p style="margin-top: 8px; font-size: 12px; color: #10b981; font-weight: 600;">
                                        <strong>ç»“æœï¼š</strong>é€šå¸¸è¡¨ç°æœ€å¥½ï¼Œæ”¶ç›Šé«˜ä¸”é£é™©å¯æ§
                                    </p>
                                </div>
                            </div>
                            
                            <div style="padding: 16px; background: rgba(79, 172, 254, 0.1); border-radius: 8px; border-left: 4px solid #4facfe;">
                                <h4 style="color: #4facfe; margin-bottom: 12px;">ğŸ’¡ ç­–ç•¥å¯¹æ¯”çš„ä½œç”¨</h4>
                                <p style="font-size: 13px; line-height: 1.8; color: var(--text-secondary);">
                                    é€šè¿‡å¯¹æ¯”è¿™5ç§ç­–ç•¥åœ¨10å¹´æ¨¡æ‹Ÿä¸­çš„è¡¨ç°ï¼Œå¯ä»¥çœ‹åˆ°ï¼š
                                </p>
                                <ul style="margin-left: 20px; margin-top: 12px; line-height: 2; font-size: 13px;">
                                    <li>å“ªä¸ªç­–ç•¥ç´¯è®¡åˆ©æ¶¦æœ€é«˜</li>
                                    <li>å“ªä¸ªç­–ç•¥ç ´äº§ç‡æœ€ä½</li>
                                    <li>å“ªä¸ªç­–ç•¥åœ¨é£é™©å’Œæ”¶ç›Šä¹‹é—´å¹³è¡¡æœ€å¥½</li>
                                    <li>ä¸åŒç­–ç•¥åœ¨ä¸åŒç»æµç¯å¢ƒä¸‹çš„è¡¨ç°</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(newModal);
                
                // ç‚¹å‡»èƒŒæ™¯å…³é—­
                newModal.addEventListener('click', function(e) {
                    if (e.target === newModal) {
                        closeStrategyExplanation();
                    }
                });
            }
            
            document.getElementById('strategy-explanation-modal').style.display = 'flex';
        }
        
        function closeStrategyExplanation() {
            const modal = document.getElementById('strategy-explanation-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // æŒ‡æ ‡è®¡ç®—è¯´æ˜
        function showComparisonMetricsExplanation() {
            const modal = document.getElementById('comparison-metrics-modal');
            if (!modal) {
                const newModal = document.createElement('div');
                newModal.id = 'comparison-metrics-modal';
                newModal.className = 'modal';
                newModal.innerHTML = `
                    <div class="modal-content" style="max-width: 800px; max-height: 90vh;">
                        <div class="modal-header">
                            <h3>ğŸ“ æŒ‡æ ‡è®¡ç®—è¯´æ˜</h3>
                            <button class="modal-close" onclick="closeComparisonMetrics()">Ã—</button>
                        </div>
                        <div class="modal-body" style="max-height: calc(90vh - 100px); overflow-y: auto;">
                            <div style="margin-bottom: 24px;">
                                <h4 style="color: var(--accent-primary); margin-bottom: 12px;">1. å¹³å‡å¥–åŠ± (Average Reward)</h4>
                                <div style="padding: 12px; background: rgba(0, 0, 0, 0.2); border-radius: 6px; font-family: monospace; font-size: 12px; color: #4facfe; margin-bottom: 8px;">
                                    å¹³å‡å¥–åŠ± = Î£(æœˆåº¦å¥–åŠ±) / å›åˆæ•°
                                </div>
                                <p style="font-size: 13px; line-height: 1.8; color: var(--text-secondary);">
                                    <strong>å«ä¹‰ï¼š</strong>æ¯ä¸ªç­–ç•¥åœ¨10å¹´æ¨¡æ‹Ÿä¸­ï¼Œæ¯ä¸ªæœˆè·å¾—çš„å¥–åŠ±çš„å¹³å‡å€¼ã€‚
                                    <br><strong>æœˆåº¦å¥–åŠ± = æœˆåº¦å‡€åˆ©æ¶¦ - é£é™©æƒ©ç½š</strong>
                                    <br>å¥–åŠ±è¶Šé«˜ï¼Œè¯´æ˜ç­–ç•¥åœ¨å•æœˆè¡¨ç°è¶Šå¥½ã€‚
                                </p>
                            </div>
                            
                            <div style="margin-bottom: 24px;">
                                <h4 style="color: var(--accent-primary); margin-bottom: 12px;">2. ç´¯è®¡åˆ©æ¶¦ (Cumulative Profit)</h4>
                                <div style="padding: 12px; background: rgba(0, 0, 0, 0.2); border-radius: 6px; font-family: monospace; font-size: 12px; color: #4facfe; margin-bottom: 8px;">
                                    ç´¯è®¡åˆ©æ¶¦ = Î£(æœˆåº¦å‡€åˆ©æ¶¦)  (10å¹´æ€»å’Œ)
                                </div>
                                <p style="font-size: 13px; line-height: 1.8; color: var(--text-secondary);">
                                    <strong>å«ä¹‰ï¼š</strong>10å¹´æ¨¡æ‹ŸæœŸé—´ï¼Œé“¶è¡Œæ€»å…±èµšå–çš„åˆ©æ¶¦ã€‚
                                    <br><strong>æœˆåº¦å‡€åˆ©æ¶¦ = åˆ©æ¯æ”¶å…¥ - è¿è¥æˆæœ¬ - è¿çº¦æŸå¤±</strong>
                                    <br>è¿™æ˜¯è¡¡é‡ç­–ç•¥é•¿æœŸç›ˆåˆ©èƒ½åŠ›çš„å…³é”®æŒ‡æ ‡ã€‚
                                </p>
                            </div>
                            
                            <div style="margin-bottom: 24px;">
                                <h4 style="color: var(--accent-primary); margin-bottom: 12px;">3. å¹³å‡NPL (Average Non-Performing Loan Rate)</h4>
                                <div style="padding: 12px; background: rgba(0, 0, 0, 0.2); border-radius: 6px; font-family: monospace; font-size: 12px; color: #4facfe; margin-bottom: 8px;">
                                    å¹³å‡NPL = Î£(æ¯æœˆNPLç‡) / æ€»æœˆæ•°
                                </div>
                                <p style="font-size: 13px; line-height: 1.8; color: var(--text-secondary);">
                                    <strong>å«ä¹‰ï¼š</strong>ä¸è‰¯è´·æ¬¾ç‡çš„å¹³å‡å€¼ã€‚NPLç‡ = ä¸è‰¯è´·æ¬¾ä½™é¢ / æ€»è´·æ¬¾ä½™é¢ã€‚
                                    <br><strong>ä¸è‰¯è´·æ¬¾ï¼š</strong>é€¾æœŸ90å¤©ä»¥ä¸Šçš„è´·æ¬¾
                                    <br>NPLç‡è¶Šä½ï¼Œè¯´æ˜ç­–ç•¥çš„é£é™©æ§åˆ¶è¶Šå¥½ã€‚é€šå¸¸é“¶è¡Œè¦æ±‚NPLç‡ < 5%ã€‚
                                </p>
                            </div>
                            
                            <div style="margin-bottom: 24px;">
                                <h4 style="color: var(--accent-primary); margin-bottom: 12px;">4. ç ´äº§ç‡ (Bankruptcy Rate)</h4>
                                <div style="padding: 12px; background: rgba(0, 0, 0, 0.2); border-radius: 6px; font-family: monospace; font-size: 12px; color: #4facfe; margin-bottom: 8px;">
                                    ç ´äº§ç‡ = ç ´äº§æ¬¡æ•° / æ€»å›åˆæ•°
                                </div>
                                <p style="font-size: 13px; line-height: 1.8; color: var(--text-secondary);">
                                    <strong>å«ä¹‰ï¼š</strong>åœ¨å¤šæ¬¡è¿è¡Œä¸­ï¼Œç­–ç•¥å¯¼è‡´é“¶è¡Œç ´äº§çš„æ¯”ä¾‹ã€‚
                                    <br><strong>ç ´äº§æ¡ä»¶ï¼š</strong>èµ„æœ¬å……è¶³ç‡ < 8% æˆ– NPLç‡ > 25%
                                    <br>ç ´äº§ç‡è¶Šä½ï¼Œè¯´æ˜ç­–ç•¥è¶Šç¨³å¥ã€‚ç†æƒ³æƒ…å†µä¸‹åº”è¯¥ä¸º0%ã€‚
                                </p>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(newModal);
                
                newModal.addEventListener('click', function(e) {
                    if (e.target === newModal) {
                        closeComparisonMetrics();
                    }
                });
            }
            
            document.getElementById('comparison-metrics-modal').style.display = 'flex';
        }
        
        function closeComparisonMetrics() {
            const modal = document.getElementById('comparison-metrics-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // å•ä¸ªæŒ‡æ ‡è®¡ç®—è¯´æ˜
        function showMetricCalculation(metricType) {
            const explanations = {
                'avg_reward': {
                    title: 'å¹³å‡å¥–åŠ±è®¡ç®—è¯´æ˜',
                    formula: 'å¹³å‡å¥–åŠ± = Î£(æœˆåº¦å¥–åŠ±) / å›åˆæ•°',
                    steps: [
                        '1. æ¯ä¸ªå›åˆæ¨¡æ‹Ÿ10å¹´ï¼ˆ120ä¸ªæœˆï¼‰',
                        '2. æ¯æœˆè®¡ç®—å¥–åŠ± = æœˆåº¦å‡€åˆ©æ¶¦ - é£é™©æƒ©ç½š',
                        '3. æœˆåº¦å‡€åˆ©æ¶¦ = åˆ©æ¯æ”¶å…¥ - è¿è¥æˆæœ¬ - è¿çº¦æŸå¤±',
                        '4. é£é™©æƒ©ç½š = NPLè¶…æ ‡æƒ©ç½š + èµ„æœ¬ä¸è¶³æƒ©ç½š',
                        '5. å°†æ‰€æœ‰å›åˆçš„å¥–åŠ±æ±‚å’Œï¼Œé™¤ä»¥å›åˆæ•°å¾—åˆ°å¹³å‡å€¼'
                    ],
                    meaning: 'åæ˜ ç­–ç•¥åœ¨å•æœˆè¡¨ç°çš„å¹³å‡æ°´å¹³ï¼Œæ•°å€¼è¶Šé«˜è¶Šå¥½ã€‚'
                },
                'profit': {
                    title: 'ç´¯è®¡åˆ©æ¶¦è®¡ç®—è¯´æ˜',
                    formula: 'ç´¯è®¡åˆ©æ¶¦ = Î£(æœˆåº¦å‡€åˆ©æ¶¦)',
                    steps: [
                        '1. æ¯æœˆè®¡ç®—å‡€åˆ©æ¶¦ = åˆ©æ¯æ”¶å…¥ - è¿è¥æˆæœ¬ - è¿çº¦æŸå¤±',
                        '2. åˆ©æ¯æ”¶å…¥ = è´·æ¬¾ä½™é¢ Ã— è´·æ¬¾åˆ©ç‡',
                        '3. è¿è¥æˆæœ¬ = è´·æ¬¾ä½™é¢ Ã— 2% (å›ºå®šæˆæœ¬ç‡)',
                        '4. è¿çº¦æŸå¤± = è¿çº¦è´·æ¬¾æœ¬é‡‘ Ã— 60% (å›æ”¶ç‡)',
                        '5. å°†120ä¸ªæœˆçš„å‡€åˆ©æ¶¦ç´¯åŠ å¾—åˆ°10å¹´æ€»åˆ©æ¶¦'
                    ],
                    meaning: 'åæ˜ ç­–ç•¥çš„é•¿æœŸç›ˆåˆ©èƒ½åŠ›ï¼Œæ•°å€¼è¶Šé«˜è¶Šå¥½ã€‚'
                },
                'npl': {
                    title: 'å¹³å‡NPLè®¡ç®—è¯´æ˜',
                    formula: 'å¹³å‡NPL = Î£(æ¯æœˆNPLç‡) / æ€»æœˆæ•°',
                    steps: [
                        '1. æ¯æœˆè®¡ç®—NPLç‡ = ä¸è‰¯è´·æ¬¾ä½™é¢ / æ€»è´·æ¬¾ä½™é¢',
                        '2. ä¸è‰¯è´·æ¬¾ = é€¾æœŸ90å¤©ä»¥ä¸Šçš„è´·æ¬¾',
                        '3. å°†120ä¸ªæœˆçš„NPLç‡æ±‚å’Œï¼Œé™¤ä»¥120å¾—åˆ°å¹³å‡å€¼',
                        '4. é€šå¸¸é“¶è¡Œè¦æ±‚NPLç‡ < 5%'
                    ],
                    meaning: 'åæ˜ ç­–ç•¥çš„é£é™©æ§åˆ¶èƒ½åŠ›ï¼Œæ•°å€¼è¶Šä½è¶Šå¥½ã€‚'
                },
                'bankruptcy': {
                    title: 'ç ´äº§ç‡è®¡ç®—è¯´æ˜',
                    formula: 'ç ´äº§ç‡ = ç ´äº§æ¬¡æ•° / æ€»å›åˆæ•°',
                    steps: [
                        '1. æ¯ä¸ªå›åˆæ£€æŸ¥æ˜¯å¦ç ´äº§',
                        '2. ç ´äº§æ¡ä»¶ï¼šèµ„æœ¬å……è¶³ç‡ < 8% æˆ– NPLç‡ > 25%',
                        '3. èµ„æœ¬å……è¶³ç‡ = èµ„æœ¬ / é£é™©åŠ æƒèµ„äº§',
                        '4. ç»Ÿè®¡æ‰€æœ‰å›åˆä¸­ç ´äº§çš„æ¬¡æ•°',
                        '5. ç ´äº§ç‡ = ç ´äº§æ¬¡æ•° / æ€»å›åˆæ•°'
                    ],
                    meaning: 'åæ˜ ç­–ç•¥çš„ç¨³å¥æ€§ï¼Œæ•°å€¼è¶Šä½è¶Šå¥½ï¼Œç†æƒ³ä¸º0%ã€‚'
                }
            };
            
            const exp = explanations[metricType];
            if (!exp) return;
            
            const modal = document.getElementById('metric-calculation-modal');
            if (modal) {
                document.getElementById('metric-calculation-title').textContent = exp.title;
                document.getElementById('metric-calculation-formula').textContent = exp.formula;
                document.getElementById('metric-calculation-steps').innerHTML = exp.steps.map(s => `<li style="margin: 8px 0; line-height: 1.8;">${s}</li>`).join('');
                document.getElementById('metric-calculation-meaning').textContent = exp.meaning;
                modal.style.display = 'flex';
            }
        }
        
        // å›¾è¡¨è¯´æ˜
        function showChartExplanation() {
            const modal = document.getElementById('chart-explanation-modal');
            if (!modal) {
                const newModal = document.createElement('div');
                newModal.id = 'chart-explanation-modal';
                newModal.className = 'modal';
                newModal.innerHTML = `
                    <div class="modal-content" style="max-width: 800px; max-height: 90vh;">
                        <div class="modal-header">
                            <h3>ğŸ“Š é›·è¾¾å›¾è¯´æ˜</h3>
                            <button class="modal-close" onclick="closeChartExplanation()">Ã—</button>
                        </div>
                        <div class="modal-body" style="max-height: calc(90vh - 100px); overflow-y: auto;">
                            <div style="margin-bottom: 24px;">
                                <h4 style="color: var(--accent-primary); margin-bottom: 12px;">å›¾è¡¨ç±»å‹ï¼šé›·è¾¾å›¾ (Radar Chart)</h4>
                                <p style="font-size: 13px; line-height: 1.8; color: var(--text-secondary);">
                                    é›·è¾¾å›¾ç”¨äºåŒæ—¶å±•ç¤ºå¤šä¸ªç»´åº¦çš„æ•°æ®ï¼Œæ¯ä¸ªç­–ç•¥ç”¨ä¸€æ¡çº¿è¡¨ç¤ºï¼Œçº¿çš„é¢ç§¯è¶Šå¤§ï¼Œè¯´æ˜è¯¥ç­–ç•¥ç»¼åˆè¡¨ç°è¶Šå¥½ã€‚
                                </p>
                            </div>
                            
                            <div style="margin-bottom: 24px;">
                                <h4 style="color: var(--accent-primary); margin-bottom: 12px;">å››ä¸ªç»´åº¦è¯´æ˜</h4>
                                
                                <div style="margin-bottom: 16px; padding: 12px; background: rgba(255, 255, 255, 0.03); border-radius: 8px;">
                                    <h5 style="color: #4facfe; margin-bottom: 6px;">1. å¹³å‡å¥–åŠ±</h5>
                                    <p style="font-size: 12px; color: var(--text-secondary); line-height: 1.6;">
                                        è®¡ç®—å…¬å¼ï¼š(å¹³å‡å¥–åŠ± + 100) / 2ï¼Œå½’ä¸€åŒ–åˆ°0-100èŒƒå›´
                                        <br>æ•°å€¼è¶Šå¤§ï¼Œè¯´æ˜ç­–ç•¥å•æœˆè¡¨ç°è¶Šå¥½
                                    </p>
                                </div>
                                
                                <div style="margin-bottom: 16px; padding: 12px; background: rgba(255, 255, 255, 0.03); border-radius: 8px;">
                                    <h5 style="color: #4facfe; margin-bottom: 6px;">2. ç´¯è®¡åˆ©æ¶¦</h5>
                                    <p style="font-size: 12px; color: var(--text-secondary); line-height: 1.6;">
                                        è®¡ç®—å…¬å¼ï¼šç´¯è®¡åˆ©æ¶¦ / 10ï¼Œå°†åˆ©æ¶¦å€¼ç¼©å°10å€æ˜¾ç¤º
                                        <br>æ•°å€¼è¶Šå¤§ï¼Œè¯´æ˜ç­–ç•¥é•¿æœŸç›ˆåˆ©èƒ½åŠ›è¶Šå¼º
                                    </p>
                                </div>
                                
                                <div style="margin-bottom: 16px; padding: 12px; background: rgba(255, 255, 255, 0.03); border-radius: 8px;">
                                    <h5 style="color: #4facfe; margin-bottom: 6px;">3. NPLæ§åˆ¶</h5>
                                    <p style="font-size: 12px; color: var(--text-secondary); line-height: 1.6;">
                                        è®¡ç®—å…¬å¼ï¼š(1 - å¹³å‡NPL) Ã— 100ï¼Œè½¬æ¢ä¸ºæ§åˆ¶èƒ½åŠ›å¾—åˆ†
                                        <br>æ•°å€¼è¶Šå¤§ï¼Œè¯´æ˜é£é™©æ§åˆ¶èƒ½åŠ›è¶Šå¼º
                                    </p>
                                </div>
                                
                                <div style="margin-bottom: 16px; padding: 12px; background: rgba(255, 255, 255, 0.03); border-radius: 8px;">
                                    <h5 style="color: #4facfe; margin-bottom: 6px;">4. ç¨³å®šæ€§</h5>
                                    <p style="font-size: 12px; color: var(--text-secondary); line-height: 1.6;">
                                        è®¡ç®—å…¬å¼ï¼š(1 - ç ´äº§ç‡) Ã— 100ï¼Œè½¬æ¢ä¸ºç¨³å®šæ€§å¾—åˆ†
                                        <br>æ•°å€¼è¶Šå¤§ï¼Œè¯´æ˜ç­–ç•¥è¶Šç¨³å¥ï¼Œä¸å®¹æ˜“ç ´äº§
                                    </p>
                                </div>
                            </div>
                            
                            <div style="padding: 16px; background: rgba(79, 172, 254, 0.1); border-radius: 8px; border-left: 4px solid #4facfe;">
                                <h4 style="color: #4facfe; margin-bottom: 12px;">ğŸ’¡ å¦‚ä½•è§£è¯»é›·è¾¾å›¾ï¼Ÿ</h4>
                                <ul style="margin-left: 20px; line-height: 2; font-size: 13px;">
                                    <li><strong>é¢ç§¯å¤§å°ï¼š</strong>çº¿çš„é¢ç§¯è¶Šå¤§ï¼Œè¯´æ˜ç­–ç•¥ç»¼åˆè¡¨ç°è¶Šå¥½</li>
                                    <li><strong>å½¢çŠ¶ï¼š</strong>å¦‚æœæŸä¸ªç»´åº¦ç‰¹åˆ«çªå‡ºï¼Œè¯´æ˜è¯¥ç­–ç•¥åœ¨è¿™ä¸ªæ–¹é¢æœ‰ä¼˜åŠ¿</li>
                                    <li><strong>å¹³è¡¡æ€§ï¼š</strong>å¦‚æœå››ä¸ªç»´åº¦éƒ½æ¯”è¾ƒå‡è¡¡ï¼Œè¯´æ˜ç­–ç•¥æ¯”è¾ƒç¨³å¥</li>
                                    <li><strong>å¯¹æ¯”ï¼š</strong>å¤šæ¡çº¿é‡å æ—¶ï¼Œé¢ç§¯æ›´å¤§çš„ç­–ç•¥æ›´ä¼˜</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(newModal);
                
                newModal.addEventListener('click', function(e) {
                    if (e.target === newModal) {
                        closeChartExplanation();
                    }
                });
            }
            
            document.getElementById('chart-explanation-modal').style.display = 'flex';
        }
        
        function closeChartExplanation() {
            const modal = document.getElementById('chart-explanation-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // AIè§£é‡ŠåŠŸèƒ½
        async function showAIExplanation(type) {
            if (type === 'comparison' && !window.comparisonResults) {
                alert('è¯·å…ˆè¿è¡Œç­–ç•¥å¯¹æ¯”');
                return;
            }
            
            const modal = document.getElementById('ai-explanation-modal');
            if (!modal) {
                const newModal = document.createElement('div');
                newModal.id = 'ai-explanation-modal';
                newModal.className = 'modal';
                newModal.innerHTML = `
                    <div class="modal-content" style="max-width: 900px; max-height: 90vh;">
                        <div class="modal-header">
                            <h3>ğŸ¤– AIæ™ºèƒ½è§£é‡Š</h3>
                            <button class="modal-close" onclick="closeAIExplanation()">Ã—</button>
                        </div>
                        <div class="modal-body" style="max-height: calc(90vh - 100px); overflow-y: auto;">
                            <div id="ai-explanation-content">
                                <div class="loading">
                                    <div class="spinner"></div>
                                    <p>AIæ­£åœ¨åˆ†æä¸­...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(newModal);
                
                newModal.addEventListener('click', function(e) {
                    if (e.target === newModal) {
                        closeAIExplanation();
                    }
                });
            }
            
            document.getElementById('ai-explanation-modal').style.display = 'flex';
            const content = document.getElementById('ai-explanation-content');
            
            try {
                if (type === 'comparison') {
                    // ç”ŸæˆAIè§£é‡Š
                    const results = window.comparisonResults;
                    if (!results || results.length === 0) {
                        content.innerHTML = '<p style="text-align: center; color: var(--text-muted);">æš‚æ— å¯¹æ¯”ç»“æœ</p>';
                        return;
                    }
                    
                    // åˆ†æç»“æœ
                    const bestStrategy = results[0];
                    const worstStrategy = results[results.length - 1];
                    const avgProfit = results.reduce((sum, r) => sum + r.avg_profit, 0) / results.length;
                    const avgNPL = results.reduce((sum, r) => sum + r.avg_npl, 0) / results.length;
                    
                    let explanation = `
                        <div style="margin-bottom: 24px;">
                            <h4 style="color: var(--accent-primary); margin-bottom: 16px;">ğŸ“Š ç­–ç•¥å¯¹æ¯”åˆ†ææŠ¥å‘Š</h4>
                            
                            <div style="padding: 16px; background: rgba(16, 185, 129, 0.1); border-radius: 8px; border-left: 4px solid #10b981; margin-bottom: 16px;">
                                <h5 style="color: #10b981; margin-bottom: 8px;">ğŸ† æœ€ä½³ç­–ç•¥ï¼š${bestStrategy.name}</h5>
                                <p style="font-size: 13px; line-height: 1.8; color: var(--text-secondary);">
                                    è¯¥ç­–ç•¥åœ¨æœ¬æ¬¡å¯¹æ¯”ä¸­è¡¨ç°æœ€ä¼˜ï¼Œç´¯è®¡åˆ©æ¶¦è¾¾åˆ° <strong>Â¥${bestStrategy.avg_profit.toFixed(0)}äº¿</strong>ï¼Œ
                                    å¹³å‡å¥–åŠ±ä¸º <strong>${bestStrategy.avg_reward.toFixed(2)}</strong>ï¼Œ
                                    NPLç‡ä¸º <strong>${(bestStrategy.avg_npl * 100).toFixed(2)}%</strong>ï¼Œ
                                    ç ´äº§ç‡ä¸º <strong>${(bestStrategy.bankruptcy_rate * 100).toFixed(0)}%</strong>ã€‚
                                </p>
                                <p style="font-size: 13px; line-height: 1.8; color: var(--text-secondary); margin-top: 8px;">
                                    <strong>ä¼˜åŠ¿åˆ†æï¼š</strong>
                                    ${bestStrategy.avg_reward > 0 ? 'âœ“ å¹³å‡å¥–åŠ±ä¸ºæ­£ï¼Œè¯´æ˜ç­–ç•¥èƒ½å¤ŸæŒç»­ç›ˆåˆ©' : 'âœ— å¹³å‡å¥–åŠ±ä¸ºè´Ÿï¼Œéœ€è¦ä¼˜åŒ–'}
                                    ${bestStrategy.avg_npl < 0.05 ? 'ï¼›âœ“ NPLç‡æ§åˆ¶åœ¨5%ä»¥ä¸‹ï¼Œé£é™©æ§åˆ¶è‰¯å¥½' : 'ï¼›âœ— NPLç‡åé«˜ï¼Œéœ€è¦åŠ å¼ºé£é™©æ§åˆ¶'}
                                    ${bestStrategy.bankruptcy_rate === 0 ? 'ï¼›âœ“ ç ´äº§ç‡ä¸º0ï¼Œç­–ç•¥éå¸¸ç¨³å¥' : 'ï¼›âš  å­˜åœ¨ç ´äº§é£é™©ï¼Œéœ€è¦è°¨æ…ä½¿ç”¨'}
                                </p>
                            </div>
                            
                            <div style="padding: 16px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border-left: 4px solid #ef4444; margin-bottom: 16px;">
                                <h5 style="color: #ef4444; margin-bottom: 8px;">âš ï¸ æœ€å·®ç­–ç•¥ï¼š${worstStrategy.name}</h5>
                                <p style="font-size: 13px; line-height: 1.8; color: var(--text-secondary);">
                                    è¯¥ç­–ç•¥è¡¨ç°è¾ƒå·®ï¼Œç´¯è®¡åˆ©æ¶¦ä¸º <strong>Â¥${worstStrategy.avg_profit.toFixed(0)}äº¿</strong>ï¼Œ
                                    å¹³å‡å¥–åŠ±ä¸º <strong>${worstStrategy.avg_reward.toFixed(2)}</strong>ã€‚
                                    ${worstStrategy.bankruptcy_rate > 0 ? `ç ´äº§ç‡é«˜è¾¾ <strong>${(worstStrategy.bankruptcy_rate * 100).toFixed(0)}%</strong>ï¼Œå­˜åœ¨è¾ƒå¤§é£é™©ã€‚` : ''}
                                </p>
                                <p style="font-size: 13px; line-height: 1.8; color: var(--text-secondary); margin-top: 8px;">
                                    <strong>é—®é¢˜åˆ†æï¼š</strong>
                                    ${worstStrategy.avg_reward < 0 ? 'âœ— å¹³å‡å¥–åŠ±ä¸ºè´Ÿï¼Œç­–ç•¥æ— æ³•æŒç»­ç›ˆåˆ©' : 'âš  å¹³å‡å¥–åŠ±è¾ƒä½ï¼Œç›ˆåˆ©èƒ½åŠ›ä¸è¶³'}
                                    ${worstStrategy.avg_npl > 0.1 ? 'ï¼›âœ— NPLç‡è¶…è¿‡10%ï¼Œé£é™©æ§åˆ¶å¤±æ•ˆ' : worstStrategy.avg_npl > 0.05 ? 'ï¼›âš  NPLç‡åé«˜ï¼Œéœ€è¦æ”¹è¿›' : 'ï¼›âœ“ NPLç‡æ§åˆ¶å°šå¯'}
                                </p>
                            </div>
                            
                            <div style="padding: 16px; background: rgba(79, 172, 254, 0.1); border-radius: 8px; border-left: 4px solid #4facfe;">
                                <h5 style="color: #4facfe; margin-bottom: 12px;">ğŸ’¡ ç»¼åˆå»ºè®®</h5>
                                <ul style="margin-left: 20px; line-height: 2; font-size: 13px;">
                                    <li><strong>æ¨èç­–ç•¥ï¼š</strong>${bestStrategy.name} - åœ¨æ”¶ç›Šå’Œé£é™©ä¹‹é—´å–å¾—äº†æœ€ä½³å¹³è¡¡</li>
                                    <li><strong>é£é™©æç¤ºï¼š</strong>${avgNPL > 0.05 ? 'å¹³å‡NPLç‡åé«˜ï¼Œå»ºè®®åŠ å¼ºé£é™©æ§åˆ¶' : 'å¹³å‡NPLç‡æ§åˆ¶è‰¯å¥½ï¼Œé£é™©å¯æ§'}</li>
                                    <li><strong>æ”¶ç›Šé¢„æœŸï¼š</strong>å¹³å‡ç´¯è®¡åˆ©æ¶¦çº¦Â¥${avgProfit.toFixed(0)}äº¿ï¼Œ${avgProfit > 100 ? 'è¡¨ç°ä¼˜ç§€' : avgProfit > 50 ? 'è¡¨ç°è‰¯å¥½' : 'éœ€è¦æ”¹è¿›'}</li>
                                    <li><strong>é€‚ç”¨åœºæ™¯ï¼š</strong>${bestStrategy.name === 'AlphaZeroç­–ç•¥' ? 'é€‚åˆå¤æ‚ç»æµç¯å¢ƒï¼Œèƒ½å¤ŸåŠ¨æ€é€‚åº”å˜åŒ–' : bestStrategy.name === 'ä¿å®ˆç­–ç•¥' ? 'é€‚åˆé£é™©åŒæ¶å‹é“¶è¡Œï¼Œè¿½æ±‚ç¨³å¥ç»è¥' : bestStrategy.name === 'è§„åˆ™ç­–ç•¥' ? 'é€‚åˆä¼ ç»Ÿé“¶è¡Œï¼ŒåŸºäºå›ºå®šè§„åˆ™è¿è¥' : 'éœ€è¦æ ¹æ®å®é™…æƒ…å†µé€‰æ‹©'}</li>
                                </ul>
                            </div>
                        </div>
                    `;
                    
                    content.innerHTML = explanation;
                }
            } catch (error) {
                console.error('AIè§£é‡Šç”Ÿæˆå¤±è´¥:', error);
                content.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-danger);">
                        <p>AIè§£é‡Šç”Ÿæˆå¤±è´¥: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        function closeAIExplanation() {
            const modal = document.getElementById('ai-explanation-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // ç­–ç•¥è¯¦æƒ…æ¨¡æ€æ¡†
        function showStrategyDetailModal() {
            const modal = document.getElementById('strategy-detail-modal');
            if (!modal) {
                const newModal = document.createElement('div');
                newModal.id = 'strategy-detail-modal';
                newModal.className = 'modal';
                newModal.innerHTML = `
                    <div class="modal-content" style="max-width: 800px; max-height: 90vh;">
                        <div class="modal-header">
                            <h3>ğŸ“‹ ç­–ç•¥è¯¦æƒ…å¯¹æ¯”</h3>
                            <button class="modal-close" onclick="closeStrategyDetail()">Ã—</button>
                        </div>
                        <div class="modal-body" style="max-height: calc(90vh - 100px); overflow-y: auto;">
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: var(--accent-primary); margin-bottom: 12px;">ç­–ç•¥å†³ç­–å‚æ•°å¯¹æ¯”</h4>
                                <table class="data-table" style="width: 100%;">
                                    <thead>
                                        <tr>
                                            <th>ç­–ç•¥</th>
                                            <th>åˆ©ç‡è°ƒæ•´èŒƒå›´</th>
                                            <th>å®¡æ‰¹ç‡èŒƒå›´</th>
                                            <th>ä¼˜è´¨å®¢æˆ·å æ¯”</th>
                                            <th>æ¬¡çº§å®¢æˆ·å æ¯”</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><strong>éšæœºç­–ç•¥</strong></td>
                                            <td>-2% ~ +2%</td>
                                            <td>30% ~ 90%</td>
                                            <td>10% ~ 60%</td>
                                            <td>10% ~ 40%</td>
                                        </tr>
                                        <tr>
                                            <td><strong>è§„åˆ™ç­–ç•¥</strong></td>
                                            <td>-1.5% ~ +1%</td>
                                            <td>40% ~ 75%</td>
                                            <td>35% ~ 65%</td>
                                            <td>10% ~ 25%</td>
                                        </tr>
                                        <tr>
                                            <td><strong>ä¿å®ˆç­–ç•¥</strong></td>
                                            <td>+0.5%</td>
                                            <td>35% ~ 45%</td>
                                            <td>65% ~ 75%</td>
                                            <td>3% ~ 5%</td>
                                        </tr>
                                        <tr>
                                            <td><strong>æ¿€è¿›ç­–ç•¥</strong></td>
                                            <td>+1.5%</td>
                                            <td>65% ~ 90%</td>
                                            <td>20% ~ 35%</td>
                                            <td>25% ~ 45%</td>
                                        </tr>
                                        <tr style="background: rgba(16, 185, 129, 0.1);">
                                            <td><strong>AlphaZero</strong></td>
                                            <td>åŠ¨æ€è°ƒæ•´</td>
                                            <td>åŠ¨æ€è°ƒæ•´</td>
                                            <td>åŠ¨æ€è°ƒæ•´</td>
                                            <td>åŠ¨æ€è°ƒæ•´</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <div style="padding: 16px; background: rgba(79, 172, 254, 0.1); border-radius: 8px; border-left: 4px solid #4facfe;">
                                <h4 style="color: #4facfe; margin-bottom: 12px;">ğŸ’¡ å†³ç­–é€»è¾‘è¯´æ˜</h4>
                                <ul style="margin-left: 20px; line-height: 2; font-size: 13px;">
                                    <li><strong>åˆ©ç‡è°ƒæ•´ï¼š</strong>ç›¸å¯¹äºå¸‚åœºåŸºå‡†åˆ©ç‡çš„è°ƒæ•´å¹…åº¦ï¼Œæ­£æ•°è¡¨ç¤ºæé«˜åˆ©ç‡ï¼Œè´Ÿæ•°è¡¨ç¤ºé™ä½åˆ©ç‡</li>
                                    <li><strong>å®¡æ‰¹ç‡ï¼š</strong>100ä¸ªç”³è¯·ä¸­æ‰¹å‡†çš„æ¯”ä¾‹ï¼Œè¶Šé«˜è¡¨ç¤ºæ”¾è´·è¶Šå®½æ¾</li>
                                    <li><strong>å®¢æˆ·å æ¯”ï¼š</strong>ä¸åŒé£é™©ç­‰çº§å®¢æˆ·çš„è´·æ¬¾æŠ•æ”¾æ¯”ä¾‹ï¼Œä¼˜è´¨å®¢æˆ·é£é™©ä½ä½†æ”¶ç›Šä¹Ÿä½ï¼Œæ¬¡çº§å®¢æˆ·é£é™©é«˜ä½†æ”¶ç›Šé«˜</li>
                                    <li><strong>åŠ¨æ€è°ƒæ•´ï¼š</strong>AlphaZeroç­–ç•¥ä¼šæ ¹æ®å½“å‰ç»æµç¯å¢ƒå’Œé“¶è¡ŒçŠ¶æ€ï¼Œè‡ªåŠ¨è°ƒæ•´è¿™äº›å‚æ•°ï¼Œè€Œä¸æ˜¯ä½¿ç”¨å›ºå®šå€¼</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(newModal);
                
                newModal.addEventListener('click', function(e) {
                    if (e.target === newModal) {
                        closeStrategyDetail();
                    }
                });
            }
            
            document.getElementById('strategy-detail-modal').style.display = 'flex';
        }
        
        function closeStrategyDetail() {
            const modal = document.getElementById('strategy-detail-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // ============================================================
        // æ•°æ®è’¸é¦
        // ============================================================
        
        let distillInterval = null;
        
        function updateDistillOptions() {
            const source = document.getElementById('distill-source').value;
            const syntheticOptions = document.getElementById('synthetic-options');
            const realDataOptions = document.getElementById('real-data-options');
            
            if (source === 'synthetic') {
                syntheticOptions.style.display = 'block';
                realDataOptions.style.display = 'none';
            } else {
                syntheticOptions.style.display = 'none';
                realDataOptions.style.display = 'block';
                
                // æ£€æŸ¥æ•°æ®æºå¯ç”¨æ€§
                checkDataSource(source);
            }
        }
        
        async function checkDataSource(source) {
            const infoDiv = document.getElementById('data-source-info');
            infoDiv.innerHTML = '<div style="font-size: 12px; color: var(--text-muted);">æ­£åœ¨æ£€æŸ¥æ•°æ®æº...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/api/distillation/sources`);
                const data = await response.json();
                
                const sourceMap = {
                    'test_data': 'data/test_data',
                    'historical': 'data/historical'
                };
                const path = sourceMap[source];
                const sourceInfo = data.sources.find(s => s.path === path);
                
                if (sourceInfo) {
                    infoDiv.innerHTML = `
                        <div style="font-size: 13px; color: var(--accent-primary);">âœ… æ•°æ®æºå¯ç”¨</div>
                        <div style="font-size: 12px; margin-top: 4px;">
                            ğŸ“ ${sourceInfo.name}<br>
                            ğŸ‘¥ ${sourceInfo.customers.toLocaleString()} å®¢æˆ·<br>
                            ğŸ’° ${sourceInfo.loans.toLocaleString()} è´·æ¬¾è®°å½•<br>
                            ğŸ’¾ ${sourceInfo.size_gb.toFixed(2)} GB
                        </div>
                    `;
                } else {
                    infoDiv.innerHTML = `
                        <div style="font-size: 13px; color: var(--accent-warning);">âš ï¸ æ•°æ®æºæœªå°±ç»ª</div>
                        <div style="font-size: 12px; margin-top: 4px; color: var(--text-muted);">
                            è¯·å…ˆè¿è¡Œæ•°æ®ç”Ÿæˆè„šæœ¬:<br>
                            <code style="font-size: 11px;">python scripts/generate_dataset.py</code>
                        </div>
                    `;
                }
            } catch (e) {
                infoDiv.innerHTML = `<div style="color: var(--accent-danger); font-size: 12px;">âŒ æ£€æŸ¥å¤±è´¥: ${e.message}</div>`;
            }
        }
        
        async function runDistillation() {
            const source = document.getElementById('distill-source').value;
            const size = parseInt(document.getElementById('distill-size').value);
            const sampleSize = parseInt(document.getElementById('distill-sample').value) || null;
            
            document.getElementById('btn-distill').disabled = true;
            document.getElementById('distill-progress').style.display = 'block';
            document.getElementById('distill-logs').innerHTML = '';
            
            // é‡ç½®æ­¥éª¤çŠ¶æ€
            document.querySelectorAll('#distill-steps .timeline-item').forEach(item => {
                item.classList.remove('active');
                item.classList.add('pending');
            });
            
            // æ„å»ºè¯·æ±‚å‚æ•°
            const params = { data_size: size };
            if (source !== 'synthetic') {
                params.use_real_data = true;
                params.data_path = source === 'test_data' ? 'data/test_data' : 'data/historical';
                if (sampleSize) params.sample_size = sampleSize;
            }
            
            try {
                await fetch(`${API_BASE}/api/distillation/run`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(params)
                });
                
                // è½®è¯¢çŠ¶æ€
                distillInterval = setInterval(async () => {
                    const response = await fetch(`${API_BASE}/api/distillation/status`);
                    const status = await response.json();
                    
                    // æ›´æ–°è¿›åº¦
                    document.getElementById('distill-progress-bar').style.width = `${status.progress}%`;
                    document.getElementById('distill-percent').textContent = `${status.progress}%`;
                    
                    // æ›´æ–°æ—¥å¿—
                    if (status.logs.length > 0) {
                        document.getElementById('distill-logs').innerHTML = status.logs.map(log => 
                            `<div class="log-entry">${log}</div>`
                        ).join('');
                    }
                    
                    // æ›´æ–°æ­¥éª¤çŠ¶æ€
                    const steps = document.querySelectorAll('#distill-steps .timeline-item');
                    const activeStep = Math.floor(status.progress / 20);
                    steps.forEach((step, i) => {
                        step.classList.remove('active', 'pending');
                        if (i < activeStep) {
                            // å®Œæˆ
                        } else if (i === activeStep) {
                            step.classList.add('active');
                        } else {
                            step.classList.add('pending');
                        }
                    });
                    
                    // å®Œæˆ
                    if (!status.running) {
                        clearInterval(distillInterval);
                        document.getElementById('btn-distill').disabled = false;
                        document.getElementById('btn-audit-log').style.display = 'block';
                        
                        if (status.run_id) {
                            document.getElementById('distill-run-id').textContent = `è¿è¡ŒID: ${status.run_id}`;
                        }
                        
                        if (status.result) {
                            const r = status.result;
                            document.getElementById('distill-logs').innerHTML += `
                                <div class="log-entry" style="color: var(--accent-primary); margin-top: 16px;">
                                    â”â”â”â”â”â” éªŒè¯ç»“æœ â”â”â”â”â”â”
                                </div>
                                <div class="log-entry">é¢„æµ‹è¿çº¦ç‡: ${(r.predicted_default_rate * 100).toFixed(2)}%</div>
                                <div class="log-entry">å®é™…è¿çº¦ç‡: ${(r.actual_default_rate * 100).toFixed(2)}%</div>
                                <div class="log-entry">åå·®: ${(r.deviation * 100).toFixed(2)}%</div>
                                <div class="log-entry" style="color: ${r.passed ? 'var(--accent-primary)' : 'var(--accent-danger)'}">
                                    éªŒè¯${r.passed ? 'âœ… é€šè¿‡' : 'âŒ æœªé€šè¿‡'}
                                </div>
                            `;
                            
                            // åŠ è½½è¯¦ç»†è¿½è¸ªä¿¡æ¯
                            loadDistillationTrace();
                        }
                    }
                }, 500);
                
            } catch (error) {
                clearInterval(distillInterval);
                document.getElementById('btn-distill').disabled = false;
                alert('è’¸é¦å¤±è´¥: ' + error.message);
            }
        }
        
        let distillationTraceData = null;
        
        async function loadDistillationTrace() {
            try {
                const response = await fetch(`${API_BASE}/api/distillation/trace`);
                const data = await response.json();
                if (data.success) {
                    distillationTraceData = data.trace;
                    updateStepDetails();
                }
            } catch (e) {
                console.error('åŠ è½½è¿½è¸ªä¿¡æ¯å¤±è´¥:', e);
            }
        }
        
        function updateStepDetails() {
            if (!distillationTraceData || !distillationTraceData.steps) return;
            
            distillationTraceData.steps.forEach(step => {
                const detailDiv = document.getElementById(`step-detail-${step.step_id}`);
                if (!detailDiv) return;
                
                let html = `<div class="action-time">è€—æ—¶: ${step.duration_ms}ms</div>`;
                
                if (step.actions && step.actions.length > 0) {
                    html += '<div style="margin-top: 8px;">';
                    step.actions.forEach(action => {
                        html += `
                            <div class="action-item">
                                <div class="action-icon">ğŸ“Œ</div>
                                <div class="action-content">
                                    <div class="action-name">${action.action}</div>
                                    <div class="action-desc">${JSON.stringify(action).replace(/"action":"[^"]+",?/g, '').slice(1, -1) || 'æ— é™„åŠ ä¿¡æ¯'}</div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                }
                
                // æ·»åŠ æ•°æ®ç»Ÿè®¡
                if (step.data_stats) {
                    html += `
                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color);">
                            <strong>æ•°æ®ç»Ÿè®¡:</strong>
                            <div style="margin-top: 8px;">
                                æ€»è®°å½•: ${step.data_stats.total_records} | 
                                è¿çº¦æ•°: ${step.data_stats.default_count} | 
                                è¿çº¦ç‡: ${step.data_stats.default_rate}%
                            </div>
                        </div>
                    `;
                }
                
                // æ·»åŠ ç‰¹å¾çŸ©é˜µå½¢çŠ¶
                if (step.feature_matrix_shape) {
                    html += `
                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color);">
                            <strong>ç‰¹å¾çŸ©é˜µ:</strong> ${step.feature_matrix_shape[0]} æ ·æœ¬ Ã— ${step.feature_matrix_shape[1]} ç‰¹å¾
                        </div>
                    `;
                }
                
                detailDiv.innerHTML = html;
            });
        }
        
        function showStepDetail(stepId) {
            if (!distillationTraceData) {
                alert('è¯·å…ˆè¿è¡Œè’¸é¦ä»»åŠ¡');
                return;
            }
            
            const step = distillationTraceData.steps?.find(s => s.step_id === stepId);
            if (!step) return;
            
            const stepNames = ['', 'æ•°æ®å‡†å¤‡', 'ç‰¹å¾å·¥ç¨‹', 'è§„å¾‹å»ºæ¨¡', 'å‡½æ•°å°è£…', 'éªŒè¯æ ¡å‡†'];
            document.getElementById('step-modal-title').textContent = `ğŸ“‹ ${stepNames[stepId]} - è¯¦ç»†è¿‡ç¨‹`;
            
            let html = `
                <div class="detail-section">
                    <div class="detail-section-title">â±ï¸ æ‰§è¡Œä¿¡æ¯</div>
                    <div class="detail-grid" style="grid-template-columns: repeat(3, 1fr);">
                        <div class="detail-item">
                            <div class="detail-label">å¼€å§‹æ—¶é—´</div>
                            <div class="detail-value">${step.start_time?.split('T')[1]?.split('.')[0] || '--'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">ç»“æŸæ—¶é—´</div>
                            <div class="detail-value">${step.end_time?.split('T')[1]?.split('.')[0] || '--'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">æ‰§è¡Œè€—æ—¶</div>
                            <div class="detail-value">${step.duration_ms} ms</div>
                        </div>
                    </div>
                </div>
            `;
            
            // æ“ä½œåˆ—è¡¨
            if (step.actions && step.actions.length > 0) {
                html += `
                    <div class="detail-section">
                        <div class="detail-section-title">ğŸ“ æ‰§è¡Œæ“ä½œ (${step.actions.length}é¡¹)</div>
                `;
                step.actions.forEach((action, i) => {
                    html += `
                        <div class="action-item">
                            <div class="action-icon">${i + 1}</div>
                            <div class="action-content">
                                <div class="action-name">${action.action}</div>
                                <div class="action-desc" style="font-family: 'JetBrains Mono', monospace; font-size: 11px; background: var(--bg-secondary); padding: 8px; border-radius: 4px; margin-top: 4px;">
                                    ${JSON.stringify(action, null, 2).replace(/[{}"]/g, '').trim()}
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            // æ­¥éª¤ç‰¹å®šå†…å®¹
            if (stepId === 1 && distillationTraceData.data_samples?.length > 0) {
                html += `
                    <div class="detail-section">
                        <div class="detail-section-title">ğŸ“Š æ•°æ®æ ·æœ¬é¢„è§ˆ (å‰5æ¡)</div>
                        <table class="data-sample-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>å¹´ä»½</th>
                                    <th>å®¢æˆ·ç±»å‹</th>
                                    <th>è´·æ¬¾é‡‘é¢</th>
                                    <th>æ˜¯å¦è¿çº¦</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${distillationTraceData.data_samples.map(s => `
                                    <tr>
                                        <td>${s.index + 1}</td>
                                        <td>${s.year}</td>
                                        <td>${s.customer_type}</td>
                                        <td>Â¥${(s.loan_amount || 0).toLocaleString()}</td>
                                        <td style="color: ${s.defaulted ? 'var(--accent-danger)' : 'var(--accent-success)'}">
                                            ${s.defaulted ? 'æ˜¯' : 'å¦'}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            if (stepId === 2 && distillationTraceData.feature_stats) {
                const fs = distillationTraceData.feature_stats;
                html += `
                    <div class="detail-section">
                        <div class="detail-section-title">ğŸ”¢ ç‰¹å¾ç»Ÿè®¡</div>
                        <div class="detail-grid" style="grid-template-columns: repeat(3, 1fr);">
                            <div class="detail-item">
                                <div class="detail-label">ç‰¹å¾æ•°é‡</div>
                                <div class="detail-value">${fs.total_features}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">æ ·æœ¬æ•°é‡</div>
                                <div class="detail-value">${fs.total_samples}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">æ­£è´Ÿæ ·æœ¬æ¯”</div>
                                <div class="detail-value">${fs.label_distribution?.positive} : ${fs.label_distribution?.negative}</div>
                            </div>
                        </div>
                        <div style="margin-top: 12px;">
                            <strong>ç‰¹å¾åˆ—è¡¨:</strong><br>
                            ${fs.feature_names?.map(f => `<span class="feature-chip">${f}</span>`).join('') || ''}
                        </div>
                    </div>
                `;
            }
            
            if (stepId === 3 && distillationTraceData.model_params?.rules_learned) {
                html += `
                    <div class="detail-section">
                        <div class="detail-section-title">ğŸ“š å­¦ä¹ åˆ°çš„ä¸šåŠ¡è§„åˆ™</div>
                        ${distillationTraceData.model_params.rules_learned.map(rule => `
                            <div class="rule-card">
                                <div class="rule-name">${rule.rule}</div>
                                <div class="rule-params">
                                    ${Object.entries(rule).filter(([k]) => k !== 'rule').map(([k, v]) => `
                                        <div class="rule-param"><span>${k}:</span> ${v}</div>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            if (stepId === 5 && distillationTraceData.validation_details) {
                const vd = distillationTraceData.validation_details;
                html += `
                    <div class="detail-section">
                        <div class="detail-section-title">âœ… éªŒè¯è¯¦æƒ…</div>
                        <div class="detail-grid" style="grid-template-columns: repeat(4, 1fr);">
                            <div class="detail-item">
                                <div class="detail-label">æµ‹è¯•è®°å½•</div>
                                <div class="detail-value">${vd.test_records}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">é¢„æµ‹è¿çº¦ç‡</div>
                                <div class="detail-value">${(vd.predicted_default_rate * 100).toFixed(2)}%</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">å®é™…è¿çº¦ç‡</div>
                                <div class="detail-value">${(vd.actual_default_rate * 100).toFixed(2)}%</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">åå·®/é˜ˆå€¼</div>
                                <div class="detail-value ${vd.passed ? 'positive' : 'negative'}">
                                    ${(vd.deviation * 100).toFixed(2)}% / ${(vd.threshold * 100)}%
                                </div>
                            </div>
                        </div>
                        ${vd.by_customer_type ? `
                            <div style="margin-top: 16px;">
                                <strong>æŒ‰å®¢æˆ·ç±»å‹åˆ†å±‚éªŒè¯:</strong>
                                <table class="data-sample-table" style="margin-top: 8px;">
                                    <thead>
                                        <tr><th>å®¢æˆ·ç±»å‹</th><th>é¢„æµ‹è¿çº¦ç‡</th><th>å®é™…è¿çº¦ç‡</th></tr>
                                    </thead>
                                    <tbody>
                                        ${Object.entries(vd.by_customer_type).map(([type, data]) => `
                                            <tr>
                                                <td>${type}</td>
                                                <td>${(data.predicted * 100).toFixed(2)}%</td>
                                                <td>${(data.actual * 100).toFixed(2)}%</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            document.getElementById('step-modal-content').innerHTML = html;
            document.getElementById('step-detail-modal').style.display = 'flex';
        }
        
        function closeStepModal() {
            document.getElementById('step-detail-modal').style.display = 'none';
        }
        
        async function showAuditLog() {
            try {
                const response = await fetch(`${API_BASE}/api/distillation/audit-log`);
                const data = await response.json();
                
                if (data.success) {
                    // é…ç½®ä¿¡æ¯
                    let configHtml = '';
                    if (data.config) {
                        configHtml = `
                            <div class="stat-card" style="margin-bottom: 16px;">
                                <div class="grid grid-4">
                                    <div>
                                        <div class="stat-label">è¿è¡ŒID</div>
                                        <div style="font-family: 'JetBrains Mono'">${data.run_id || '--'}</div>
                                    </div>
                                    <div>
                                        <div class="stat-label">æ•°æ®æ¨¡å¼</div>
                                        <div>${data.config.data_mode === 'real' ? 'çœŸå®æ•°æ®' : 'åˆæˆæ•°æ®'}</div>
                                    </div>
                                    <div>
                                        <div class="stat-label">æ•°æ®æ¥æº</div>
                                        <div>${data.config.data_path || 'åˆæˆç”Ÿæˆ'}</div>
                                    </div>
                                    <div>
                                        <div class="stat-label">æ ·æœ¬æ•°é‡</div>
                                        <div>${data.config.sample_size}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    document.getElementById('audit-config').innerHTML = configHtml;
                    
                    // å®¡è®¡æ—¥å¿—
                    let logHtml = '<div style="max-height: 400px; overflow-y: auto;">';
                    if (data.audit_log && data.audit_log.length > 0) {
                        data.audit_log.forEach(entry => {
                            const time = entry.timestamp?.split('T')[1]?.split('.')[0] || '--';
                            logHtml += `
                                <div class="audit-entry">
                                    <div class="audit-time">${time}</div>
                                    <div class="audit-action">${entry.action}</div>
                                    <div class="audit-detail">${entry.details}</div>
                                </div>
                            `;
                        });
                    } else {
                        logHtml += '<div style="text-align: center; color: var(--text-muted); padding: 40px;">æš‚æ— å®¡è®¡æ—¥å¿—</div>';
                    }
                    logHtml += '</div>';
                    document.getElementById('audit-log-content').innerHTML = logHtml;
                    
                    document.getElementById('audit-log-modal').style.display = 'flex';
                }
            } catch (e) {
                alert('åŠ è½½å®¡è®¡æ—¥å¿—å¤±è´¥: ' + e.message);
            }
        }
        
        function closeAuditLog() {
            document.getElementById('audit-log-modal').style.display = 'none';
        }
        
        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
        ['audit-log-modal', 'step-detail-modal', 'trace-modal'].forEach(id => {
            document.getElementById(id)?.addEventListener('click', function(e) {
                if (e.target === this) this.style.display = 'none';
            });
        });
        
        function closeTraceModal() {
            document.getElementById('trace-modal').style.display = 'none';
        }
        
        // ========== ç»æµå‘¨æœŸåˆ†æè¿½è¸ª ==========
        async function showCycleTrace() {
            try {
                const response = await fetch(`${API_BASE}/api/analysis/trace`);
                const data = await response.json();
                
                if (data.success && data.trace) {
                    const trace = data.trace;
                    document.getElementById('trace-modal-title').textContent = 'ğŸ“ˆ ç»æµå‘¨æœŸåˆ†æ - è¿‡ç¨‹è¿½è¸ª';
                    
                    let html = `
                        <div class="stat-card" style="margin-bottom: 16px;">
                            <div class="grid grid-4">
                                <div>
                                    <div class="stat-label">è¿è¡ŒID</div>
                                    <div style="font-family: 'JetBrains Mono'">${trace.run_id || '--'}</div>
                                </div>
                                <div>
                                    <div class="stat-label">å¼€å§‹æ—¶é—´</div>
                                    <div>${trace.start_time?.split('T')[1]?.split('.')[0] || '--'}</div>
                                </div>
                                <div>
                                    <div class="stat-label">æ ·æœ¬æ•°é‡</div>
                                    <div>${trace.config?.customer_count || '--'}</div>
                                </div>
                                <div>
                                    <div class="stat-label">åˆ†æåœºæ™¯</div>
                                    <div>4ä¸ªç»æµå‘¨æœŸ</div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // æ­¥éª¤è¯¦æƒ…
                    if (trace.steps?.length > 0) {
                        html += '<div class="detail-section"><div class="detail-section-title">ğŸ“‹ æ‰§è¡Œæ­¥éª¤</div>';
                        trace.steps.forEach(step => {
                            html += `
                                <div class="action-item">
                                    <div class="action-icon">${step.step_id}</div>
                                    <div class="action-content">
                                        <div class="action-name">${step.name}</div>
                                        <div class="action-desc" style="font-size: 12px; color: var(--text-muted);">
                                            ${step.duration_ms ? `è€—æ—¶: ${step.duration_ms}ms | ` : ''}
                                            ${JSON.stringify(step.details || {}).slice(0, 200)}...
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        html += '</div>';
                    }
                    
                    // å®¢æˆ·æ ·æœ¬
                    if (trace.customer_samples?.length > 0) {
                        html += `
                            <div class="detail-section">
                                <div class="detail-section-title">ğŸ‘¥ å®¢æˆ·æ ·æœ¬ (å‰10ä¸ª)</div>
                                <table class="data-sample-table">
                                    <thead><tr><th>ID</th><th>ç±»å‹</th><th>æœˆæ”¶å…¥</th><th>è´Ÿå€ºç‡</th></tr></thead>
                                    <tbody>
                                        ${trace.customer_samples.map(c => `
                                            <tr>
                                                <td>${c.id?.slice(-8) || '--'}</td>
                                                <td>${c.type}</td>
                                                <td>Â¥${(c.income || 0).toLocaleString()}</td>
                                                <td>${(c.debt_ratio * 100).toFixed(1)}%</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `;
                    }
                    
                    // å®¡è®¡æ—¥å¿—
                    html += buildAuditLogHtml(trace.audit_log);
                    
                    document.getElementById('trace-modal-content').innerHTML = html;
                    document.getElementById('trace-modal').style.display = 'flex';
                }
            } catch (e) {
                alert('åŠ è½½è¿½è¸ªä¿¡æ¯å¤±è´¥: ' + e.message);
            }
        }
        
        // ========== é“¶è¡Œæ¨¡æ‹Ÿè¿½è¸ª ==========
        async function showSimulationTrace() {
            try {
                const response = await fetch(`${API_BASE}/api/simulation/trace`);
                const data = await response.json();
                
                if (data.success && data.trace) {
                    const trace = data.trace;
                    document.getElementById('trace-modal-title').textContent = 'ğŸ¦ é“¶è¡Œæ¨¡æ‹Ÿ - è¿‡ç¨‹è¿½è¸ª';
                    
                    let html = `
                        <div class="stat-card" style="margin-bottom: 16px;">
                            <div class="grid grid-4">
                                <div>
                                    <div class="stat-label">è¿è¡ŒID</div>
                                    <div style="font-family: 'JetBrains Mono'">${trace.run_id || '--'}</div>
                                </div>
                                <div>
                                    <div class="stat-label">ä½¿ç”¨ç­–ç•¥</div>
                                    <div>${trace.config?.strategy_name || '--'}</div>
                                </div>
                                <div>
                                    <div class="stat-label">æ¨¡æ‹Ÿæœˆæ•°</div>
                                    <div>${trace.summary?.total_months || '--'}</div>
                                </div>
                                <div>
                                    <div class="stat-label">æœ€ç»ˆç»“æœ</div>
                                    <div style="color: ${trace.summary?.is_bankrupt ? 'var(--accent-danger)' : 'var(--accent-success)'}">
                                        ${trace.summary?.is_bankrupt ? 'ç ´äº§' : 'å­˜æ´»'}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // å…³é”®äº‹ä»¶
                    if (trace.key_events?.length > 0) {
                        html += '<div class="detail-section"><div class="detail-section-title">âš ï¸ å…³é”®äº‹ä»¶</div>';
                        trace.key_events.forEach(e => {
                            html += `
                                <div class="action-item">
                                    <div class="action-icon" style="background: rgba(239, 68, 68, 0.2); color: var(--accent-danger);">!</div>
                                    <div class="action-content">
                                        <div class="action-name">ç¬¬${e.month}æœˆ: ${e.event}</div>
                                        <div class="action-desc">${e.details}</div>
                                    </div>
                                </div>
                            `;
                        });
                        html += '</div>';
                    }
                    
                    // æœˆåº¦å†³ç­–æ ·æœ¬
                    if (trace.monthly_decisions?.length > 0) {
                        html += `
                            <div class="detail-section">
                                <div class="detail-section-title">ğŸ“Š æœˆåº¦å†³ç­–è®°å½• (å…³é”®æœˆä»½)</div>
                                <table class="data-sample-table">
                                    <thead><tr><th>æœˆä»½</th><th>ç»æµå‘¨æœŸ</th><th>å†³ç­–</th><th>èµ„æœ¬å˜åŒ–</th><th>NPLå˜åŒ–</th><th>å¥–åŠ±</th></tr></thead>
                                    <tbody>
                                        ${trace.monthly_decisions.slice(0, 15).map(d => `
                                            <tr>
                                                <td>${d.month}</td>
                                                <td>${d.eco_phase}</td>
                                                <td style="color: ${d.action_name === 'æ‰¹å‡†' ? 'var(--accent-success)' : 'var(--accent-danger)'}">
                                                    ${d.action_name}
                                                </td>
                                                <td style="color: ${d.capital_change >= 0 ? 'var(--accent-success)' : 'var(--accent-danger)'}">
                                                    ${d.capital_change >= 0 ? '+' : ''}Â¥${(d.capital_change/1e8).toFixed(2)}äº¿
                                                </td>
                                                <td style="color: ${d.npl_change <= 0 ? 'var(--accent-success)' : 'var(--accent-danger)'}">
                                                    ${d.npl_change >= 0 ? '+' : ''}${(d.npl_change*100).toFixed(2)}%
                                                </td>
                                                <td>${d.reward.toFixed(2)}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `;
                    }
                    
                    // å®¡è®¡æ—¥å¿—
                    html += buildAuditLogHtml(trace.audit_log);
                    
                    document.getElementById('trace-modal-content').innerHTML = html;
                    document.getElementById('trace-modal').style.display = 'flex';
                }
            } catch (e) {
                alert('åŠ è½½è¿½è¸ªä¿¡æ¯å¤±è´¥: ' + e.message);
            }
        }
        
        // ========== ç­–ç•¥å¯¹æ¯”è¿½è¸ª ==========
        async function showComparisonTrace() {
            try {
                const response = await fetch(`${API_BASE}/api/comparison/trace`);
                const data = await response.json();
                
                if (data.success && data.trace) {
                    const trace = data.trace;
                    document.getElementById('trace-modal-title').textContent = 'âš”ï¸ ç­–ç•¥å¯¹æ¯” - è¿‡ç¨‹è¿½è¸ª';
                    
                    let html = `
                        <div class="stat-card" style="margin-bottom: 16px;">
                            <div class="grid grid-4">
                                <div>
                                    <div class="stat-label">è¿è¡ŒID</div>
                                    <div style="font-family: 'JetBrains Mono'">${trace.run_id || '--'}</div>
                                </div>
                                <div>
                                    <div class="stat-label">ç­–ç•¥æ•°é‡</div>
                                    <div>${trace.strategies?.length || 4}</div>
                                </div>
                                <div>
                                    <div class="stat-label">æ¯ç­–ç•¥å›åˆ</div>
                                    <div>${trace.config?.episodes_per_strategy || '--'}</div>
                                </div>
                                <div>
                                    <div class="stat-label">èƒœå‡ºç­–ç•¥</div>
                                    <div style="color: var(--accent-primary)">${trace.winner || '--'}</div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // å„ç­–ç•¥è¯¦ç»†ç»“æœ
                    if (trace.episode_details) {
                        html += '<div class="detail-section"><div class="detail-section-title">ğŸ“Š å„ç­–ç•¥å›åˆè¯¦æƒ…</div>';
                        for (const [strategy, episodes] of Object.entries(trace.episode_details)) {
                            const result = trace.results?.find(r => r.name === strategy);
                            html += `
                                <div class="rule-card">
                                    <div class="rule-name">${strategy} ${result ? `(å¹³å‡å¥–åŠ±: ${result.avg_reward.toFixed(2)})` : ''}</div>
                                    <table class="data-sample-table" style="margin-top: 8px;">
                                        <thead><tr><th>å›åˆ</th><th>æœˆæ•°</th><th>å¥–åŠ±</th><th>åˆ©æ¶¦</th><th>NPL</th><th>ç»“æœ</th></tr></thead>
                                        <tbody>
                                            ${episodes.map(ep => `
                                                <tr>
                                                    <td>${ep.episode}</td>
                                                    <td>${ep.months}</td>
                                                    <td>${ep.reward.toFixed(2)}</td>
                                                    <td>Â¥${(ep.profit/1e8).toFixed(1)}äº¿</td>
                                                    <td>${(ep.npl*100).toFixed(1)}%</td>
                                                    <td style="color: ${ep.bankrupt ? 'var(--accent-danger)' : 'var(--accent-success)'}">
                                                        ${ep.bankrupt ? 'ç ´äº§' : 'å­˜æ´»'}
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            `;
                        }
                        html += '</div>';
                    }
                    
                    // å®¡è®¡æ—¥å¿—
                    html += buildAuditLogHtml(trace.audit_log);
                    
                    document.getElementById('trace-modal-content').innerHTML = html;
                    document.getElementById('trace-modal').style.display = 'flex';
                }
            } catch (e) {
                alert('åŠ è½½è¿½è¸ªä¿¡æ¯å¤±è´¥: ' + e.message);
            }
        }
        
        // æ„å»ºå®¡è®¡æ—¥å¿—HTML
        function buildAuditLogHtml(auditLog) {
            if (!auditLog || auditLog.length === 0) return '';
            
            return `
                <div class="detail-section">
                    <div class="detail-section-title">ğŸ“‹ å®¡è®¡æ—¥å¿— (${auditLog.length}æ¡)</div>
                    <div style="max-height: 250px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px;">
                        ${auditLog.map(entry => `
                            <div class="audit-entry">
                                <div class="audit-time">${entry.timestamp?.split('T')[1]?.split('.')[0] || '--'}</div>
                                <div class="audit-action">${entry.action}</div>
                                <div class="audit-detail">${entry.details}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        // ========== æ•°æ®æµè§ˆå™¨ ==========
        let currentDataSource = 'test_data';
        let currentTable = 'customers';
        let currentPage = 1;
        let totalPages = 1;
        
        async function refreshDataSources() {
            try {
                const response = await fetch(`${API_BASE}/api/data/sources`);
                const data = await response.json();
                
                if (data.success) {
                    let html = '';
                    data.sources.forEach(source => {
                        const isActive = source.name === currentDataSource;
                        html += `
                            <div class="data-source-item ${isActive ? 'active' : ''}" onclick="selectDataSource('${source.name}')">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <strong>ğŸ“ ${source.name}</strong>
                                    <span style="font-size: 11px; color: var(--text-muted);">
                                        ${source.summary?.total_customers?.toLocaleString() || '?'} å®¢æˆ·
                                    </span>
                                </div>
                                <div style="margin-top: 8px;">
                                    ${source.files.map(f => `
                                        <div class="data-file-item ${f.name.replace('.parquet','') === currentTable && isActive ? 'active' : ''}" 
                                             onclick="event.stopPropagation(); selectTable('${source.name}', '${f.name.replace('.parquet','')}')">
                                            <span>ğŸ“„ ${f.name}</span>
                                            <span>${f.size_mb} MB</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    });
                    document.getElementById('data-sources-list').innerHTML = html;
                }
            } catch (e) {
                document.getElementById('data-sources-list').innerHTML = `
                    <div style="color: var(--accent-danger); padding: 20px;">åŠ è½½å¤±è´¥: ${e.message}</div>
                `;
            }
        }
        
        function selectDataSource(source) {
            currentDataSource = source;
            refreshDataSources();
        }
        
        async function selectTable(source, table) {
            currentDataSource = source;
            currentTable = table;
            currentPage = 1;
            
            refreshDataSources();
            await loadTableSchema();
            await loadTableData();
        }
        
        async function loadTableSchema() {
            try {
                const response = await fetch(`${API_BASE}/api/data/schema`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ source: currentDataSource, table: currentTable })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('btn-stats').style.display = 'block';
                    
                    let html = `
                        <div style="margin-bottom: 12px; font-size: 13px; color: var(--text-muted);">
                            ${data.total_records.toLocaleString()} æ¡è®°å½• Â· ${data.total_columns} ä¸ªå­—æ®µ
                        </div>
                        <div style="max-height: 300px; overflow-y: auto;">
                            <table class="schema-table">
                                <thead>
                                    <tr><th>å­—æ®µå</th><th>ç±»å‹</th><th>ç©ºå€¼</th><th>å”¯ä¸€å€¼</th></tr>
                                </thead>
                                <tbody>
                    `;
                    
                    data.schema.forEach(col => {
                        const dtypeClass = col.dtype.includes('int') ? 'dtype-int' : 
                                          col.dtype.includes('float') ? 'dtype-float' :
                                          col.dtype.includes('bool') ? 'dtype-bool' :
                                          col.dtype.includes('datetime') ? 'dtype-datetime' : 'dtype-object';
                        html += `
                            <tr>
                                <td><strong>${col.name}</strong></td>
                                <td><span class="dtype-badge ${dtypeClass}">${col.dtype}</span></td>
                                <td>${col.null_count}</td>
                                <td>${col.unique_count}</td>
                            </tr>
                        `;
                    });
                    
                    html += '</tbody></table></div>';
                    document.getElementById('table-schema').innerHTML = html;
                }
            } catch (e) {
                document.getElementById('table-schema').innerHTML = `
                    <div style="color: var(--accent-danger);">åŠ è½½å¤±è´¥: ${e.message}</div>
                `;
            }
        }
        
        async function loadTableData() {
            const search = document.getElementById('data-search')?.value || '';
            
            try {
                const response = await fetch(`${API_BASE}/api/data/browse`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        source: currentDataSource,
                        table: currentTable,
                        page: currentPage,
                        page_size: 20,
                        search: search
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    totalPages = data.total_pages;
                    
                    if (data.records.length === 0) {
                        document.getElementById('data-table-container').innerHTML = `
                            <div style="text-align: center; color: var(--text-muted); padding: 40px;">æ²¡æœ‰æ‰¾åˆ°è®°å½•</div>
                        `;
                        document.getElementById('data-pagination').style.display = 'none';
                        return;
                    }
                    
                    // æ„å»ºè¡¨æ ¼
                    let html = '<div class="data-grid"><table><thead><tr>';
                    
                    // åªæ˜¾ç¤ºå‰8åˆ—
                    const displayCols = data.columns.slice(0, 8);
                    displayCols.forEach(col => {
                        html += `<th>${col}</th>`;
                    });
                    if (data.columns.length > 8) {
                        html += `<th style="color: var(--text-muted);">+${data.columns.length - 8} æ›´å¤š</th>`;
                    }
                    html += '</tr></thead><tbody>';
                    
                    data.records.forEach(record => {
                        const recordId = record[data.columns[0]];
                        html += `<tr onclick="showRecordDetail('${currentDataSource}', '${currentTable}', '${recordId}')">`;
                        displayCols.forEach(col => {
                            let val = record[col];
                            if (val === null) val = '<span style="color:var(--text-muted)">NULL</span>';
                            else if (typeof val === 'boolean') val = val ? 'âœ“' : 'âœ—';
                            else if (typeof val === 'number') val = val.toLocaleString();
                            html += `<td>${val}</td>`;
                        });
                        if (data.columns.length > 8) {
                            html += '<td>...</td>';
                        }
                        html += '</tr>';
                    });
                    
                    html += '</tbody></table></div>';
                    document.getElementById('data-table-container').innerHTML = html;
                    
                    // åˆ†é¡µ
                    document.getElementById('data-pagination').style.display = 'flex';
                    document.getElementById('pagination-info').textContent = 
                        `ç¬¬ ${currentPage} / ${totalPages} é¡µ Â· å…± ${data.total_records.toLocaleString()} æ¡è®°å½•`;
                    document.getElementById('btn-prev').disabled = currentPage <= 1;
                    document.getElementById('btn-next').disabled = currentPage >= totalPages;
                }
            } catch (e) {
                document.getElementById('data-table-container').innerHTML = `
                    <div style="color: var(--accent-danger); padding: 20px;">åŠ è½½å¤±è´¥: ${e.message}</div>
                `;
            }
        }
        
        function searchData() {
            currentPage = 1;
            loadTableData();
        }
        
        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                loadTableData();
            }
        }
        
        function nextPage() {
            if (currentPage < totalPages) {
                currentPage++;
                loadTableData();
            }
        }
        
        async function showRecordDetail(source, table, recordId) {
            try {
                const response = await fetch(`${API_BASE}/api/data/record/${source}/${table}/${recordId}`);
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('record-modal-title').textContent = `ğŸ“‹ è®°å½•è¯¦æƒ… - ${recordId}`;
                    
                    let html = `
                        <div style="margin-bottom: 16px; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                            <div class="grid grid-3">
                                <div><span style="color:var(--text-muted)">æ•°æ®æº:</span> ${source}</div>
                                <div><span style="color:var(--text-muted)">æ•°æ®è¡¨:</span> ${table}</div>
                                <div><span style="color:var(--text-muted)">å­—æ®µæ•°:</span> ${data.field_details.length}</div>
                            </div>
                        </div>
                    `;
                    
                    data.field_details.forEach(field => {
                        const dtypeClass = field.dtype.includes('int') ? 'dtype-int' : 
                                          field.dtype.includes('float') ? 'dtype-float' :
                                          field.dtype.includes('bool') ? 'dtype-bool' : 'dtype-object';
                        
                        let displayVal = field.value;
                        if (field.is_null) {
                            displayVal = '<span style="color:var(--text-muted);font-style:italic">NULL</span>';
                        } else if (typeof field.value === 'boolean') {
                            displayVal = field.value ? '<span style="color:var(--accent-success)">âœ“ æ˜¯</span>' : '<span style="color:var(--accent-danger)">âœ— å¦</span>';
                        } else if (typeof field.value === 'number') {
                            displayVal = field.value.toLocaleString();
                        }
                        
                        html += `
                            <div class="record-field">
                                <div class="field-name">${field.name}</div>
                                <div class="field-value">${displayVal}</div>
                                <div class="field-meta">
                                    <span class="dtype-badge ${dtypeClass}">${field.dtype}</span>
                                </div>
                            </div>
                        `;
                    });
                    
                    document.getElementById('record-modal-content').innerHTML = html;
                    document.getElementById('record-detail-modal').style.display = 'flex';
                }
            } catch (e) {
                alert('åŠ è½½è®°å½•å¤±è´¥: ' + e.message);
            }
        }
        
        function closeRecordModal() {
            document.getElementById('record-detail-modal').style.display = 'none';
        }
        
        async function showTableStats() {
            try {
                const response = await fetch(`${API_BASE}/api/data/stats`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ source: currentDataSource, table: currentTable })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const stats = data.stats;
                    document.getElementById('stats-modal-title').textContent = `ğŸ“Š ${currentTable} ç»Ÿè®¡ä¿¡æ¯`;
                    
                    let html = `
                        <div class="stat-card" style="margin-bottom: 16px;">
                            <div class="grid grid-4">
                                <div>
                                    <div class="stat-label">æ€»è®°å½•æ•°</div>
                                    <div class="stat-value">${stats.total_records.toLocaleString()}</div>
                                </div>
                                <div>
                                    <div class="stat-label">å­—æ®µæ•°</div>
                                    <div class="stat-value">${stats.total_columns}</div>
                                </div>
                                <div>
                                    <div class="stat-label">å†…å­˜å ç”¨</div>
                                    <div class="stat-value">${stats.memory_usage_mb} MB</div>
                                </div>
                                <div>
                                    <div class="stat-label">æ•°æ®æº</div>
                                    <div class="stat-value">${currentDataSource}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="detail-section">
                            <div class="detail-section-title">ğŸ“‹ å­—æ®µç»Ÿè®¡</div>
                            <div style="max-height: 400px; overflow-y: auto;">
                    `;
                    
                    for (const [colName, colStats] of Object.entries(stats.column_stats)) {
                        const dtypeClass = colStats.dtype.includes('int') ? 'dtype-int' : 
                                          colStats.dtype.includes('float') ? 'dtype-float' :
                                          colStats.dtype.includes('bool') ? 'dtype-bool' : 'dtype-object';
                        
                        html += `
                            <div class="rule-card">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <div class="rule-name">${colName}</div>
                                    <span class="dtype-badge ${dtypeClass}">${colStats.dtype}</span>
                                </div>
                                <div class="grid grid-4" style="font-size: 12px;">
                                    <div>
                                        <span style="color:var(--text-muted)">ç©ºå€¼:</span> 
                                        ${colStats.null_count} (${colStats.null_percent}%)
                                    </div>
                                    <div>
                                        <span style="color:var(--text-muted)">å”¯ä¸€å€¼:</span> 
                                        ${colStats.unique_count}
                                    </div>
                        `;
                        
                        if (colStats.min !== undefined) {
                            html += `
                                    <div>
                                        <span style="color:var(--text-muted)">èŒƒå›´:</span> 
                                        ${colStats.min?.toLocaleString()} ~ ${colStats.max?.toLocaleString()}
                                    </div>
                                    <div>
                                        <span style="color:var(--text-muted)">å‡å€¼:</span> 
                                        ${colStats.mean?.toFixed(2)}
                                    </div>
                            `;
                        }
                        
                        html += '</div>';
                        
                        // åˆ†å¸ƒæ¡å½¢å›¾
                        if (colStats.top_values) {
                            const maxCount = Math.max(...Object.values(colStats.top_values));
                            html += '<div style="margin-top: 8px;">';
                            for (const [val, count] of Object.entries(colStats.top_values).slice(0, 5)) {
                                const pct = (count / maxCount * 100).toFixed(0);
                                html += `
                                    <div style="display: flex; align-items: center; margin: 4px 0; font-size: 11px;">
                                        <div style="width: 100px; overflow: hidden; text-overflow: ellipsis;">${val}</div>
                                        <div style="flex: 1; margin: 0 8px;">
                                            <div class="stat-bar">
                                                <div class="stat-bar-fill" style="width: ${pct}%"></div>
                                            </div>
                                        </div>
                                        <div style="width: 50px; text-align: right;">${count}</div>
                                    </div>
                                `;
                            }
                            html += '</div>';
                        }
                        
                        html += '</div>';
                    }
                    
                    html += '</div></div>';
                    
                    document.getElementById('stats-modal-content').innerHTML = html;
                    document.getElementById('stats-modal').style.display = 'flex';
                }
            } catch (e) {
                alert('åŠ è½½ç»Ÿè®¡ä¿¡æ¯å¤±è´¥: ' + e.message);
            }
        }
        
        function closeStatsModal() {
            document.getElementById('stats-modal').style.display = 'none';
        }
        
        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
        ['record-detail-modal', 'stats-modal'].forEach(id => {
            document.getElementById(id)?.addEventListener('click', function(e) {
                if (e.target === this) this.style.display = 'none';
            });
        });
        
        // ============================================================
        // é£æ§å‹åŠ›æµ‹è¯•
        // ============================================================
        
        async function runStressTest() {
            const resultsDiv = document.getElementById('stress-test-results');
            const detailsDiv = document.getElementById('stress-details');
            
            resultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>å‹åŠ›æµ‹è¯•ä¸­...</p></div>';
            detailsDiv.style.display = 'none';
            
            // æ”¶é›†é…ç½®å‚æ•°
            const config = {
                event_type: document.getElementById('stress-event-type').value,
                severity: document.getElementById('stress-severity').value,
                duration: parseInt(document.getElementById('stress-duration').value),
                customer_type: document.getElementById('stress-customer-type').value,
                industry: document.getElementById('stress-industry').value,
                city_tier: document.getElementById('stress-city-tier').value,
                loan_amount: parseFloat(document.getElementById('stress-loan-amount').value),
                interest_rate: parseFloat(document.getElementById('stress-interest-rate').value),
                loan_term: parseInt(document.getElementById('stress-loan-term').value),
                customer_count: parseInt(document.getElementById('stress-customer-count').value),
                sensitivity: {
                    gdp: document.getElementById('sensitivity-gdp').checked,
                    unemployment: document.getElementById('sensitivity-unemployment').checked,
                    interest: document.getElementById('sensitivity-interest').checked,
                    inflation: document.getElementById('sensitivity-inflation').checked
                },
                sensitivity_range: parseFloat(document.getElementById('sensitivity-range').value) / 100,
                resilience: {
                    default: document.getElementById('resilience-default').checked,
                    profit: document.getElementById('resilience-profit').checked,
                    recovery: document.getElementById('resilience-recovery').checked,
                    capital: document.getElementById('resilience-capital').checked
                }
            };
            
            // ä¿å­˜æ•°æ®ç”¨äºä¸‹é’»
            window.stressTestData = null;
            
            try {
                const response = await fetch(`${API_BASE}/api/stress-test`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // ä¿å­˜æ•°æ®ç”¨äºä¸‹é’»
                    window.stressTestData = data;
                    displayStressTestResults(data);
                } else {
                    resultsDiv.innerHTML = `<div style="color: var(--accent-danger); padding: 20px;">âŒ ${data.error || 'å‹åŠ›æµ‹è¯•å¤±è´¥'}</div>`;
                }
            } catch (error) {
                console.error('å‹åŠ›æµ‹è¯•é”™è¯¯:', error);
                resultsDiv.innerHTML = `<div style="color: var(--accent-danger); padding: 20px;">âŒ ç½‘ç»œé”™è¯¯: ${error.message}</div>`;
            }
        }
        
        function displayStressTestResults(data) {
            const resultsDiv = document.getElementById('stress-test-results');
            const detailsDiv = document.getElementById('stress-details');
            
            // ä¸»ç»“æœæ‘˜è¦
            const severityMap = {
                'mild': { label: 'è½»åº¦', color: '#10b981' },
                'moderate': { label: 'ä¸­åº¦', color: '#f59e0b' },
                'severe': { label: 'é‡åº¦', color: '#ef4444' },
                'extreme': { label: 'æç«¯', color: '#dc2626' }
            };
            
            const severity = severityMap[data.config.severity] || severityMap.moderate;
            
            // ç»æµçŠ¶æ€ä¿¡æ¯
            const ecoState = data.economic_state || {};
            const phaseMap = {
                'ç¹è£': { color: '#10b981', icon: 'ğŸ“ˆ' },
                'è¡°é€€': { color: '#f59e0b', icon: 'ğŸ“‰' },
                'è§æ¡': { color: '#ef4444', icon: 'âš ï¸' },
                'å¤è‹': { color: '#3b82f6', icon: 'ğŸ”„' }
            };
            const phase = phaseMap[ecoState.phase] || phaseMap['è¡°é€€'];
            
            resultsDiv.innerHTML = `
                <div style="padding: 20px;">
                    <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 24px;">
                        <div style="font-size: 48px;">ğŸ¦¢</div>
                        <div style="flex: 1;">
                            <div style="font-size: 18px; font-weight: 600; margin-bottom: 4px;">${data.event_name}</div>
                            <div style="color: var(--text-muted); font-size: 13px;">${data.config.duration}ä¸ªæœˆ | ${severity.label}å¼ºåº¦</div>
                        </div>
                        <div style="padding: 8px 16px; background: rgba(${phase.color === '#10b981' ? '16, 185, 129' : phase.color === '#f59e0b' ? '245, 158, 11' : phase.color === '#ef4444' ? '239, 68, 68' : '59, 130, 246'}, 0.1); border-radius: 8px; border: 1px solid ${phase.color};">
                            <div style="font-size: 12px; color: var(--text-muted);">ç»æµå‘¨æœŸ</div>
                            <div style="font-size: 14px; font-weight: 600; color: ${phase.color};">
                                ${phase.icon} ${ecoState.phase || 'æœªçŸ¥'}
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-4" style="gap: 16px; margin-bottom: 24px;">
                        <div style="padding: 16px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border-left: 4px solid #ef4444; position: relative;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                                <div style="font-size: 12px; color: var(--text-muted);">è¿çº¦ç‡</div>
                                <button onclick="showMetricCalculation('default_rate')" style="background: transparent; border: none; color: var(--accent-primary); cursor: pointer; font-size: 14px; padding: 4px 8px; border-radius: 4px; transition: all 0.2s;" onmouseover="this.style.background='rgba(59, 130, 246, 0.2)'" onmouseout="this.style.background='transparent'">ğŸ“Š è®¡ç®—è¯´æ˜</button>
                            </div>
                            <div style="font-size: 24px; font-weight: bold; color: #ef4444;">
                                ${(data.impact.default_rate * 100).toFixed(2)}%
                            </div>
                            ${data.impact.normal_default_rate ? `
                            <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">
                                æ­£å¸¸: ${(data.impact.normal_default_rate * 100).toFixed(2)}% 
                                (${data.impact.default_rate_change > 0 ? '+' : ''}${(data.impact.default_rate_change * 100).toFixed(2)}%)
                            </div>
                            ` : ''}
                        </div>
                        <div style="padding: 16px; background: rgba(245, 158, 11, 0.1); border-radius: 8px; border-left: 4px solid #f59e0b; position: relative;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                                <div style="font-size: 12px; color: var(--text-muted);">åˆ©æ¶¦å›æ’¤</div>
                                <button onclick="showMetricCalculation('profit_drawdown')" style="background: transparent; border: none; color: var(--accent-primary); cursor: pointer; font-size: 14px; padding: 4px 8px; border-radius: 4px; transition: all 0.2s;" onmouseover="this.style.background='rgba(59, 130, 246, 0.2)'" onmouseout="this.style.background='transparent'">ğŸ“Š è®¡ç®—è¯´æ˜</button>
                            </div>
                            <div style="font-size: 24px; font-weight: bold; color: #f59e0b;">
                                ${(data.resilience.profit_drawdown * 100).toFixed(1)}%
                            </div>
                        </div>
                        <div style="padding: 16px; background: rgba(16, 185, 129, 0.1); border-radius: 8px; border-left: 4px solid #10b981; position: relative;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                                <div style="font-size: 12px; color: var(--text-muted);">æ¢å¤æ—¶é—´</div>
                                <button onclick="showMetricCalculation('recovery_time')" style="background: transparent; border: none; color: var(--accent-primary); cursor: pointer; font-size: 14px; padding: 4px 8px; border-radius: 4px; transition: all 0.2s;" onmouseover="this.style.background='rgba(59, 130, 246, 0.2)'" onmouseout="this.style.background='transparent'">ğŸ“Š è®¡ç®—è¯´æ˜</button>
                            </div>
                            <div style="font-size: 24px; font-weight: bold; color: #10b981;">
                                ${data.resilience.recovery_months}ä¸ªæœˆ
                            </div>
                        </div>
                        <div style="padding: 16px; background: rgba(139, 92, 246, 0.1); border-radius: 8px; border-left: 4px solid #8b5cf6; position: relative;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                                <div style="font-size: 12px; color: var(--text-muted);">éŸ§æ€§è¯„åˆ†</div>
                                <button onclick="showMetricCalculation('resilience_score')" style="background: transparent; border: none; color: var(--accent-primary); cursor: pointer; font-size: 14px; padding: 4px 8px; border-radius: 4px; transition: all 0.2s;" onmouseover="this.style.background='rgba(59, 130, 246, 0.2)'" onmouseout="this.style.background='transparent'">ğŸ“Š è®¡ç®—è¯´æ˜</button>
                            </div>
                            <div style="font-size: 24px; font-weight: bold; color: ${data.resilience.resilience_score > 70 ? '#10b981' : data.resilience.resilience_score > 50 ? '#f59e0b' : '#ef4444'};">
                                ${data.resilience.resilience_score}/100
                            </div>
                            <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">
                                ${data.resilience.resilience_score > 70 ? 'ä¼˜ç§€' : data.resilience.resilience_score > 50 ? 'è‰¯å¥½' : 'éœ€æ”¹è¿›'}
                            </div>
                        </div>
                    </div>
                    
                    <div style="padding: 16px; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border-left: 4px solid #3b82f6; margin-bottom: 16px; position: relative;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                            <div style="font-size: 13px; font-weight: 600; color: #3b82f6;">é£é™©ç­‰çº§</div>
                            <button onclick="showMetricCalculation('risk_level')" style="background: transparent; border: none; color: var(--accent-primary); cursor: pointer; font-size: 12px; padding: 4px 8px; border-radius: 4px; transition: all 0.2s;" onmouseover="this.style.background='rgba(59, 130, 246, 0.2)'" onmouseout="this.style.background='transparent'">ğŸ“Š è®¡ç®—è¯´æ˜</button>
                        </div>
                        <div style="font-size: 18px; font-weight: bold; margin-bottom: 8px;">
                            ${data.risk_level}
                        </div>
                        <div style="font-size: 12px; color: var(--text-muted);">
                            ${data.risk_description}
                        </div>
                    </div>
                    
                    ${ecoState.gdp_growth !== undefined ? `
                    <div style="padding: 16px; background: rgba(102, 126, 234, 0.1); border-radius: 8px; margin-bottom: 16px;">
                        <div style="font-size: 13px; font-weight: 600; margin-bottom: 12px; color: #3b82f6;">ğŸ“ˆ ç»æµæŒ‡æ ‡å¯¹æ¯”</div>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
                            <div style="padding: 12px; background: rgba(255, 255, 255, 0.1); border-radius: 6px;">
                                <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">GDPå¢é•¿ç‡</div>
                                <div style="font-size: 16px; font-weight: 600; color: ${ecoState.gdp_growth < 0 ? '#ef4444' : '#10b981'};">
                                    ${(ecoState.gdp_growth * 100).toFixed(2)}%
                                </div>
                                ${ecoState.base_gdp_growth !== undefined ? `
                                <div style="font-size: 10px; color: var(--text-muted); margin-top: 4px;">
                                    æ­£å¸¸: ${(ecoState.base_gdp_growth * 100).toFixed(2)}%
                                </div>
                                ` : ''}
                            </div>
                            <div style="padding: 12px; background: rgba(255, 255, 255, 0.1); border-radius: 6px;">
                                <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">å¤±ä¸šç‡</div>
                                <div style="font-size: 16px; font-weight: 600; color: ${ecoState.unemployment_rate > 0.1 ? '#ef4444' : '#f59e0b'};">
                                    ${(ecoState.unemployment_rate * 100).toFixed(2)}%
                                </div>
                                ${ecoState.base_unemployment_rate !== undefined ? `
                                <div style="font-size: 10px; color: var(--text-muted); margin-top: 4px;">
                                    æ­£å¸¸: ${(ecoState.base_unemployment_rate * 100).toFixed(2)}%
                                </div>
                                ` : ''}
                            </div>
                            <div style="padding: 12px; background: rgba(255, 255, 255, 0.1); border-radius: 6px;">
                                <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">ä¿¡ç”¨åˆ©å·®</div>
                                <div style="font-size: 16px; font-weight: 600; color: ${ecoState.credit_spread > 0.05 ? '#ef4444' : '#f59e0b'};">
                                    ${(ecoState.credit_spread * 100).toFixed(2)}%
                                </div>
                                ${ecoState.base_credit_spread !== undefined ? `
                                <div style="font-size: 10px; color: var(--text-muted); margin-top: 4px;">
                                    æ­£å¸¸: ${(ecoState.base_credit_spread * 100).toFixed(2)}%
                                </div>
                                ` : ''}
                            </div>
                            <div style="padding: 12px; background: rgba(255, 255, 255, 0.1); border-radius: 6px;">
                                <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">æµ‹è¯•å®¢æˆ·æ•°</div>
                                <div style="font-size: 16px; font-weight: 600; color: #3b82f6;">
                                    ${data.config.customer_count || 100}äºº
                                </div>
                                <div style="font-size: 10px; color: var(--text-muted); margin-top: 4px;">
                                    è´·æ¬¾é‡‘é¢: Â¥${(data.config.loan_amount / 10000).toFixed(0)}ä¸‡
                                </div>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;
            
            // è¯¦ç»†åˆ†æ
            displayBlackSwanImpact(data.impact);
            displaySensitivityAnalysis(data.sensitivity);
            displayResilienceAssessment(data.resilience);
            displayContingencyPlan(data.contingency_plan);
            
            detailsDiv.style.display = 'grid';
        }
        
        function displayBlackSwanImpact(impact) {
            const div = document.getElementById('black-swan-impact');
            const affectedRatio = impact.affected_ratio || 0;
            
            div.innerHTML = `
                <div style="padding: 16px;">
                    <div style="margin-bottom: 16px;">
                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">è¿çº¦ç‡</div>
                        <div style="font-size: 20px; font-weight: bold; color: ${impact.default_rate_change > 0.1 ? '#ef4444' : '#f59e0b'}">
                            ${(impact.default_rate * 100).toFixed(2)}%
                        </div>
                        ${impact.normal_default_rate ? `
                        <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">
                            æ­£å¸¸: ${(impact.normal_default_rate * 100).toFixed(2)}% 
                            (${impact.default_rate_change > 0 ? '+' : ''}${(impact.default_rate_change * 100).toFixed(2)}%)
                        </div>
                        ` : ''}
                    </div>
                    <div style="margin-bottom: 16px;">
                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">å—å½±å“å®¢æˆ·</div>
                        <div style="font-size: 18px; font-weight: bold;">
                            ${impact.affected_customers.toLocaleString()}äºº
                        </div>
                        <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">
                            (${(affectedRatio * 100).toFixed(1)}%)
                        </div>
                    </div>
                    <div>
                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">æ½œåœ¨æŸå¤±</div>
                        <div style="font-size: 18px; font-weight: bold; color: #ef4444;">
                            Â¥${(impact.potential_loss / 10000).toFixed(1)}ä¸‡
                        </div>
                    </div>
                    ${impact.explanation ? `
                    <div style="margin-top: 16px; padding: 12px; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border-left: 3px solid #3b82f6;">
                        <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">ğŸ’¡ è¯´æ˜</div>
                        <div style="font-size: 12px; line-height: 1.6;">${impact.explanation}</div>
                    </div>
                    ` : ''}
                </div>
            `;
        }
        
        function displaySensitivityAnalysis(sensitivity) {
            const div = document.getElementById('sensitivity-analysis');
            let html = '<div style="padding: 16px;">';
            
            const nameMap = {
                'gdp': 'GDPå¢é•¿ç‡',
                'unemployment': 'å¤±ä¸šç‡',
                'interest': 'åˆ©ç‡',
                'inflation': 'é€šèƒ€ç‡'
            };
            
            for (const [key, value] of Object.entries(sensitivity)) {
                const color = Math.abs(value) > 0.2 ? '#ef4444' : Math.abs(value) > 0.1 ? '#f59e0b' : '#10b981';
                html += `
                    <div style="margin-bottom: 16px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                            <span style="font-size: 12px; color: var(--text-muted);">${nameMap[key] || key}</span>
                            <span style="font-size: 12px; font-weight: bold; color: ${color};">
                                ${value > 0 ? '+' : ''}${(value * 100).toFixed(1)}%
                            </span>
                        </div>
                        <div style="height: 6px; background: var(--bg-secondary); border-radius: 3px; overflow: hidden;">
                            <div style="height: 100%; width: ${Math.min(100, Math.abs(value) * 200)}%; background: ${color};"></div>
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            div.innerHTML = html;
        }
        
        function displayResilienceAssessment(resilience) {
            const div = document.getElementById('resilience-assessment');
            div.innerHTML = `
                <div style="padding: 16px;">
                    <div style="margin-bottom: 16px;">
                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">æœ€å¤§å›æ’¤</div>
                        <div style="font-size: 20px; font-weight: bold; color: #f59e0b;">
                            ${(resilience.max_drawdown * 100).toFixed(1)}%
                        </div>
                    </div>
                    <div style="margin-bottom: 16px;">
                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">æ¢å¤é€Ÿåº¦</div>
                        <div style="font-size: 18px; font-weight: bold; color: #10b981;">
                            ${resilience.recovery_months}ä¸ªæœˆ
                        </div>
                    </div>
                    <div>
                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">éŸ§æ€§è¯„åˆ†</div>
                        <div style="font-size: 18px; font-weight: bold; color: ${resilience.resilience_score > 70 ? '#10b981' : resilience.resilience_score > 50 ? '#f59e0b' : '#ef4444'};">
                            ${resilience.resilience_score}/100
                        </div>
                    </div>
                    ${resilience.explanation ? `
                    <div style="margin-top: 16px; padding: 12px; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border-left: 3px solid #3b82f6;">
                        <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">ğŸ’¡ è¯´æ˜</div>
                        <div style="font-size: 12px; line-height: 1.6;">${resilience.explanation}</div>
                    </div>
                    ` : ''}
                </div>
            `;
        }
        
        function displayContingencyPlan(plan) {
            const div = document.getElementById('contingency-plan');
            let html = '<div style="padding: 16px;">';
            
            plan.forEach((item, index) => {
                const iconMap = {
                    'high': 'ğŸ”´',
                    'medium': 'ğŸŸ¡',
                    'low': 'ğŸŸ¢'
                };
                html += `
                    <div style="margin-bottom: 12px; padding: 12px; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border-left: 3px solid #3b82f6;">
                        <div style="display: flex; align-items: start; gap: 8px;">
                            <span style="font-size: 16px;">${iconMap[item.priority] || 'âšª'}</span>
                            <div style="flex: 1;">
                                <div style="font-size: 13px; font-weight: 600; margin-bottom: 4px;">${item.action}</div>
                                <div style="font-size: 12px; color: var(--text-muted);">${item.description}</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            div.innerHTML = html;
        }
        
        // ä¸‹é’»åŠŸèƒ½
        function showImpactDetail() {
            if (!window.stressTestData) return;
            
            const data = window.stressTestData;
            const modal = document.getElementById('stress-detail-modal');
            const title = document.getElementById('stress-detail-title');
            const content = document.getElementById('stress-detail-content');
            
            title.textContent = 'ğŸ¦¢ é»‘å¤©é¹…å½±å“è¯¦ç»†åˆ†æ';
            
            let html = '<div style="padding: 20px;">';
            
            // ç»Ÿè®¡æ‘˜è¦
            if (data.statistics) {
                const stats = data.statistics;
                html += `
                    <div style="margin-bottom: 24px; padding: 16px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1)); border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.3);">
                        <h4 style="margin-bottom: 16px; color: var(--accent-primary);">ğŸ“Š ç»Ÿè®¡æ‘˜è¦</h4>
                        <div class="grid grid-4" style="gap: 16px;">
                            <div>
                                <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">æ€»å®¢æˆ·æ•°</div>
                                <div style="font-size: 20px; font-weight: bold; color: #3b82f6;">${stats.total_customers}</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">å—å½±å“å®¢æˆ·</div>
                                <div style="font-size: 20px; font-weight: bold; color: #ef4444;">${stats.affected_count}</div>
                                <div style="font-size: 11px; color: var(--text-muted);">(${(stats.affected_ratio * 100).toFixed(1)}%)</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">å¹³å‡è¿çº¦ç‡å˜åŒ–</div>
                                <div style="font-size: 20px; font-weight: bold; color: ${stats.avg_stress_prob > stats.avg_normal_prob ? '#ef4444' : '#10b981'};">
                                    ${((stats.avg_stress_prob - stats.avg_normal_prob) * 100).toFixed(2)}%
                                </div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">æ ‡å‡†å·®</div>
                                <div style="font-size: 16px; font-weight: bold; color: #f59e0b;">
                                    æ­£å¸¸: ${(stats.std_normal * 100).toFixed(2)}%<br>
                                    å‹åŠ›: ${(stats.std_stress * 100).toFixed(2)}%
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // è®¡ç®—æ­¥éª¤
            if (data.calculation_steps && data.calculation_steps.length > 0) {
                html += '<h4 style="margin-bottom: 16px; color: var(--accent-primary);">ğŸ“‹ è®¡ç®—æ­¥éª¤</h4>';
                data.calculation_steps.forEach(step => {
                    html += `
                        <div style="margin-bottom: 20px; padding: 16px; background: var(--bg-secondary); border-radius: 8px; border-left: 4px solid var(--accent-primary);">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                <span style="font-size: 20px; font-weight: bold; color: var(--accent-primary);">${step.step}</span>
                                <div style="font-size: 16px; font-weight: 600;">${step.name}</div>
                            </div>
                            <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px; line-height: 1.6;">${step.description}</div>
                            <div style="padding: 10px; background: rgba(59, 130, 246, 0.1); border-radius: 6px; font-family: 'JetBrains Mono', monospace; font-size: 12px; margin-bottom: 8px; border: 1px solid rgba(59, 130, 246, 0.2);">
                                ${step.formula}
                            </div>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="font-size: 13px; color: var(--text-muted);">è®¡ç®—ç»“æœ:</div>
                                <div style="font-size: 16px; font-weight: 600; color: var(--accent-primary);">
                                    ${typeof step.value === 'number' ? (step.value > 1 ? step.value.toLocaleString() : (step.value * 100).toFixed(2) + '%') : step.value}
                                </div>
                            </div>
                            ${step.details ? `<div style="font-size: 12px; color: var(--text-muted); margin-top: 8px; padding: 8px; background: rgba(16, 185, 129, 0.1); border-radius: 4px; border-left: 3px solid #10b981;">ğŸ’¡ ${step.details}</div>` : ''}
                        </div>
                    `;
                });
            }
            
            // åˆ†ç»„åˆ†æ
            if (data.grouped_analysis) {
                html += '<h4 style="margin-top: 32px; margin-bottom: 16px; color: var(--accent-primary);">ğŸ“Š åˆ†ç»„åˆ†æ</h4>';
                
                // æŒ‰å®¢æˆ·ç±»å‹åˆ†ç»„
                if (data.grouped_analysis.by_customer_type) {
                    html += '<h5 style="margin-top: 20px; margin-bottom: 12px; font-size: 14px; color: var(--accent-primary);">ğŸ‘¥ æŒ‰å®¢æˆ·ç±»å‹åˆ†æ</h5>';
                    html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px; margin-bottom: 20px;">';
                    for (const [type, group] of Object.entries(data.grouped_analysis.by_customer_type)) {
                        const changeColor = group.avg_change > 0.1 ? '#ef4444' : group.avg_change > 0.05 ? '#f59e0b' : '#10b981';
                        html += `
                            <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; border-left: 3px solid ${changeColor};">
                                <div style="font-size: 13px; font-weight: 600; margin-bottom: 8px;">${type}</div>
                                <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">å®¢æˆ·æ•°: ${group.count}</div>
                                <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">æ­£å¸¸è¿çº¦ç‡: ${(group.avg_normal_prob * 100).toFixed(2)}%</div>
                                <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">å‹åŠ›è¿çº¦ç‡: ${(group.avg_stress_prob * 100).toFixed(2)}%</div>
                                <div style="font-size: 12px; font-weight: 600; color: ${changeColor}; margin-top: 4px;">
                                    å˜åŒ–: ${group.avg_change > 0 ? '+' : ''}${(group.avg_change * 100).toFixed(2)}%
                                </div>
                                <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">
                                    å—å½±å“: ${group.affected_count}äºº (${(group.affected_ratio * 100).toFixed(1)}%)
                                </div>
                            </div>
                        `;
                    }
                    html += '</div>';
                }
                
                // æŒ‰è¡Œä¸šåˆ†ç»„
                if (data.grouped_analysis.by_industry) {
                    html += '<h5 style="margin-top: 20px; margin-bottom: 12px; font-size: 14px; color: var(--accent-primary);">ğŸ­ æŒ‰è¡Œä¸šåˆ†æ</h5>';
                    html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px; margin-bottom: 20px;">';
                    for (const [industry, group] of Object.entries(data.grouped_analysis.by_industry)) {
                        const changeColor = group.avg_change > 0.1 ? '#ef4444' : group.avg_change > 0.05 ? '#f59e0b' : '#10b981';
                        html += `
                            <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; border-left: 3px solid ${changeColor};">
                                <div style="font-size: 13px; font-weight: 600; margin-bottom: 8px;">${industry}</div>
                                <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">å®¢æˆ·æ•°: ${group.count}</div>
                                <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">æ­£å¸¸è¿çº¦ç‡: ${(group.avg_normal_prob * 100).toFixed(2)}%</div>
                                <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">å‹åŠ›è¿çº¦ç‡: ${(group.avg_stress_prob * 100).toFixed(2)}%</div>
                                <div style="font-size: 12px; font-weight: 600; color: ${changeColor}; margin-top: 4px;">
                                    å˜åŒ–: ${group.avg_change > 0 ? '+' : ''}${(group.avg_change * 100).toFixed(2)}%
                                </div>
                                <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">
                                    å—å½±å“: ${group.affected_count}äºº (${(group.affected_ratio * 100).toFixed(1)}%)
                                </div>
                            </div>
                        `;
                    }
                    html += '</div>';
                }
                
                // æŒ‰åŸå¸‚ç­‰çº§åˆ†ç»„
                if (data.grouped_analysis.by_city_tier) {
                    html += '<h5 style="margin-top: 20px; margin-bottom: 12px; font-size: 14px; color: var(--accent-primary);">ğŸ™ï¸ æŒ‰åŸå¸‚ç­‰çº§åˆ†æ</h5>';
                    html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px; margin-bottom: 20px;">';
                    for (const [city, group] of Object.entries(data.grouped_analysis.by_city_tier)) {
                        const changeColor = group.avg_change > 0.1 ? '#ef4444' : group.avg_change > 0.05 ? '#f59e0b' : '#10b981';
                        html += `
                            <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; border-left: 3px solid ${changeColor};">
                                <div style="font-size: 13px; font-weight: 600; margin-bottom: 8px;">${city}</div>
                                <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">å®¢æˆ·æ•°: ${group.count}</div>
                                <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">æ­£å¸¸è¿çº¦ç‡: ${(group.avg_normal_prob * 100).toFixed(2)}%</div>
                                <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">å‹åŠ›è¿çº¦ç‡: ${(group.avg_stress_prob * 100).toFixed(2)}%</div>
                                <div style="font-size: 12px; font-weight: 600; color: ${changeColor}; margin-top: 4px;">
                                    å˜åŒ–: ${group.avg_change > 0 ? '+' : ''}${(group.avg_change * 100).toFixed(2)}%
                                </div>
                                <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">
                                    å—å½±å“: ${group.affected_count}äºº (${(group.affected_ratio * 100).toFixed(1)}%)
                                </div>
                            </div>
                        `;
                    }
                    html += '</div>';
                }
            }
            
            // é£é™©åˆ†å¸ƒå¯è§†åŒ–
            if (data.customer_details && data.customer_details.length > 0) {
                html += '<h4 style="margin-top: 32px; margin-bottom: 16px; color: var(--accent-primary);">ğŸ“ˆ é£é™©åˆ†å¸ƒåˆ†æ</h4>';
                
                // è®¡ç®—åˆ†å¸ƒåŒºé—´
                const ranges = [
                    { label: 'ä½é£é™© (<5%)', min: 0, max: 0.05, color: '#10b981' },
                    { label: 'ä¸­ä½é£é™© (5-10%)', min: 0.05, max: 0.10, color: '#84cc16' },
                    { label: 'ä¸­é£é™© (10-20%)', min: 0.10, max: 0.20, color: '#f59e0b' },
                    { label: 'é«˜é£é™© (20-30%)', min: 0.20, max: 0.30, color: '#ef4444' },
                    { label: 'æé«˜é£é™© (>30%)', min: 0.30, max: 1.0, color: '#dc2626' }
                ];
                
                const normalDist = {};
                const stressDist = {};
                ranges.forEach(range => {
                    normalDist[range.label] = data.customer_details.filter(c => c.normal_prob >= range.min && c.normal_prob < range.max).length;
                    stressDist[range.label] = data.customer_details.filter(c => c.stress_prob >= range.min && c.stress_prob < range.max).length;
                });
                
                html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">';
                
                // æ­£å¸¸åœºæ™¯åˆ†å¸ƒ
                html += '<div style="padding: 16px; background: var(--bg-secondary); border-radius: 8px;">';
                html += '<div style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: #3b82f6;">æ­£å¸¸åœºæ™¯é£é™©åˆ†å¸ƒ</div>';
                ranges.forEach(range => {
                    const count = normalDist[range.label];
                    const pct = (count / data.customer_details.length * 100).toFixed(1);
                    html += `
                        <div style="margin-bottom: 8px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                <span style="font-size: 12px; color: var(--text-muted);">${range.label}</span>
                                <span style="font-size: 12px; font-weight: 600;">${count}äºº (${pct}%)</span>
                            </div>
                            <div style="height: 8px; background: var(--bg-primary); border-radius: 4px; overflow: hidden;">
                                <div style="height: 100%; width: ${pct}%; background: ${range.color};"></div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                
                // å‹åŠ›åœºæ™¯åˆ†å¸ƒ
                html += '<div style="padding: 16px; background: var(--bg-secondary); border-radius: 8px;">';
                html += '<div style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: #ef4444;">å‹åŠ›åœºæ™¯é£é™©åˆ†å¸ƒ</div>';
                ranges.forEach(range => {
                    const count = stressDist[range.label];
                    const pct = (count / data.customer_details.length * 100).toFixed(1);
                    html += `
                        <div style="margin-bottom: 8px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                <span style="font-size: 12px; color: var(--text-muted);">${range.label}</span>
                                <span style="font-size: 12px; font-weight: 600;">${count}äºº (${pct}%)</span>
                            </div>
                            <div style="height: 8px; background: var(--bg-primary); border-radius: 4px; overflow: hidden;">
                                <div style="height: 100%; width: ${pct}%; background: ${range.color};"></div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                html += '</div>';
            }
            
            // å®¢æˆ·è¯¦æƒ…è¡¨æ ¼
            if (data.customer_details && data.customer_details.length > 0) {
                html += '<h4 style="margin-top: 32px; margin-bottom: 16px; color: var(--accent-primary);">ğŸ‘¥ å®¢æˆ·è¯¦æƒ…åˆ—è¡¨</h4>';
                html += '<div style="max-height: 500px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px;">';
                html += '<table style="width: 100%; border-collapse: collapse; font-size: 12px;">';
                html += '<thead><tr style="background: var(--bg-secondary); position: sticky; top: 0; z-index: 10;">';
                html += '<th style="padding: 10px; text-align: left; border-bottom: 2px solid var(--border-color);">#</th>';
                html += '<th style="padding: 10px; text-align: left; border-bottom: 2px solid var(--border-color);">å®¢æˆ·ç±»å‹</th>';
                html += '<th style="padding: 10px; text-align: left; border-bottom: 2px solid var(--border-color);">è¡Œä¸š</th>';
                html += '<th style="padding: 10px; text-align: left; border-bottom: 2px solid var(--border-color);">åŸå¸‚</th>';
                html += '<th style="padding: 10px; text-align: right; border-bottom: 2px solid var(--border-color);">æ­£å¸¸è¿çº¦ç‡</th>';
                html += '<th style="padding: 10px; text-align: right; border-bottom: 2px solid var(--border-color);">å‹åŠ›è¿çº¦ç‡</th>';
                html += '<th style="padding: 10px; text-align: right; border-bottom: 2px solid var(--border-color);">å˜åŒ–</th>';
                html += '<th style="padding: 10px; text-align: center; border-bottom: 2px solid var(--border-color);">çŠ¶æ€</th>';
                html += '</tr></thead><tbody>';
                
                data.customer_details.forEach(customer => {
                    const changeColor = customer.change > 0.1 ? '#ef4444' : customer.change > 0.05 ? '#f59e0b' : '#10b981';
                    const isAffected = customer.is_affected || customer.stress_prob > (data.statistics?.avg_normal_prob || 0) * 1.2;
                    html += `<tr style="border-bottom: 1px solid var(--border-color); ${isAffected ? 'background: rgba(239, 68, 68, 0.05);' : ''}">`;
                    html += `<td style="padding: 10px;">${customer.index}</td>`;
                    html += `<td style="padding: 10px;">${customer.customer_type}</td>`;
                    html += `<td style="padding: 10px;">${customer.industry}</td>`;
                    html += `<td style="padding: 10px;">${customer.city_tier}</td>`;
                    html += `<td style="padding: 10px; text-align: right;">${(customer.normal_prob * 100).toFixed(2)}%</td>`;
                    html += `<td style="padding: 10px; text-align: right; color: ${changeColor}; font-weight: ${isAffected ? '600' : '400'};">
                        ${(customer.stress_prob * 100).toFixed(2)}%
                    </td>`;
                    html += `<td style="padding: 10px; text-align: right; color: ${changeColor}; font-weight: ${isAffected ? '600' : '400'};">
                        ${customer.change > 0 ? '+' : ''}${(customer.change * 100).toFixed(2)}%
                    </td>`;
                    html += `<td style="padding: 10px; text-align: center;">
                        ${isAffected ? '<span style="color: #ef4444; font-weight: 600;">âš ï¸ å—å½±å“</span>' : '<span style="color: #10b981;">âœ“ æ­£å¸¸</span>'}
                    </td>`;
                    html += `</tr>`;
                });
                
                html += '</tbody></table></div>';
            }
            
            html += '</div>';
            content.innerHTML = html;
            modal.style.display = 'flex';
        }
        
        function showSensitivityDetail() {
            if (!window.stressTestData || !window.stressTestData.sensitivity_details) return;
            
            const data = window.stressTestData;
            const modal = document.getElementById('stress-detail-modal');
            const title = document.getElementById('stress-detail-title');
            const content = document.getElementById('stress-detail-content');
            
            title.textContent = 'ğŸ”¬ æ•æ„Ÿæ€§åˆ†æè¯¦ç»†æŠ¥å‘Š';
            
            let html = '<div style="padding: 20px;">';
            
            // æ•æ„Ÿæ€§åˆ†ææ¦‚è¿°
            html += `
                <div style="margin-bottom: 24px; padding: 16px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1)); border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.3);">
                    <h4 style="margin-bottom: 12px; color: var(--accent-primary);">ğŸ“Š æ•æ„Ÿæ€§åˆ†æè¯´æ˜</h4>
                    <div style="font-size: 13px; line-height: 1.8; color: var(--text-muted);">
                        <p>æ•æ„Ÿæ€§åˆ†æé€šè¿‡æ”¹å˜å•ä¸ªç»æµå‚æ•°ï¼Œè§‚å¯Ÿå…¶å¯¹è¿çº¦ç‡çš„å½±å“ã€‚æ¯ä¸ªå‚æ•°ç‹¬ç«‹å˜åŒ–ï¼Œå…¶ä»–å‚æ•°ä¿æŒä¸å˜ï¼Œä»¥é‡åŒ–è¯¥å‚æ•°å¯¹é£é™©çš„è´¡çŒ®åº¦ã€‚</p>
                        <p style="margin-top: 8px;">å½±å“å¹…åº¦ = (æµ‹è¯•è¿çº¦ç‡ - åŸºå‡†è¿çº¦ç‡) / åŸºå‡†è¿çº¦ç‡ Ã— 100%</p>
                    </div>
                </div>
            `;
            
            // æ•æ„Ÿæ€§æ’åº
            const sensitivityEntries = Object.entries(data.sensitivity_details || {});
            sensitivityEntries.sort((a, b) => Math.abs(b[1].impact) - Math.abs(a[1].impact));
            
            html += '<h4 style="margin-bottom: 16px; color: var(--accent-primary);">ğŸ“ˆ æ•æ„Ÿæ€§æ’åºï¼ˆæŒ‰å½±å“å¹…åº¦ï¼‰</h4>';
            html += '<div style="margin-bottom: 24px; padding: 16px; background: var(--bg-secondary); border-radius: 8px;">';
            sensitivityEntries.forEach(([key, detail], index) => {
                const nameMap = {
                    'gdp': 'GDPå¢é•¿ç‡',
                    'unemployment': 'å¤±ä¸šç‡',
                    'interest': 'åˆ©ç‡',
                    'inflation': 'é€šèƒ€ç‡'
                };
                const impactAbs = Math.abs(detail.impact);
                const color = impactAbs > 0.2 ? '#ef4444' : impactAbs > 0.1 ? '#f59e0b' : '#10b981';
                html += `
                    <div style="display: flex; align-items: center; gap: 12px; padding: 12px; margin-bottom: 8px; background: rgba(255, 255, 255, 0.05); border-radius: 6px;">
                        <div style="font-size: 18px; font-weight: bold; color: ${color}; width: 30px;">${index + 1}</div>
                        <div style="flex: 1; font-size: 14px; font-weight: 600;">${nameMap[key] || key}</div>
                        <div style="font-size: 16px; font-weight: bold; color: ${color};">
                            ${detail.impact > 0 ? '+' : ''}${(detail.impact * 100).toFixed(2)}%
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            // è¯¦ç»†åˆ†æ
            for (const [key, detail] of Object.entries(data.sensitivity_details)) {
                const nameMap = {
                    'gdp': 'GDPå¢é•¿ç‡',
                    'unemployment': 'å¤±ä¸šç‡',
                    'interest': 'åˆ©ç‡',
                    'inflation': 'é€šèƒ€ç‡'
                };
                
                const impactAbs = Math.abs(detail.impact);
                const impactLevel = impactAbs > 0.2 ? 'æé«˜' : impactAbs > 0.1 ? 'é«˜' : impactAbs > 0.05 ? 'ä¸­' : 'ä½';
                const impactColor = impactAbs > 0.2 ? '#ef4444' : impactAbs > 0.1 ? '#f59e0b' : '#10b981';
                
                html += `
                    <div style="margin-bottom: 24px; padding: 20px; background: var(--bg-secondary); border-radius: 8px; border-left: 4px solid ${impactColor};">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                            <h4 style="color: var(--accent-primary); margin: 0;">${nameMap[key] || key}</h4>
                            <span style="padding: 4px 12px; background: rgba(${impactColor === '#ef4444' ? '239, 68, 68' : impactColor === '#f59e0b' ? '245, 158, 11' : '16, 185, 129'}, 0.2); border-radius: 12px; font-size: 12px; color: ${impactColor}; font-weight: 600;">
                                ${impactLevel}æ•æ„Ÿæ€§
                            </span>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 16px;">
                            <div style="padding: 12px; background: rgba(59, 130, 246, 0.1); border-radius: 6px;">
                                <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">å‚æ•°åŸºå‡†å€¼</div>
                                <div style="font-size: 18px; font-weight: 600; color: #3b82f6;">${(detail.base_value * 100).toFixed(2)}%</div>
                            </div>
                            <div style="padding: 12px; background: rgba(139, 92, 246, 0.1); border-radius: 6px;">
                                <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">å‚æ•°æµ‹è¯•å€¼</div>
                                <div style="font-size: 18px; font-weight: 600; color: #8b5cf6;">${(detail.test_value * 100).toFixed(2)}%</div>
                                <div style="font-size: 10px; color: var(--text-muted); margin-top: 4px;">
                                    å˜åŒ–: ${detail.test_value > detail.base_value ? '+' : ''}${((detail.test_value - detail.base_value) * 100).toFixed(2)}%
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 16px;">
                            <div style="padding: 12px; background: rgba(16, 185, 129, 0.1); border-radius: 6px;">
                                <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">åŸºå‡†è¿çº¦ç‡</div>
                                <div style="font-size: 18px; font-weight: 600; color: #10b981;">${(detail.base_default_rate * 100).toFixed(2)}%</div>
                            </div>
                            <div style="padding: 12px; background: rgba(${detail.impact > 0 ? '239, 68, 68' : '16, 185, 129'}, 0.1); border-radius: 6px;">
                                <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">æµ‹è¯•è¿çº¦ç‡</div>
                                <div style="font-size: 18px; font-weight: 600; color: ${detail.impact > 0 ? '#ef4444' : '#10b981'};">
                                    ${(detail.test_default_rate * 100).toFixed(2)}%
                                </div>
                                <div style="font-size: 10px; color: var(--text-muted); margin-top: 4px;">
                                    å˜åŒ–: ${detail.test_default_rate > detail.base_default_rate ? '+' : ''}${((detail.test_default_rate - detail.base_default_rate) * 100).toFixed(2)}%
                                </div>
                            </div>
                        </div>
                        
                        <div style="padding: 16px; background: rgba(59, 130, 246, 0.1); border-radius: 8px; margin-bottom: 12px;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                                <div style="font-size: 13px; font-weight: 600; color: var(--accent-primary);">å½±å“å¹…åº¦</div>
                                <div style="font-size: 24px; font-weight: bold; color: ${impactColor};">
                                    ${detail.impact > 0 ? '+' : ''}${(detail.impact * 100).toFixed(2)}%
                                </div>
                            </div>
                            <div style="height: 8px; background: var(--bg-primary); border-radius: 4px; overflow: hidden; margin-top: 8px;">
                                <div style="height: 100%; width: ${Math.min(100, Math.abs(detail.impact) * 200)}%; background: ${impactColor};"></div>
                            </div>
                        </div>
                        
                        ${detail.explanation ? `
                        <div style="padding: 12px; background: rgba(16, 185, 129, 0.1); border-radius: 8px; border-left: 3px solid #10b981;">
                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">ğŸ’¡ åˆ†æè¯´æ˜</div>
                            <div style="font-size: 12px; line-height: 1.6;">${detail.explanation}</div>
                        </div>
                        ` : ''}
                        
                        <div style="margin-top: 12px; padding: 12px; background: rgba(245, 158, 11, 0.1); border-radius: 8px; border-left: 3px solid #f59e0b;">
                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">ğŸ“Œ ä¸šåŠ¡å»ºè®®</div>
                            <div style="font-size: 12px; line-height: 1.6;">
                                ${impactAbs > 0.2 ? 
                                    `è¯¥å‚æ•°å¯¹è¿çº¦ç‡å½±å“æå¤§ï¼Œå»ºè®®å¯†åˆ‡å…³æ³¨${nameMap[key]}çš„å˜åŒ–ï¼Œå»ºç«‹é¢„è­¦æœºåˆ¶ã€‚` :
                                    impactAbs > 0.1 ?
                                    `è¯¥å‚æ•°å¯¹è¿çº¦ç‡å½±å“è¾ƒå¤§ï¼Œå»ºè®®å®šæœŸç›‘æ§${nameMap[key]}çš„å˜åŒ–è¶‹åŠ¿ã€‚` :
                                    `è¯¥å‚æ•°å¯¹è¿çº¦ç‡å½±å“è¾ƒå°ï¼Œå¯ä½œä¸ºæ¬¡è¦ç›‘æ§æŒ‡æ ‡ã€‚`
                                }
                            </div>
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            content.innerHTML = html;
            modal.style.display = 'flex';
        }
        
        function showResilienceDetail() {
            if (!window.stressTestData) return;
            
            const data = window.stressTestData;
            const modal = document.getElementById('stress-detail-modal');
            const title = document.getElementById('stress-detail-title');
            const content = document.getElementById('stress-detail-content');
            
            title.textContent = 'ğŸ›¡ï¸ éŸ§æ€§è¯„ä¼°è¯¦ç»†åˆ†æ';
            
            let html = '<div style="padding: 20px;">';
            
            // éŸ§æ€§è¯„åˆ†è®¡ç®—
            const resilience = data.resilience || {};
            const maxDrawdown = resilience.max_drawdown || 0;
            const recoveryMonths = resilience.recovery_months || 0;
            const resilienceScore = resilience.resilience_score || 0;
            
            html += `
                <div style="margin-bottom: 24px; padding: 20px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1)); border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.3);">
                    <h4 style="margin-bottom: 16px; color: var(--accent-primary);">ğŸ“Š éŸ§æ€§è¯„åˆ†è®¡ç®—</h4>
                    <div style="font-size: 13px; line-height: 1.8; color: var(--text-muted); margin-bottom: 16px;">
                        <p>éŸ§æ€§è¯„åˆ†ç”¨äºé‡åŒ–ç­–ç•¥åœ¨æç«¯åœºæ™¯ä¸‹çš„æ¢å¤èƒ½åŠ›ï¼Œç»¼åˆè€ƒè™‘åˆ©æ¶¦å›æ’¤å’Œæ¢å¤é€Ÿåº¦ã€‚</p>
                    </div>
                    <div style="padding: 12px; background: rgba(255, 255, 255, 0.1); border-radius: 6px; font-family: 'JetBrains Mono', monospace; font-size: 12px; margin-bottom: 12px;">
                        éŸ§æ€§è¯„åˆ† = 100 - (æœ€å¤§å›æ’¤ Ã— 150) - (æ¢å¤æ—¶é—´ Ã— 2)
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                        <div style="padding: 12px; background: rgba(255, 255, 255, 0.1); border-radius: 6px;">
                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">æœ€å¤§å›æ’¤è´¡çŒ®</div>
                            <div style="font-size: 16px; font-weight: 600; color: #f59e0b;">
                                -${(maxDrawdown * 150).toFixed(1)}åˆ†
                            </div>
                        </div>
                        <div style="padding: 12px; background: rgba(255, 255, 255, 0.1); border-radius: 6px;">
                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">æ¢å¤æ—¶é—´è´¡çŒ®</div>
                            <div style="font-size: 16px; font-weight: 600; color: #3b82f6;">
                                -${(recoveryMonths * 2).toFixed(0)}åˆ†
                            </div>
                        </div>
                        <div style="padding: 12px; background: rgba(255, 255, 255, 0.1); border-radius: 6px;">
                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">æœ€ç»ˆè¯„åˆ†</div>
                            <div style="font-size: 20px; font-weight: bold; color: ${resilienceScore > 70 ? '#10b981' : resilienceScore > 50 ? '#f59e0b' : '#ef4444'};">
                                ${resilienceScore}/100
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // è¯¦ç»†æŒ‡æ ‡åˆ†æ
            html += '<h4 style="margin-bottom: 16px; color: var(--accent-primary);">ğŸ“ˆ è¯¦ç»†æŒ‡æ ‡åˆ†æ</h4>';
            html += '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 24px;">';
            
            // æœ€å¤§å›æ’¤åˆ†æ
            html += `
                <div style="padding: 16px; background: var(--bg-secondary); border-radius: 8px; border-left: 4px solid #f59e0b;">
                    <h5 style="margin-bottom: 12px; color: #f59e0b;">æœ€å¤§å›æ’¤åˆ†æ</h5>
                    <div style="font-size: 24px; font-weight: bold; color: #f59e0b; margin-bottom: 8px;">
                        ${(maxDrawdown * 100).toFixed(1)}%
                    </div>
                    <div style="font-size: 12px; color: var(--text-muted); line-height: 1.6;">
                        ${maxDrawdown > 0.5 ? 
                            'âš ï¸ å›æ’¤è¶…è¿‡50%ï¼Œè¡¨æ˜ç­–ç•¥åœ¨æç«¯åœºæ™¯ä¸‹æŠ—é£é™©èƒ½åŠ›è¾ƒå¼±ï¼Œéœ€è¦åŠ å¼ºé£é™©æ§åˆ¶æªæ–½ã€‚' :
                            maxDrawdown > 0.3 ?
                            'âš ï¸ å›æ’¤åœ¨30-50%ä¹‹é—´ï¼Œç­–ç•¥æŠ—é£é™©èƒ½åŠ›ä¸­ç­‰ï¼Œå»ºè®®ä¼˜åŒ–èµ„äº§é…ç½®ã€‚' :
                            maxDrawdown > 0.2 ?
                            'âœ“ å›æ’¤åœ¨20-30%ä¹‹é—´ï¼Œç­–ç•¥æŠ—é£é™©èƒ½åŠ›è‰¯å¥½ã€‚' :
                            'âœ“ å›æ’¤ä½äº20%ï¼Œç­–ç•¥æŠ—é£é™©èƒ½åŠ›ä¼˜ç§€ã€‚'
                        }
                    </div>
                </div>
            `;
            
            // æ¢å¤é€Ÿåº¦åˆ†æ
            html += `
                <div style="padding: 16px; background: var(--bg-secondary); border-radius: 8px; border-left: 4px solid #3b82f6;">
                    <h5 style="margin-bottom: 12px; color: #3b82f6;">æ¢å¤é€Ÿåº¦åˆ†æ</h5>
                    <div style="font-size: 24px; font-weight: bold; color: #3b82f6; margin-bottom: 8px;">
                        ${recoveryMonths}ä¸ªæœˆ
                    </div>
                    <div style="font-size: 12px; color: var(--text-muted); line-height: 1.6;">
                        ${recoveryMonths > 12 ? 
                            'âš ï¸ æ¢å¤æ—¶é—´è¶…è¿‡12ä¸ªæœˆï¼Œè¡¨æ˜ç­–ç•¥æ¢å¤èƒ½åŠ›è¾ƒå¼±ï¼Œéœ€è¦è¾ƒé•¿æ—¶é—´æ‰èƒ½æ¢å¤æ­£å¸¸æ°´å¹³ã€‚' :
                            recoveryMonths > 6 ?
                            'âš ï¸ æ¢å¤æ—¶é—´åœ¨6-12ä¸ªæœˆä¹‹é—´ï¼Œç­–ç•¥æ¢å¤èƒ½åŠ›ä¸­ç­‰ã€‚' :
                            recoveryMonths > 3 ?
                            'âœ“ æ¢å¤æ—¶é—´åœ¨3-6ä¸ªæœˆä¹‹é—´ï¼Œç­–ç•¥æ¢å¤èƒ½åŠ›è‰¯å¥½ã€‚' :
                            'âœ“ æ¢å¤æ—¶é—´å°‘äº3ä¸ªæœˆï¼Œç­–ç•¥æ¢å¤èƒ½åŠ›ä¼˜ç§€ã€‚'
                        }
                    </div>
                </div>
            `;
            html += '</div>';
            
            // éŸ§æ€§ç­‰çº§è¯„ä¼°
            const resilienceLevel = resilienceScore > 70 ? { label: 'ä¼˜ç§€', color: '#10b981', desc: 'ç­–ç•¥éŸ§æ€§æå¼ºï¼Œèƒ½å¤Ÿæœ‰æ•ˆåº”å¯¹æç«¯åœºæ™¯' } :
                                   resilienceScore > 50 ? { label: 'è‰¯å¥½', color: '#84cc16', desc: 'ç­–ç•¥éŸ§æ€§è‰¯å¥½ï¼ŒåŸºæœ¬èƒ½å¤Ÿåº”å¯¹æç«¯åœºæ™¯' } :
                                   resilienceScore > 30 ? { label: 'ä¸­ç­‰', color: '#f59e0b', desc: 'ç­–ç•¥éŸ§æ€§ä¸­ç­‰ï¼Œéœ€è¦åŠ å¼ºé£é™©æ§åˆ¶' } :
                                   { label: 'è¾ƒå¼±', color: '#ef4444', desc: 'ç­–ç•¥éŸ§æ€§è¾ƒå¼±ï¼Œéœ€è¦ç«‹å³é‡‡å–æ”¹è¿›æªæ–½' };
            
            html += `
                <div style="margin-bottom: 24px; padding: 16px; background: rgba(${resilienceLevel.color === '#10b981' ? '16, 185, 129' : resilienceLevel.color === '#84cc16' ? '132, 204, 22' : resilienceLevel.color === '#f59e0b' ? '245, 158, 11' : '239, 68, 68'}, 0.1); border-radius: 8px; border-left: 4px solid ${resilienceLevel.color};">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                        <div style="font-size: 20px; font-weight: bold; color: ${resilienceLevel.color};">
                            ${resilienceScore}/100
                        </div>
                        <div style="font-size: 16px; font-weight: 600; color: ${resilienceLevel.color};">
                            ${resilienceLevel.label}
                        </div>
                    </div>
                    <div style="font-size: 13px; line-height: 1.6; color: var(--text-muted);">
                        ${resilienceLevel.desc}
                    </div>
                </div>
            `;
            
            // æ”¹è¿›å»ºè®®
            html += '<h4 style="margin-bottom: 16px; color: var(--accent-primary);">ğŸ’¡ æ”¹è¿›å»ºè®®</h4>';
            html += '<div style="padding: 16px; background: var(--bg-secondary); border-radius: 8px;">';
            
            const suggestions = [];
            if (maxDrawdown > 0.3) {
                suggestions.push({
                    priority: 'high',
                    action: 'é™ä½èµ„äº§é›†ä¸­åº¦',
                    description: 'é€šè¿‡åˆ†æ•£æŠ•èµ„é™ä½å•ä¸€èµ„äº§é£é™©ï¼Œå‡å°‘æœ€å¤§å›æ’¤å¹…åº¦'
                });
            }
            if (recoveryMonths > 6) {
                suggestions.push({
                    priority: 'high',
                    action: 'ä¼˜åŒ–èµ„äº§é…ç½®',
                    description: 'å¢åŠ æµåŠ¨æ€§èµ„äº§æ¯”ä¾‹ï¼Œæé«˜ç­–ç•¥çš„å¿«é€Ÿæ¢å¤èƒ½åŠ›'
                });
            }
            if (resilienceScore < 50) {
                suggestions.push({
                    priority: 'medium',
                    action: 'å»ºç«‹é£é™©ç¼“å†²æœºåˆ¶',
                    description: 'å¢åŠ èµ„æœ¬ç¼“å†²ï¼Œå»ºç«‹é£é™©é¢„è­¦ç³»ç»Ÿï¼Œæå‰åº”å¯¹æç«¯åœºæ™¯'
                });
            }
            if (maxDrawdown > 0.2 && recoveryMonths > 3) {
                suggestions.push({
                    priority: 'medium',
                    action: 'åŠ¨æ€è°ƒæ•´ç­–ç•¥',
                    description: 'æ ¹æ®å¸‚åœºå˜åŒ–åŠ¨æ€è°ƒæ•´ç­–ç•¥å‚æ•°ï¼Œæé«˜é€‚åº”æ€§'
                });
            }
            
            if (suggestions.length === 0) {
                suggestions.push({
                    priority: 'low',
                    action: 'ä¿æŒå½“å‰ç­–ç•¥',
                    description: 'ç­–ç•¥éŸ§æ€§è¡¨ç°è‰¯å¥½ï¼Œç»§ç»­ä¿æŒå¹¶å®šæœŸè¯„ä¼°'
                });
            }
            
            suggestions.forEach(suggestion => {
                const iconMap = {
                    'high': 'ğŸ”´',
                    'medium': 'ğŸŸ¡',
                    'low': 'ğŸŸ¢'
                };
                html += `
                    <div style="margin-bottom: 12px; padding: 12px; background: rgba(59, 130, 246, 0.1); border-radius: 6px; border-left: 3px solid #3b82f6;">
                        <div style="display: flex; align-items: start; gap: 8px;">
                            <span style="font-size: 16px;">${iconMap[suggestion.priority] || 'âšª'}</span>
                            <div style="flex: 1;">
                                <div style="font-size: 13px; font-weight: 600; margin-bottom: 4px;">${suggestion.action}</div>
                                <div style="font-size: 12px; color: var(--text-muted);">${suggestion.description}</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            if (resilience.explanation) {
                html += `
                    <div style="margin-top: 24px; padding: 16px; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border-left: 4px solid #3b82f6;">
                        <div style="font-size: 13px; font-weight: 600; margin-bottom: 8px; color: #3b82f6;">ğŸ“ è¯¦ç»†è¯´æ˜</div>
                        <div style="font-size: 13px; line-height: 1.8;">${resilience.explanation}</div>
                    </div>
                `;
            }
            
            html += '</div>';
            content.innerHTML = html;
            modal.style.display = 'flex';
        }
        
        function closeStressDetail() {
            document.getElementById('stress-detail-modal').style.display = 'none';
        }
        
        // æ˜¾ç¤ºæŒ‡æ ‡è®¡ç®—è¯´æ˜
        function showMetricCalculation(metricType) {
            const data = window.stressTestData;
            if (!data) {
                alert('è¯·å…ˆè¿è¡Œå‹åŠ›æµ‹è¯•');
                return;
            }
            const modal = document.getElementById('metric-calculation-modal');
            const title = document.getElementById('metric-calculation-title');
            const content = document.getElementById('metric-calculation-content');
            
            if (!modal || !title || !content) {
                console.error('è®¡ç®—è¯´æ˜å¼¹çª—å…ƒç´ æœªæ‰¾åˆ°');
                alert('è®¡ç®—è¯´æ˜åŠŸèƒ½æœªæ­£ç¡®åŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                return;
            }
            
            const calculations = {
                'default_rate': {
                    title: 'ğŸ“Š è¿çº¦ç‡è®¡ç®—è¯´æ˜',
                    formula: 'è¿çº¦ç‡ = Î£(å®¢æˆ·è¿çº¦æ¦‚ç‡) / å®¢æˆ·æ€»æ•°',
                    steps: [
                        {
                            step: 1,
                            name: 'æ­£å¸¸åœºæ™¯è¿çº¦ç‡',
                            description: `åœ¨æ­£å¸¸ç»æµç¯å¢ƒä¸‹ï¼Œå¯¹${data.config?.customer_count || 100}ä¸ªæµ‹è¯•å®¢æˆ·è¿›è¡Œè¿çº¦æ¦‚ç‡é¢„æµ‹`,
                            formula: 'æ­£å¸¸è¿çº¦ç‡ = Î£(æ­£å¸¸åœºæ™¯ä¸‹å®¢æˆ·è¿çº¦æ¦‚ç‡) / å®¢æˆ·æ•°é‡',
                            value: data.impact?.normal_default_rate ? (data.impact.normal_default_rate * 100).toFixed(2) + '%' : 'N/A',
                            details: `ä½¿ç”¨ä¸–ç•Œæ¨¡å‹é¢„æµ‹æ¯ä¸ªå®¢æˆ·åœ¨æ­£å¸¸å¸‚åœºæ¡ä»¶ä¸‹çš„è¿çº¦æ¦‚ç‡ï¼Œç„¶åè®¡ç®—å¹³å‡å€¼`
                        },
                        {
                            step: 2,
                            name: 'å‹åŠ›åœºæ™¯è¿çº¦ç‡',
                            description: `åœ¨${data.event_name || 'å‹åŠ›'}äº‹ä»¶å½±å“ä¸‹ï¼Œé‡æ–°è®¡ç®—è¿çº¦æ¦‚ç‡`,
                            formula: 'å‹åŠ›è¿çº¦ç‡ = Î£(å‹åŠ›åœºæ™¯ä¸‹å®¢æˆ·è¿çº¦æ¦‚ç‡) / å®¢æˆ·æ•°é‡',
                            value: data.impact?.default_rate ? (data.impact.default_rate * 100).toFixed(2) + '%' : 'N/A',
                            details: `åœ¨å‹åŠ›å¸‚åœºæ¡ä»¶ä¸‹ï¼ˆè°ƒæ•´GDPã€å¤±ä¸šç‡ã€åˆ©ç‡ç­‰å‚æ•°ï¼‰ï¼Œé‡æ–°é¢„æµ‹æ¯ä¸ªå®¢æˆ·çš„è¿çº¦æ¦‚ç‡`
                        },
                        {
                            step: 3,
                            name: 'è¿çº¦ç‡å˜åŒ–',
                            description: 'è®¡ç®—å‹åŠ›åœºæ™¯ç›¸å¯¹äºæ­£å¸¸åœºæ™¯çš„å˜åŒ–',
                            formula: 'è¿çº¦ç‡å˜åŒ– = å‹åŠ›è¿çº¦ç‡ - æ­£å¸¸è¿çº¦ç‡',
                            value: data.impact?.default_rate_change ? ((data.impact.default_rate_change > 0 ? '+' : '') + (data.impact.default_rate_change * 100).toFixed(2) + '%') : 'N/A',
                            details: `å˜åŒ–å¹…åº¦åæ˜ äº†${data.event_name || 'å‹åŠ›äº‹ä»¶'}å¯¹è¿çº¦é£é™©çš„ç›´æ¥å½±å“`
                        }
                    ],
                    explanation: 'è¿çº¦ç‡æ˜¯é€šè¿‡å¯¹æ¯ä¸ªæµ‹è¯•å®¢æˆ·ä½¿ç”¨ä¸–ç•Œæ¨¡å‹è¿›è¡Œè¿çº¦æ¦‚ç‡é¢„æµ‹ï¼Œç„¶åè®¡ç®—å¹³å‡å€¼å¾—åˆ°çš„ã€‚å‹åŠ›åœºæ™¯ä¸‹ï¼Œç»æµç¯å¢ƒå‚æ•°ï¼ˆGDPå¢é•¿ç‡ã€å¤±ä¸šç‡ã€åˆ©ç‡ç­‰ï¼‰ä¼šæ ¹æ®äº‹ä»¶ç±»å‹å’Œå¼ºåº¦è¿›è¡Œè°ƒæ•´ï¼Œä»è€Œå½±å“å®¢æˆ·çš„è¿çº¦æ¦‚ç‡ã€‚'
                },
                'profit_drawdown': {
                    title: 'ğŸ“Š åˆ©æ¶¦å›æ’¤è®¡ç®—è¯´æ˜',
                    formula: 'æœ€å¤§å›æ’¤ = (å³°å€¼åˆ©æ¶¦ - æœ€ä½åˆ©æ¶¦) / å³°å€¼åˆ©æ¶¦',
                    steps: [
                        {
                            step: 1,
                            name: 'æ¨¡æ‹Ÿåˆ©æ¶¦å˜åŒ–',
                            description: `æ¨¡æ‹Ÿ${data.config?.duration || 6}ä¸ªæœˆå‹åŠ›äº‹ä»¶æœŸé—´åŠåç»­12ä¸ªæœˆçš„åˆ©æ¶¦å˜åŒ–`,
                            formula: 'æœˆåˆ©æ¶¦ = ä¸Šæœˆåˆ©æ¶¦ Ã— (1 - ä¸‹é™ç‡) æˆ– Ã— (1 + æ¢å¤ç‡)',
                            value: 'æ—¶é—´åºåˆ—',
                            details: `åœ¨äº‹ä»¶æœŸé—´ï¼Œåˆ©æ¶¦æŒ‰${data.config?.severity === 'extreme' ? 'æç«¯' : data.config?.severity === 'severe' ? 'é‡åº¦' : data.config?.severity === 'moderate' ? 'ä¸­åº¦' : 'è½»åº¦'}å¼ºåº¦é€æ­¥ä¸‹é™ï¼›äº‹ä»¶ç»“æŸåï¼Œåˆ©æ¶¦é€æ­¥æ¢å¤`
                        },
                        {
                            step: 2,
                            name: 'è®¡ç®—æœ€å¤§å›æ’¤',
                            description: 'æ‰¾åˆ°åˆ©æ¶¦æ›²çº¿çš„æœ€ä½ç‚¹ï¼Œè®¡ç®—ç›¸å¯¹äºå³°å€¼çš„å›æ’¤å¹…åº¦',
                            formula: 'æœ€å¤§å›æ’¤ = (å³°å€¼åˆ©æ¶¦ - æœ€ä½åˆ©æ¶¦) / å³°å€¼åˆ©æ¶¦ Ã— 100%',
                            value: data.resilience?.profit_drawdown ? (data.resilience.profit_drawdown * 100).toFixed(1) + '%' : 'N/A',
                            details: `å³°å€¼åˆ©æ¶¦ä¸ºåŸºå‡†å€¼ï¼ˆ1000ï¼‰ï¼Œæœ€ä½åˆ©æ¶¦ä¸º${data.resilience?.profit_drawdown ? (1000 * (1 - data.resilience.profit_drawdown)).toFixed(0) : 'N/A'}ï¼Œå›æ’¤å¹…åº¦ä¸º${data.resilience?.profit_drawdown ? (data.resilience.profit_drawdown * 100).toFixed(1) : 'N/A'}%`
                        }
                    ],
                    explanation: 'åˆ©æ¶¦å›æ’¤é€šè¿‡æ¨¡æ‹Ÿå‹åŠ›äº‹ä»¶æœŸé—´çš„åˆ©æ¶¦å˜åŒ–æ›²çº¿æ¥è®¡ç®—ã€‚äº‹ä»¶æœŸé—´åˆ©æ¶¦ä¼šä¸‹é™ï¼Œä¸‹é™å¹…åº¦å–å†³äºäº‹ä»¶å¼ºåº¦å’ŒæŒç»­æ—¶é—´ã€‚æœ€å¤§å›æ’¤åæ˜ äº†åœ¨æœ€åæƒ…å†µä¸‹åˆ©æ¶¦çš„æŸå¤±ç¨‹åº¦ã€‚'
                },
                'recovery_time': {
                    title: 'ğŸ“Š æ¢å¤æ—¶é—´è®¡ç®—è¯´æ˜',
                    formula: 'æ¢å¤æ—¶é—´ = æ¢å¤åˆ°90%å³°å€¼åˆ©æ¶¦æ‰€éœ€çš„æœˆæ•°',
                    steps: [
                        {
                            step: 1,
                            name: 'å®šä¹‰æ¢å¤é˜ˆå€¼',
                            description: 'è®¾å®šæ¢å¤ç›®æ ‡ä¸ºå³°å€¼åˆ©æ¶¦çš„90%',
                            formula: 'æ¢å¤é˜ˆå€¼ = å³°å€¼åˆ©æ¶¦ Ã— 90%',
                            value: '900ï¼ˆåŸºå‡†åˆ©æ¶¦1000çš„90%ï¼‰',
                            details: '90%é˜ˆå€¼æ˜¯è¡Œä¸šå¸¸ç”¨çš„æ¢å¤æ ‡å‡†ï¼Œè¡¨ç¤ºåŸºæœ¬æ¢å¤åˆ°æ­£å¸¸ç»è¥æ°´å¹³'
                        },
                        {
                            step: 2,
                            name: 'è®¡ç®—æ¢å¤æ—¶é—´',
                            description: 'ä»äº‹ä»¶ç»“æŸå¼€å§‹ï¼Œè®¡ç®—åˆ©æ¶¦æ¢å¤åˆ°é˜ˆå€¼æ‰€éœ€çš„æœˆæ•°',
                            formula: 'æ¢å¤æ—¶é—´ = é¦–æ¬¡è¾¾åˆ°æ¢å¤é˜ˆå€¼çš„æœˆä»½ - äº‹ä»¶ç»“æŸæœˆä»½',
                            value: data.resilience?.recovery_months ? data.resilience.recovery_months + 'ä¸ªæœˆ' : 'N/A',
                            details: `äº‹ä»¶ç»“æŸåï¼Œåˆ©æ¶¦æŒ‰æ¯æœˆçº¦5%çš„é€Ÿåº¦æ¢å¤ï¼Œç›´åˆ°è¾¾åˆ°æˆ–è¶…è¿‡æ¢å¤é˜ˆå€¼`
                        }
                    ],
                    explanation: 'æ¢å¤æ—¶é—´åæ˜ äº†ç­–ç•¥åœ¨å‹åŠ›äº‹ä»¶åçš„æ¢å¤èƒ½åŠ›ã€‚æ¢å¤é€Ÿåº¦å–å†³äºç­–ç•¥çš„éŸ§æ€§å’Œå¸‚åœºç¯å¢ƒçš„æ”¹å–„é€Ÿåº¦ã€‚è¾ƒçŸ­çš„æ¢å¤æ—¶é—´è¡¨æ˜ç­–ç•¥å…·æœ‰è¾ƒå¼ºçš„æŠ—é£é™©èƒ½åŠ›ã€‚'
                },
                'resilience_score': {
                    title: 'ğŸ“Š éŸ§æ€§è¯„åˆ†è®¡ç®—è¯´æ˜',
                    formula: 'éŸ§æ€§è¯„åˆ† = 100 - (æœ€å¤§å›æ’¤ Ã— 150) - (æ¢å¤æ—¶é—´ Ã— 2)',
                    steps: [
                        {
                            step: 1,
                            name: 'å›æ’¤æƒ©ç½š',
                            description: 'æ ¹æ®æœ€å¤§å›æ’¤è®¡ç®—æƒ©ç½šåˆ†æ•°',
                            formula: 'å›æ’¤æƒ©ç½š = æœ€å¤§å›æ’¤ Ã— 150',
                            value: data.resilience?.profit_drawdown ? (data.resilience.profit_drawdown * 150).toFixed(1) + 'åˆ†' : 'N/A',
                            details: `å›æ’¤è¶Šå¤§ï¼Œæƒ©ç½šè¶Šé«˜ã€‚æ¯1%çš„å›æ’¤æ‰£é™¤1.5åˆ†`
                        },
                        {
                            step: 2,
                            name: 'æ¢å¤æ—¶é—´æƒ©ç½š',
                            description: 'æ ¹æ®æ¢å¤æ—¶é—´è®¡ç®—æƒ©ç½šåˆ†æ•°',
                            formula: 'æ¢å¤æ—¶é—´æƒ©ç½š = æ¢å¤æ—¶é—´(æœˆ) Ã— 2',
                            value: data.resilience?.recovery_months ? (data.resilience.recovery_months * 2) + 'åˆ†' : 'N/A',
                            details: `æ¢å¤æ—¶é—´è¶Šé•¿ï¼Œæƒ©ç½šè¶Šé«˜ã€‚æ¯ä¸ªæœˆæ‰£é™¤2åˆ†`
                        },
                        {
                            step: 3,
                            name: 'è®¡ç®—æœ€ç»ˆè¯„åˆ†',
                            description: 'ä»æ»¡åˆ†100åˆ†ä¸­æ‰£é™¤å„é¡¹æƒ©ç½š',
                            formula: 'éŸ§æ€§è¯„åˆ† = 100 - å›æ’¤æƒ©ç½š - æ¢å¤æ—¶é—´æƒ©ç½š',
                            value: data.resilience?.resilience_score ? data.resilience.resilience_score + '/100' : 'N/A',
                            details: `è¯„åˆ†èŒƒå›´0-100ï¼Œ${data.resilience?.resilience_score > 70 ? '70åˆ†ä»¥ä¸Šä¸ºä¼˜ç§€' : data.resilience?.resilience_score > 50 ? '50-70åˆ†ä¸ºè‰¯å¥½' : '50åˆ†ä»¥ä¸‹éœ€è¦æ”¹è¿›'}`
                        }
                    ],
                    explanation: 'éŸ§æ€§è¯„åˆ†ç»¼åˆè¯„ä¼°ç­–ç•¥åœ¨æç«¯åœºæ™¯ä¸‹çš„è¡¨ç°ã€‚è¯„åˆ†è¶Šé«˜ï¼Œè¡¨æ˜ç­–ç•¥åœ¨å‹åŠ›ä¸‹çš„æŸå¤±è¶Šå°ã€æ¢å¤è¶Šå¿«ï¼Œæ•´ä½“éŸ§æ€§è¶Šå¼ºã€‚'
                },
                'risk_level': {
                    title: 'ğŸ“Š é£é™©ç­‰çº§è®¡ç®—è¯´æ˜',
                    formula: 'æ ¹æ®è¿çº¦ç‡å’Œåˆ©æ¶¦å›æ’¤ç»¼åˆåˆ¤æ–­',
                    steps: [
                        {
                            step: 1,
                            name: 'è¯„ä¼°è¿çº¦ç‡é£é™©',
                            description: 'æ ¹æ®å‹åŠ›åœºæ™¯ä¸‹çš„å¹³å‡è¿çº¦ç‡åˆ¤æ–­',
                            formula: 'è¿çº¦ç‡ > 25% â†’ æé«˜é£é™©\nè¿çº¦ç‡ > 15% â†’ é«˜é£é™©\nè¿çº¦ç‡ > 10% â†’ ä¸­é£é™©\nè¿çº¦ç‡ â‰¤ 10% â†’ ä½é£é™©',
                            value: data.impact?.default_rate ? (data.impact.default_rate * 100).toFixed(2) + '%' : 'N/A',
                            details: `å½“å‰è¿çº¦ç‡ä¸º${data.impact?.default_rate ? (data.impact.default_rate * 100).toFixed(2) : 'N/A'}%ï¼Œ${data.impact?.default_rate > 0.25 ? 'å±äºæé«˜é£é™©' : data.impact?.default_rate > 0.15 ? 'å±äºé«˜é£é™©' : data.impact?.default_rate > 0.10 ? 'å±äºä¸­é£é™©' : 'å±äºä½é£é™©'}`
                        },
                        {
                            step: 2,
                            name: 'è¯„ä¼°å›æ’¤é£é™©',
                            description: 'æ ¹æ®æœ€å¤§åˆ©æ¶¦å›æ’¤åˆ¤æ–­',
                            formula: 'å›æ’¤ > 50% â†’ æé«˜é£é™©\nå›æ’¤ > 30% â†’ é«˜é£é™©\nå›æ’¤ > 20% â†’ ä¸­é£é™©\nå›æ’¤ â‰¤ 20% â†’ ä½é£é™©',
                            value: data.resilience?.profit_drawdown ? (data.resilience.profit_drawdown * 100).toFixed(1) + '%' : 'N/A',
                            details: `å½“å‰å›æ’¤ä¸º${data.resilience?.profit_drawdown ? (data.resilience.profit_drawdown * 100).toFixed(1) : 'N/A'}%ï¼Œ${data.resilience?.profit_drawdown > 0.5 ? 'å±äºæé«˜é£é™©' : data.resilience?.profit_drawdown > 0.3 ? 'å±äºé«˜é£é™©' : data.resilience?.profit_drawdown > 0.2 ? 'å±äºä¸­é£é™©' : 'å±äºä½é£é™©'}`
                        },
                        {
                            step: 3,
                            name: 'ç»¼åˆé£é™©ç­‰çº§',
                            description: 'å–è¿çº¦ç‡å’Œå›æ’¤é£é™©ä¸­çš„è¾ƒé«˜ç­‰çº§',
                            formula: 'é£é™©ç­‰çº§ = max(è¿çº¦ç‡é£é™©ç­‰çº§, å›æ’¤é£é™©ç­‰çº§)',
                            value: data.risk_level || 'N/A',
                            details: data.risk_description || 'æ ¹æ®ç»¼åˆè¯„ä¼°ç¡®å®šæœ€ç»ˆé£é™©ç­‰çº§'
                        }
                    ],
                    explanation: 'é£é™©ç­‰çº§ç»¼åˆè€ƒè™‘äº†è¿çº¦ç‡å’Œåˆ©æ¶¦å›æ’¤ä¸¤ä¸ªç»´åº¦ã€‚åªè¦å…¶ä¸­ä¸€ä¸ªæŒ‡æ ‡è¾¾åˆ°é«˜é£é™©é˜ˆå€¼ï¼Œæ•´ä½“é£é™©ç­‰çº§å°±ä¼šç›¸åº”æå‡ã€‚è¿™ç¡®ä¿äº†é£é™©åˆ¤æ–­çš„å…¨é¢æ€§å’Œå‡†ç¡®æ€§ã€‚'
                }
            };
            
            const calc = calculations[metricType];
            if (!calc) return;
            
            title.textContent = calc.title;
            
            let html = '<div style="padding: 20px;">';
            
            // å…¬å¼
            html += `
                <div style="margin-bottom: 24px; padding: 16px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1)); border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.3);">
                    <div style="font-size: 13px; font-weight: 600; margin-bottom: 8px; color: #3b82f6;">ğŸ“ è®¡ç®—å…¬å¼</div>
                    <div style="padding: 12px; background: rgba(255, 255, 255, 0.1); border-radius: 6px; font-family: \'JetBrains Mono\', monospace; font-size: 14px; color: var(--text-primary);">
                        ${calc.formula}
                    </div>
                </div>
            `;
            
            // è®¡ç®—æ­¥éª¤
            html += '<h4 style="margin-bottom: 16px; color: var(--accent-primary);">ğŸ“‹ è®¡ç®—æ­¥éª¤</h4>';
            calc.steps.forEach(step => {
                html += `
                    <div style="margin-bottom: 20px; padding: 16px; background: var(--bg-secondary); border-radius: 8px; border-left: 4px solid var(--accent-primary);">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                            <span style="font-size: 20px; font-weight: bold; color: var(--accent-primary);">${step.step}</span>
                            <div style="font-size: 16px; font-weight: 600;">${step.name}</div>
                        </div>
                        <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px; line-height: 1.6;">${step.description}</div>
                        <div style="padding: 10px; background: rgba(59, 130, 246, 0.1); border-radius: 6px; font-family: \'JetBrains Mono\', monospace; font-size: 12px; margin-bottom: 8px; border: 1px solid rgba(59, 130, 246, 0.2); white-space: pre-wrap;">
                            ${step.formula}
                        </div>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="font-size: 13px; color: var(--text-muted);">è®¡ç®—ç»“æœ:</div>
                            <div style="font-size: 16px; font-weight: 600; color: var(--accent-primary);">
                                ${step.value}
                            </div>
                        </div>
                        ${step.details ? `<div style="font-size: 12px; color: var(--text-muted); margin-top: 8px; padding: 8px; background: rgba(16, 185, 129, 0.1); border-radius: 4px; border-left: 3px solid #10b981;">ğŸ’¡ ${step.details}</div>` : ''}
                    </div>
                `;
            });
            
            // è¯´æ˜
            html += `
                <div style="margin-top: 24px; padding: 16px; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border-left: 4px solid #3b82f6;">
                    <div style="font-size: 13px; font-weight: 600; margin-bottom: 8px; color: #3b82f6;">ğŸ“ è¯¦ç»†è¯´æ˜</div>
                    <div style="font-size: 13px; line-height: 1.8; color: var(--text-muted);">
                        ${calc.explanation}
                    </div>
                </div>
            `;
            
            html += '</div>';
            content.innerHTML = html;
            modal.style.display = 'flex';
        }
        
        function closeMetricCalculation() {
            document.getElementById('metric-calculation-modal').style.display = 'none';
        }
        
        // ============================================================
        // å¤šæ¨¡å‹å¯¹æŠ—è¯„æµ‹
        // ============================================================
        
        let availableModels = [];
        let availableTestCases = [];
        let selectedModelIds = new Set(); // å…¨å±€ä¿å­˜é€‰ä¸­çš„æ¨¡å‹ID
        
        async function loadModels() {
            try {
                const response = await fetch(`${API_BASE}/api/models/list`);
                const data = await response.json();
                console.log('æ¨¡å‹åˆ—è¡¨å“åº”:', data);
                if (data.success) {
                    availableModels = data.models || [];
                    console.log('å¯ç”¨æ¨¡å‹:', availableModels);
                    renderModelSelection();
                } else {
                    console.error('åŠ è½½æ¨¡å‹å¤±è´¥:', data.error);
                    const container = document.getElementById('model-selection');
                    if (container) {
                        container.innerHTML = `<p style="color: var(--accent-danger);">åŠ è½½æ¨¡å‹å¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}</p>`;
                    }
                }
            } catch (error) {
                console.error('åŠ è½½æ¨¡å‹åˆ—è¡¨å¤±è´¥:', error);
                const container = document.getElementById('model-selection');
                if (container) {
                    container.innerHTML = `<p style="color: var(--accent-danger);">ç½‘ç»œé”™è¯¯: ${error.message}</p>`;
                }
            }
        }
        
        async function loadTestCases() {
            try {
                const response = await fetch(`${API_BASE}/api/evaluation/test-cases`);
                const data = await response.json();
                if (data.success) {
                    availableTestCases = data.test_cases;
                    renderTestCaseSelection();
                }
            } catch (error) {
                console.error('åŠ è½½æµ‹è¯•ç”¨ä¾‹å¤±è´¥:', error);
            }
        }
        
        let currentCategory = 'all';
        let searchKeyword = '';
        
        function filterModels() {
            searchKeyword = document.getElementById('model-search')?.value.toLowerCase() || '';
            renderModelSelection();
        }
        
        function filterByCategory(category) {
            currentCategory = category;
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.model-category-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.category === category) {
                    btn.classList.add('active');
                }
            });
            // åˆ‡æ¢åˆ†ç±»æ—¶ä¿ç•™é€‰ä¸­çŠ¶æ€
            renderModelSelection();
        }
        
        function toggleModelSelection(modelId) {
            if (selectedModelIds.has(modelId)) {
                selectedModelIds.delete(modelId);
            } else {
                selectedModelIds.add(modelId);
            }
            
            const checkbox = document.querySelector(`.model-checkbox[value="${modelId}"]`);
            if (checkbox) {
                checkbox.checked = selectedModelIds.has(modelId);
                const card = checkbox.closest('.model-card');
                if (card) {
                    card.classList.toggle('selected', checkbox.checked);
                }
            }
        }
        
        function selectAllModels() {
            // è·å–å½“å‰è¿‡æ»¤åçš„æ‰€æœ‰æ¨¡å‹
            const visibleCheckboxes = document.querySelectorAll('.model-checkbox');
            visibleCheckboxes.forEach(checkbox => {
                const modelId = checkbox.value;
                selectedModelIds.add(modelId);
                checkbox.checked = true;
                const card = checkbox.closest('.model-card');
                if (card) {
                    card.classList.add('selected');
                }
            });
        }
        
        function deselectAllModels() {
            // åªå–æ¶ˆå½“å‰å¯è§çš„æ¨¡å‹é€‰æ‹©
            const visibleCheckboxes = document.querySelectorAll('.model-checkbox');
            visibleCheckboxes.forEach(checkbox => {
                const modelId = checkbox.value;
                selectedModelIds.delete(modelId);
                checkbox.checked = false;
                const card = checkbox.closest('.model-card');
                if (card) {
                    card.classList.remove('selected');
                }
            });
        }
        
        function renderModelSelection() {
            const container = document.getElementById('model-selection');
            if (!container) {
                console.error('model-selection å®¹å™¨æœªæ‰¾åˆ°');
                return;
            }
            
            console.log('æ¸²æŸ“æ¨¡å‹é€‰æ‹©ï¼Œæ¨¡å‹æ•°é‡:', availableModels.length);
            
            if (availableModels.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); padding: 12px;">æš‚æ— å¯ç”¨æ¨¡å‹ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡</p>';
                return;
            }
            
            // è¿‡æ»¤æ¨¡å‹
            let filteredModels = availableModels;
            
            // æŒ‰åˆ†ç±»è¿‡æ»¤
            if (currentCategory !== 'all') {
                filteredModels = filteredModels.filter(model => {
                    const modelType = (model.type && model.type.value) || model.type || '';
                    return modelType.toLowerCase().includes(currentCategory);
                });
            }
            
            // æŒ‰å…³é”®è¯æœç´¢
            if (searchKeyword) {
                filteredModels = filteredModels.filter(model => {
                    const modelId = (model.id || '').toLowerCase();
                    const modelType = ((model.type && model.type.value) || model.type || '').toLowerCase();
                    return modelId.includes(searchKeyword) || modelType.includes(searchKeyword);
                });
            }
            
            if (filteredModels.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); padding: 12px;">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„æ¨¡å‹</p>';
                return;
            }
            
            // æ¨¡å‹å›¾æ ‡æ˜ å°„
            const modelIcons = {
                'gpt-4': 'ğŸ§ ',
                'claude-3': 'ğŸ¤–',
                'local-model': 'ğŸ’»',
                'rag-model': 'ğŸ“š'
            };
            
            // æ¨¡å‹ç‰¹æ€§æ˜ å°„
            const modelFeatures = {
                'gpt-4': ['æ¨ç†', 'å¤šæ¨¡æ€'],
                'claude-3': ['æ¨ç†', 'é•¿ä¸Šä¸‹æ–‡'],
                'local-model': ['æœ¬åœ°éƒ¨ç½²', 'ä¾¿å®œ'],
                'rag-model': ['çŸ¥è¯†æ£€ç´¢', 'ä¸“ä¸š']
            };
            
            let html = '';
            filteredModels.forEach(model => {
                const modelId = model.id || model.model_id || 'æœªçŸ¥';
                const modelType = (model.type && model.type.value) || model.type || 'æœªçŸ¥';
                const status = model.status || 'active';
                const config = model.config || {};
                const provider = config.provider || modelType;
                const features = config.features || modelFeatures[modelId] || [];
                
                // æ ¹æ®æ¨¡å‹ç±»å‹å’ŒIDé€‰æ‹©åˆé€‚çš„å›¾æ ‡
                let icon = 'ğŸ¤–';
                if (modelId.includes('gpt') || modelId.includes('openai')) {
                    icon = 'ğŸ§ ';
                } else if (modelId.includes('claude') || modelId.includes('anthropic')) {
                    icon = 'ğŸ¯';
                } else if (modelId.includes('gemini') || modelId.includes('google')) {
                    icon = 'ğŸ’';
                } else if (modelId.includes('qwen') || modelId.includes('é€šä¹‰')) {
                    icon = 'ğŸŒŸ';
                } else if (modelId.includes('ollama') || modelId.includes('local') || modelType.includes('local')) {
                    icon = 'ğŸ’»';
                } else if (modelId.includes('rag') || modelType.includes('rag')) {
                    icon = 'ğŸ“š';
                } else if (modelId.includes('deepseek')) {
                    icon = 'ğŸ”¬';
                } else if (modelId.includes('kimi') || modelId.includes('moonshot')) {
                    icon = 'ğŸŒ™';
                } else if (modelId.includes('glm') || modelId.includes('æ™ºè°±')) {
                    icon = 'âœ¨';
                }
                
                const isSelected = selectedModelIds.has(modelId);
                
                html += `
                    <div class="model-card ${isSelected ? 'selected' : ''}" onclick="toggleModelSelection('${modelId}')" style="padding: 16px; background: ${isSelected ? 'rgba(59, 130, 246, 0.1)' : 'var(--bg-secondary)'}; border: 2px solid ${isSelected ? 'var(--accent-primary)' : 'var(--border-color)'}; border-radius: 12px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden;">
                        <div style="display: flex; align-items: start; gap: 12px;">
                            <div style="font-size: 32px; flex-shrink: 0;">${icon}</div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px;">
                                    <div style="font-weight: 600; font-size: 15px; color: var(--text-primary);">${modelId}</div>
                                    <label style="display: flex; align-items: center; cursor: pointer;" onclick="event.stopPropagation();">
                                        <input type="checkbox" class="model-checkbox" value="${modelId}" ${isSelected ? 'checked' : ''} style="width: 20px; height: 20px; cursor: pointer; accent-color: var(--accent-primary);">
                                    </label>
                                </div>
                                <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">${provider}</div>
                                ${features.length > 0 ? `
                                <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 8px;">
                                    ${features.map(f => `<span style="padding: 3px 8px; background: rgba(59, 130, 246, 0.15); border-radius: 4px; font-size: 11px; color: #3b82f6; font-weight: 500;">${f}</span>`).join('')}
                                </div>
                                ` : ''}
                                <div style="display: flex; align-items: center; gap: 8px; margin-top: 8px;">
                                    <span style="padding: 4px 10px; background: rgba(16, 185, 129, 0.15); border-radius: 6px; font-size: 11px; color: #10b981; font-weight: 600;">${status}</span>
                                </div>
                            </div>
                        </div>
                        ${isSelected ? `
                        <div style="position: absolute; top: 0; right: 0; width: 0; height: 0; border-style: solid; border-width: 0 24px 24px 0; border-color: transparent var(--accent-primary) transparent transparent;"></div>
                        <div style="position: absolute; top: 2px; right: 2px; color: white; font-size: 12px;">âœ“</div>
                        ` : ''}
                    </div>
                `;
            });
            container.innerHTML = html;
        }
        
        function renderTestCaseSelection() {
            const container = document.getElementById('test-case-selection');
            if (!container) return;
            
            let html = '';
            availableTestCases.forEach(testCase => {
                html += `
                    <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 8px; border: 1px solid var(--border-color);">
                        <label style="display: flex; align-items: start; gap: 8px; cursor: pointer;">
                            <input type="checkbox" class="testcase-checkbox" value="${testCase.id}" checked style="width: 18px; height: 18px; cursor: pointer; margin-top: 2px;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: 14px; margin-bottom: 4px;">${testCase.scenario}</div>
                                <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">${testCase.initial_prompt}</div>
                                <div style="display: flex; gap: 8px; align-items: center; margin-top: 8px;">
                                    <span style="font-size: 11px; color: var(--text-muted);">${testCase.rounds_count || 0}è½®å¯¹è¯</span>
                                    <button onclick="event.stopPropagation(); showTestCaseDetail('${testCase.id}')" style="padding: 2px 6px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 4px; color: #3b82f6; font-size: 10px; cursor: pointer;">æŸ¥çœ‹è¯¦æƒ…</button>
                                </div>
                            </div>
                        </label>
                    </div>
                `;
            });
            container.innerHTML = html || '<p style="color: var(--text-muted);">æš‚æ— æµ‹è¯•ç”¨ä¾‹</p>';
        }
        
        async function showTestCaseDetail(testCaseId) {
            try {
                const response = await fetch(`${API_BASE}/api/evaluation/test-case/${testCaseId}`);
                const data = await response.json();
                
                if (data.success) {
                    const tc = data.test_case;
                    let html = `
                        <div style="max-width: 800px; max-height: 80vh; overflow-y: auto;">
                            <h3 style="margin-bottom: 16px; color: var(--accent-primary);">${tc.scenario}</h3>
                            
                            <div style="margin-bottom: 20px; padding: 16px; background: var(--bg-secondary); border-radius: 8px;">
                                <h4 style="margin-bottom: 8px; font-size: 14px;">åˆå§‹æç¤º</h4>
                                <p style="color: var(--text-secondary); font-size: 13px; line-height: 1.6;">${tc.initial_prompt}</p>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <h4 style="margin-bottom: 12px; font-size: 14px;">å¯¹è¯è½®æ¬¡ (${tc.rounds.length}è½®)</h4>
                                ${tc.rounds.map((round, idx) => `
                                    <div style="margin-bottom: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 6px; border-left: 3px solid var(--accent-primary);">
                                        <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">ç¬¬${idx + 1}è½® - ${round.action || round.role}</div>
                                        <div style="font-size: 13px; color: var(--text-secondary);">${round.content}</div>
                                    </div>
                                `).join('')}
                            </div>
                            
                            ${tc.evaluation_criteria ? `
                            <div style="margin-bottom: 20px; padding: 16px; background: rgba(16, 185, 129, 0.1); border-radius: 8px; border: 1px solid rgba(16, 185, 129, 0.3);">
                                <h4 style="margin-bottom: 12px; font-size: 14px; color: #10b981;">è¯„ä¼°æ ‡å‡†</h4>
                                ${Object.entries(tc.evaluation_criteria).map(([key, value]) => `
                                    <div style="margin-bottom: 8px;">
                                        <strong style="font-size: 12px; color: var(--text-primary);">${key}:</strong>
                                        <span style="font-size: 12px; color: var(--text-secondary); margin-left: 8px;">${value}</span>
                                    </div>
                                `).join('')}
                            </div>
                            ` : ''}
                            
                            ${tc.compliance_requirements ? `
                            <div style="margin-bottom: 20px; padding: 16px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border: 1px solid rgba(239, 68, 68, 0.3);">
                                <h4 style="margin-bottom: 12px; font-size: 14px; color: #ef4444;">åˆè§„è¦æ±‚</h4>
                                <ul style="margin: 0; padding-left: 20px;">
                                    ${tc.compliance_requirements.map(req => `
                                        <li style="font-size: 12px; color: var(--text-secondary); margin-bottom: 6px; line-height: 1.5;">${req}</li>
                                    `).join('')}
                                </ul>
                            </div>
                            ` : ''}
                            
                            <div style="margin-top: 20px; padding: 12px; background: var(--bg-secondary); border-radius: 6px;">
                                <div style="font-size: 11px; color: var(--text-muted);">
                                    <strong>é¢„æœŸå…³é”®è¯:</strong> ${tc.expected_keywords?.join(', ') || 'æ— '}
                                </div>
                                <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">
                                    <strong>é¢„æœŸè¡Œä¸º:</strong> ${tc.expected_behavior || 'æ— '}
                                </div>
                            </div>
                        </div>
                    `;
                    
                    showModal('æµ‹è¯•ç”¨ä¾‹è¯¦æƒ…', html);
                }
            } catch (error) {
                console.error('åŠ è½½æµ‹è¯•ç”¨ä¾‹è¯¦æƒ…å¤±è´¥:', error);
                alert('åŠ è½½æµ‹è¯•ç”¨ä¾‹è¯¦æƒ…å¤±è´¥: ' + error.message);
            }
        }
        
        async function showMetricsExplanation() {
            try {
                const response = await fetch(`${API_BASE}/api/evaluation/metrics-explanation`);
                const data = await response.json();
                
                if (data.success) {
                    const exp = data.explanation;
                    const audit = data.audit_info;
                    
                    let html = `
                        <div style="max-width: 900px; max-height: 80vh; overflow-y: auto;">
                            <div style="margin-bottom: 20px; padding: 12px; background: rgba(59, 130, 246, 0.1); border-radius: 6px; border: 1px solid rgba(59, 130, 246, 0.3);">
                                <div style="font-size: 11px; color: var(--text-muted);">
                                    <strong>ç‰ˆæœ¬:</strong> ${audit.version} | 
                                    <strong>æ›´æ–°æ—¥æœŸ:</strong> ${audit.last_updated} | 
                                    <strong>å®¡æ ¸äºº:</strong> ${audit.reviewer}<br>
                                    <strong>åˆè§„æ ‡å‡†:</strong> ${audit.compliance_standard}
                                </div>
                            </div>
                            
                            ${Object.entries(exp).map(([key, metric]) => `
                                <div style="margin-bottom: 20px; padding: 16px; background: var(--bg-secondary); border-radius: 8px; border-left: 4px solid var(--accent-primary);">
                                    <h4 style="margin-bottom: 12px; font-size: 15px; color: var(--accent-primary);">
                                        ${metric.name}
                                        ${metric.weight > 0 ? `<span style="font-size: 11px; color: var(--text-muted); margin-left: 8px;">(æƒé‡: ${(metric.weight * 100).toFixed(0)}%)</span>` : ''}
                                    </h4>
                                    
                                    <div style="margin-bottom: 8px;">
                                        <strong style="font-size: 12px; color: var(--text-primary);">æè¿°:</strong>
                                        <span style="font-size: 12px; color: var(--text-secondary); margin-left: 8px;">${metric.description}</span>
                                    </div>
                                    
                                    <div style="margin-bottom: 8px;">
                                        <strong style="font-size: 12px; color: var(--text-primary);">è®¡ç®—æ–¹æ³•:</strong>
                                        <span style="font-size: 12px; color: var(--text-secondary); margin-left: 8px;">${metric.calculation}</span>
                                    </div>
                                    
                                    <div style="margin-bottom: 8px; padding: 8px; background: rgba(0, 0, 0, 0.2); border-radius: 4px; font-family: monospace; font-size: 11px; color: var(--text-secondary);">
                                        <strong>å…¬å¼:</strong> ${metric.formula}
                                    </div>
                                    
                                    <div style="padding: 8px; background: rgba(239, 68, 68, 0.1); border-radius: 4px; border-left: 3px solid #ef4444;">
                                        <strong style="font-size: 11px; color: #ef4444;">åˆè§„è¯´æ˜:</strong>
                                        <span style="font-size: 11px; color: var(--text-secondary); margin-left: 8px;">${metric.compliance_note}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    
                    showModal('è¯„åˆ†ä¾æ®è¯´æ˜ï¼ˆåˆè§„å®¡è®¡ï¼‰', html);
                }
            } catch (error) {
                console.error('åŠ è½½è¯„åˆ†ä¾æ®å¤±è´¥:', error);
                alert('åŠ è½½è¯„åˆ†ä¾æ®å¤±è´¥: ' + error.message);
            }
        }
        
        async function runEvaluation() {
            const resultsDiv = document.getElementById('evaluation-results');
            const detailsDiv = document.getElementById('evaluation-details');
            
            // è·å–é€‰ä¸­çš„æ¨¡å‹
            // ä»å…¨å±€é€‰ä¸­é›†åˆè·å–é€‰ä¸­çš„æ¨¡å‹
            const selectedModels = Array.from(selectedModelIds);
            
            if (selectedModels.length === 0) {
                alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ¨¡å‹');
                return;
            }
            
            // è·å–é€‰ä¸­çš„æµ‹è¯•ç”¨ä¾‹
            const selectedTestCases = Array.from(document.querySelectorAll('.testcase-checkbox:checked'))
                .map(cb => cb.value);
            
            resultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>æ­£åœ¨æ‰§è¡Œè¯„æµ‹...</p></div>';
            detailsDiv.style.display = 'none';
            
            try {
                const response = await fetch(`${API_BASE}/api/evaluation/create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model_ids: selectedModels,
                        test_case_ids: selectedTestCases
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // ä¿å­˜ç»“æœä¾›åç»­ä½¿ç”¨
                    window.lastEvaluationResults = data.results || [];
                    displayEvaluationResults(data);
                } else {
                    resultsDiv.innerHTML = `<div style="color: var(--accent-danger); padding: 20px;">âŒ ${data.error || 'è¯„æµ‹å¤±è´¥'}</div>`;
                }
            } catch (error) {
                console.error('è¯„æµ‹é”™è¯¯:', error);
                resultsDiv.innerHTML = `<div style="color: var(--accent-danger); padding: 20px;">âŒ ç½‘ç»œé”™è¯¯: ${error.message}</div>`;
            }
        }
        
        function displayEvaluationResults(data) {
            const resultsDiv = document.getElementById('evaluation-results');
            const detailsDiv = document.getElementById('evaluation-details');
            const comparisonDiv = document.getElementById('detailed-comparison');
            
            // æ˜¾ç¤ºæ±‡æ€»ç»“æœ
            let html = '<div style="padding: 20px;">';
            html += '<h3 style="margin-bottom: 20px; color: var(--accent-primary);">ğŸ“Š è¯„æµ‹æ±‡æ€»</h3>';
            
            // æ¨¡å‹å¯¹æ¯”è¡¨æ ¼ï¼ˆä¸“ä¸šç‰ˆ - 12ä¸ªç»´åº¦ï¼‰
            html += '<div style="overflow-x: auto; margin-bottom: 24px;">';
            html += '<table style="width: 100%; border-collapse: collapse; font-size: 12px;">';
            html += '<thead><tr style="background: var(--bg-secondary); position: sticky; top: 0;">';
            html += '<th style="padding: 12px; text-align: left; border-bottom: 2px solid var(--border-color);">æ¨¡å‹</th>';
            html += '<th style="padding: 12px; text-align: right; border-bottom: 2px solid var(--border-color);" title="å›ç­”æ­£ç¡®æ€§">æ­£ç¡®ç‡</th>';
            html += '<th style="padding: 12px; text-align: right; border-bottom: 2px solid var(--border-color);" title="å¹»è§‰/é”™è¯¯ä¿¡æ¯æ¯”ä¾‹">å¹»è§‰ç‡</th>';
            html += '<th style="padding: 12px; text-align: right; border-bottom: 2px solid var(--border-color);" title="é‡‘èåˆè§„æ€§">åˆè§„ç‡</th>';
            html += '<th style="padding: 12px; text-align: right; border-bottom: 2px solid var(--border-color);" title="ä¸“ä¸šæœ¯è¯­ä½¿ç”¨">ä¸“ä¸šæ€§</th>';
            html += '<th style="padding: 12px; text-align: right; border-bottom: 2px solid var(--border-color);" title="å“åº”è´¨é‡">è´¨é‡</th>';
            html += '<th style="padding: 12px; text-align: right; border-bottom: 2px solid var(--border-color);" title="å¤šè½®å¯¹è¯ä¸€è‡´æ€§">ä¸€è‡´æ€§</th>';
            html += '<th style="padding: 12px; text-align: right; border-bottom: 2px solid var(--border-color);" title="ä¸šåŠ¡åœºæ™¯é€‚é…åº¦">ä¸šåŠ¡é€‚é…</th>';
            html += '<th style="padding: 12px; text-align: right; border-bottom: 2px solid var(--border-color);" title="å¹³å‡å“åº”æ—¶é—´">å»¶æ—¶</th>';
            html += '<th style="padding: 12px; text-align: right; border-bottom: 2px solid var(--border-color); font-weight: 600;" title="ç»¼åˆè¯„åˆ†">ç»¼åˆè¯„åˆ†</th>';
            html += '</tr></thead><tbody>';
            
            const summary = data.summary || {};
            // æŒ‰ç»¼åˆè¯„åˆ†æ’åº
            const sortedModels = Object.entries(summary).sort((a, b) => 
                (b[1].avg_overall_score || 0) - (a[1].avg_overall_score || 0)
            );
            
            sortedModels.forEach(([modelId, metrics]) => {
                const scoreColor = (metrics.avg_overall_score || 0) > 0.8 ? '#10b981' : 
                                 (metrics.avg_overall_score || 0) > 0.6 ? '#84cc16' :
                                 (metrics.avg_overall_score || 0) > 0.4 ? '#f59e0b' : '#ef4444';
                const scoreLevel = (metrics.avg_overall_score || 0) > 0.8 ? 'ä¼˜ç§€' : 
                                 (metrics.avg_overall_score || 0) > 0.6 ? 'è‰¯å¥½' :
                                 (metrics.avg_overall_score || 0) > 0.4 ? 'ä¸­ç­‰' : 'éœ€æ”¹è¿›';
                
                html += `<tr style="border-bottom: 1px solid var(--border-color);">`;
                html += `<td style="padding: 12px; font-weight: 600;">${modelId}</td>`;
                html += `<td style="padding: 12px; text-align: right;">${((metrics.avg_accuracy || 0) * 100).toFixed(1)}%</td>`;
                html += `<td style="padding: 12px; text-align: right; color: ${(metrics.avg_hallucination_rate || 0) > 0.3 ? '#ef4444' : (metrics.avg_hallucination_rate || 0) > 0.15 ? '#f59e0b' : '#10b981'};">${((metrics.avg_hallucination_rate || 0) * 100).toFixed(1)}%</td>`;
                html += `<td style="padding: 12px; text-align: right;">${((metrics.avg_compliance_rate || 0) * 100).toFixed(1)}%</td>`;
                html += `<td style="padding: 12px; text-align: right;">${((metrics.avg_professionalism || 0) * 100).toFixed(1)}%</td>`;
                html += `<td style="padding: 12px; text-align: right;">${((metrics.avg_response_quality || 0) * 100).toFixed(1)}%</td>`;
                html += `<td style="padding: 12px; text-align: right;">${((metrics.avg_consistency || 0) * 100).toFixed(1)}%</td>`;
                html += `<td style="padding: 12px; text-align: right;">${((metrics.avg_business_fit || 0) * 100).toFixed(1)}%</td>`;
                html += `<td style="padding: 12px; text-align: right;">${((metrics.avg_latency || 0) * 1000).toFixed(0)}ms</td>`;
                html += `<td style="padding: 12px; text-align: right;">
                    <div style="font-weight: 600; color: ${scoreColor}; font-size: 14px;">${((metrics.avg_overall_score || 0) * 100).toFixed(1)}</div>
                    <div style="font-size: 10px; color: var(--text-muted);">${scoreLevel}</div>
                </td>`;
                html += `</tr>`;
            });
            
            html += '</tbody></table></div>';
            
            // æŒ‡æ ‡å¯¹æ¯”å›¾è¡¨
            html += '<h4 style="margin-bottom: 16px; color: var(--accent-primary);">ğŸ“ˆ æŒ‡æ ‡å¯¹æ¯”</h4>';
            html += '<div class="grid grid-4" style="gap: 16px; margin-bottom: 24px;">';
            
            sortedModels.forEach(([modelId, metrics]) => {
                const scoreColor = (metrics.avg_overall_score || 0) > 0.8 ? '#10b981' : 
                                 (metrics.avg_overall_score || 0) > 0.6 ? '#84cc16' :
                                 (metrics.avg_overall_score || 0) > 0.4 ? '#f59e0b' : '#ef4444';
                html += `
                    <div style="padding: 16px; background: var(--bg-secondary); border-radius: 8px; border-left: 4px solid ${scoreColor};">
                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px; font-weight: 600;">${modelId}</div>
                        <div style="font-size: 24px; font-weight: bold; color: ${scoreColor}; margin-bottom: 8px;">
                            ${((metrics.avg_overall_score || 0) * 100).toFixed(1)}
                        </div>
                        <div style="font-size: 11px; color: var(--text-muted); line-height: 1.6;">
                            æ­£ç¡®ç‡: ${((metrics.avg_accuracy || 0) * 100).toFixed(1)}%<br>
                            ä¸“ä¸šæ€§: ${((metrics.avg_professionalism || 0) * 100).toFixed(1)}%<br>
                            åˆè§„ç‡: ${((metrics.avg_compliance_rate || 0) * 100).toFixed(1)}%<br>
                            ä¸šåŠ¡é€‚é…: ${((metrics.avg_business_fit || 0) * 100).toFixed(1)}%
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            html += '</div>';
            
            resultsDiv.innerHTML = html;
            
            // æ˜¾ç¤ºè¯¦ç»†å¯¹æ¯”
            if (comparisonDiv) {
                displayDetailedComparison(data.results, comparisonDiv);
            }
            detailsDiv.style.display = 'block';
        }
        
        function displayDetailedComparison(results, container) {
            if (!container) return;
            
            let html = '<div style="padding: 20px;">';
            html += '<h4 style="margin-bottom: 16px; color: var(--accent-primary);">ğŸ’¬ å®Œæ•´å¯¹è¯å†…å®¹</h4>';
            
            // æŒ‰æµ‹è¯•ç”¨ä¾‹åˆ†ç»„
            const testCaseGroups = {};
            results.forEach(result => {
                if (!testCaseGroups[result.test_case_id]) {
                    testCaseGroups[result.test_case_id] = [];
                }
                testCaseGroups[result.test_case_id].push(result);
            });
            
            Object.entries(testCaseGroups).forEach(([testCaseId, testResults]) => {
                html += `<div style="margin-bottom: 32px; padding: 16px; background: var(--bg-secondary); border-radius: 8px;">`;
                html += `<h5 style="margin-bottom: 16px; color: var(--accent-primary);">æµ‹è¯•ç”¨ä¾‹: ${testCaseId}</h5>`;
                
                testResults.forEach(result => {
                    html += `<div style="margin-bottom: 24px; padding: 16px; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.3);">`;
                    html += `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">`;
                    html += `<div style="font-weight: 600; color: var(--accent-primary); font-size: 15px;">${result.model_id}</div>`;
                    html += `<div style="display: flex; gap: 8px;">`;
                    html += `<button onclick="saveScript('${result.model_id}', '${result.test_case_id}')" style="padding: 6px 12px; background: rgba(16, 185, 129, 0.2); border: 1px solid rgba(16, 185, 129, 0.5); border-radius: 4px; color: #10b981; font-size: 11px; cursor: pointer;">ğŸ’¾ ä¿å­˜è¯æœ¯</button>`;
                    html += `<button onclick="exportScript('${result.model_id}', '${result.test_case_id}', 'json')" style="padding: 6px 12px; background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.5); border-radius: 4px; color: #3b82f6; font-size: 11px; cursor: pointer;">ğŸ“¥ å¯¼å‡ºJSON</button>`;
                    html += `<button onclick="exportScript('${result.model_id}', '${result.test_case_id}', 'txt')" style="padding: 6px 12px; background: rgba(139, 92, 246, 0.2); border: 1px solid rgba(139, 92, 246, 0.5); border-radius: 4px; color: #8b5cf6; font-size: 11px; cursor: pointer;">ğŸ“„ å¯¼å‡ºTXT</button>`;
                    html += `</div>`;
                    html += `</div>`;
                    
                    // æ˜¾ç¤ºå®Œæ•´å¯¹è¯å†å²
                    if (result.dialogue_history && result.dialogue_history.length > 0) {
                        result.dialogue_history.forEach((dialogue, idx) => {
                            const isUser = dialogue.role === 'user';
                            const roleName = isUser ? 'å®¢æˆ·' : 'å®¢æœ';
                            const bgColor = isUser ? 'rgba(59, 130, 246, 0.1)' : 'rgba(16, 185, 129, 0.1)';
                            const borderColor = isUser ? 'rgba(59, 130, 246, 0.3)' : 'rgba(16, 185, 129, 0.3)';
                            
                            html += `<div style="margin-bottom: 12px; padding: 12px; background: ${bgColor}; border-radius: 6px; border-left: 4px solid ${borderColor};">`;
                            html += `<div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 6px;">`;
                            html += `<div style="font-weight: 600; font-size: 12px; color: ${isUser ? '#3b82f6' : '#10b981'};">[ç¬¬${Math.floor(idx/2)+1}è½®] ${roleName}</div>`;
                            if (dialogue.latency) {
                                html += `<div style="font-size: 10px; color: var(--text-muted);">${(dialogue.latency * 1000).toFixed(0)}ms</div>`;
                            }
                            html += `</div>`;
                            html += `<div style="font-size: 13px; line-height: 1.8; color: var(--text-secondary); white-space: pre-wrap;">${dialogue.content || ''}</div>`;
                            html += `</div>`;
                        });
                    } else {
                        // å…¼å®¹æ—§æ ¼å¼
                        result.responses.forEach((response, idx) => {
                            html += `<div style="margin-bottom: 8px; padding: 8px; background: rgba(255, 255, 255, 0.05); border-radius: 4px;">`;
                            html += `<div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">ç¬¬${idx + 1}è½® (${(result.latencies[idx] * 1000).toFixed(0)}ms)</div>`;
                            html += `<div style="font-size: 13px; line-height: 1.6;">${response}</div>`;
                            html += `</div>`;
                        });
                    }
                    
                    html += `<div style="margin-top: 12px; padding: 8px; background: rgba(0, 0, 0, 0.2); border-radius: 4px; font-size: 12px; color: var(--text-muted);">`;
                    html += `ç»¼åˆè¯„åˆ†: <strong style="color: var(--accent-primary);">${((result.metrics.overall_score || 0) * 100).toFixed(1)}</strong> | `;
                    html += `æ­£ç¡®ç‡: ${((result.metrics.accuracy || 0) * 100).toFixed(1)}% | `;
                    html += `åˆè§„ç‡: ${((result.metrics.compliance_rate || 0) * 100).toFixed(1)}%`;
                    html += `</div>`;
                    html += `</div>`;
                });
                
                html += `</div>`;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        async function saveScript(modelId, testCaseId) {
            try {
                // ä»ç»“æœä¸­è·å–å¯¹è¯å†å²
                const resultsDiv = document.getElementById('evaluation-results');
                const result = window.lastEvaluationResults?.find(r => r.model_id === modelId && r.test_case_id === testCaseId);
                
                if (!result || !result.dialogue_history) {
                    alert('æœªæ‰¾åˆ°å¯¹è¯å†å²ï¼Œè¯·å…ˆå®Œæˆè¯„æµ‹');
                    return;
                }
                
                const scriptName = prompt('è¯·è¾“å…¥è¯æœ¯æ¨¡æ¿åç§°:', `${testCaseId}_${modelId}`);
                if (!scriptName) return;
                
                const response = await fetch(`${API_BASE}/api/evaluation/save-script`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model_id: modelId,
                        test_case_id: testCaseId,
                        dialogue_history: result.dialogue_history,
                        script_name: scriptName
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    alert(`âœ… è¯æœ¯æ¨¡æ¿å·²ä¿å­˜ï¼\nID: ${data.script.id}\nåç§°: ${data.script.name}`);
                } else {
                    alert('ä¿å­˜å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('ä¿å­˜è¯æœ¯å¤±è´¥:', error);
                alert('ä¿å­˜å¤±è´¥: ' + error.message);
            }
        }
        
        async function exportScript(modelId, testCaseId, format) {
            try {
                const result = window.lastEvaluationResults?.find(r => r.model_id === modelId && r.test_case_id === testCaseId);
                
                if (!result || !result.dialogue_history) {
                    alert('æœªæ‰¾åˆ°å¯¹è¯å†å²');
                    return;
                }
                
                // ä¸´æ—¶ä¿å­˜åå¯¼å‡º
                const saveResponse = await fetch(`${API_BASE}/api/evaluation/save-script`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model_id: modelId,
                        test_case_id: testCaseId,
                        dialogue_history: result.dialogue_history,
                        script_name: `export_${testCaseId}_${modelId}`
                    })
                });
                
                const saveData = await saveResponse.json();
                if (!saveData.success) {
                    alert('å¯¼å‡ºå¤±è´¥: ' + saveData.error);
                    return;
                }
                
                const exportResponse = await fetch(`${API_BASE}/api/evaluation/export-script`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        script_id: saveData.script.id,
                        format: format
                    })
                });
                
                const exportData = await exportResponse.json();
                if (exportData.success) {
                    // ä¸‹è½½æ–‡ä»¶
                    const blob = new Blob([exportData.content], { type: 'text/plain;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = exportData.filename || `script.${format}`;
                    a.click();
                    URL.revokeObjectURL(url);
                } else {
                    alert('å¯¼å‡ºå¤±è´¥: ' + exportData.error);
                }
            } catch (error) {
                console.error('å¯¼å‡ºå¤±è´¥:', error);
                alert('å¯¼å‡ºå¤±è´¥: ' + error.message);
            }
        }
        
        // AI Hub ç›¸å…³å‡½æ•°
        let currentHubTab = 'models';
        
        function switchHubTab(tabName) {
            currentHubTab = tabName;
            
            // æ›´æ–°æ ‡ç­¾æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.hub-tab-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.tab === tabName) {
                    btn.classList.add('active');
                }
            });
            
            // æ˜¾ç¤ºå¯¹åº”å†…å®¹
            document.querySelectorAll('.hub-tab-content').forEach(content => {
                content.style.display = 'none';
            });
            const targetContent = document.getElementById(`hub-tab-${tabName}`);
            if (targetContent) {
                targetContent.style.display = 'block';
            }
            
            // åŠ è½½å¯¹åº”æ•°æ®
            if (tabName === 'models') {
                loadHubModels();
            } else if (tabName === 'sensitive') {
                loadSensitiveWords();
            } else if (tabName === 'permissions') {
                loadPermissions();
            } else if (tabName === 'statistics') {
                loadStatistics();
            }
        }
        
        async function loadHubModels() {
            try {
                const response = await fetch(`${API_BASE}/api/models/list`);
                const data = await response.json();
                
                if (data.success) {
                    const container = document.getElementById('hub-model-list');
                    if (!container) return;
                    
                    let html = '';
                    data.models.forEach((model, index) => {
                        const modelId = model.id || 'æœªçŸ¥';
                        const modelType = (model.type && model.type.value) || model.type || 'æœªçŸ¥';
                        const config = model.config || {};
                        const provider = config.provider || modelType;
                        
                        html += `
                            <div class="model-list-item" 
                                 onclick="selectHubModel('${modelId}')" 
                                 id="model-item-${modelId}"
                                 style="padding: 12px; margin-bottom: 8px; background: var(--bg-secondary); border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 12px;">
                                <div style="font-size: 24px;">ğŸ¤–</div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">${modelId}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">${provider}</div>
                                </div>
                                <span style="padding: 4px 8px; background: rgba(16, 185, 129, 0.2); border-radius: 4px; font-size: 11px; color: #10b981;">${model.status || 'active'}</span>
                            </div>
                        `;
                    });
                    container.innerHTML = html || '<p style="color: var(--text-muted); padding: 20px; text-align: center;">æš‚æ— æ¨¡å‹</p>';
                }
            } catch (error) {
                console.error('åŠ è½½æ¨¡å‹åˆ—è¡¨å¤±è´¥:', error);
            }
        }
        
        async function selectHubModel(modelId) {
            try {
                // æ›´æ–°é€‰ä¸­çŠ¶æ€
                document.querySelectorAll('.model-list-item').forEach(item => {
                    item.style.borderColor = 'var(--border-color)';
                    item.style.background = 'var(--bg-secondary)';
                });
                const selectedItem = document.getElementById(`model-item-${modelId}`);
                if (selectedItem) {
                    selectedItem.style.borderColor = 'var(--accent-primary)';
                    selectedItem.style.background = 'rgba(59, 130, 246, 0.1)';
                }
                
                const response = await fetch(`${API_BASE}/api/hub/model/${modelId}`);
                const data = await response.json();
                
                if (data.success) {
                    const model = data.model;
                    const container = document.getElementById('hub-model-detail');
                    if (!container) return;
                    
                    // æ˜¾ç¤ºå¯ç¼–è¾‘çš„è¡¨å•
                    const html = `
                        <div style="padding: 20px;">
                            <h3 style="margin-bottom: 20px; color: var(--accent-primary);">${model.id}</h3>
                            
                            <form id="model-config-form" onsubmit="saveModelConfigInline(event, '${model.id}')">
                                <div class="model-config-section" style="margin-bottom: 24px;">
                                    <h4 style="margin-bottom: 16px; color: var(--accent-primary);">ğŸ”‘ API åŸºç¡€é…ç½®</h4>
                                    
                                    <div style="margin-bottom: 16px;">
                                        <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 500; color: var(--text-primary);">API Key <span style="color: #ef4444;">*</span></label>
                                        <input type="text" id="config-api-key" value="${model.api_key || ''}" 
                                               placeholder="sk-..." 
                                               style="width: 100%; padding: 10px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-family: monospace; font-size: 12px;"
                                               required>
                                        <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">è¯·è¾“å…¥çœŸå®çš„APIå¯†é’¥ï¼Œå°†å®‰å…¨ä¿å­˜åˆ°æœ¬åœ°æ–‡ä»¶</div>
                                    </div>
                                    
                                    <div style="margin-bottom: 16px;">
                                        <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 500; color: var(--text-primary);">Endpoint URL <span style="color: #ef4444;">*</span></label>
                                        <input type="url" id="config-endpoint" value="${model.endpoint || ''}" 
                                               placeholder="https://api.openai.com/v1/chat/completions" 
                                               style="width: 100%; padding: 10px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-family: monospace; font-size: 12px;"
                                               required>
                                    </div>
                                    
                                    <div style="margin-bottom: 16px;">
                                        <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 500; color: var(--text-primary);">æ¨¡å‹åç§°</label>
                                        <input type="text" id="config-model-name" value="${model.model_name || model.id}" 
                                               placeholder="æ¨¡å‹æ˜¾ç¤ºåç§°" 
                                               style="width: 100%; padding: 10px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 13px;">
                                    </div>
                                    
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                        <div>
                                            <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 500; color: var(--text-primary);">Temperature</label>
                                            <input type="number" id="config-temperature" value="${model.temperature || 0.7}" 
                                                   min="0" max="2" step="0.1"
                                                   style="width: 100%; padding: 10px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 13px;">
                                        </div>
                                        <div>
                                            <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 500; color: var(--text-primary);">Max Tokens</label>
                                            <input type="number" id="config-max-tokens" value="${model.max_tokens || ''}" 
                                                   min="1" step="1"
                                                   placeholder="ç•™ç©ºä¸ºé»˜è®¤"
                                                   style="width: 100%; padding: 10px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 13px;">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="model-config-section" style="margin-bottom: 24px;">
                                    <h4 style="margin-bottom: 16px; color: var(--accent-primary);">ğŸ“Š ä½¿ç”¨é™é¢</h4>
                                    
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                        <div>
                                            <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 500; color: var(--text-primary);">æ¯æ—¥é™é¢</label>
                                            <input type="number" id="config-daily-limit" value="${model.daily_limit || 10000}" 
                                                   min="0" step="1"
                                                   placeholder="ç•™ç©ºä¸ºæ— é™åˆ¶"
                                                   style="width: 100%; padding: 10px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 13px;">
                                        </div>
                                        <div>
                                            <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 500; color: var(--text-primary);">æ¯åˆ†é’Ÿé™é¢</label>
                                            <input type="number" id="config-rate-limit" value="${model.rate_limit || 60}" 
                                                   min="0" step="1"
                                                   placeholder="ç•™ç©ºä¸ºæ— é™åˆ¶"
                                                   style="width: 100%; padding: 10px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 13px;">
                                        </div>
                                    </div>
                                    <div style="margin-top: 12px; padding: 10px; background: rgba(59, 130, 246, 0.1); border-radius: 6px; font-size: 12px; color: var(--text-secondary);">
                                        å·²ä½¿ç”¨ï¼ˆä»Šæ—¥ï¼‰: <strong>${model.used_today || 0}</strong> / ${model.daily_limit || 'âˆ'}
                                    </div>
                                </div>
                                
                                <div class="model-config-section" style="margin-bottom: 24px;">
                                    <h4 style="margin-bottom: 16px; color: var(--accent-primary);">âš¡ ç†”æ–­ä¿æŠ¤</h4>
                                    
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                        <div>
                                            <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 500; color: var(--text-primary);">é”™è¯¯ç‡é˜ˆå€¼ (%)</label>
                                            <input type="number" id="config-error-rate" value="${model.circuit_breaker_error_rate || 0.5}" 
                                                   min="0" max="100" step="0.1"
                                                   style="width: 100%; padding: 10px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 13px;">
                                        </div>
                                        <div>
                                            <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 500; color: var(--text-primary);">å“åº”æ—¶é—´é˜ˆå€¼ (ms)</label>
                                            <input type="number" id="config-latency" value="${model.circuit_breaker_latency || 5000}" 
                                                   min="0" step="100"
                                                   style="width: 100%; padding: 10px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 13px;">
                                        </div>
                                    </div>
                                    <div style="margin-top: 12px; padding: 10px; background: ${model.circuit_breaker_open ? 'rgba(239, 68, 68, 0.1)' : 'rgba(16, 185, 129, 0.1)'}; border-radius: 6px; font-size: 12px; color: ${model.circuit_breaker_open ? '#ef4444' : '#10b981'};">
                                        ç†”æ–­çŠ¶æ€: <strong>${model.circuit_breaker_open ? 'å·²ç†”æ–­' : 'æ­£å¸¸'}</strong>
                                    </div>
                                </div>
                                
                                <div class="model-config-section" style="margin-bottom: 24px;">
                                    <h4 style="margin-bottom: 16px; color: var(--accent-primary);">ğŸš« æ•æ„Ÿè¯è¿‡æ»¤</h4>
                                    
                                    <div style="margin-bottom: 12px;">
                                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                            <input type="checkbox" id="config-sensitive-filter" ${model.sensitive_filter_enabled ? 'checked' : ''} 
                                                   style="width: 18px; height: 18px; cursor: pointer;">
                                            <span style="font-size: 13px; color: var(--text-primary);">å¯ç”¨æ•æ„Ÿè¯è¿‡æ»¤</span>
                                        </label>
                                    </div>
                                    
                                    <div>
                                        <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 500; color: var(--text-primary);">è¿‡æ»¤æ¨¡å¼</label>
                                        <select id="config-filter-mode" style="width: 100%; padding: 10px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 13px;">
                                            <option value="replace" ${model.filter_mode === 'replace' ? 'selected' : ''}>æ›¿æ¢ä¸º***</option>
                                            <option value="block" ${model.filter_mode === 'block' ? 'selected' : ''}>ç›´æ¥æ‹¦æˆª</option>
                                            <option value="warn" ${model.filter_mode === 'warn' ? 'selected' : ''}>è­¦å‘Šæç¤º</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div style="display: flex; gap: 8px; margin-top: 24px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                                    <button type="submit" style="flex: 1; padding: 12px; background: var(--accent-primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 14px;">ğŸ’¾ ä¿å­˜é…ç½®</button>
                                    <button type="button" onclick="testModel('${model.id}')" style="flex: 1; padding: 12px; background: rgba(59, 130, 246, 0.1); color: #3b82f6; border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 14px;">ğŸ”Œ æµ‹è¯•è¿æ¥</button>
                                </div>
                            </form>
                        </div>
                    `;
                    container.innerHTML = html;
                }
            } catch (error) {
                console.error('åŠ è½½æ¨¡å‹è¯¦æƒ…å¤±è´¥:', error);
                const container = document.getElementById('hub-model-detail');
                if (container) {
                    container.innerHTML = `<div style="padding: 20px; color: var(--accent-danger);">åŠ è½½å¤±è´¥: ${error.message}</div>`;
                }
            }
        }
        
        function saveModelConfigInline(event, modelId) {
            event.preventDefault();
            
            const formData = {
                api_key: document.getElementById('config-api-key').value.trim(),
                endpoint: document.getElementById('config-endpoint').value.trim(),
                model_name: document.getElementById('config-model-name').value.trim(),
                temperature: parseFloat(document.getElementById('config-temperature').value) || 0.7,
                max_tokens: document.getElementById('config-max-tokens').value ? parseInt(document.getElementById('config-max-tokens').value) : null,
                daily_limit: document.getElementById('config-daily-limit').value ? parseInt(document.getElementById('config-daily-limit').value) : null,
                rate_limit: document.getElementById('config-rate-limit').value ? parseInt(document.getElementById('config-rate-limit').value) : null,
                circuit_breaker_error_rate: parseFloat(document.getElementById('config-error-rate').value) || 0.5,
                circuit_breaker_latency: parseInt(document.getElementById('config-latency').value) || 5000,
                sensitive_filter_enabled: document.getElementById('config-sensitive-filter').checked,
                filter_mode: document.getElementById('config-filter-mode').value
            };
            
            // éªŒè¯å¿…å¡«é¡¹
            if (!formData.api_key) {
                alert('âš ï¸ API Key ä¸èƒ½ä¸ºç©ºï¼');
                return;
            }
            if (!formData.endpoint) {
                alert('âš ï¸ Endpoint URL ä¸èƒ½ä¸ºç©ºï¼');
                return;
            }
            
            // æ˜¾ç¤ºä¿å­˜ä¸­çŠ¶æ€
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'ğŸ’¾ ä¿å­˜ä¸­...';
            submitBtn.disabled = true;
            
            // æ›´æ–°é…ç½®
            fetch(`${API_BASE}/api/hub/model/${modelId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            })
            .then(res => res.json())
            .then(updateData => {
                if (updateData.success) {
                    alert('âœ… é…ç½®æ›´æ–°æˆåŠŸå¹¶å·²ä¿å­˜åˆ°æœ¬åœ°æ–‡ä»¶ï¼');
                    selectHubModel(modelId); // åˆ·æ–°æ˜¾ç¤º
                } else {
                    alert('âŒ æ›´æ–°å¤±è´¥: ' + updateData.error);
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            })
            .catch(error => {
                console.error('æ›´æ–°é…ç½®å¤±è´¥:', error);
                alert('âŒ æ›´æ–°å¤±è´¥: ' + error.message);
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            });
        }
        
        async function loadSensitiveWords() {
            try {
                const response = await fetch(`${API_BASE}/api/hub/sensitive-words`);
                const data = await response.json();
                
                if (data.success) {
                    const container = document.getElementById('hub-sensitive-words');
                    if (!container) return;
                    
                    let html = '<div style="margin-bottom: 20px;">';
                    if (data.words && data.words.length > 0) {
                        data.words.forEach(word => {
                            html += `
                                <span class="sensitive-word-item">
                                    ${word.word}
                                    <span class="delete-btn" onclick="deleteSensitiveWord('${word.id}')">Ã—</span>
                                </span>
                            `;
                        });
                    } else {
                        html += '<p style="color: var(--text-muted);">æš‚æ— æ•æ„Ÿè¯</p>';
                    }
                    html += '</div>';
                    container.innerHTML = html;
                }
            } catch (error) {
                console.error('åŠ è½½æ•æ„Ÿè¯å¤±è´¥:', error);
                const container = document.getElementById('hub-sensitive-words');
                if (container) {
                    container.innerHTML = `<div style="color: var(--accent-danger);">åŠ è½½å¤±è´¥: ${error.message}</div>`;
                }
            }
        }
        
        async function loadPermissions() {
            try {
                // åŠ è½½ç”¨æˆ·åˆ—è¡¨
                const userResponse = await fetch(`${API_BASE}/api/hub/users`);
                const userData = await userResponse.json();
                
                const userContainer = document.getElementById('hub-user-permissions');
                if (userContainer && userData.success) {
                    let html = '<div style="margin-bottom: 20px;">';
                    html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">';
                    html += '<h4 style="margin: 0; font-size: 14px; color: var(--accent-primary);">ç”¨æˆ·åˆ—è¡¨</h4>';
                    html += '<button onclick="showAddUserModal()" style="padding: 6px 12px; background: var(--accent-primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">+ æ·»åŠ ç”¨æˆ·</button>';
                    html += '</div>';
                    
                    if (userData.users && userData.users.length > 0) {
                        userData.users.forEach(user => {
                            html += `
                                <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 8px; border: 1px solid var(--border-color);">
                                    <div style="display: flex; justify-content: space-between; align-items: start;">
                                        <div style="flex: 1;">
                                            <div style="font-weight: 600; font-size: 14px; margin-bottom: 4px;">${user.username}</div>
                                            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">${user.email}</div>
                                            <div style="display: flex; gap: 8px; margin-top: 8px;">
                                                <span style="padding: 2px 8px; background: rgba(59, 130, 246, 0.1); border-radius: 4px; font-size: 11px; color: #3b82f6;">${user.role}</span>
                                                <span style="font-size: 11px; color: var(--text-muted);">æœ€åç™»å½•: ${user.last_login || 'ä»æœª'}</span>
                                            </div>
                                        </div>
                                        <button onclick="editUser('${user.id}')" style="padding: 4px 8px; background: rgba(59, 130, 246, 0.1); color: #3b82f6; border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 4px; cursor: pointer; font-size: 11px;">ç¼–è¾‘</button>
                                    </div>
                                </div>
                            `;
                        });
                    } else {
                        html += '<p style="color: var(--text-muted);">æš‚æ— ç”¨æˆ·</p>';
                    }
                    html += '</div>';
                    userContainer.innerHTML = html;
                }
                
                // åŠ è½½è§’è‰²åˆ—è¡¨
                const roleResponse = await fetch(`${API_BASE}/api/hub/roles`);
                const roleData = await roleResponse.json();
                
                const roleContainer = document.getElementById('hub-roles');
                if (roleContainer && roleData.success) {
                    let html = '<div style="margin-bottom: 20px;">';
                    html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">';
                    html += '<h4 style="margin: 0; font-size: 14px; color: var(--accent-primary);">è§’è‰²åˆ—è¡¨</h4>';
                    html += '<button onclick="showAddRoleModal()" style="padding: 6px 12px; background: var(--accent-primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">+ æ·»åŠ è§’è‰²</button>';
                    html += '</div>';
                    
                    if (roleData.roles && roleData.roles.length > 0) {
                        roleData.roles.forEach(role => {
                            html += `
                                <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 8px; border: 1px solid var(--border-color);">
                                    <div style="display: flex; justify-content: space-between; align-items: start;">
                                        <div style="flex: 1;">
                                            <div style="font-weight: 600; font-size: 14px; margin-bottom: 4px;">${role.name}</div>
                                            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">${role.description}</div>
                                            <div style="display: flex; gap: 4px; flex-wrap: wrap; margin-top: 8px;">
                                                ${role.permissions.map(p => `<span style="padding: 2px 6px; background: rgba(16, 185, 129, 0.1); border-radius: 4px; font-size: 10px; color: #10b981;">${p}</span>`).join('')}
                                            </div>
                                            <div style="font-size: 11px; color: var(--text-muted); margin-top: 8px;">ç”¨æˆ·æ•°: ${role.user_count}</div>
                                        </div>
                                        <button onclick="editRole('${role.id}')" style="padding: 4px 8px; background: rgba(59, 130, 246, 0.1); color: #3b82f6; border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 4px; cursor: pointer; font-size: 11px;">ç¼–è¾‘</button>
                                    </div>
                                </div>
                            `;
                        });
                    } else {
                        html += '<p style="color: var(--text-muted);">æš‚æ— è§’è‰²</p>';
                    }
                    html += '</div>';
                    roleContainer.innerHTML = html;
                }
            } catch (error) {
                console.error('åŠ è½½æƒé™æ•°æ®å¤±è´¥:', error);
                const userContainer = document.getElementById('hub-user-permissions');
                const roleContainer = document.getElementById('hub-roles');
                if (userContainer) {
                    userContainer.innerHTML = `<div style="color: var(--accent-danger);">åŠ è½½å¤±è´¥: ${error.message}</div>`;
                }
                if (roleContainer) {
                    roleContainer.innerHTML = `<div style="color: var(--accent-danger);">åŠ è½½å¤±è´¥: ${error.message}</div>`;
                }
            }
        }
        
        function showAddUserModal() {
            const username = prompt('è¯·è¾“å…¥ç”¨æˆ·å:');
            if (username && username.trim()) {
                const email = prompt('è¯·è¾“å…¥é‚®ç®±:');
                if (email && email.trim()) {
                    const role = prompt('è¯·è¾“å…¥è§’è‰² (admin/analyst/viewer/operator):', 'viewer');
                    if (role) {
                        alert('âœ… ç”¨æˆ·æ·»åŠ æˆåŠŸï¼\nï¼ˆå®é™…åº”ç”¨ä¸­éœ€è¦è°ƒç”¨åç«¯APIä¿å­˜ï¼‰');
                        loadPermissions();
                    }
                }
            }
        }
        
        function editUser(userId) {
            alert(`ç¼–è¾‘ç”¨æˆ· ${userId}\nï¼ˆå®é™…åº”ç”¨ä¸­æ‰“å¼€ç¼–è¾‘è¡¨å•ï¼‰`);
        }
        
        function showAddRoleModal() {
            const name = prompt('è¯·è¾“å…¥è§’è‰²åç§°:');
            if (name && name.trim()) {
                const description = prompt('è¯·è¾“å…¥è§’è‰²æè¿°:');
                if (description) {
                    alert('âœ… è§’è‰²æ·»åŠ æˆåŠŸï¼\nï¼ˆå®é™…åº”ç”¨ä¸­éœ€è¦è°ƒç”¨åç«¯APIä¿å­˜ï¼‰');
                    loadPermissions();
                }
            }
        }
        
        function editRole(roleId) {
            alert(`ç¼–è¾‘è§’è‰² ${roleId}\nï¼ˆå®é™…åº”ç”¨ä¸­æ‰“å¼€ç¼–è¾‘è¡¨å•ï¼‰`);
        }
        
        async function loadStatistics() {
            try {
                const response = await fetch(`${API_BASE}/api/hub/statistics`);
                const data = await response.json();
                
                if (data.success) {
                    // è°ƒç”¨ç»Ÿè®¡
                    const callContainer = document.getElementById('hub-call-stats');
                    if (callContainer) {
                        callContainer.innerHTML = `
                            <div style="text-align: center;">
                                <div style="font-size: 32px; font-weight: bold; color: var(--accent-primary); margin-bottom: 8px;">${(data.call_stats.total || 0).toLocaleString()}</div>
                                <div style="font-size: 12px; color: var(--text-muted);">æ€»è°ƒç”¨æ¬¡æ•°</div>
                                <div style="margin-top: 16px; font-size: 13px; color: var(--text-secondary); text-align: left; padding: 0 20px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                        <span>ä»Šæ—¥:</span>
                                        <span style="font-weight: 600;">${(data.call_stats.today || 0).toLocaleString()}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                        <span>æœ¬å‘¨:</span>
                                        <span style="font-weight: 600;">${(data.call_stats.week || 0).toLocaleString()}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span>æœ¬æœˆ:</span>
                                        <span style="font-weight: 600;">${(data.call_stats.month || 0).toLocaleString()}</span>
                                    </div>
                                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color);">
                                        <button onclick="showStatisticsDrillDown('calls')" style="width: 100%; padding: 8px; background: rgba(59, 130, 246, 0.1); color: #3b82f6; border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 500;">ğŸ“Š æŸ¥çœ‹è¯¦æƒ…</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    // æˆæœ¬ç»Ÿè®¡
                    const costContainer = document.getElementById('hub-cost-stats');
                    if (costContainer) {
                        costContainer.innerHTML = `
                            <div style="text-align: center;">
                                <div style="font-size: 32px; font-weight: bold; color: var(--accent-primary); margin-bottom: 8px;">Â¥${(data.cost_stats.total || 0).toFixed(2)}</div>
                                <div style="font-size: 12px; color: var(--text-muted);">æ€»æˆæœ¬</div>
                                <div style="margin-top: 16px; font-size: 13px; color: var(--text-secondary); text-align: left; padding: 0 20px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                        <span>ä»Šæ—¥:</span>
                                        <span style="font-weight: 600;">Â¥${(data.cost_stats.today || 0).toFixed(2)}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                        <span>æœ¬æœˆ:</span>
                                        <span style="font-weight: 600;">Â¥${(data.cost_stats.month || 0).toFixed(2)}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px; padding-top: 8px; border-top: 1px solid var(--border-color);">
                                        <span style="font-size: 11px; color: var(--text-muted);">å¹³å‡æ¯æ¬¡:</span>
                                        <span style="font-size: 11px; font-weight: 600;">Â¥${(data.cost_stats.avg_per_call || 0).toFixed(4)}</span>
                                    </div>
                                    <div style="margin-top: 12px;">
                                        <button onclick="showStatisticsDrillDown('costs')" style="width: 100%; padding: 8px; background: rgba(59, 130, 246, 0.1); color: #3b82f6; border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 500;">ğŸ“Š æŸ¥çœ‹è¯¦æƒ…</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    // å¼‚å¸¸ç»Ÿè®¡
                    const errorContainer = document.getElementById('hub-error-stats');
                    if (errorContainer) {
                        errorContainer.innerHTML = `
                            <div style="text-align: center;">
                                <div style="font-size: 32px; font-weight: bold; color: ${(data.error_stats.total || 0) > 0 ? '#ef4444' : '#10b981'}; margin-bottom: 8px;">${data.error_stats.total || 0}</div>
                                <div style="font-size: 12px; color: var(--text-muted);">å¼‚å¸¸æ¬¡æ•°</div>
                                <div style="margin-top: 16px; font-size: 13px; color: var(--text-secondary); text-align: left; padding: 0 20px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                        <span>é”™è¯¯ç‡:</span>
                                        <span style="font-weight: 600; color: ${((data.error_stats.rate || 0) * 100) > 5 ? '#ef4444' : '#10b981'};">${((data.error_stats.rate || 0) * 100).toFixed(2)}%</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                        <span>ç†”æ–­æ¬¡æ•°:</span>
                                        <span style="font-weight: 600;">${data.error_stats.circuit_breaker || 0}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px; padding-top: 8px; border-top: 1px solid var(--border-color);">
                                        <span style="font-size: 11px; color: var(--text-muted);">å¹³å‡å»¶è¿Ÿ:</span>
                                        <span style="font-size: 11px; font-weight: 600;">${(data.error_stats.avg_error_latency || 0).toFixed(1)}s</span>
                                    </div>
                                    <div style="margin-top: 12px;">
                                        <button onclick="showStatisticsDrillDown('errors')" style="width: 100%; padding: 8px; background: rgba(59, 130, 246, 0.1); color: #3b82f6; border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 500;">ğŸ“Š æŸ¥çœ‹è¯¦æƒ…</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    // ä¿å­˜ç»Ÿè®¡æ•°æ®ä¾›ä¸‹é’»ä½¿ç”¨
                    window.statisticsData = data;
                }
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥:', error);
                const containers = ['hub-call-stats', 'hub-cost-stats', 'hub-error-stats'];
                containers.forEach(id => {
                    const container = document.getElementById(id);
                    if (container) {
                        container.innerHTML = `<div style="color: var(--accent-danger); text-align: center; padding: 20px;">åŠ è½½å¤±è´¥: ${error.message}</div>`;
                    }
                });
            }
        }
        
        function showAddModelModal() {
            // åˆ›å»ºæ·»åŠ æ¨¡å‹æ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.id = 'add-model-modal';
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 700px;">
                    <div class="modal-header">
                        <h3>â• æ·»åŠ æ–°æ¨¡å‹</h3>
                        <button class="modal-close" onclick="closeAddModelModal()">Ã—</button>
                    </div>
                    <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                        <form id="add-model-form" onsubmit="addModel(event)">
                            <div class="model-config-section" style="margin-bottom: 20px;">
                                <h4 style="margin-bottom: 16px; color: var(--accent-primary);">ğŸ“ åŸºæœ¬ä¿¡æ¯</h4>
                                
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 500; color: var(--text-primary);">æ¨¡å‹ID <span style="color: #ef4444;">*</span></label>
                                    <input type="text" id="add-model-id" 
                                           placeholder="ä¾‹å¦‚: my-custom-model" 
                                           style="width: 100%; padding: 10px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 13px;"
                                           required>
                                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">æ¨¡å‹çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œåªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿å’Œè¿å­—ç¬¦</div>
                                </div>
                                
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 500; color: var(--text-primary);">æ¨¡å‹ç±»å‹ <span style="color: #ef4444;">*</span></label>
                                    <select id="add-model-type" style="width: 100%; padding: 10px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 13px;" required>
                                        <option value="openai">OpenAI å…¼å®¹</option>
                                        <option value="anthropic">Anthropic</option>
                                        <option value="local_llm">æœ¬åœ°æ¨¡å‹ (Local LLM)</option>
                                        <option value="rag">RAG åº”ç”¨</option>
                                        <option value="agent">æ™ºèƒ½ä»£ç† (Agent)</option>
                                    </select>
                                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">é€‰æ‹©æ¨¡å‹çš„æ¥å£ç±»å‹</div>
                                </div>
                                
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 500; color: var(--text-primary);">æä¾›å•†åç§°</label>
                                    <input type="text" id="add-provider" 
                                           placeholder="ä¾‹å¦‚: Customã€OpenAIã€Anthropic" 
                                           style="width: 100%; padding: 10px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 13px;">
                                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">æ¨¡å‹æä¾›å•†çš„åç§°</div>
                                </div>
                            </div>
                            
                            <div class="model-config-section" style="margin-bottom: 20px;">
                                <h4 style="margin-bottom: 16px; color: var(--accent-primary);">ğŸ”‘ API é…ç½®</h4>
                                
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 500; color: var(--text-primary);">API Key</label>
                                    <input type="text" id="add-api-key" 
                                           placeholder="sk-... (å¯é€‰ï¼Œç•™ç©ºå°†ä½¿ç”¨demo-key)" 
                                           style="width: 100%; padding: 10px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-family: monospace; font-size: 12px;">
                                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">APIå¯†é’¥ï¼Œç•™ç©ºå°†ä½¿ç”¨demo-key</div>
                                </div>
                                
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 500; color: var(--text-primary);">Endpoint URL <span style="color: #ef4444;">*</span></label>
                                    <input type="url" id="add-endpoint" 
                                           placeholder="https://api.example.com/v1/chat/completions" 
                                           style="width: 100%; padding: 10px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-family: monospace; font-size: 12px;"
                                           required>
                                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">æ¨¡å‹çš„APIç«¯ç‚¹åœ°å€</div>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 500; color: var(--text-primary);">Temperature</label>
                                        <input type="number" id="add-temperature" value="0.7" 
                                               min="0" max="2" step="0.1"
                                               style="width: 100%; padding: 10px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 13px;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 500; color: var(--text-primary);">Max Tokens</label>
                                        <input type="number" id="add-max-tokens" 
                                               min="1" step="1"
                                               placeholder="ç•™ç©ºä¸ºé»˜è®¤"
                                               style="width: 100%; padding: 10px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 13px;">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="model-config-section" style="margin-bottom: 20px;">
                                <h4 style="margin-bottom: 16px; color: var(--accent-primary);">ğŸ“Š ä½¿ç”¨é™é¢ï¼ˆå¯é€‰ï¼‰</h4>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 500; color: var(--text-primary);">æ¯æ—¥é™é¢</label>
                                        <input type="number" id="add-daily-limit" value="10000" 
                                               min="0" step="1"
                                               placeholder="ç•™ç©ºä¸ºæ— é™åˆ¶"
                                               style="width: 100%; padding: 10px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 13px;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 500; color: var(--text-primary);">æ¯åˆ†é’Ÿé™é¢</label>
                                        <input type="number" id="add-rate-limit" value="60" 
                                               min="0" step="1"
                                               placeholder="ç•™ç©ºä¸ºæ— é™åˆ¶"
                                               style="width: 100%; padding: 10px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 13px;">
                                    </div>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 8px; margin-top: 24px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                                <button type="submit" style="flex: 1; padding: 12px; background: var(--accent-primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 14px;">âœ… æ·»åŠ æ¨¡å‹</button>
                                <button type="button" onclick="closeAddModelModal()" style="flex: 1; padding: 12px; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 14px;">å–æ¶ˆ</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeAddModelModal();
                }
            });
        }
        
        function closeAddModelModal() {
            const modal = document.getElementById('add-model-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        function addModel(event) {
            event.preventDefault();
            
            const modelId = document.getElementById('add-model-id').value.trim();
            const modelType = document.getElementById('add-model-type').value;
            const provider = document.getElementById('add-provider').value.trim() || 'Custom';
            const apiKey = document.getElementById('add-api-key').value.trim();
            const endpoint = document.getElementById('add-endpoint').value.trim();
            const temperature = parseFloat(document.getElementById('add-temperature').value) || 0.7;
            const maxTokens = document.getElementById('add-max-tokens').value ? parseInt(document.getElementById('add-max-tokens').value) : null;
            const dailyLimit = document.getElementById('add-daily-limit').value ? parseInt(document.getElementById('add-daily-limit').value) : null;
            const rateLimit = document.getElementById('add-rate-limit').value ? parseInt(document.getElementById('add-rate-limit').value) : null;
            
            // éªŒè¯å¿…å¡«é¡¹
            if (!modelId) {
                alert('âš ï¸ æ¨¡å‹IDä¸èƒ½ä¸ºç©ºï¼');
                return;
            }
            if (!endpoint) {
                alert('âš ï¸ Endpoint URLä¸èƒ½ä¸ºç©ºï¼');
                return;
            }
            
            // éªŒè¯æ¨¡å‹IDæ ¼å¼ï¼ˆåªå…è®¸å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ã€è¿å­—ç¬¦ï¼‰
            if (!/^[a-zA-Z0-9_-]+$/.test(modelId)) {
                alert('âš ï¸ æ¨¡å‹IDåªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿å’Œè¿å­—ç¬¦ï¼');
                return;
            }
            
            // æ˜¾ç¤ºæ·»åŠ ä¸­çŠ¶æ€
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'â³ æ·»åŠ ä¸­...';
            submitBtn.disabled = true;
            
            // è°ƒç”¨APIæ³¨å†Œæ¨¡å‹
            fetch(`${API_BASE}/api/models/register`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model_id: modelId,
                    model_type: modelType,
                    config: {
                        model_name: modelId,
                        api_key: apiKey || 'demo-key',
                        endpoint: endpoint,
                        provider: provider,
                        temperature: temperature,
                        max_tokens: maxTokens,
                        daily_limit: dailyLimit,
                        rate_limit: rateLimit,
                        features: []
                    }
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert('âœ… æ¨¡å‹æ·»åŠ æˆåŠŸå¹¶å·²ä¿å­˜ï¼');
                    closeAddModelModal();
                    loadHubModels(); // åˆ·æ–°æ¨¡å‹åˆ—è¡¨
                } else {
                    alert('âŒ æ·»åŠ å¤±è´¥: ' + data.error);
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            })
            .catch(error => {
                console.error('æ·»åŠ æ¨¡å‹å¤±è´¥:', error);
                alert('âŒ æ·»åŠ å¤±è´¥: ' + error.message);
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            });
        }
        
        // ç»Ÿè®¡ä¸‹é’»åŠŸèƒ½
        async function showStatisticsDrillDown(type) {
            try {
                // è·å–ä¸‹é’»æ•°æ®
                const response = await fetch(`${API_BASE}/api/hub/statistics/drilldown?type=${type}`);
                const data = await response.json();
                
                if (!data.success) {
                    alert('åŠ è½½ä¸‹é’»æ•°æ®å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                    return;
                }
                
                // åˆ›å»ºæˆ–æ˜¾ç¤ºæ¨¡æ€æ¡†
                let modal = document.getElementById('statistics-drilldown-modal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'statistics-drilldown-modal';
                    modal.className = 'modal';
                    modal.innerHTML = `
                        <div class="modal-content" style="max-width: 1000px; max-height: 90vh;">
                            <div class="modal-header">
                                <h3 id="drilldown-modal-title">ğŸ“Š ç»Ÿè®¡è¯¦æƒ…</h3>
                                <button class="modal-close" onclick="closeStatisticsDrillDown()">Ã—</button>
                            </div>
                            <div class="modal-body" style="max-height: calc(90vh - 100px); overflow-y: auto;">
                                <div style="display: flex; gap: 8px; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 12px;">
                                    <button class="drilldown-tab-btn active" onclick="switchDrilldownTab('department')" data-tab="department">æŒ‰éƒ¨é—¨</button>
                                    <button class="drilldown-tab-btn" onclick="switchDrilldownTab('user')" data-tab="user">æŒ‰äººå‘˜</button>
                                    <button class="drilldown-tab-btn" onclick="switchDrilldownTab('model')" data-tab="model">æŒ‰æ¨¡å‹</button>
                                    <button class="drilldown-tab-btn" onclick="switchDrilldownTab('time')" data-tab="time">æŒ‰æ—¶é—´è¶‹åŠ¿</button>
                                </div>
                                <div id="drilldown-content"></div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                    
                    // ç‚¹å‡»èƒŒæ™¯å…³é—­
                    modal.addEventListener('click', function(e) {
                        if (e.target === modal) {
                            closeStatisticsDrillDown();
                        }
                    });
                }
                
                // è®¾ç½®æ ‡é¢˜
                const titles = {
                    'calls': 'è°ƒç”¨ç»Ÿè®¡è¯¦æƒ…',
                    'costs': 'æˆæœ¬ç»Ÿè®¡è¯¦æƒ…',
                    'errors': 'å¼‚å¸¸ç›‘æ§è¯¦æƒ…'
                };
                document.getElementById('drilldown-modal-title').textContent = `ğŸ“Š ${titles[type] || 'ç»Ÿè®¡è¯¦æƒ…'}`;
                
                // æ˜¾ç¤ºæ¨¡æ€æ¡†
                modal.style.display = 'flex';
                
                // ä¿å­˜å½“å‰ç±»å‹å’Œæ•°æ®
                window.currentDrilldownType = type;
                window.drilldownData = data;
                
                // é»˜è®¤æ˜¾ç¤ºæŒ‰éƒ¨é—¨
                switchDrilldownTab('department');
                
            } catch (error) {
                console.error('åŠ è½½ä¸‹é’»æ•°æ®å¤±è´¥:', error);
                alert('åŠ è½½ä¸‹é’»æ•°æ®å¤±è´¥: ' + error.message);
            }
        }
        
        function switchDrilldownTab(tabName) {
            // æ›´æ–°æ ‡ç­¾æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.drilldown-tab-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.tab === tabName) {
                    btn.classList.add('active');
                }
            });
            
            const type = window.currentDrilldownType;
            const data = window.drilldownData;
            
            if (!data || !data.success) return;
            
            const container = document.getElementById('drilldown-content');
            let html = '';
            
            if (tabName === 'department') {
                html = renderDepartmentRank(data.department_rank || [], type);
            } else if (tabName === 'user') {
                html = renderUserRank(data.user_rank || [], type);
            } else if (tabName === 'model') {
                html = renderModelRank(data.model_rank || [], type);
            } else if (tabName === 'time') {
                html = renderTimeTrend(data.time_trend || [], type);
            }
            
            container.innerHTML = html;
        }
        
        function renderDepartmentRank(ranks, type) {
            if (!ranks || ranks.length === 0) {
                return '<p style="text-align: center; color: var(--text-muted); padding: 40px;">æš‚æ— æ•°æ®</p>';
            }
            
            let html = '<div style="margin-bottom: 20px;"><h4 style="margin-bottom: 12px; color: var(--accent-primary);">ğŸ¢ éƒ¨é—¨æ’å (Top 10)</h4>';
            html += '<table class="data-table" style="width: 100%;">';
            html += '<thead><tr><th>æ’å</th><th>éƒ¨é—¨</th><th>è°ƒç”¨æ¬¡æ•°</th><th>å æ¯”</th></tr></thead><tbody>';
            
            ranks.slice(0, 10).forEach((item, index) => {
                const pct = item.total > 0 ? ((item.count / item.total) * 100).toFixed(2) : '0.00';
                html += `<tr>
                    <td style="text-align: center; font-weight: 600;">${index + 1}</td>
                    <td>${item.department || 'æœªçŸ¥'}</td>
                    <td style="text-align: right; font-family: monospace;">${(item.count || 0).toLocaleString()}</td>
                    <td style="text-align: right; font-family: monospace;">${pct}%</td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            return html;
        }
        
        function renderUserRank(ranks, type) {
            if (!ranks || ranks.length === 0) {
                return '<p style="text-align: center; color: var(--text-muted); padding: 40px;">æš‚æ— æ•°æ®</p>';
            }
            
            let html = '<div style="margin-bottom: 20px;"><h4 style="margin-bottom: 12px; color: var(--accent-primary);">ğŸ‘¤ äººå‘˜æ’å (Top 10)</h4>';
            html += '<table class="data-table" style="width: 100%;">';
            html += '<thead><tr><th>æ’å</th><th>ç”¨æˆ·å</th><th>éƒ¨é—¨</th><th>è°ƒç”¨æ¬¡æ•°</th><th>å æ¯”</th></tr></thead><tbody>';
            
            ranks.slice(0, 10).forEach((item, index) => {
                const pct = item.total > 0 ? ((item.count / item.total) * 100).toFixed(2) : '0.00';
                html += `<tr>
                    <td style="text-align: center; font-weight: 600;">${index + 1}</td>
                    <td>${item.username || 'æœªçŸ¥'}</td>
                    <td>${item.department || '-'}</td>
                    <td style="text-align: right; font-family: monospace;">${(item.count || 0).toLocaleString()}</td>
                    <td style="text-align: right; font-family: monospace;">${pct}%</td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            return html;
        }
        
        function renderModelRank(ranks, type) {
            if (!ranks || ranks.length === 0) {
                return '<p style="text-align: center; color: var(--text-muted); padding: 40px;">æš‚æ— æ•°æ®</p>';
            }
            
            let html = '<div style="margin-bottom: 20px;"><h4 style="margin-bottom: 12px; color: var(--accent-primary);">ğŸ¤– æ¨¡å‹æ’å (Top 10)</h4>';
            html += '<table class="data-table" style="width: 100%;">';
            html += '<thead><tr><th>æ’å</th><th>æ¨¡å‹ID</th><th>è°ƒç”¨æ¬¡æ•°</th><th>å æ¯”</th></tr></thead><tbody>';
            
            ranks.slice(0, 10).forEach((item, index) => {
                const pct = item.total > 0 ? ((item.count / item.total) * 100).toFixed(2) : '0.00';
                html += `<tr>
                    <td style="text-align: center; font-weight: 600;">${index + 1}</td>
                    <td>${item.model_id || 'æœªçŸ¥'}</td>
                    <td style="text-align: right; font-family: monospace;">${(item.count || 0).toLocaleString()}</td>
                    <td style="text-align: right; font-family: monospace;">${pct}%</td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            return html;
        }
        
        function renderTimeTrend(trends, type) {
            if (!trends || trends.length === 0) {
                return '<p style="text-align: center; color: var(--text-muted); padding: 40px;">æš‚æ— æ•°æ®</p>';
            }
            
            let html = '<div style="margin-bottom: 20px;"><h4 style="margin-bottom: 12px; color: var(--accent-primary);">ğŸ“ˆ æ—¶é—´è¶‹åŠ¿ (æœ€è¿‘7å¤©)</h4>';
            html += '<table class="data-table" style="width: 100%;">';
            html += '<thead><tr><th>æ—¥æœŸ</th><th>è°ƒç”¨æ¬¡æ•°</th><th>è¶‹åŠ¿</th></tr></thead><tbody>';
            
            trends.forEach((item, index) => {
                const trend = index > 0 && trends[index - 1].count ? 
                    ((item.count - trends[index - 1].count) / trends[index - 1].count * 100).toFixed(1) : '-';
                const trendIcon = trend !== '-' ? (parseFloat(trend) > 0 ? 'â†‘' : 'â†“') : '';
                const trendColor = trend !== '-' ? (parseFloat(trend) > 0 ? '#10b981' : '#ef4444') : 'var(--text-muted)';
                
                html += `<tr>
                    <td>${item.date || '-'}</td>
                    <td style="text-align: right; font-family: monospace;">${(item.count || 0).toLocaleString()}</td>
                    <td style="text-align: right; color: ${trendColor};">${trendIcon} ${trend !== '-' ? trend + '%' : '-'}</td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            return html;
        }
        
        function closeStatisticsDrillDown() {
            const modal = document.getElementById('statistics-drilldown-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        function showAddSensitiveWordModal() {
            const word = prompt('è¯·è¾“å…¥æ•æ„Ÿè¯:');
            if (word && word.trim()) {
                addSensitiveWord(word.trim());
            }
        }
        
        async function addSensitiveWord(word) {
            try {
                const response = await fetch(`${API_BASE}/api/hub/sensitive-words`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ word: word, category: 'é€šç”¨' })
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('âœ… æ•æ„Ÿè¯æ·»åŠ æˆåŠŸï¼');
                    loadSensitiveWords();
                } else {
                    alert('æ·»åŠ å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('æ·»åŠ æ•æ„Ÿè¯å¤±è´¥:', error);
                alert('æ·»åŠ å¤±è´¥: ' + error.message);
            }
        }
        
        async function deleteSensitiveWord(wordId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ•æ„Ÿè¯å—ï¼Ÿ')) return;
            
            try {
                const response = await fetch(`${API_BASE}/api/hub/sensitive-words/${wordId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('âœ… æ•æ„Ÿè¯åˆ é™¤æˆåŠŸï¼');
                    loadSensitiveWords();
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('åˆ é™¤æ•æ„Ÿè¯å¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }
        
        function editModelConfig(modelId) {
            // è·å–å½“å‰é…ç½®
            fetch(`${API_BASE}/api/hub/model/${modelId}`)
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        const model = data.model;
                        
                        // åˆ›å»ºç¼–è¾‘æ¨¡æ€æ¡†
                        const modal = document.createElement('div');
                        modal.className = 'modal';
                        modal.style.display = 'flex';
                        modal.id = 'edit-model-modal';
                        
                        modal.innerHTML = `
                            <div class="modal-content" style="max-width: 700px;">
                                <div class="modal-header">
                                    <h3>ç¼–è¾‘æ¨¡å‹é…ç½® - ${model.id}</h3>
                                    <button class="modal-close" onclick="closeEditModelModal()">Ã—</button>
                                </div>
                                <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                                    <form id="edit-model-form" onsubmit="saveModelConfig(event, '${modelId}')">
                                        <div class="model-config-section" style="margin-bottom: 20px;">
                                            <h4 style="margin-bottom: 16px; color: var(--accent-primary);">ğŸ”‘ API åŸºç¡€é…ç½®</h4>
                                            
                                            <div style="margin-bottom: 16px;">
                                                <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 500; color: var(--text-primary);">API Key <span style="color: #ef4444;">*</span></label>
                                                <input type="text" id="edit-api-key" value="${model.api_key || ''}" 
                                                       placeholder="sk-..." 
                                                       style="width: 100%; padding: 10px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-family: monospace; font-size: 12px;"
                                                       required>
                                                <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">è¯·è¾“å…¥çœŸå®çš„APIå¯†é’¥ï¼Œå°†å®‰å…¨ä¿å­˜åˆ°æœ¬åœ°æ–‡ä»¶</div>
                                            </div>
                                            
                                            <div style="margin-bottom: 16px;">
                                                <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 500; color: var(--text-primary);">Endpoint URL <span style="color: #ef4444;">*</span></label>
                                                <input type="url" id="edit-endpoint" value="${model.endpoint || ''}" 
                                                       placeholder="https://api.openai.com/v1/chat/completions" 
                                                       style="width: 100%; padding: 10px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-family: monospace; font-size: 12px;"
                                                       required>
                                            </div>
                                            
                                            <div style="margin-bottom: 16px;">
                                                <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 500; color: var(--text-primary);">æ¨¡å‹åç§°</label>
                                                <input type="text" id="edit-model-name" value="${model.model_name || model.id}" 
                                                       placeholder="æ¨¡å‹æ˜¾ç¤ºåç§°" 
                                                       style="width: 100%; padding: 10px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 13px;">
                                            </div>
                                            
                                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                                <div>
                                                    <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 500; color: var(--text-primary);">Temperature</label>
                                                    <input type="number" id="edit-temperature" value="${model.temperature || 0.7}" 
                                                           min="0" max="2" step="0.1"
                                                           style="width: 100%; padding: 10px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 13px;">
                                                </div>
                                                <div>
                                                    <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 500; color: var(--text-primary);">Max Tokens</label>
                                                    <input type="number" id="edit-max-tokens" value="${model.max_tokens || ''}" 
                                                           min="1" step="1"
                                                           placeholder="ç•™ç©ºä¸ºé»˜è®¤"
                                                           style="width: 100%; padding: 10px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 13px;">
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="model-config-section" style="margin-bottom: 20px;">
                                            <h4 style="margin-bottom: 16px; color: var(--accent-primary);">ğŸ“Š ä½¿ç”¨é™é¢</h4>
                                            
                                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                                <div>
                                                    <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 500; color: var(--text-primary);">æ¯æ—¥é™é¢</label>
                                                    <input type="number" id="edit-daily-limit" value="${model.daily_limit || 10000}" 
                                                           min="0" step="1"
                                                           placeholder="ç•™ç©ºä¸ºæ— é™åˆ¶"
                                                           style="width: 100%; padding: 10px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 13px;">
                                                </div>
                                                <div>
                                                    <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 500; color: var(--text-primary);">æ¯åˆ†é’Ÿé™é¢</label>
                                                    <input type="number" id="edit-rate-limit" value="${model.rate_limit || 60}" 
                                                           min="0" step="1"
                                                           placeholder="ç•™ç©ºä¸ºæ— é™åˆ¶"
                                                           style="width: 100%; padding: 10px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 13px;">
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="model-config-section" style="margin-bottom: 20px;">
                                            <h4 style="margin-bottom: 16px; color: var(--accent-primary);">âš¡ ç†”æ–­ä¿æŠ¤</h4>
                                            
                                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                                <div>
                                                    <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 500; color: var(--text-primary);">é”™è¯¯ç‡é˜ˆå€¼ (%)</label>
                                                    <input type="number" id="edit-error-rate" value="${model.circuit_breaker_error_rate || 0.5}" 
                                                           min="0" max="100" step="0.1"
                                                           style="width: 100%; padding: 10px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 13px;">
                                                </div>
                                                <div>
                                                    <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 500; color: var(--text-primary);">å“åº”æ—¶é—´é˜ˆå€¼ (ms)</label>
                                                    <input type="number" id="edit-latency" value="${model.circuit_breaker_latency || 5000}" 
                                                           min="0" step="100"
                                                           style="width: 100%; padding: 10px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 13px;">
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="model-config-section" style="margin-bottom: 20px;">
                                            <h4 style="margin-bottom: 16px; color: var(--accent-primary);">ğŸš« æ•æ„Ÿè¯è¿‡æ»¤</h4>
                                            
                                            <div style="margin-bottom: 12px;">
                                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                                    <input type="checkbox" id="edit-sensitive-filter" ${model.sensitive_filter_enabled ? 'checked' : ''} 
                                                           style="width: 18px; height: 18px; cursor: pointer;">
                                                    <span style="font-size: 13px; color: var(--text-primary);">å¯ç”¨æ•æ„Ÿè¯è¿‡æ»¤</span>
                                                </label>
                                            </div>
                                            
                                            <div>
                                                <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 500; color: var(--text-primary);">è¿‡æ»¤æ¨¡å¼</label>
                                                <select id="edit-filter-mode" style="width: 100%; padding: 10px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 13px;">
                                                    <option value="replace" ${model.filter_mode === 'replace' ? 'selected' : ''}>æ›¿æ¢ä¸º***</option>
                                                    <option value="block" ${model.filter_mode === 'block' ? 'selected' : ''}>ç›´æ¥æ‹¦æˆª</option>
                                                    <option value="warn" ${model.filter_mode === 'warn' ? 'selected' : ''}>è­¦å‘Šæç¤º</option>
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <div style="display: flex; gap: 8px; margin-top: 24px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                                            <button type="submit" style="flex: 1; padding: 12px; background: var(--accent-primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 14px;">ğŸ’¾ ä¿å­˜é…ç½®</button>
                                            <button type="button" onclick="closeEditModelModal()" style="flex: 1; padding: 12px; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 14px;">å–æ¶ˆ</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        `;
                        
                        document.body.appendChild(modal);
                        
                        // ç‚¹å‡»èƒŒæ™¯å…³é—­
                        modal.addEventListener('click', function(e) {
                            if (e.target === modal) {
                                closeEditModelModal();
                            }
                        });
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½æ¨¡å‹é…ç½®å¤±è´¥:', error);
                    alert('åŠ è½½å¤±è´¥: ' + error.message);
                });
        }
        
        function closeEditModelModal() {
            const modal = document.getElementById('edit-model-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        function saveModelConfig(event, modelId) {
            event.preventDefault();
            
            const formData = {
                api_key: document.getElementById('edit-api-key').value.trim(),
                endpoint: document.getElementById('edit-endpoint').value.trim(),
                model_name: document.getElementById('edit-model-name').value.trim(),
                temperature: parseFloat(document.getElementById('edit-temperature').value) || 0.7,
                max_tokens: document.getElementById('edit-max-tokens').value ? parseInt(document.getElementById('edit-max-tokens').value) : null,
                daily_limit: document.getElementById('edit-daily-limit').value ? parseInt(document.getElementById('edit-daily-limit').value) : null,
                rate_limit: document.getElementById('edit-rate-limit').value ? parseInt(document.getElementById('edit-rate-limit').value) : null,
                circuit_breaker_error_rate: parseFloat(document.getElementById('edit-error-rate').value) || 0.5,
                circuit_breaker_latency: parseInt(document.getElementById('edit-latency').value) || 5000,
                sensitive_filter_enabled: document.getElementById('edit-sensitive-filter').checked,
                filter_mode: document.getElementById('edit-filter-mode').value
            };
            
            // éªŒè¯å¿…å¡«é¡¹
            if (!formData.api_key) {
                alert('âš ï¸ API Key ä¸èƒ½ä¸ºç©ºï¼');
                return;
            }
            if (!formData.endpoint) {
                alert('âš ï¸ Endpoint URL ä¸èƒ½ä¸ºç©ºï¼');
                return;
            }
            
            // æ˜¾ç¤ºä¿å­˜ä¸­çŠ¶æ€
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'ğŸ’¾ ä¿å­˜ä¸­...';
            submitBtn.disabled = true;
            
            // æ›´æ–°é…ç½®
            fetch(`${API_BASE}/api/hub/model/${modelId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            })
            .then(res => res.json())
            .then(updateData => {
                if (updateData.success) {
                    alert('âœ… é…ç½®æ›´æ–°æˆåŠŸå¹¶å·²ä¿å­˜åˆ°æœ¬åœ°æ–‡ä»¶ï¼');
                    closeEditModelModal();
                    selectHubModel(modelId); // åˆ·æ–°æ˜¾ç¤º
                } else {
                    alert('âŒ æ›´æ–°å¤±è´¥: ' + updateData.error);
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            })
            .catch(error => {
                console.error('æ›´æ–°é…ç½®å¤±è´¥:', error);
                alert('âŒ æ›´æ–°å¤±è´¥: ' + error.message);
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            });
        }
        
        async function testModel(modelId) {
            try {
                const response = await fetch(`${API_BASE}/api/hub/model/${modelId}/test`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                if (data.success) {
                    const result = data.result;
                    const message = `âœ… è¿æ¥æµ‹è¯•æˆåŠŸï¼\n\n` +
                                  `çŠ¶æ€: ${result.status}\n` +
                                  `å“åº”æ—¶é—´: ${(result.latency * 1000).toFixed(0)}ms\n` +
                                  `æµ‹è¯•æ—¶é—´: ${result.test_time}\n` +
                                  `æ¶ˆæ¯: ${result.message}`;
                    alert(message);
                } else {
                    alert('âŒ è¿æ¥æµ‹è¯•å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('æµ‹è¯•è¿æ¥å¤±è´¥:', error);
                alert('æµ‹è¯•å¤±è´¥: ' + error.message);
            }
        }

        // å¤šé“¶è¡Œå¯¹æ¯”ï¼ˆæœ€å°å¯è¡Œç‰ˆï¼‰
        function ensureBankComparisonModal() {
            let modal = document.getElementById('bank-comparison-modal');
            if (modal) return modal;
            modal = document.createElement('div');
            modal.id = 'bank-comparison-modal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 900px; max-height: 90vh;">
                    <div class="modal-header">
                        <h3>ğŸ¦ å¤šé“¶è¡Œå¯¹æ¯”</h3>
                        <button class="modal-close" onclick="closeBankComparisonModal()">Ã—</button>
                    </div>
                    <div class="modal-body" style="max-height: calc(90vh - 100px); overflow-y: auto;">
                        <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 12px;">
                            é»˜è®¤æ¯”è¾ƒ 3 å®¶é“¶è¡Œï¼ˆç¨³å¥/å¹³è¡¡/æ¿€è¿›ï¼‰ï¼ŒåŒä¸€æ‰¹å®¢æˆ·ä¸‹çš„å®¡æ‰¹ç‡ã€è¿çº¦æ¦‚ç‡ï¼ˆä¼°ç®—NPLï¼‰ã€é¢„ä¼°åˆ©æ¶¦ã€‚å¯ç›´æ¥ç‚¹å‡»è¿è¡Œï¼Œæˆ–è°ƒæ•´å‚æ•°åå†è¿è¡Œã€‚
                        </p>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 10px; margin-bottom: 12px;">
                            <div>
                                <label style="display:block;font-size:12px;color:var(--text-muted);margin-bottom:4px;">åŸºå‡†åˆ©ç‡</label>
                                <input id="bank-base-rate" type="number" step="0.001" value="0.08" style="width:100%;padding:8px;border:1px solid var(--border-color);border-radius:6px;background:var(--bg-secondary);color:var(--text-primary);">
                            </div>
                            <div>
                                <label style="display:block;font-size:12px;color:var(--text-muted);margin-bottom:4px;">è´·æ¬¾é‡‘é¢</label>
                                <input id="bank-loan-amount" type="number" step="10000" value="100000" style="width:100%;padding:8px;border:1px solid var(--border-color);border-radius:6px;background:var(--bg-secondary);color:var(--text-primary);">
                            </div>
                            <div>
                                <label style="display:block;font-size:12px;color:var(--text-muted);margin-bottom:4px;">å®¢æˆ·æ•°</label>
                                <input id="bank-customer-count" type="number" step="50" value="300" style="width:100%;padding:8px;border:1px solid var(--border-color);border-radius:6px;background:var(--bg-secondary);color:var(--text-primary);">
                            </div>
                            <div>
                                <label style="display:block;font-size:12px;color:var(--text-muted);margin-bottom:4px;">éšæœºç§å­</label>
                                <input id="bank-seed" type="number" step="1" value="42" style="width:100%;padding:8px;border:1px solid var(--border-color);border-radius:6px;background:var(--bg-secondary);color:var(--text-primary);">
                            </div>
                        </div>
                        <button class="btn-primary" style="margin-bottom: 12px;" onclick="runBankComparison()">è¿è¡Œå¯¹æ¯”</button>
                        <div id="bank-comparison-result" style="min-height: 80px; border: 1px solid var(--border-color); border-radius: 8px; padding: 12px; background: var(--bg-secondary);"></div>
                    </div>
                </div>
            `;
            modal.addEventListener('click', function(e) {
                if (e.target === modal) closeBankComparisonModal();
            });
            document.body.appendChild(modal);
            return modal;
        }

        function openBankComparison() {
            ensureBankComparisonModal().style.display = 'flex';
            runBankComparison();
        }

        function closeBankComparisonModal() {
            const modal = document.getElementById('bank-comparison-modal');
            if (modal) modal.style.display = 'none';
        }

        async function runBankComparison() {
            const resultBox = document.getElementById('bank-comparison-result');
            if (!resultBox) return;
            resultBox.innerHTML = `<div class="loading"><div class="spinner"></div><p>è®¡ç®—ä¸­...</p></div>`;
            try {
                const baseRate = parseFloat(document.getElementById('bank-base-rate')?.value || 0.08);
                const loanAmount = parseFloat(document.getElementById('bank-loan-amount')?.value || 100000);
                const customerCount = parseInt(document.getElementById('bank-customer-count')?.value || 300);
                const seed = parseInt(document.getElementById('bank-seed')?.value || 42);
                const payload = {
                    banks: [
                        {"name": "ç¨³å¥é“¶è¡Œ", "approval_threshold": 0.12, "rate_spread": 0.01},
                        {"name": "å¹³è¡¡é“¶è¡Œ", "approval_threshold": 0.18, "rate_spread": 0.015},
                        {"name": "æ¿€è¿›é“¶è¡Œ", "approval_threshold": 0.25, "rate_spread": 0.02}
                    ],
                    customer_count: customerCount,
                    loan_amount: loanAmount,
                    base_rate: baseRate,
                    seed: seed
                };
                const res = await fetch(`${API_BASE}/api/bank-comparison/run`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (!data.success) throw new Error(data.error || 'è¯·æ±‚å¤±è´¥');
                const rows = data.results.map((r, idx) => `
                    <tr>
                        <td>${idx + 1}</td>
                        <td>${r.name}</td>
                        <td>${(r.approval_rate * 100).toFixed(1)}%</td>
                        <td>${(r.avg_default_prob * 100).toFixed(2)}%</td>
                        <td>${(r.est_profit / 1e6).toFixed(2)} ç™¾ä¸‡</td>
                        <td>${r.sample_size}</td>
                    </tr>
                `).join('');
                const detailRows = data.results.map((r, idx) => `
                    <tr>
                        <td>${idx + 1}</td>
                        <td>${r.name}</td>
                        <td>${(r.dp_p95 * 100).toFixed(2)}%</td>
                        <td>${(r.interest_income / 1e6).toFixed(2)} ç™¾ä¸‡</td>
                        <td>${(r.expected_loss / 1e6).toFixed(2)} ç™¾ä¸‡</td>
                        <td>${(r.risk_factor_mean).toFixed(3)}</td>
                        <td>${r.factor_top5.map(f => `${f[0]}:${f[1].toFixed(3)}`).join(' , ')}</td>
                    </tr>
                `).join('');
                resultBox.innerHTML = `
                    <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">
                        å®¢æˆ·æ•°: ${data.summary.customer_count} Â· è´·æ¬¾é‡‘é¢: Â¥${data.summary.loan_amount.toLocaleString()} Â· åŸºå‡†åˆ©ç‡: ${(data.summary.base_rate*100).toFixed(1)}%
                    </div>
                    <table class="data-table" style="width: 100%; font-size: 13px;">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>é“¶è¡Œ</th>
                                <th>å®¡æ‰¹ç‡</th>
                                <th>è¿çº¦æ¦‚ç‡(NPLä¼°)</th>
                                <th>é¢„ä¼°åˆ©æ¶¦</th>
                                <th>æ ·æœ¬æ•°</th>
                            </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                    <div style="margin-top: 12px; font-size: 13px; color: var(--text-muted);">
                        <strong>è®¡ç®—è¯´æ˜ï¼š</strong> ${data.summary.calculation_notes.join('ï¼› ')}
                    </div>
                    <div style="margin-top: 12px; font-size: 13px; color: var(--text-muted);">
                        <strong>é«˜çº§æ˜ç»†ï¼š</strong>
                    </div>
                    <table class="data-table" style="width: 100%; font-size: 12px; margin-top: 6px;">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>é“¶è¡Œ</th>
                                <th>P95è¿çº¦ç‡</th>
                                <th>åˆ©æ¯æ”¶å…¥</th>
                                <th>é¢„æœŸæŸå¤±</th>
                                <th>é£é™©å› å­å‡å€¼</th>
                                <th>Top5å› å­</th>
                            </tr>
                        </thead>
                        <tbody>${detailRows}</tbody>
                    </table>
                `;
            } catch (e) {
                console.error(e);
                resultBox.innerHTML = `<div style="color: var(--text-danger);">è¿è¡Œå¤±è´¥: ${e.message}</div>`;
            }
        }

        // AI æ¼”æ­¦åœºï¼ˆè´·æ¬¾å®¡æ‰¹PKï¼‰
        function ensureArenaModal() {
            let modal = document.getElementById('arena-modal');
            if (modal) return modal;
            modal = document.createElement('div');
            modal.id = 'arena-modal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 960px; max-height: 90vh;">
                    <div class="modal-header">
                        <h3>ğŸ§  AI æ¼”æ­¦åœºï¼ˆå®¡æ‰¹PKï¼‰</h3>
                        <button class="modal-close" onclick="closeArenaModal()">Ã—</button>
                    </div>
                    <div class="modal-body" style="max-height: calc(90vh - 100px); overflow-y: auto;">
                        <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 12px;">
                            å¯¹æ¯”å¤šæ¨¡å‹/ç­–ç•¥åœ¨åŒä¸€æ‰¹å®¢æˆ·ã€åŒä¸€å®è§‚æƒ…æ™¯ä¸‹çš„å®¡æ‰¹ç‡ã€è¿çº¦æ¦‚ç‡(NPLä¼°)ã€é¢„ä¼°åˆ©æ¶¦ã€RAROCã€‚
                        </p>
                        <div style="margin-bottom: 12px; padding: 10px; background: var(--bg-secondary); border-radius: 6px; border: 1px solid var(--border-color);">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <label style="font-size: 12px; color: var(--text-muted);">ä¸šåŠ¡åœºæ™¯æ¨¡æ¿ï¼š</label>
                                <select id="arena-scenario-template" style="flex: 1; padding: 8px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 12px;" onchange="loadScenarioTemplate(this.value)">
                                    <option value="">-- é€‰æ‹©åœºæ™¯æ¨¡æ¿ï¼ˆå¯é€‰ï¼‰--</option>
                                </select>
                                <button class="btn-secondary" style="font-size: 12px; padding: 6px 10px;" onclick="showScenarioTemplates()">æŸ¥çœ‹æ‰€æœ‰æ¨¡æ¿</button>
                            </div>
                            <div id="scenario-template-info" style="font-size: 11px; color: var(--text-muted); display: none; margin-top: 6px; padding: 6px; background: var(--bg-primary); border-radius: 4px;"></div>
                        </div>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 12px;">
                            <label style="font-size: 12px; color: var(--text-muted);">å®¢æˆ·æ•°</label>
                            <input id="arena-customer-count" type="number" value="300" min="50" max="2000" step="50"
                                   style="width: 100px; padding: 8px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary);">
                            <label style="font-size: 12px; color: var(--text-muted);">è´·æ¬¾é¢</label>
                            <input id="arena-loan-amount" type="number" value="100000" step="5000"
                                   style="width: 120px; padding: 8px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary);">
                            <label style="font-size: 12px; color: var(--text-muted);">åŸºå‡†åˆ©ç‡</label>
                            <input id="arena-base-rate" type="number" value="0.08" step="0.005" min="0.01" max="0.3"
                                   style="width: 100px; padding: 8px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary);">
                            <label style="font-size: 12px; color: var(--text-muted);">ç§å­</label>
                            <input id="arena-seed" type="number" value="42" step="1"
                                   style="width: 90px; padding: 8px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary);">
                            <label style="font-size: 12px; color: var(--text-muted);">æƒ…æ™¯</label>
                            <select id="arena-scenario" style="padding: 8px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary);">
                                <option value="normal">æ­£å¸¸</option>
                                <option value="stress">å‹åŠ›</option>
                            </select>
                            <label style="font-size: 12px; color: var(--text-muted);">é»‘å¤©é¹…</label>
                            <input id="arena-black-swan" type="checkbox" style="width:16px;height:16px; margin-top: 8px;">
                            <button class="btn-primary" onclick="runArena()" style="margin-left: auto;">è¿è¡ŒPK</button>
                        </div>
                        <div style="margin-bottom:8px; display:flex; align-items:center; gap:8px;">
                            <span style="font-size:12px; color:var(--text-muted);">å‚èµ›è€…</span>
                            <button class="btn-secondary" style="font-size:12px; padding:4px 8px;" onclick="addArenaParticipant()">+ æ·»åŠ </button>
                        </div>
                        <div id="arena-participants" style="display: grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap: 10px; margin-bottom: 12px;">
                            <!-- åŠ¨æ€å¡«å……å‚èµ›è€…å¡ç‰‡ -->
                        </div>
                        <div style="margin-bottom:12px; border-top: 1px solid var(--border-color); padding-top: 12px;">
                            <div style="margin-bottom:8px; display:flex; align-items:center; gap:8px;">
                                <span style="font-size:12px; color:var(--text-muted);">è§„åˆ™å¼•æ“é…ç½®</span>
                                <button class="btn-secondary" style="font-size:12px; padding:4px 8px;" onclick="addArenaRule()">+ æ·»åŠ è§„åˆ™</button>
                                <button class="btn-secondary" style="font-size:12px; padding:4px 8px;" onclick="loadDefaultRules()">åŠ è½½é»˜è®¤è§„åˆ™</button>
                            </div>
                            <div id="arena-rules" style="display: grid; gap: 10px; margin-bottom: 8px;">
                                <!-- åŠ¨æ€å¡«å……è§„åˆ™å¡ç‰‡ -->
                            </div>
                        </div>
                        <div id="arena-result" style="min-height: 100px; border: 1px solid var(--border-color); border-radius: 8px; padding: 12px; background: var(--bg-secondary);"></div>
                        <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
                            <button class="btn-secondary" style="font-size:12px; padding:6px 10px;" onclick="showArenaCalc()">è®¡ç®—è¯´æ˜</button>
                            <button class="btn-secondary" style="font-size:12px; padding:6px 10px;" onclick="showArenaAIExplain()">AIè§£é‡Š</button>
                            <button class="btn-secondary" style="font-size:12px; padding:6px 10px;" onclick="exportArenaResult('json')">å¯¼å‡ºJSON</button>
                            <button class="btn-secondary" style="font-size:12px; padding:6px 10px;" onclick="exportArenaResult('csv')">å¯¼å‡ºCSV</button>
                            <button class="btn-secondary" style="font-size:12px; padding:6px 10px;" onclick="exportArenaResult('txt')">å¯¼å‡ºTXT</button>
                            <button class="btn-secondary" style="font-size:12px; padding:6px 10px;" onclick="exportArenaResult('html')">å¯¼å‡ºHTML</button>
                            <button class="btn-secondary" style="font-size:12px; padding:6px 10px;" onclick="showArenaReplay()">å›æ”¾</button>
                            <button class="btn-secondary" style="font-size:12px; padding:6px 10px;" onclick="showArenaCharts()">å›¾è¡¨</button>
                        </div>
                    </div>
                </div>
            `;
            modal.addEventListener('click', function(e) { if (e.target === modal) closeArenaModal(); });
            document.body.appendChild(modal);
            return modal;
        }

        // å…¨å±€å˜é‡ï¼šå­˜å‚¨æ¨¡å‹åˆ—è¡¨
        let arenaModelList = [];

        // åŠ è½½æ¨¡å‹åˆ—è¡¨
        async function loadArenaModels() {
            try {
                const res = await fetch(`${API_BASE}/api/models/list`);
                const data = await res.json();
                if (data.success && data.models) {
                    arenaModelList = data.models.map(m => ({
                        id: m.id,
                        name: m.config?.model_name || m.id,
                        type: m.type?.value || m.type || 'unknown',
                        provider: m.config?.provider || 'æœªçŸ¥'
                    }));
                }
            } catch (e) {
                console.error('åŠ è½½æ¨¡å‹åˆ—è¡¨å¤±è´¥:', e);
                arenaModelList = [];
            }
        }

        // ç”Ÿæˆæ¨¡å‹ä¸‹æ‹‰é€‰é¡¹HTML
        function generateModelSelectOptions(selectedModelId) {
            let options = '<option value="">æ—  (ç­–ç•¥æ¨¡å¼)</option>';
            arenaModelList.forEach(model => {
                const selected = model.id === selectedModelId ? 'selected' : '';
                const label = `${model.name} (${model.provider})`;
                options += `<option value="${model.id}" ${selected}>${label}</option>`;
            });
            return options;
        }

        // å…¨å±€å˜é‡ï¼šå­˜å‚¨åœºæ™¯æ¨¡æ¿åˆ—è¡¨
        let arenaScenarioTemplates = [];

        // åŠ è½½åœºæ™¯æ¨¡æ¿åˆ—è¡¨
        async function loadScenarioTemplates() {
            try {
                const res = await fetch(`${API_BASE}/api/arena/scenario-templates`);
                const data = await res.json();
                if (data.success && data.templates) {
                    arenaScenarioTemplates = data.full_templates || [];
                    const select = document.getElementById('arena-scenario-template');
                    if (select) {
                        select.innerHTML = '<option value="">-- é€‰æ‹©åœºæ™¯æ¨¡æ¿ï¼ˆå¯é€‰ï¼‰--</option>' +
                            data.templates.map(t => 
                                `<option value="${t.id}">${t.name} - ${t.description}</option>`
                            ).join('');
                    }
                }
            } catch (e) {
                console.error('åŠ è½½åœºæ™¯æ¨¡æ¿å¤±è´¥:', e);
            }
        }

        // åŠ è½½åœºæ™¯æ¨¡æ¿è¯¦æƒ…å¹¶åº”ç”¨åˆ°ç•Œé¢
        async function loadScenarioTemplate(templateId) {
            if (!templateId) {
                document.getElementById('scenario-template-info').style.display = 'none';
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE}/api/arena/scenario-templates/${templateId}`);
                const data = await res.json();
                if (data.success && data.template) {
                    const template = data.template;
                    
                    // åº”ç”¨æ¨¡æ¿å‚æ•°åˆ°ç•Œé¢
                    document.getElementById('arena-customer-count').value = template.customer_count || 300;
                    document.getElementById('arena-loan-amount').value = template.loan_amount || 100000;
                    document.getElementById('arena-base-rate').value = template.base_rate || 0.08;
                    document.getElementById('arena-scenario').value = template.scenario || 'normal';
                    document.getElementById('arena-black-swan').checked = template.black_swan || false;
                    
                    // åº”ç”¨æ¨èçš„å‚èµ›è€…
                    if (template.recommended_participants && template.recommended_participants.length > 0) {
                        initArenaParticipants(template.recommended_participants);
                    }
                    
                    // åº”ç”¨æ¨èçš„è§„åˆ™
                    if (template.recommended_rules && template.recommended_rules.length > 0) {
                        // åŠ è½½é»˜è®¤è§„åˆ™ï¼Œç„¶åç­›é€‰å‡ºæ¨èçš„è§„åˆ™
                        loadDefaultRules().then(() => {
                            setTimeout(() => {
                                const container = document.getElementById('arena-rules');
                                if (container) {
                                    const cards = Array.from(container.children);
                                    cards.forEach(card => {
                                        const nameInput = card.querySelector('input[type="text"]');
                                        if (nameInput && !template.recommended_rules.includes(nameInput.value)) {
                                            card.remove();
                                        }
                                    });
                                }
                            }, 500);
                        });
                    }
                    
                    // æ˜¾ç¤ºæ¨¡æ¿ä¿¡æ¯
                    const infoDiv = document.getElementById('scenario-template-info');
                    if (infoDiv) {
                        infoDiv.innerHTML = `
                            <strong>${template.name}</strong><br>
                            <span style="color: var(--accent-primary);">ä¸šåŠ¡ä»·å€¼ï¼š</span>${template.business_value || ''}<br>
                            <span style="color: var(--accent-primary);">é€‚ç”¨åœºæ™¯ï¼š</span>${(template.use_cases || []).join('ã€')}
                        `;
                        infoDiv.style.display = 'block';
                    }
                }
            } catch (e) {
                console.error('åŠ è½½åœºæ™¯æ¨¡æ¿è¯¦æƒ…å¤±è´¥:', e);
            }
        }

        // æ˜¾ç¤ºæ‰€æœ‰åœºæ™¯æ¨¡æ¿
        function showScenarioTemplates() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px; max-height: 80vh;">
                    <div class="modal-header">
                        <h3>ğŸ“‹ ä¸šåŠ¡åœºæ™¯æ¨¡æ¿åº“</h3>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">Ã—</button>
                    </div>
                    <div class="modal-body" style="max-height: calc(80vh - 100px); overflow-y: auto;">
                        <div id="scenario-templates-list" style="display: grid; gap: 12px;">
                            <div style="padding: 12px; text-align: center; color: var(--text-muted);">åŠ è½½ä¸­...</div>
                        </div>
                    </div>
                </div>
            `;
            modal.addEventListener('click', function(e) { if (e.target === modal) modal.remove(); });
            document.body.appendChild(modal);
            
            // åŠ è½½æ¨¡æ¿åˆ—è¡¨
            fetch(`${API_BASE}/api/arena/scenario-templates`)
                .then(res => res.json())
                .then(data => {
                    if (data.success && data.templates) {
                        const listDiv = document.getElementById('scenario-templates-list');
                        listDiv.innerHTML = data.templates.map(t => `
                            <div class="card" style="padding: 16px; cursor: pointer;" onclick="loadScenarioTemplate('${t.id}'); this.closest('.modal').remove();">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                    <h4 style="margin: 0; color: var(--accent-primary);">${t.name}</h4>
                                    <span style="font-size: 11px; padding: 2px 8px; background: var(--bg-secondary); border-radius: 4px; color: var(--text-muted);">${t.category || 'é€šç”¨'}</span>
                                </div>
                                <p style="font-size: 12px; color: var(--text-secondary); margin: 8px 0;">${t.description || ''}</p>
                                <div style="font-size: 11px; color: var(--text-muted); margin-top: 8px;">
                                    <strong>ä¸šåŠ¡ä»·å€¼ï¼š</strong>${t.business_value || ''}<br>
                                    <strong>é€‚ç”¨åœºæ™¯ï¼š</strong>${(t.use_cases || []).join('ã€')}
                                </div>
                            </div>
                        `).join('');
                    }
                })
                .catch(e => {
                    console.error('åŠ è½½åœºæ™¯æ¨¡æ¿å¤±è´¥:', e);
                    document.getElementById('scenario-templates-list').innerHTML = 
                        '<div style="padding: 12px; color: var(--accent-danger);">åŠ è½½å¤±è´¥</div>';
                });
        }

        function openArenaModal() {
            ensureArenaModal().style.display = 'flex';
            loadArenaModels().then(() => {
                loadScenarioTemplates().then(() => {
                    initArenaParticipants();
                });
            });
        }

        function closeArenaModal() {
            const modal = document.getElementById('arena-modal');
            if (modal) modal.style.display = 'none';
        }

        function initArenaParticipants(defaults) {
            const container = document.getElementById('arena-participants');
            if (!container) return;
            container.innerHTML = '';
            
            // å¦‚æœæ²¡æœ‰æä¾›é»˜è®¤å€¼ï¼Œåˆ›å»ºé»˜è®¤å‚èµ›è€…é…ç½®
            if (!defaults) {
                // ç­‰å¾…æ¨¡å‹åˆ—è¡¨åŠ è½½å®Œæˆåå†åˆ›å»ºé»˜è®¤é…ç½®
                if (arenaModelList.length > 0) {
                    createDefaultParticipants();
                } else {
                    loadArenaModels().then(() => {
                        createDefaultParticipants();
                    });
                }
            } else {
                // ä½¿ç”¨æä¾›çš„é»˜è®¤å€¼
                defaults.forEach(addArenaParticipantCard);
            }
        }
        
        function createDefaultParticipants() {
            // è·å–å¯ç”¨çš„æ¨¡å‹åˆ—è¡¨ï¼ˆä¼˜å…ˆé€‰æ‹©ä¸åŒç±»å‹çš„æ¨¡å‹ï¼‰
            const availableModels = arenaModelList.filter(m => m.id);
            
            // æ™ºèƒ½é€‰æ‹©æ¨¡å‹ï¼šä¼˜å…ˆé€‰æ‹©ä¸åŒæä¾›å•†çš„æ¨¡å‹
            const selectedModels = [];
            const usedProviders = new Set();
            
            // ç¬¬ä¸€è½®ï¼šä¼˜å…ˆé€‰æ‹©ä¸åŒæä¾›å•†çš„æ¨¡å‹
            for (const model of availableModels) {
                if (selectedModels.length >= 3) break;
                if (!usedProviders.has(model.provider)) {
                    selectedModels.push(model.id);
                    usedProviders.add(model.provider);
                }
            }
            
            // ç¬¬äºŒè½®ï¼šå¦‚æœè¿˜ä¸å¤Ÿ3ä¸ªï¼Œç»§ç»­æ·»åŠ 
            for (const model of availableModels) {
                if (selectedModels.length >= 3) break;
                if (!selectedModels.includes(model.id)) {
                    selectedModels.push(model.id);
                }
            }
            
            // é»˜è®¤å‚èµ›è€…é…ç½®ï¼ˆæ¯ä¸ªç­–ç•¥é€‰æ‹©ä¸åŒçš„æ¨¡å‹ï¼‰
            const defaultParticipants = [
                { 
                    name: 'ç­–ç•¥1', 
                    approval_threshold: 0.12, 
                    rate_spread: 0.01, 
                    model_id: selectedModels[0] || '' 
                },
                { 
                    name: 'ç­–ç•¥2', 
                    approval_threshold: 0.18, 
                    rate_spread: 0.015, 
                    model_id: selectedModels[1] || '' 
                },
                { 
                    name: 'ç­–ç•¥3', 
                    approval_threshold: 0.25, 
                    rate_spread: 0.02, 
                    model_id: selectedModels[2] || '' 
                },
            ];
            
            defaultParticipants.forEach(addArenaParticipantCard);
            console.log('âœ… å·²åˆ›å»ºé»˜è®¤å‚èµ›è€…ï¼Œæ¯ä¸ªç­–ç•¥é€‰æ‹©äº†ä¸åŒçš„æ¨¡å‹');
        }

        function addArenaParticipantCard(p) {
            const container = document.getElementById('arena-participants');
            if (!container) return;
            const card = document.createElement('div');
            card.className = 'card';
            card.style.padding = '10px';
            card.style.display = 'grid';
            card.style.gap = '6px';
            // ç¡®ä¿æ¨¡å‹åˆ—è¡¨å·²åŠ è½½
            const modelSelectOptions = generateModelSelectOptions(p.model_id || '');
            card.innerHTML = `
                <div style="display:flex; justify-content: space-between; align-items:center;">
                    <input type="text" class="form-input" value="${p.name || ''}" placeholder="åç§°" style="flex:1; margin-right:6px;">
                    <button class="btn-secondary" style="padding:4px 8px;font-size:12px;" onclick="this.parentElement.parentElement.remove()">åˆ é™¤</button>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:6px;">
                    <input type="number" class="form-input" value="${p.approval_threshold || 0.18}" step="0.01" placeholder="å®¡æ‰¹é˜ˆå€¼">
                    <input type="number" class="form-input" value="${p.rate_spread || 0.01}" step="0.001" placeholder="åˆ©å·®">
                </div>
                <select class="form-input arena-model-select" style="width: 100%;">
                    ${modelSelectOptions}
                </select>
            `;
            container.appendChild(card);
            console.log(`å·²æ·»åŠ å‚èµ›è€…å¡ç‰‡: ${p.name || 'æ–°ç­–ç•¥'}, å½“å‰æ€»æ•°: ${container.children.length}`);
        }

        function addArenaParticipant() {
            // è·å–å½“å‰å·²æœ‰çš„ç­–ç•¥æ•°é‡ï¼Œè‡ªåŠ¨å‘½å
            const container = document.getElementById('arena-participants');
            const currentCount = container ? container.children.length : 0;
            const newName = `ç­–ç•¥${currentCount + 1}`;
            
            // é€‰æ‹©ä¸€ä¸ªæœªä½¿ç”¨çš„æ¨¡å‹ï¼ˆå¦‚æœæœ‰ï¼‰
            const usedModelIds = new Set();
            if (container) {
                Array.from(container.children).forEach(card => {
                    const select = card.querySelector('select');
                    if (select && select.value) {
                        usedModelIds.add(select.value);
                    }
                });
            }
            
            // é€‰æ‹©ä¸€ä¸ªæœªä½¿ç”¨çš„æ¨¡å‹
            let selectedModelId = '';
            for (const model of arenaModelList) {
                if (model.id && !usedModelIds.has(model.id)) {
                    selectedModelId = model.id;
                    break;
                }
            }
            
            addArenaParticipantCard({
                name: newName, 
                approval_threshold: 0.18, 
                rate_spread: 0.01,
                model_id: selectedModelId
            });
        }

        function collectArenaParticipants() {
            const container = document.getElementById('arena-participants');
            if (!container) {
                console.warn('æœªæ‰¾åˆ°å‚èµ›è€…å®¹å™¨');
                return [];
            }
            // è·å–æ‰€æœ‰å¡ç‰‡ï¼ˆåŒ…æ‹¬.cardç±»çš„divå…ƒç´ ï¼‰
            const cards = Array.from(container.children).filter(c => c.classList.contains('card'));
            console.log(`æ”¶é›†å‚èµ›è€…ï¼šæ‰¾åˆ° ${cards.length} ä¸ªå¡ç‰‡ï¼ˆå®¹å™¨æ€»å­å…ƒç´ : ${container.children.length}ï¼‰`);
            
            if (cards.length === 0) {
                console.warn('æœªæ‰¾åˆ°ä»»ä½•å‚èµ›è€…å¡ç‰‡');
                return [];
            }
            
            const participants = cards.map((c, idx) => {
                // è·å–æ‰€æœ‰è¾“å…¥æ¡†ï¼ˆæ–‡æœ¬å’Œæ•°å­—ï¼‰
                const textInputs = c.querySelectorAll('input[type="text"]');
                const numberInputs = c.querySelectorAll('input[type="number"]');
                const select = c.querySelector('select.arena-model-select') || c.querySelector('select');
                
                const name = textInputs[0]?.value?.trim() || `æœªå‘½åç­–ç•¥${idx + 1}`;
                const approval_threshold = parseFloat(numberInputs[0]?.value || 0.18);
                const rate_spread = parseFloat(numberInputs[1]?.value || 0.01);
                const modelId = select?.value?.trim() || null;
                
                const participant = {
                    name: name,
                    approval_threshold: approval_threshold,
                    rate_spread: rate_spread,
                    model_id: modelId || null
                };
                console.log(`å‚èµ›è€… ${idx + 1}:`, participant);
                return participant;
            });
            console.log(`âœ… æ€»å…±æ”¶é›†åˆ° ${participants.length} ä¸ªå‚èµ›è€…:`, participants);
            return participants;
        }

        // è§„åˆ™é…ç½®ç›¸å…³å‡½æ•°
        function addArenaRule(ruleData) {
            const container = document.getElementById('arena-rules');
            if (!container) return;
            const rule = ruleData || {
                name: 'æ–°è§„åˆ™',
                description: '',
                priority: 0,
                enabled: true,
                conditions: [{field: 'monthly_income', op: '>', value: 0}],
                action: {approval_threshold_delta: 0, rate_spread_delta: 0},
                penalty: {score_delta: 0}
            };
            const card = document.createElement('div');
            card.className = 'card';
            card.style.padding = '12px';
            card.style.border = '1px solid var(--border-color)';
            card.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                    <input type="text" class="form-input" value="${rule.name || ''}" placeholder="è§„åˆ™åç§°" style="flex:1; margin-right:8px;">
                    <label style="font-size:11px; color:var(--text-muted); display:flex; align-items:center; gap:4px;">
                        <input type="checkbox" ${rule.enabled ? 'checked' : ''} style="width:14px;height:14px;">
                        å¯ç”¨
                    </label>
                    <input type="number" class="form-input" value="${rule.priority || 0}" placeholder="ä¼˜å…ˆçº§" style="width:80px; margin-right:8px;">
                    <button class="btn-secondary" style="padding:4px 8px;font-size:12px;" onclick="this.closest('.card').remove()">åˆ é™¤</button>
                </div>
                <textarea class="form-input" placeholder="è§„åˆ™æè¿°" style="width:100%; min-height:40px; margin-bottom:8px;">${rule.description || ''}</textarea>
                <div style="margin-bottom:8px;">
                    <div style="font-size:11px; color:var(--text-muted); margin-bottom:4px;">æ¡ä»¶</div>
                    <div class="rule-conditions" style="display:grid; gap:6px;">
                        ${(rule.conditions || []).map((cond, idx) => `
                            <div style="display:flex; gap:6px; align-items:center;">
                                <select class="form-input" style="flex:1; font-size:11px;">
                                    <option value="monthly_income" ${cond.field === 'monthly_income' ? 'selected' : ''}>æœˆæ”¶å…¥</option>
                                    <option value="age" ${cond.field === 'age' ? 'selected' : ''}>å¹´é¾„</option>
                                    <option value="debt_ratio" ${cond.field === 'debt_ratio' ? 'selected' : ''}>è´Ÿå€ºç‡</option>
                                    <option value="credit_score" ${cond.field === 'credit_score' ? 'selected' : ''}>ä¿¡ç”¨åˆ†</option>
                                    <option value="years_in_business" ${cond.field === 'years_in_business' ? 'selected' : ''}>ç»è¥å¹´é™</option>
                                    <option value="annual_revenue" ${cond.field === 'annual_revenue' ? 'selected' : ''}>å¹´æ”¶å…¥ï¼ˆä¼ä¸šï¼‰</option>
                                    <option value="total_assets" ${cond.field === 'total_assets' ? 'selected' : ''}>æ€»èµ„äº§</option>
                                    <option value="deposit_balance" ${cond.field === 'deposit_balance' ? 'selected' : ''}>å­˜æ¬¾ä½™é¢</option>
                                    <option value="previous_loans" ${cond.field === 'previous_loans' ? 'selected' : ''}>å†å²è´·æ¬¾æ•°</option>
                                    <option value="max_historical_dpd" ${cond.field === 'max_historical_dpd' ? 'selected' : ''}>æœ€å¤§é€¾æœŸå¤©æ•°</option>
                                    <option value="risk_score" ${cond.field === 'risk_score' ? 'selected' : ''}>é£é™©è¯„åˆ†</option>
                                </select>
                                <select class="form-input" style="width:80px; font-size:11px;">
                                    <option value=">" ${cond.op === '>' ? 'selected' : ''}>></option>
                                    <option value=">=" ${cond.op === '>=' ? 'selected' : ''}>>=</option>
                                    <option value="<" ${cond.op === '<' ? 'selected' : ''}><</option>
                                    <option value="<=" ${cond.op === '<=' ? 'selected' : ''}><=</option>
                                    <option value="==" ${cond.op === '==' ? 'selected' : ''}>==</option>
                                </select>
                                <input type="number" class="form-input" value="${cond.value || 0}" step="0.01" style="width:100px; font-size:11px;">
                                <button class="btn-secondary" style="padding:2px 6px;font-size:11px;" onclick="this.parentElement.remove()">Ã—</button>
                            </div>
                        `).join('')}
                    </div>
                    <button class="btn-secondary" style="font-size:11px; padding:4px 8px; margin-top:4px;" onclick="addRuleCondition(this)">+ æ·»åŠ æ¡ä»¶</button>
                </div>
                <div style="margin-bottom:8px; border-top: 1px solid var(--border-color); padding-top: 8px;">
                    <div style="font-size:11px; color:var(--accent-primary); margin-bottom:6px; font-weight:500;">ğŸ“‹ åŠ¨ä½œå‚æ•°</div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:6px; padding:8px; background:var(--bg-secondary); border-radius:4px;">
                        <input type="number" class="form-input" value="${rule.action?.approval_threshold_delta || 0}" step="0.01" placeholder="å®¡æ‰¹é˜ˆå€¼è°ƒæ•´" style="font-size:11px;" data-action="approval_threshold_delta">
                        <input type="number" class="form-input" value="${rule.action?.rate_spread_delta || 0}" step="0.001" placeholder="åˆ©å·®è°ƒæ•´" style="font-size:11px;" data-action="rate_spread_delta">
                        <input type="number" class="form-input" value="${rule.action?.loan_amount_multiplier || 1.0}" step="0.1" placeholder="è´·æ¬¾é‡‘é¢å€æ•°" style="font-size:11px;" data-action="loan_amount_multiplier">
                        <input type="number" class="form-input" value="${rule.action?.term_months_delta || 0}" step="1" placeholder="æœŸé™è°ƒæ•´ï¼ˆæœˆï¼‰" style="font-size:11px;" data-action="term_months_delta">
                        <input type="number" class="form-input" value="${rule.action?.min_loan_amount || 0}" step="1000" placeholder="æœ€å°è´·æ¬¾é‡‘é¢" style="font-size:11px;" data-action="min_loan_amount">
                        <input type="number" class="form-input" value="${rule.action?.max_loan_amount || 0}" step="1000" placeholder="æœ€å¤§è´·æ¬¾é‡‘é¢" style="font-size:11px;" data-action="max_loan_amount">
                        <label style="font-size:11px; display:flex; align-items:center; gap:4px;">
                            <input type="checkbox" ${rule.action?.force_approve ? 'checked' : ''} style="width:14px;height:14px;" data-action="force_approve">å¼ºåˆ¶é€šè¿‡
                        </label>
                        <label style="font-size:11px; display:flex; align-items:center; gap:4px;">
                            <input type="checkbox" ${rule.action?.force_reject ? 'checked' : ''} style="width:14px;height:14px;" data-action="force_reject">å¼ºåˆ¶æ‹’ç»
                        </label>
                        <label style="font-size:11px; display:flex; align-items:center; gap:4px;">
                            <input type="checkbox" ${rule.action?.require_collateral ? 'checked' : ''} style="width:14px;height:14px;" data-action="require_collateral">è¦æ±‚æŠµæŠ¼
                        </label>
                        <label style="font-size:11px; display:flex; align-items:center; gap:4px;">
                            <input type="checkbox" ${rule.action?.require_guarantor ? 'checked' : ''} style="width:14px;height:14px;" data-action="require_guarantor">è¦æ±‚æ‹…ä¿
                        </label>
                        <input type="number" class="form-input" value="${rule.action?.collateral_ratio || 0}" step="0.1" placeholder="æŠµæŠ¼ç‰©æ¯”ä¾‹" style="font-size:11px;" data-action="collateral_ratio">
                        <input type="number" class="form-input" value="${rule.action?.guarantor_credit_min || 0}" step="10" placeholder="æ‹…ä¿äººæœ€ä½ä¿¡ç”¨åˆ†" style="font-size:11px;" data-action="guarantor_credit_min">
                    </div>
                </div>
                <div style="margin-bottom:8px; border-top: 1px solid var(--border-color); padding-top: 8px;">
                    <div style="font-size:11px; color:var(--accent-warning); margin-bottom:6px; font-weight:500;">âš–ï¸ æƒ©ç½šå‚æ•°</div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:6px; padding:8px; background:var(--bg-secondary); border-radius:4px;">
                        <input type="number" class="form-input" value="${rule.penalty?.score_delta || 0}" step="0.01" placeholder="ç»¼åˆè¯„åˆ†è°ƒæ•´" style="font-size:11px;" data-penalty="score_delta">
                        <input type="number" class="form-input" value="${rule.penalty?.profit_score_delta || 0}" step="0.01" placeholder="åˆ©æ¶¦å¾—åˆ†è°ƒæ•´" style="font-size:11px;" data-penalty="profit_score_delta">
                        <input type="number" class="form-input" value="${rule.penalty?.risk_score_delta || 0}" step="0.01" placeholder="é£é™©å¾—åˆ†è°ƒæ•´" style="font-size:11px;" data-penalty="risk_score_delta">
                        <input type="number" class="form-input" value="${rule.penalty?.compliance_score_delta || 0}" step="0.01" placeholder="åˆè§„å¾—åˆ†è°ƒæ•´" style="font-size:11px;" data-penalty="compliance_score_delta">
                        <input type="number" class="form-input" value="${rule.penalty?.risk_multiplier || 1.0}" step="0.1" placeholder="é£é™©å€æ•°" style="font-size:11px;" data-penalty="risk_multiplier">
                        <input type="number" class="form-input" value="${rule.penalty?.default_prob_multiplier || 1.0}" step="0.1" placeholder="è¿çº¦æ¦‚ç‡å€æ•°" style="font-size:11px;" data-penalty="default_prob_multiplier">
                        <input type="number" class="form-input" value="${rule.penalty?.profit_discount || 1.0}" step="0.01" placeholder="åˆ©æ¶¦æŠ˜æ‰£" style="font-size:11px;" data-penalty="profit_discount">
                        <input type="number" class="form-input" value="${rule.penalty?.interest_rate_bonus || 0}" step="0.001" placeholder="åˆ©ç‡åŠ æˆ" style="font-size:11px;" data-penalty="interest_rate_bonus">
                    </div>
                </details>
            `;
            container.appendChild(card);
        }

        function addRuleCondition(btn) {
            const container = btn.previousElementSibling;
            const condDiv = document.createElement('div');
            condDiv.style.cssText = 'display:flex; gap:6px; align-items:center;';
            condDiv.innerHTML = `
                <select class="form-input" style="flex:1; font-size:11px;">
                    <option value="monthly_income">æœˆæ”¶å…¥</option>
                    <option value="age">å¹´é¾„</option>
                    <option value="debt_ratio">è´Ÿå€ºç‡</option>
                    <option value="credit_score">ä¿¡ç”¨åˆ†</option>
                    <option value="years_in_business">ç»è¥å¹´é™</option>
                    <option value="annual_revenue">å¹´æ”¶å…¥ï¼ˆä¼ä¸šï¼‰</option>
                    <option value="total_assets">æ€»èµ„äº§</option>
                    <option value="deposit_balance">å­˜æ¬¾ä½™é¢</option>
                    <option value="previous_loans">å†å²è´·æ¬¾æ•°</option>
                    <option value="max_historical_dpd">æœ€å¤§é€¾æœŸå¤©æ•°</option>
                    <option value="risk_score">é£é™©è¯„åˆ†</option>
                </select>
                <select class="form-input" style="width:80px; font-size:11px;">
                    <option value=">">></option>
                    <option value=">=">>=</option>
                    <option value="<"><</option>
                    <option value="<="><=</option>
                    <option value="==">==</option>
                </select>
                <input type="number" class="form-input" value="0" step="0.01" style="width:100px; font-size:11px;">
                <button class="btn-secondary" style="padding:2px 6px;font-size:11px;" onclick="this.parentElement.remove()">Ã—</button>
            `;
            container.appendChild(condDiv);
        }

        async function loadDefaultRules() {
            const container = document.getElementById('arena-rules');
            if (!container) return;
            container.innerHTML = '<div style="padding:12px; text-align:center; color:var(--text-muted);">åŠ è½½ä¸­...</div>';
            try {
                const res = await fetch(`${API_BASE}/api/arena/default-rules`);
                const data = await res.json();
                if (data.success && data.rules) {
                    container.innerHTML = '';
                    data.rules.forEach(rule => addArenaRule(rule));
                    console.log(`âœ… å·²åŠ è½½ ${data.count} æ¡é»˜è®¤è§„åˆ™`);
                } else {
                    container.innerHTML = '<div style="padding:12px; color:var(--accent-danger);">åŠ è½½å¤±è´¥</div>';
                }
            } catch (e) {
                console.error('åŠ è½½é»˜è®¤è§„åˆ™å¤±è´¥:', e);
                container.innerHTML = '<div style="padding:12px; color:var(--accent-danger);">åŠ è½½å¤±è´¥: ' + e.message + '</div>';
            }
        }

        function collectArenaRules() {
            const container = document.getElementById('arena-rules');
            if (!container) return [];
            const cards = Array.from(container.children);
            return cards.map(card => {
                const inputs = card.querySelectorAll('input');
                const textarea = card.querySelector('textarea');
                const enabledCheckbox = card.querySelector('input[type="checkbox"]');
                
                // æ”¶é›†æ¡ä»¶
                const conditions = Array.from(card.querySelectorAll('.rule-conditions > div')).map(condDiv => {
                    const selects = condDiv.querySelectorAll('select');
                    const input = condDiv.querySelector('input[type="number"]');
                    return {
                        field: selects[0]?.value || 'monthly_income',
                        op: selects[1]?.value || '>',
                        value: parseFloat(input?.value || 0)
                    };
                });
                
                // æ”¶é›†åŠ¨ä½œå‚æ•°ï¼ˆä½¿ç”¨data-actionå±æ€§ï¼‰
                const actionInputs = card.querySelectorAll('[data-action]');
                const action = {
                    approval_threshold_delta: 0,
                    rate_spread_delta: 0,
                    loan_amount_multiplier: 1.0,
                    term_months_delta: 0,
                    min_loan_amount: 0,
                    max_loan_amount: 0,
                    force_approve: false,
                    force_reject: false,
                    require_collateral: false,
                    require_guarantor: false,
                    collateral_ratio: 0,
                    guarantor_credit_min: 0
                };
                actionInputs.forEach(input => {
                    const key = input.getAttribute('data-action');
                    if (input.type === 'checkbox') {
                        action[key] = input.checked;
                    } else {
                        const val = parseFloat(input.value || 0);
                        action[key] = isNaN(val) ? 0 : val;
                    }
                });
                
                // æ”¶é›†æƒ©ç½šå‚æ•°ï¼ˆä½¿ç”¨data-penaltyå±æ€§ï¼‰
                const penaltyInputs = card.querySelectorAll('[data-penalty]');
                const penalty = {
                    score_delta: 0,
                    profit_score_delta: 0,
                    risk_score_delta: 0,
                    compliance_score_delta: 0,
                    risk_multiplier: 1.0,
                    default_prob_multiplier: 1.0,
                    profit_discount: 1.0,
                    interest_rate_bonus: 0
                };
                penaltyInputs.forEach(input => {
                    const key = input.getAttribute('data-penalty');
                    const val = parseFloat(input.value || 0);
                    penalty[key] = isNaN(val) ? (key.includes('multiplier') || key === 'profit_discount' ? 1.0 : 0) : val;
                });
                
                return {
                    name: inputs[0]?.value || 'æœªå‘½åè§„åˆ™',
                    description: textarea?.value || '',
                    priority: parseInt(inputs[1]?.value || 0),
                    enabled: enabledCheckbox?.checked !== false,
                    conditions: conditions,
                    action: action,
                    penalty: penalty
                };
            });
        }

        async function runArena() {
            const box = document.getElementById('arena-result');
            if (!box) return;
            box.innerHTML = `<div class="loading"><div class="spinner"></div><p>è®¡ç®—ä¸­...</p></div>`;
            try {
                // é‡æ–°æ”¶é›†æ‰€æœ‰å‚èµ›è€…å’Œè§„åˆ™ï¼ˆç¡®ä¿è·å–æœ€æ–°æ•°æ®ï¼‰
                const participants = collectArenaParticipants();
                const rules = collectArenaRules();
                
                // éªŒè¯å‚èµ›è€…æ•°é‡
                if (participants.length === 0) {
                    throw new Error('è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªå‚èµ›è€…');
                }
                
                console.log('è¿è¡ŒPKï¼Œå‚èµ›è€…æ•°é‡:', participants.length, 'è§„åˆ™æ•°é‡:', rules.length);
                
                const payload = {
                    participants,
                    rules,
                    customer_count: parseInt(document.getElementById('arena-customer-count')?.value || 300),
                    loan_amount: parseFloat(document.getElementById('arena-loan-amount')?.value || 100000),
                    base_rate: parseFloat(document.getElementById('arena-base-rate')?.value || 0.08),
                    seed: parseInt(document.getElementById('arena-seed')?.value || 42),
                    scenario: document.getElementById('arena-scenario')?.value || 'normal',
                    black_swan: !!document.getElementById('arena-black-swan')?.checked
                };
                
                console.log('å‘é€è¯·æ±‚ï¼Œpayload:', JSON.stringify(payload, null, 2));
                const res = await fetch(`${API_BASE}/api/arena/run`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                // æ£€æŸ¥å“åº”çŠ¶æ€
                if (!res.ok) {
                    const errorText = await res.text();
                    throw new Error(`HTTP ${res.status}: ${errorText.substring(0, 200)}`);
                }
                
                // æ£€æŸ¥Content-Type
                const contentType = res.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await res.text();
                    throw new Error(`æœåŠ¡å™¨è¿”å›äº†éJSONå“åº”: ${text.substring(0, 200)}`);
                }
                
                const data = await res.json();
                if (!data.success) throw new Error(data.error || 'è¯·æ±‚å¤±è´¥');
                window.lastArenaResult = data;
                const rows = data.results.map((r, idx) => {
                    const scoreBreakdown = r.score_breakdown || {};
                    const triggeredRules = r.triggered_rules || {};
                    const triggeredRulesList = r.triggered_rules_list || [];
                    return `
                    <tr>
                        <td>${idx + 1}</td>
                        <td><strong>${r.name}</strong><br><span style="font-size:11px; color:var(--text-muted);">ç»¼åˆå¾—åˆ†: ${(scoreBreakdown.overall_score * 100).toFixed(1)}%</span></td>
                        <td>${(r.approval_rate * 100).toFixed(1)}%</td>
                        <td>${(r.avg_default_prob * 100).toFixed(2)}%</td>
                        <td>${(r.est_profit / 1e6).toFixed(2)} ç™¾ä¸‡</td>
                        <td>${r.sample_size}</td>
                        <td>${r.raroc ? r.raroc.toFixed(4) : 'â€”'}</td>
                        <td style="font-size:11px;">
                            ${scoreBreakdown.profit_score ? `åˆ©æ¶¦: ${(scoreBreakdown.profit_score*100).toFixed(0)}%<br>` : ''}
                            ${scoreBreakdown.risk_score ? `é£é™©: ${(scoreBreakdown.risk_score*100).toFixed(0)}%<br>` : ''}
                            ${scoreBreakdown.stability_score ? `ç¨³å®š: ${(scoreBreakdown.stability_score*100).toFixed(0)}%<br>` : ''}
                            ${scoreBreakdown.compliance_score ? `åˆè§„: ${(scoreBreakdown.compliance_score*100).toFixed(0)}%` : ''}
                        </td>
                        <td style="font-size:11px;">
                            ${triggeredRulesList.length > 0 ? triggeredRulesList.slice(0, 3).map(rule => `${rule}`).join('<br>') + (triggeredRulesList.length > 3 ? '<br>...' : '') : 'â€”'}
                        </td>
                        <td>
                            <button class="btn-secondary" style="font-size:11px; padding:4px 8px;" onclick="showArenaDetail('${r.name}', ${idx})">è¯¦æƒ…</button>
                        </td>
                    </tr>
                `;
                }).join('');
                box.innerHTML = `
                    <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">
                        å®¢æˆ·æ•°: ${data.summary.customer_count} Â· è´·æ¬¾é‡‘é¢: Â¥${data.summary.loan_amount.toLocaleString()} Â· åŸºå‡†åˆ©ç‡: ${(data.summary.base_rate*100).toFixed(1)}% Â· åœºæ™¯: ${data.summary.scenario} Â· é»‘å¤©é¹…: ${data.summary.black_swan} Â· è§„åˆ™æ•°: ${data.summary.rules_count || 0}
                    </div>
                    <table class="data-table" style="width: 100%; font-size: 13px;">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>å‚èµ›è€…</th>
                                <th>å®¡æ‰¹ç‡</th>
                                <th>è¿çº¦æ¦‚ç‡</th>
                                <th>é¢„ä¼°åˆ©æ¶¦</th>
                                <th>æ ·æœ¬æ•°</th>
                                <th>RAROC</th>
                                <th>è¯„åˆ†åˆ†è§£</th>
                                <th>è§¦å‘è§„åˆ™</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                `;
            } catch (e) {
                console.error(e);
                box.innerHTML = `<div style="color: var(--text-danger);">è¿è¡Œå¤±è´¥: ${e.message}</div>`;
            }
        }

        function showArenaDetail(participantName, index) {
            const data = window.lastArenaResult;
            if (!data || !data.results || !data.results[index]) return;
            const result = data.results[index];
            const scoreBreakdown = result.score_breakdown || {};
            const triggeredRules = result.triggered_rules || {};
            const triggeredRulesList = result.triggered_rules_list || [];
            const profitBreakdown = result.profit_breakdown || {};
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px; max-height: 90vh;">
                    <div class="modal-header">
                        <h3>${participantName} - è¯¦ç»†åˆ†æ</h3>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">Ã—</button>
                    </div>
                    <div class="modal-body" style="max-height: calc(90vh - 100px); overflow-y: auto;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                            <div class="card" style="padding: 12px;">
                                <h4 style="font-size: 14px; margin-bottom: 8px;">åŸºç¡€æŒ‡æ ‡</h4>
                                <div style="font-size: 12px; line-height: 1.8;">
                                    <div>å®¡æ‰¹ç‡: ${(result.approval_rate * 100).toFixed(1)}%</div>
                                    <div>è¿çº¦æ¦‚ç‡: ${(result.avg_default_prob * 100).toFixed(2)}%</div>
                                    <div>è¿çº¦P95: ${result.dp_p95 ? (result.dp_p95*100).toFixed(2)+'%' : 'â€”'}</div>
                                    <div>RAROC: ${result.raroc ? result.raroc.toFixed(4) : 'â€”'}</div>
                                    <div>åˆ©æ¶¦æ³¢åŠ¨ç‡: ${result.profit_volatility ? (result.profit_volatility / 1e6).toFixed(2) + ' ç™¾ä¸‡' : 'â€”'}</div>
                                    <div>æœ€å¤§å›æ’¤: ${result.max_drawdown ? (result.max_drawdown * 100).toFixed(2) + '%' : 'â€”'}</div>
                                </div>
                            </div>
                            <div class="card" style="padding: 12px;">
                                <h4 style="font-size: 14px; margin-bottom: 8px;">è¯„åˆ†åˆ†è§£</h4>
                                <div style="font-size: 12px; line-height: 1.8;">
                                    <div>ç»¼åˆå¾—åˆ†: <strong>${(scoreBreakdown.overall_score * 100).toFixed(1)}%</strong></div>
                                    <div>åˆ©æ¶¦å¾—åˆ†: ${(scoreBreakdown.profit_score * 100).toFixed(1)}%</div>
                                    <div>é£é™©å¾—åˆ†: ${(scoreBreakdown.risk_score * 100).toFixed(1)}%</div>
                                    <div>ç¨³å®šæ€§å¾—åˆ†: ${(scoreBreakdown.stability_score * 100).toFixed(1)}%</div>
                                    <div>åˆè§„å¾—åˆ†: ${(scoreBreakdown.compliance_score * 100).toFixed(1)}%</div>
                                    <div>æ•ˆç‡å¾—åˆ†: ${(scoreBreakdown.efficiency_score * 100).toFixed(1)}%</div>
                                    <div>å¯è§£é‡Šæ€§å¾—åˆ†: ${(scoreBreakdown.explainability_score * 100).toFixed(1)}%</div>
                                </div>
                            </div>
                        </div>
                        <div class="card" style="padding: 12px; margin-bottom: 16px;">
                            <h4 style="font-size: 14px; margin-bottom: 8px;">åˆ©æ¶¦åˆ†è§£</h4>
                            <div style="font-size: 12px; line-height: 1.8;">
                                <div>åˆ©æ¯æ”¶å…¥: Â¥${profitBreakdown.interest_income ? profitBreakdown.interest_income.toLocaleString() : '0'}</div>
                                <div>é¢„æœŸæŸå¤±: Â¥${profitBreakdown.expected_loss ? profitBreakdown.expected_loss.toLocaleString() : '0'}</div>
                                <div>å‡€åˆ©æ¶¦: Â¥${profitBreakdown.net_profit ? profitBreakdown.net_profit.toLocaleString() : '0'}</div>
                            </div>
                        </div>
                        <div class="card" style="padding: 12px; margin-bottom: 16px;">
                            <h4 style="font-size: 14px; margin-bottom: 8px;">è§¦å‘è§„åˆ™ç»Ÿè®¡</h4>
                            <div style="font-size: 12px;">
                                ${Object.keys(triggeredRules).length > 0 ? 
                                    Object.entries(triggeredRules).map(([rule, count]) => 
                                        `<div style="margin-bottom: 4px;">${rule}: ${count} æ¬¡</div>`
                                    ).join('') : 
                                    '<div style="color: var(--text-muted);">æœªè§¦å‘ä»»ä½•è§„åˆ™</div>'
                                }
                            </div>
                        </div>
                        ${result.factor_top5 && result.factor_top5.length > 0 ? `
                        <div class="card" style="padding: 12px; margin-bottom: 16px;">
                            <h4 style="font-size: 14px; margin-bottom: 8px;">Top 5 é£é™©å› å­</h4>
                            <div style="font-size: 12px;">
                                ${result.factor_top5.map(f => `<div style="margin-bottom: 4px;">${f[0]}: ${f[1].toFixed(3)}</div>`).join('')}
                            </div>
                        </div>
                        ` : ''}
                        ${result.customer_details && result.customer_details.length > 0 ? `
                        <div class="card" style="padding: 12px; margin-bottom: 16px;">
                            <h4 style="font-size: 14px; margin-bottom: 8px;">å®¢æˆ·å†³ç­–è¯¦æƒ…</h4>
                            <div style="max-height: 300px; overflow-y: auto;">
                                <table class="data-table" style="width: 100%; font-size: 11px;">
                                    <thead>
                                        <tr>
                                            <th>å®¢æˆ·ID</th>
                                            <th>å†³ç­–</th>
                                            <th>è¿çº¦æ¦‚ç‡</th>
                                            <th>åˆ©æ¶¦</th>
                                            <th>è§¦å‘è§„åˆ™</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${result.customer_details.slice(0, 50).map(c => `
                                            <tr>
                                                <td>${c.customer_id || 'â€”'}</td>
                                                <td><span style="color: ${c.decision === 'approved' ? 'var(--accent-primary)' : 'var(--accent-danger)'};">${c.decision === 'approved' ? 'é€šè¿‡' : 'æ‹’ç»'}</span></td>
                                                <td>${(c.default_prob * 100).toFixed(2)}%</td>
                                                <td>Â¥${c.profit ? c.profit.toLocaleString() : '0'}</td>
                                                <td style="font-size: 10px;">${(c.triggered_rules || []).join(', ') || 'â€”'}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                                ${result.customer_details.length > 50 ? `<div style="padding: 8px; text-align: center; color: var(--text-muted); font-size: 11px;">ä»…æ˜¾ç¤ºå‰50æ¡ï¼Œå…±${result.customer_details.length}æ¡</div>` : ''}
                            </div>
                        </div>
                        ` : ''}
                        <div class="card" style="padding: 12px;">
                            <h4 style="font-size: 14px; margin-bottom: 8px;">ç­–ç•¥å»ºè®®</h4>
                            <div style="font-size: 12px; line-height: 1.8; color: var(--text-secondary);">
                                ${generateStrategyRecommendations(result, scoreBreakdown)}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            modal.addEventListener('click', function(e) { if (e.target === modal) modal.remove(); });
            document.body.appendChild(modal);
        }

        function generateStrategyRecommendations(result, scoreBreakdown) {
            const recommendations = [];
            
            // åŸºäºå®¡æ‰¹ç‡
            if (result.approval_rate < 0.3) {
                recommendations.push('âš ï¸ å®¡æ‰¹ç‡è¾ƒä½ï¼Œå¯èƒ½é”™å¤±ä¼˜è´¨å®¢æˆ·ï¼Œå»ºè®®é€‚å½“é™ä½å®¡æ‰¹é˜ˆå€¼');
            } else if (result.approval_rate > 0.7) {
                recommendations.push('âš ï¸ å®¡æ‰¹ç‡è¾ƒé«˜ï¼Œå¯èƒ½å­˜åœ¨é£é™©æ•å£è¿‡å¤§ï¼Œå»ºè®®æé«˜å®¡æ‰¹æ ‡å‡†');
            }
            
            // åŸºäºè¿çº¦æ¦‚ç‡
            if (result.avg_default_prob > 0.15) {
                recommendations.push('ğŸ”´ è¿çº¦æ¦‚ç‡åé«˜ï¼Œå»ºè®®åŠ å¼ºé£é™©æ§åˆ¶æªæ–½ï¼Œæé«˜å®¡æ‰¹æ ‡å‡†');
            } else if (result.avg_default_prob < 0.05) {
                recommendations.push('âœ… è¿çº¦æ¦‚ç‡è¾ƒä½ï¼Œå¯ä»¥è€ƒè™‘é€‚å½“æ”¾å®½å®¡æ‰¹æ¡ä»¶ä»¥æå‡åˆ©æ¶¦');
            }
            
            // åŸºäºåˆ©æ¶¦å¾—åˆ†
            if (scoreBreakdown.profit_score < 0.5) {
                recommendations.push('ğŸ’° åˆ©æ¶¦å¾—åˆ†åä½ï¼Œå»ºè®®ä¼˜åŒ–åˆ©ç‡å®šä»·ç­–ç•¥æˆ–æé«˜å®¡æ‰¹æ•ˆç‡');
            }
            
            // åŸºäºé£é™©å¾—åˆ†
            if (scoreBreakdown.risk_score < 0.5) {
                recommendations.push('ğŸ›¡ï¸ é£é™©å¾—åˆ†åä½ï¼Œå»ºè®®åŠ å¼ºé£é™©è¯†åˆ«å’Œé˜²æ§æªæ–½');
            }
            
            // åŸºäºRAROC
            if (result.raroc && result.raroc < 0.1) {
                recommendations.push('ğŸ“Š RAROCåä½ï¼Œå»ºè®®ä¼˜åŒ–é£é™©è°ƒæ•´åçš„æ”¶ç›Šè¡¨ç°');
            }
            
            return recommendations.length > 0 ? recommendations.join('<br>') : 'âœ… ç­–ç•¥è¡¨ç°è‰¯å¥½ï¼Œå»ºè®®ç»§ç»­ä¿æŒ';
        }

        function showArenaCalc() {
            const data = window.lastArenaResult;
            if (!data) { alert('è¯·å…ˆè¿è¡Œä¸€æ¬¡PK'); return; }
            const notes = data.summary?.calculation_notes || [];
            alert(`è®¡ç®—è¯´æ˜ï¼š\n${notes.join('\n')}`);
        }

        async function showArenaAIExplain() {
            const data = window.lastArenaResult;
            if (!data) { alert('è¯·å…ˆè¿è¡Œä¸€æ¬¡PK'); return; }
            
            try {
                const res = await fetch(`${API_BASE}/api/arena/ai-explain`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const explainData = await res.json();
                if (!explainData.success) throw new Error(explainData.error || 'è§£é‡Šç”Ÿæˆå¤±è´¥');
                
                const analysis = explainData.analysis;
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'flex';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 800px; max-height: 90vh;">
                        <div class="modal-header">
                            <h3>ğŸ¤– AI æ™ºèƒ½è§£é‡Š</h3>
                            <button class="modal-close" onclick="this.closest('.modal').remove()">Ã—</button>
                        </div>
                        <div class="modal-body" style="max-height: calc(90vh - 100px); overflow-y: auto;">
                            <div class="card" style="padding: 16px; margin-bottom: 16px;">
                                <h4 style="font-size: 14px; margin-bottom: 8px;">ğŸ† èƒœè€…åˆ†æ</h4>
                                <div style="font-size: 13px; line-height: 1.8; white-space: pre-wrap;">${analysis.winner_analysis || 'æš‚æ— æ•°æ®'}</div>
                            </div>
                            <div class="card" style="padding: 16px; margin-bottom: 16px;">
                                <h4 style="font-size: 14px; margin-bottom: 8px;">ğŸ“Š æ€§èƒ½å¯¹æ¯”</h4>
                                <div style="font-size: 13px;">
                                    ${analysis.performance_comparison.map(p => `<div style="margin-bottom: 8px;">â€¢ ${p.summary}</div>`).join('')}
                                </div>
                            </div>
                            <div class="card" style="padding: 16px; margin-bottom: 16px;">
                                <h4 style="font-size: 14px; margin-bottom: 8px;">ğŸ’¡ å…³é”®æ´å¯Ÿ</h4>
                                <div style="font-size: 13px;">
                                    ${analysis.key_insights.map(i => `<div style="margin-bottom: 8px;">â€¢ ${i}</div>`).join('')}
                                </div>
                            </div>
                            <div class="card" style="padding: 16px; margin-bottom: 16px;">
                                <h4 style="font-size: 14px; margin-bottom: 8px;">âš ï¸ é£é™©è¯„ä¼°</h4>
                                <div style="font-size: 13px;">${analysis.risk_assessment || 'æš‚æ— æ•°æ®'}</div>
                            </div>
                            <div class="card" style="padding: 16px;">
                                <h4 style="font-size: 14px; margin-bottom: 8px;">ğŸ’¼ å»ºè®®</h4>
                                <div style="font-size: 13px;">
                                    ${analysis.recommendations.map(r => `<div style="margin-bottom: 8px;">â€¢ ${r}</div>`).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                modal.addEventListener('click', function(e) { if (e.target === modal) modal.remove(); });
                document.body.appendChild(modal);
            } catch (e) {
                console.error('AIè§£é‡Šå¤±è´¥:', e);
                alert('AIè§£é‡Šç”Ÿæˆå¤±è´¥: ' + e.message);
            }
        }
        
        async function exportArenaResult(format) {
            const data = window.lastArenaResult;
            if (!data) { alert('è¯·å…ˆè¿è¡Œä¸€æ¬¡PK'); return; }
            
            try {
                const res = await fetch(`${API_BASE}/api/arena/export`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ...data, format })
                });
                
                if (res.ok) {
                    const blob = await res.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = res.headers.get('Content-Disposition')?.split('filename=')[1] || `arena_result.${format}`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    console.log(`âœ… å·²å¯¼å‡º ${format.toUpperCase()} æ ¼å¼æŠ¥å‘Š`);
                } else {
                    throw new Error('å¯¼å‡ºå¤±è´¥');
                }
            } catch (e) {
                console.error('å¯¼å‡ºå¤±è´¥:', e);
                alert('å¯¼å‡ºå¤±è´¥: ' + e.message);
            }
        }
        
        function showArenaReplay() {
            const data = window.lastArenaResult;
            if (!data || !data.results) { alert('è¯·å…ˆè¿è¡Œä¸€æ¬¡PK'); return; }
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 1000px; max-height: 90vh;">
                    <div class="modal-header">
                        <h3>ğŸ“¹ æ¼”æ­¦åœºå›æ”¾</h3>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">Ã—</button>
                    </div>
                    <div class="modal-body" style="max-height: calc(90vh - 100px); overflow-y: auto;">
                        <div style="margin-bottom: 16px;">
                            <label style="font-size: 12px; color: var(--text-muted);">é€‰æ‹©å‚èµ›è€…:</label>
                            <select id="replay-participant" class="form-input" style="width: 200px; margin-left: 8px;" onchange="updateReplayView()">
                                ${data.results.map((r, idx) => `<option value="${idx}">${r.name}</option>`).join('')}
                            </select>
                        </div>
                        <div id="replay-content" style="min-height: 400px;">
                            <!-- åŠ¨æ€å¡«å……å›æ”¾å†…å®¹ -->
                        </div>
                    </div>
                </div>
            `;
            modal.addEventListener('click', function(e) { if (e.target === modal) modal.remove(); });
            document.body.appendChild(modal);
            
            // åˆå§‹åŒ–å›æ”¾è§†å›¾
            window.updateReplayView = function() {
                const idx = parseInt(document.getElementById('replay-participant')?.value || 0);
                const result = data.results[idx];
                const content = document.getElementById('replay-content');
                if (!result || !content) return;
                
                const customerDetails = result.customer_details || [];
                const triggeredRules = result.triggered_rules || {};
                
                content.innerHTML = `
                    <div class="card" style="padding: 16px; margin-bottom: 16px;">
                        <h4 style="font-size: 14px; margin-bottom: 12px;">ğŸ“Š æ€»ä½“ç»Ÿè®¡</h4>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; font-size: 13px;">
                            <div>å®¡æ‰¹ç‡: <strong>${(result.approval_rate * 100).toFixed(1)}%</strong></div>
                            <div>è¿çº¦æ¦‚ç‡: <strong>${(result.avg_default_prob * 100).toFixed(2)}%</strong></div>
                            <div>é¢„ä¼°åˆ©æ¶¦: <strong>Â¥${(result.est_profit / 1e6).toFixed(2)} ç™¾ä¸‡</strong></div>
                        </div>
                    </div>
                    <div class="card" style="padding: 16px; margin-bottom: 16px;">
                        <h4 style="font-size: 14px; margin-bottom: 12px;">ğŸ“‹ å®¢æˆ·å†³ç­–è¯¦æƒ… (æ˜¾ç¤ºå‰50ä¸ª)</h4>
                        <div style="max-height: 400px; overflow-y: auto;">
                            <table class="data-table" style="width: 100%; font-size: 12px;">
                                <thead>
                                    <tr>
                                        <th>å®¢æˆ·ID</th>
                                        <th>å†³ç­–</th>
                                        <th>è¿çº¦æ¦‚ç‡</th>
                                        <th>è§¦å‘è§„åˆ™</th>
                                        <th>åˆ©æ¶¦</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${customerDetails.map(c => `
                                        <tr>
                                            <td>${c.customer_id}</td>
                                            <td><span style="color: ${c.decision === 'approved' ? 'var(--accent-primary)' : 'var(--accent-danger)'}">${c.decision === 'approved' ? 'âœ… é€šè¿‡' : 'âŒ æ‹’ç»'}</span></td>
                                            <td>${c.default_prob ? (c.default_prob * 100).toFixed(2) + '%' : 'â€”'}</td>
                                            <td>${c.triggered_rules && c.triggered_rules.length > 0 ? c.triggered_rules.join(', ') : 'æ— '}</td>
                                            <td>${c.profit ? 'Â¥' + c.profit.toLocaleString() : 'â€”'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card" style="padding: 16px;">
                        <h4 style="font-size: 14px; margin-bottom: 12px;">ğŸ”§ è§„åˆ™è§¦å‘ç»Ÿè®¡</h4>
                        <div style="font-size: 13px;">
                            ${Object.entries(triggeredRules).map(([rule, count]) => `
                                <div style="margin-bottom: 8px;">
                                    <strong>${rule}</strong>: ${count} æ¬¡
                                </div>
                            `).join('') || '<div style="color: var(--text-muted);">æœªè§¦å‘ä»»ä½•è§„åˆ™</div>'}
                        </div>
                    </div>
                `;
            };
            
            updateReplayView();
        }
        
        function showArenaCharts() {
            const data = window.lastArenaResult;
            if (!data || !data.results) { alert('è¯·å…ˆè¿è¡Œä¸€æ¬¡PK'); return; }
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 1000px; max-height: 90vh;">
                    <div class="modal-header">
                        <h3>ğŸ“Š æ¼”æ­¦åœºå¯è§†åŒ–åˆ†æ</h3>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">Ã—</button>
                    </div>
                    <div class="modal-body" style="max-height: calc(90vh - 100px); overflow-y: auto;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                            <div class="card" style="padding: 16px;">
                                <h4 style="font-size: 14px; margin-bottom: 12px;">é›·è¾¾å›¾</h4>
                                <canvas id="arena-radar-chart" style="max-height: 300px;"></canvas>
                            </div>
                            <div class="card" style="padding: 16px;">
                                <h4 style="font-size: 14px; margin-bottom: 12px;">åˆ©æ¶¦å¯¹æ¯”</h4>
                                <canvas id="arena-profit-chart" style="max-height: 300px;"></canvas>
                            </div>
                        </div>
                        <div class="card" style="padding: 16px;">
                            <h4 style="font-size: 14px; margin-bottom: 12px;">å›æ’¤æ›²çº¿</h4>
                            <canvas id="arena-drawdown-chart" style="max-height: 300px;"></canvas>
                        </div>
                    </div>
                </div>
            `;
            modal.addEventListener('click', function(e) { if (e.target === modal) modal.remove(); });
            document.body.appendChild(modal);
            
            // æ¸²æŸ“å›¾è¡¨
            setTimeout(() => {
                renderArenaCharts(data);
            }, 100);
        }
        
        function renderArenaCharts(data) {
            const results = data.results || [];
            
            // é›·è¾¾å›¾ - è¯„åˆ†åˆ†è§£
            const radarCtx = document.getElementById('arena-radar-chart')?.getContext('2d');
            if (radarCtx && results.length > 0) {
                const top3 = results.slice(0, 3);
                const datasets = top3.map((r, idx) => {
                    const sb = r.score_breakdown || {};
                    return {
                        label: r.name,
                        data: [
                            (sb.profit_score || 0) * 100,
                            (sb.risk_score || 0) * 100,
                            (sb.stability_score || 0) * 100,
                            (sb.compliance_score || 0) * 100,
                            (sb.efficiency_score || 0) * 100,
                            (sb.explainability_score || 0) * 100
                        ],
                        backgroundColor: `rgba(${idx === 0 ? '0, 212, 170' : idx === 1 ? '124, 58, 237' : '59, 130, 246'}, 0.2)`,
                        borderColor: `rgb(${idx === 0 ? '0, 212, 170' : idx === 1 ? '124, 58, 237' : '59, 130, 246'})`,
                        borderWidth: 2
                    };
                });
                
                new Chart(radarCtx, {
                    type: 'radar',
                    data: {
                        labels: ['åˆ©æ¶¦', 'é£é™©', 'ç¨³å®šæ€§', 'åˆè§„', 'æ•ˆç‡', 'å¯è§£é‡Šæ€§'],
                        datasets: datasets
                    },
                    options: {
                        scales: {
                            r: {
                                beginAtZero: true,
                                max: 100
                            }
                        },
                        plugins: {
                            legend: { display: true }
                        }
                    }
                });
            }
            
            // æŸ±çŠ¶å›¾ - åˆ©æ¶¦å¯¹æ¯”
            const profitCtx = document.getElementById('arena-profit-chart')?.getContext('2d');
            if (profitCtx) {
                new Chart(profitCtx, {
                    type: 'bar',
                    data: {
                        labels: results.map(r => r.name),
                        datasets: [{
                            label: 'é¢„ä¼°åˆ©æ¶¦ (ç™¾ä¸‡)',
                            data: results.map(r => r.est_profit / 1e6),
                            backgroundColor: 'rgba(0, 212, 170, 0.6)',
                            borderColor: 'rgb(0, 212, 170)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        },
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });
            }
            
            // æŠ˜çº¿å›¾ - å›æ’¤æ›²çº¿ï¼ˆæ¨¡æ‹Ÿæ•°æ®ï¼‰
            const drawdownCtx = document.getElementById('arena-drawdown-chart')?.getContext('2d');
            if (drawdownCtx && results.length > 0) {
                // ç”Ÿæˆæ¨¡æ‹Ÿçš„å›æ’¤æ•°æ®
                const generateDrawdownData = (maxDrawdown) => {
                    const data = [];
                    for (let i = 0; i < 20; i++) {
                        data.push(Math.random() * maxDrawdown * 0.3);
                    }
                    return data;
                };
                
                const datasets = results.slice(0, 3).map((r, idx) => ({
                    label: r.name,
                    data: generateDrawdownData(r.max_drawdown || 0.1),
                    borderColor: `rgb(${idx === 0 ? '0, 212, 170' : idx === 1 ? '124, 58, 237' : '59, 130, 246'})`,
                    backgroundColor: `rgba(${idx === 0 ? '0, 212, 170' : idx === 1 ? '124, 58, 237' : '59, 130, 246'}, 0.1)`,
                    tension: 0.4
                }));
                
                new Chart(drawdownCtx, {
                    type: 'line',
                    data: {
                        labels: Array.from({length: 20}, (_, i) => `T${i+1}`),
                        datasets: datasets
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'å›æ’¤ (%)' }
                            }
                        },
                        plugins: {
                            legend: { display: true }
                        }
                    }
                });
            }
        }
        
        // é¡µé¢åˆ‡æ¢æ—¶åŠ è½½æ•°æ®
        const origSwitchPage = window.switchPage || function(){};
        window.switchPage = function(pageName) {
            origSwitchPage(pageName);
            if (pageName === 'databrowser') {
                refreshDataSources();
            } else if (pageName === 'modeleval') {
                loadModels();
                loadTestCases();
            } else if (pageName === 'aihub') {
                loadHubModels();
            }
        };
        
        // åˆå§‹åŒ–
        console.log('ğŸ® Gamium Finance AI å·²åŠ è½½');
    </script>
</body>
</html>

